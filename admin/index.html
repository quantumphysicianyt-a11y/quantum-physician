<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quantum Physician — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
/* ============================================================
   UNIFIED QP ADMIN — Professional Neutral Theme
   Colors: Slate/Zinc neutrals + warm sand accent + teal action
   ============================================================ */
:root {
  --sidebar-w: 260px;
  --bg: #0f1117;
  --bg-raised: #171921;
  --bg-card: #1c1e28;
  --bg-hover: #22242f;
  --bg-input: rgba(255,255,255,.04);
  --border: rgba(255,255,255,.07);
  --border-hover: rgba(255,255,255,.14);
  --text: rgba(255,255,255,.9);
  --text-secondary: rgba(255,255,255,.55);
  --text-muted: rgba(255,255,255,.3);
  --accent: #5ba8b2;
  --accent-glow: rgba(91,168,178,.15);
  --accent-soft: rgba(91,168,178,.1);
  --warm: #c9a87c;
  --warm-soft: rgba(201,168,124,.1);
  --success: #3dd68c;
  --success-soft: rgba(61,214,140,.1);
  --warning: #f0b429;
  --warning-soft: rgba(240,180,41,.1);
  --danger: #ef5350;
  --danger-soft: rgba(239,83,80,.1);
  --purple: #a78bfa;
  --purple-soft: rgba(167,139,250,.1);
  --radius: 10px;
  --radius-sm: 6px;
  --radius-lg: 14px;
  --shadow: 0 1px 3px rgba(0,0,0,.3), 0 1px 2px rgba(0,0,0,.2);
  --shadow-lg: 0 4px 24px rgba(0,0,0,.4);
  --transition: .2s cubic-bezier(.22,1,.36,1);
  --font: 'DM Sans', system-ui, -apple-system, sans-serif;
  --font-display: 'Instrument Serif', Georgia, serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--text);font-size:14px;line-height:1.5;min-height:100vh}
a{color:inherit;text-decoration:none}
img{max-width:100%;display:block}

/* ===== AUTH SCREEN ===== */
.auth-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px}
.auth-box{width:100%;max-width:380px;text-align:center}
.auth-logo{height:60px;width:auto;margin:0 auto 8px;opacity:.85}
.auth-subtitle{font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--text-muted);margin-bottom:36px}
.auth-card{background:var(--bg-raised);border:1px solid var(--border);border-radius:var(--radius-lg);padding:32px 28px}
.auth-card h2{font-family:var(--font-display);font-size:24px;font-weight:400;margin-bottom:6px;color:var(--text)}
.auth-card p{font-size:13px;color:var(--text-secondary);margin-bottom:24px}
.auth-field{margin-bottom:14px;text-align:left}
.auth-field label{display:block;font-size:11px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
.auth-field input{width:100%;padding:11px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px;font-family:var(--font);transition:border var(--transition)}
.auth-field input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.auth-field input::placeholder{color:var(--text-muted)}
.auth-error{color:var(--danger);font-size:12px;margin-bottom:14px;display:none}
.auth-btn{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius-sm);font-size:13px;font-weight:600;letter-spacing:.04em;cursor:pointer;transition:all var(--transition);font-family:var(--font)}
.auth-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}

/* ===== LAYOUT ===== */
.admin-layout{min-height:100vh;display:none}
.sidebar{position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);background:var(--bg-raised);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:50;overflow-y:auto}
.main-content{margin-left:var(--sidebar-w);min-height:100vh;padding:0}

/* ===== SIDEBAR ===== */
.sb-logo{padding:22px 20px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.sb-logo img{height:38px;width:auto;opacity:.9}
.sb-logo-text{font-family:var(--font-display);font-size:16px;color:var(--text);line-height:1.2}
.sb-logo-text small{font-family:var(--font);font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);display:block;margin-top:1px}

.sb-nav{flex:1;padding:16px 12px}
.sb-section{margin-bottom:20px}
.sb-section-label{font-size:10px;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--text-muted);padding:0 10px;margin-bottom:6px}

.sb-link{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--radius-sm);color:var(--text-secondary);font-size:13px;font-weight:500;cursor:pointer;transition:all var(--transition);border:none;background:none;width:100%;text-align:left;font-family:var(--font)}
.sb-link:hover{background:var(--bg-hover);color:var(--text)}
.sb-link.active{background:var(--accent-soft);color:var(--accent);font-weight:600}
.sb-link.active .sb-icon{color:var(--accent)}
.sb-icon{width:18px;height:18px;flex-shrink:0;opacity:.7}
.sb-link.active .sb-icon{opacity:1}
.sb-link .sb-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;min-width:18px;text-align:center}

.sb-footer{padding:16px;border-top:1px solid var(--border)}
.sb-user{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--radius-sm);cursor:default}
.sb-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--warm));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0}
.sb-user-info{flex:1;min-width:0}
.sb-user-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-user-role{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em}
.sb-logout{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:6px;border-radius:var(--radius-sm);transition:all var(--transition)}
.sb-logout:hover{color:var(--danger);background:var(--danger-soft)}
.sb-logout svg{width:16px;height:16px}

/* ===== TOP BAR ===== */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 28px;border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:40}
.topbar-title{font-family:var(--font-display);font-size:22px;font-weight:400;color:var(--text)}
.topbar-right{display:flex;align-items:center;gap:12px}
.topbar-search{display:flex;align-items:center;gap:8px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);padding:8px 14px;min-width:260px;transition:border var(--transition)}
.topbar-search:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.topbar-search svg{width:16px;height:16px;color:var(--text-muted);flex-shrink:0}
.topbar-search input{border:none;background:none;color:var(--text);font-size:13px;font-family:var(--font);flex:1;outline:none}
.topbar-search input::placeholder{color:var(--text-muted)}
.topbar-btn{width:36px;height:36px;border-radius:var(--radius-sm);background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition);position:relative}
.topbar-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--bg-hover)}
.topbar-btn svg{width:18px;height:18px}

/* ===== CONTENT PAGES ===== */
.page{display:none;padding:28px}
.page.active{display:block}
.page-header{margin-bottom:24px}
.page-header h1{font-family:var(--font-display);font-size:26px;font-weight:400;margin-bottom:4px}
.page-header p{color:var(--text-secondary);font-size:13px}

/* ===== STAT CARDS ===== */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:border var(--transition)}
.stat-card:hover{border-color:var(--border-hover)}
.stat-label{font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.stat-label .dot{width:6px;height:6px;border-radius:50%}
.stat-value{font-size:28px;font-weight:300;font-family:var(--font-display);line-height:1.1}
.stat-value.teal{color:var(--accent)}
.stat-value.warm{color:var(--warm)}
.stat-value.green{color:var(--success)}
.stat-value.purple{color:var(--purple)}
.stat-change{font-size:11px;margin-top:6px;display:flex;align-items:center;gap:4px}
.stat-change.up{color:var(--success)}
.stat-change.down{color:var(--danger)}
.stat-change svg{width:12px;height:12px}

/* ===== CARDS / SECTIONS ===== */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.card-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.card-body{padding:20px}

/* ===== TABLES ===== */
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);padding:10px 14px;border-bottom:1px solid var(--border)}
.tbl td{padding:12px 14px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text-secondary)}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--bg-hover)}
.tbl .email{color:var(--accent);font-weight:500}
.tbl .name{color:var(--text)}
.tbl .mono{font-family:'DM Mono',monospace;font-size:12px;color:var(--text-muted)}
.tbl .amount{font-weight:600;color:var(--success)}
.tbl .amount.zero{color:var(--text-muted)}

/* ===== BADGES ===== */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;letter-spacing:.02em;text-transform:uppercase}
.badge.teal{background:var(--accent-soft);color:var(--accent)}
.badge.green{background:var(--success-soft);color:var(--success)}
.badge.warm{background:var(--warm-soft);color:var(--warm)}
.badge.purple{background:var(--purple-soft);color:var(--purple)}
.badge.danger{background:var(--danger-soft);color:var(--danger)}
.badge.muted{background:rgba(255,255,255,.05);color:var(--text-muted)}
.badge.yellow{background:var(--warning-soft);color:var(--warning)}

/* ===== BUTTONS ===== */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;transition:all var(--transition);border:1px solid transparent;font-family:var(--font);letter-spacing:.02em}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn-ghost{background:transparent;color:var(--text-secondary);border-color:var(--border)}
.btn-ghost:hover{background:var(--bg-hover);color:var(--text);border-color:var(--border-hover)}
.btn-danger{background:var(--danger-soft);color:var(--danger);border-color:rgba(239,83,80,.2)}
.btn-danger:hover{background:rgba(239,83,80,.15)}
.btn-success{background:var(--success-soft);color:var(--success);border-color:rgba(61,214,140,.2)}
.btn-success:hover{background:rgba(61,214,140,.15)}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-icon{width:32px;height:32px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);cursor:pointer;transition:all var(--transition)}
.btn-icon:hover{background:var(--bg-hover);color:var(--text);border-color:var(--border-hover)}
.btn-icon svg{width:16px;height:16px}

/* ===== FORM ELEMENTS ===== */
.input{width:100%;padding:9px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px;font-family:var(--font);transition:border var(--transition)}
.input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.input::placeholder{color:var(--text-muted)}
select.input{cursor:pointer;appearance:auto}
.form-row{display:flex;gap:12px;align-items:end;margin-bottom:16px}
.form-group{flex:1}
.form-group label{display:block;font-size:11px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}

/* ===== TABS ===== */
.tabs{display:flex;gap:4px;padding:0 20px;background:var(--bg-raised);border-bottom:1px solid var(--border)}
.tab-btn{padding:12px 16px;background:none;border:none;border-bottom:2px solid transparent;color:var(--text-secondary);font-size:12px;font-weight:500;cursor:pointer;transition:all var(--transition);font-family:var(--font);letter-spacing:.02em}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.tab-content{display:none}
.tab-content.active{display:block}

/* ===== CUSTOMER DETAIL PANEL ===== */
.detail-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;margin-bottom:20px;animation:slideIn .25s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.detail-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.detail-email{font-size:18px;font-weight:600;color:var(--accent)}
.detail-name{font-size:13px;color:var(--text-secondary)}
.detail-id{font-size:11px;color:var(--text-muted);font-family:'DM Mono',monospace}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
@media(max-width:700px){.detail-grid{grid-template-columns:1fr}}
.detail-section{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.detail-section h4{font-size:11px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:12px;display:flex;align-items:center;gap:6px}
.detail-section h4 .sec-dot{width:5px;height:5px;border-radius:50%}
.product-tags{display:flex;flex-wrap:wrap;gap:6px}
.product-tag{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
.product-tag.fusion{background:var(--purple-soft);color:var(--purple)}
.product-tag.academy{background:var(--accent-soft);color:var(--accent)}
.product-tag.bundle{background:var(--warm-soft);color:var(--warm)}
.referral-stat-row{display:flex;gap:12px;margin-bottom:10px}
.ref-stat{flex:1;text-align:center;padding:10px;background:var(--bg-card);border-radius:var(--radius-sm)}
.ref-stat-val{font-size:20px;font-weight:300;font-family:var(--font-display)}
.ref-stat-label{font-size:9px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);margin-top:2px}
.ref-code{font-family:'DM Mono',monospace;font-size:16px;letter-spacing:.1em;color:var(--warm);background:var(--warm-soft);padding:6px 14px;border-radius:var(--radius-sm);display:inline-block}
.credit-actions{display:flex;gap:8px;align-items:center;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);flex-wrap:wrap}
.credit-actions input{width:90px}

/* ===== EMPTY STATES ===== */
.empty{text-align:center;padding:40px 20px;color:var(--text-muted)}
.empty svg{width:40px;height:40px;margin-bottom:12px;opacity:.3}
.empty p{font-size:13px}

/* ===== LOADING ===== */
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-center{display:flex;flex-direction:column;align-items:center;gap:12px;padding:40px;color:var(--text-secondary);font-size:13px}

/* ===== GRID LAYOUTS ===== */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
@media(max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}

/* ===== MESSAGES ===== */
.msg{padding:10px 14px;border-radius:var(--radius-sm);font-size:13px;margin-bottom:14px;display:none}
.msg.success{display:block;background:var(--success-soft);color:var(--success);border:1px solid rgba(61,214,140,.2)}
.msg.error{display:block;background:var(--danger-soft);color:var(--danger);border:1px solid rgba(239,83,80,.2)}
.msg.info{display:block;background:var(--accent-soft);color:var(--accent);border:1px solid rgba(91,168,178,.2)}

/* ===== FILTER PILLS ===== */
.filter-row{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.pill{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text-secondary);transition:all var(--transition);font-family:var(--font)}
.pill:hover{border-color:var(--border-hover);color:var(--text)}
.pill.active{background:var(--accent-soft);border-color:rgba(91,168,178,.3);color:var(--accent);font-weight:600}

/* ===== DROPDOWN AUTOCOMPLETE ===== */
.ac-wrap{position:relative}
.ac-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border:1px solid var(--accent);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);max-height:260px;overflow-y:auto;z-index:100;display:none;box-shadow:var(--shadow-lg)}
.ac-dropdown.open{display:block}
.ac-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s}
.ac-item:hover,.ac-item.sel{background:var(--accent-soft)}
.ac-item:last-child{border-bottom:none}
.ac-item .ac-email{color:var(--accent);font-weight:500;font-size:13px}
.ac-item .ac-code{color:var(--warm);font-size:11px;font-family:'DM Mono',monospace;margin-left:8px}
.ac-item .ac-name{color:var(--text-muted);font-size:11px;display:block;margin-top:1px}
.ac-hl{background:rgba(91,168,178,.25);color:#fff;border-radius:2px}

/* ===== PAGINATION ===== */
.pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 0;font-size:12px;color:var(--text-muted)}
.pagination .page-btns{display:flex;gap:6px}

/* ===== ACTIVITY FEED ===== */
.feed-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.feed-item:last-child{border-bottom:none}
.feed-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}
.feed-content{flex:1;min-width:0}
.feed-text{font-size:13px;color:var(--text-secondary)}
.feed-text strong{color:var(--text);font-weight:500}
.feed-time{font-size:11px;color:var(--text-muted);margin-top:2px}

/* ===== BROWSER TABLE ===== */
.browser-stats{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.bs{flex:1;min-width:90px;text-align:center;padding:12px 8px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm)}
.bs-val{font-size:22px;font-weight:300;font-family:var(--font-display)}
.bs-label{font-size:9px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);margin-top:2px}

/* ===== MOBILE SIDEBAR ===== */
.mobile-menu-btn{display:none;position:fixed;top:14px;left:14px;z-index:60;width:40px;height:40px;border-radius:var(--radius-sm);background:var(--bg-raised);border:1px solid var(--border);color:var(--text);cursor:pointer;align-items:center;justify-content:center}
.mobile-menu-btn svg{width:20px;height:20px}
.sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:45}
@media(max-width:900px){
  .sidebar{transform:translateX(-100%);transition:transform .3s ease}
  .sidebar.open{transform:translateX(0)}
  .sb-overlay.open{display:block}
  .main-content{margin-left:0}
  .mobile-menu-btn{display:flex}
  .topbar{padding-left:60px}
  .stats-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:500px){
  .stats-grid{grid-template-columns:1fr}
  .page{padding:16px}
  .topbar{padding:12px 16px 12px 56px}
  .topbar-search{display:none}
}
</style>
</head>
<body>

<!-- ============ AUTH SCREEN ============ -->
<div class="auth-screen" id="auth-screen">
  <div class="auth-box">
    <img src="/assets/images/QP-Logo.png" alt="QP" class="auth-logo" onerror="this.style.display='none'">
    <div class="auth-subtitle">Practice Management</div>
    <div class="auth-card">
      <h2>Admin Access</h2>
      <p>Enter your credentials to continue</p>
      <div class="auth-field">
        <label>Username</label>
        <input type="text" id="auth-user" placeholder="Username" autocomplete="username">
      </div>
      <div class="auth-field">
        <label>Password</label>
        <input type="password" id="auth-pass" placeholder="Password" autocomplete="current-password" onkeypress="if(event.key==='Enter')doAuth()">
      </div>
      <div class="auth-error" id="auth-error">Invalid credentials</div>
      <button class="auth-btn" onclick="doAuth()">Sign In</button>
    </div>
  </div>
</div>

<!-- ============ ADMIN LAYOUT ============ -->
<div class="admin-layout" id="admin-layout">

  <!-- Mobile menu btn -->
  <button class="mobile-menu-btn" onclick="toggleSidebar()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div class="sb-overlay" id="sb-overlay" onclick="toggleSidebar()"></div>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sb-logo">
      <img src="/assets/images/QP-Logo.png" alt="QP" onerror="this.parentElement.innerHTML='<div class=\'sb-logo-text\'>Quantum<br>Physician<small>Admin</small></div>'">
      <div class="sb-logo-text">Quantum<br>Physician<small>Admin</small></div>
    </div>

    <nav class="sb-nav">
      <div class="sb-section">
        <div class="sb-section-label">Overview</div>
        <button class="sb-link active" onclick="go('dashboard',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          Dashboard
        </button>
        <button class="sb-link" onclick="go('customers',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Customers
        </button>
      </div>

      <div class="sb-section">
        <div class="sb-section-label">Products</div>
        <button class="sb-link" onclick="go('academy',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
          Academy
        </button>
        <button class="sb-link" onclick="go('fusion',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Fusion Sessions
        </button>
        <button class="sb-link" onclick="go('sessions',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          1-on-1 Sessions
        </button>
        <button class="sb-link" onclick="go('memberships',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          Memberships
        </button>
      </div>

      <div class="sb-section">
        <div class="sb-section-label">Engage</div>
        <button class="sb-link" onclick="go('referrals',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          Referrals & Credits
        </button>
        <button class="sb-link" onclick="go('email',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Email Campaigns
        </button>
        <button class="sb-link" onclick="go('analytics',this)">
          <svg class="sb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          Analytics
        </button>
      </div>
    </nav>

    <div class="sb-footer">
      <div class="sb-user">
        <div class="sb-avatar">TC</div>
        <div class="sb-user-info">
          <div class="sb-user-name">Dr. Tracey Clark</div>
          <div class="sb-user-role">Administrator</div>
        </div>
        <button class="sb-logout" onclick="doLogout()" title="Sign out">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <div class="topbar">
      <div class="topbar-title" id="topbar-title">Dashboard</div>
      <div class="topbar-right">
        <div class="topbar-search" id="global-search-wrap">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="global-search" placeholder="Search customers, courses..." autocomplete="off" oninput="handleGlobalSearch()" onkeydown="handleGlobalKeydown(event)">
          <div class="ac-dropdown" id="global-ac"></div>
        </div>
        <button class="topbar-btn" title="Refresh" onclick="refreshCurrentPage()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        </button>
      </div>
    </div>

    <!-- ============ DASHBOARD PAGE ============ -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <h1>Dashboard</h1>
        <p>Revenue overview across all products</p>
      </div>

      <div class="stats-grid" id="dash-stats">
        <div class="stat-card">
          <div class="stat-label"><span class="dot" style="background:var(--success)"></span> Total Revenue</div>
          <div class="stat-value green" id="ds-revenue">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><span class="dot" style="background:var(--accent)"></span> Academy Sales</div>
          <div class="stat-value teal" id="ds-academy">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><span class="dot" style="background:var(--purple)"></span> Fusion Sales</div>
          <div class="stat-value purple" id="ds-fusion">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><span class="dot" style="background:var(--warm)"></span> Total Customers</div>
          <div class="stat-value warm" id="ds-customers">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><span class="dot" style="background:var(--accent)"></span> Academy Enrollments</div>
          <div class="stat-value teal" id="ds-enrollments">—</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><span class="dot" style="background:var(--warning)"></span> Active Referrers</div>
          <div class="stat-value" style="color:var(--warning)" id="ds-referrers">—</div>
        </div>
      </div>

      <div class="grid-2">
        <!-- Recent Purchases -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              Recent Purchases
            </div>
            <button class="btn btn-ghost btn-sm" onclick="go('customers')">View All</button>
          </div>
          <div class="card-body" id="dash-purchases" style="max-height:360px;overflow-y:auto">
            <div class="loading-center"><div class="spinner"></div>Loading...</div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              Recent Activity
            </div>
          </div>
          <div class="card-body" id="dash-activity" style="max-height:360px;overflow-y:auto">
            <div class="loading-center"><div class="spinner"></div>Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ CUSTOMERS PAGE ============ -->
    <div class="page" id="page-customers">
      <div class="page-header">
        <h1>Customers</h1>
        <p>Unified customer profiles across all products</p>
      </div>

      <!-- Quick Search -->
      <div class="form-row" style="margin-bottom:20px">
        <div class="form-group ac-wrap" style="flex:2">
          <input type="text" class="input" id="cust-search" placeholder="Search by email, name, or referral code..." autocomplete="off" oninput="handleCustSearch()" onkeydown="handleCustKeydown(event)">
          <div class="ac-dropdown" id="cust-ac"></div>
        </div>
        <button class="btn btn-primary" onclick="searchCustomer()">Search</button>
      </div>
      <div class="msg" id="cust-msg"></div>
      <div id="cust-result"></div>

      <!-- Browser -->
      <div class="card" style="margin-top:20px">
        <div class="card-header">
          <div class="card-title">All Customers</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="loadCustomerBrowser()">Refresh</button>
          </div>
        </div>
        <div class="card-body" style="padding:16px">
          <div class="browser-stats" id="cust-browser-stats"></div>
          <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
            <select class="input" style="width:180px" id="cb-filter" onchange="applyCBFilter()">
              <option value="all">All Customers</option>
              <option value="academy">Academy Owners</option>
              <option value="fusion">Fusion Owners</option>
              <option value="bundle">Bundle Owners</option>
              <option value="no-purchase">No Purchases</option>
              <option value="has-credits">Has Credits</option>
              <option value="has-referrals">Has Referrals</option>
            </select>
            <select class="input" style="width:160px" id="cb-sort" onchange="applyCBFilter()">
              <option value="email-asc">Email A→Z</option>
              <option value="recent">Most Recent</option>
              <option value="credits">Highest Credits</option>
              <option value="referrals">Most Referrals</option>
            </select>
            <input type="text" class="input" style="width:200px" id="cb-search" placeholder="Filter..." oninput="applyCBFilter()">
          </div>
          <div style="overflow-x:auto">
            <table class="tbl" id="cust-table">
              <thead><tr><th>Email</th><th>Name</th><th>Products</th><th>Credits</th><th>Referrals</th><th></th></tr></thead>
              <tbody id="cb-tbody"><tr><td colspan="6" class="loading-center"><div class="spinner"></div>Loading...</td></tr></tbody>
            </table>
          </div>
          <div class="pagination" id="cb-pagination"></div>
        </div>
      </div>

      <!-- Grant Access -->
      <div class="card" style="margin-top:20px">
        <div class="card-header"><div class="card-title">Grant Access</div></div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="input" id="grant-email" placeholder="customer@example.com">
            </div>
            <div class="form-group">
              <label>Product</label>
              <select class="input" id="grant-product">
                <optgroup label="Fusion Sessions">
                  <option value="bundle-all">Complete Bundle</option>
                  <option value="session-01">S1: Intolerance & Sensitivity</option>
                  <option value="session-02">S2: Anxiety & Overwhelm</option>
                  <option value="session-03">S3: Pain & Tension</option>
                  <option value="session-04">S4: Sleep & Reset</option>
                  <option value="session-05">S5: Digestion & Integration</option>
                  <option value="session-06">S6: Immune Balance</option>
                  <option value="session-07">S7: Hormonal Harmony</option>
                  <option value="session-08">S8: Phobias & Fear</option>
                  <option value="session-09">S9: Fatigue & Vitality</option>
                  <option value="session-10">S10: Weight & Self-Perception</option>
                  <option value="session-11">S11: Relationships & Boundaries</option>
                  <option value="session-12">S12: Purpose & Alignment</option>
                </optgroup>
                <optgroup label="Academy Courses">
                  <option value="breaking-up-with-your-beliefs">Breaking Up with Your Beliefs</option>
                  <option value="power-of-the-question">The Power of The Question</option>
                  <option value="creative-mind-mapping">Creative Mind Mapping</option>
                  <option value="quantum-vision-boards">Quantum Vision Boards</option>
                  <option value="becoming-present">Becoming Present</option>
                  <option value="transformational-mastery">Transformational Mastery (All 5)</option>
                </optgroup>
              </select>
            </div>
            <button class="btn btn-success" onclick="grantAccess()">Grant</button>
          </div>
          <div class="msg" id="grant-msg"></div>
        </div>
      </div>
    </div>

    <!-- ============ ACADEMY PAGE ============ -->
    <div class="page" id="page-academy">
      <div class="page-header">
        <h1>Academy</h1>
        <p>Course management, enrollments, and student progress</p>
      </div>

      <div class="stats-grid" id="acad-stats"></div>

      <!-- Course Enrollments -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-header">
          <div class="card-title">Course Enrollments</div>
          <button class="btn btn-ghost btn-sm" onclick="loadAcademyData()">Refresh</button>
        </div>
        <div class="card-body" id="acad-courses">
          <div class="loading-center"><div class="spinner"></div>Loading...</div>
        </div>
      </div>

      <!-- Recent Academy Purchases -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Recent Academy Purchases</div>
        </div>
        <div class="card-body" style="max-height:400px;overflow-y:auto" id="acad-purchases">
          <div class="loading-center"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
    </div>

    <!-- ============ FUSION SESSIONS PAGE ============ -->
    <div class="page" id="page-fusion">
      <div class="page-header">
        <h1>Fusion Sessions</h1>
        <p>Subscription management and content delivery</p>
      </div>
      <div class="stats-grid" id="fusion-stats"></div>
      <div class="card">
        <div class="card-header"><div class="card-title">Session Purchases</div><button class="btn btn-ghost btn-sm" onclick="loadFusionData()">Refresh</button></div>
        <div class="card-body" id="fusion-content"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
      </div>
    </div>

    <!-- ============ 1-ON-1 SESSIONS PAGE ============ -->
    <div class="page" id="page-sessions">
      <div class="page-header">
        <h1>1-on-1 Sessions</h1>
        <p>Booking management and scheduling</p>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <p>Session booking system coming in Session 3.<br>Database tables <code>session_types</code> and <code>session_bookings</code> will be created.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ MEMBERSHIPS PAGE ============ -->
    <div class="page" id="page-memberships">
      <div class="page-header">
        <h1>Memberships</h1>
        <p>Tier management and access control</p>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            <p>Membership tiers coming in Session 4.<br>Tables <code>membership_tiers</code> and <code>memberships</code> will be created.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ REFERRALS & CREDITS PAGE ============ -->
    <div class="page" id="page-referrals">
      <div class="page-header">
        <h1>Referrals & Credits</h1>
        <p>Cross-platform referral tracking and credit management</p>
      </div>

      <div class="stats-grid" id="ref-stats"></div>

      <div class="grid-2" style="margin-bottom:20px">
        <!-- Top Referrers -->
        <div class="card">
          <div class="card-header"><div class="card-title">Top Referrers</div></div>
          <div class="card-body" style="max-height:360px;overflow-y:auto" id="ref-leaderboard">
            <div class="loading-center"><div class="spinner"></div>Loading...</div>
          </div>
        </div>
        <!-- Recent Credit Activity -->
        <div class="card">
          <div class="card-header"><div class="card-title">Recent Credit Activity</div></div>
          <div class="card-body" style="max-height:360px;overflow-y:auto" id="ref-activity">
            <div class="loading-center"><div class="spinner"></div>Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ EMAIL CAMPAIGNS PAGE ============ -->
    <div class="page" id="page-email">
      <div class="page-header">
        <h1>Email Campaigns</h1>
        <p>Targeted email campaigns and automation</p>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            <p>Email campaigns will be migrated from the existing Fusion admin in Session 5.<br>Existing email infrastructure stays live until then.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ ANALYTICS PAGE ============ -->
    <div class="page" id="page-analytics">
      <div class="page-header">
        <h1>Analytics</h1>
        <p>Revenue by product line, engagement metrics</p>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
            <p>Full analytics dashboard coming in Session 5.<br>Charts and metrics will be migrated here.</p>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /main-content -->
</div><!-- /admin-layout -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================================
// CONFIG
// ============================================================
const ADMIN_USERNAME = 'QPadmin';
const ADMIN_PASSWORD = 'QPfs#2026';
const SUPABASE_URL = 'https://rihlrfiqokqrlmzjjyxj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpaGxyZmlxb2txcmxtempqeXhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MTU2NDYsImV4cCI6MjA4NDA5MTY0Nn0.G2TQKSmQpPYb8Cyzo7R833G7xkr0855faLRjrJ9ov-4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Product name maps
const FUSION_NAMES = {
  'bundle-all': 'Complete Bundle',
  'session-01': 'S1: Intolerance & Sensitivity',
  'session-02': 'S2: Anxiety & Overwhelm',
  'session-03': 'S3: Pain & Tension',
  'session-04': 'S4: Sleep & Reset',
  'session-05': 'S5: Digestion & Integration',
  'session-06': 'S6: Immune Balance',
  'session-07': 'S7: Hormonal Harmony',
  'session-08': 'S8: Phobias & Fear',
  'session-09': 'S9: Fatigue & Vitality',
  'session-10': 'S10: Weight & Self-Perception',
  'session-11': 'S11: Relationships & Boundaries',
  'session-12': 'S12: Purpose & Alignment'
};
const ACADEMY_NAMES = {
  'quantum-vision-boards': 'Quantum Vision Boards',
  'becoming-present': 'Becoming Present',
  'breaking-up-with-your-beliefs': 'Breaking Up with Your Beliefs',
  'creative-mind-mapping': 'Creative Mind Mapping',
  'power-of-the-question': 'The Power of The Question',
  'transformational-mastery': 'Transformational Mastery'
};
const ACADEMY_SLUGS = ['breaking-up-with-your-beliefs','power-of-the-question','creative-mind-mapping','quantum-vision-boards','becoming-present'];

function isFusion(pid) { return pid && (pid.startsWith('session-') || pid === 'bundle-all'); }
function isAcademy(pid) { return pid && ACADEMY_NAMES[pid]; }
function productName(pid) { return FUSION_NAMES[pid] || ACADEMY_NAMES[pid] || pid; }
function productBadge(pid) {
  if (pid === 'bundle-all') return '<span class="badge warm">Bundle</span>';
  if (pid === 'transformational-mastery') return '<span class="badge warm">Academy Bundle</span>';
  if (isFusion(pid)) return '<span class="badge purple">Fusion</span>';
  if (isAcademy(pid)) return '<span class="badge teal">Academy</span>';
  return '<span class="badge muted">Unknown</span>';
}

function fmt$(cents) { if (!cents) return '$0'; return '$' + (cents / 100 || cents).toFixed(2).replace(/\.00$/, ''); }
function fmtMoney(val) { return '$' + Number(val || 0).toFixed(2).replace(/\.00$/, ''); }
function timeAgo(d) {
  if (!d) return '—';
  const s = Math.floor((Date.now() - new Date(d)) / 1000);
  if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago'; if (s < 604800) return Math.floor(s/86400) + 'd ago';
  return new Date(d).toLocaleDateString();
}
function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

// ============================================================
// AUTH
// ============================================================
function doAuth() {
  const u = document.getElementById('auth-user').value;
  const p = document.getElementById('auth-pass').value;
  if (u === ADMIN_USERNAME && p === ADMIN_PASSWORD) {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('admin-layout').style.display = 'block';
    sessionStorage.setItem('qp_admin_auth', 'true');
    initAdmin();
  } else {
    document.getElementById('auth-error').style.display = 'block';
  }
}
function doLogout() {
  sessionStorage.removeItem('qp_admin_auth');
  location.reload();
}
// Auto-login
if (sessionStorage.getItem('qp_admin_auth') === 'true') {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('admin-layout').style.display = 'block';
  setTimeout(initAdmin, 50);
}

// ============================================================
// NAVIGATION
// ============================================================
let currentPage = 'dashboard';
const PAGE_TITLES = {
  dashboard: 'Dashboard', customers: 'Customers', academy: 'Academy',
  fusion: 'Fusion Sessions', sessions: '1-on-1 Sessions', memberships: 'Memberships',
  referrals: 'Referrals & Credits', email: 'Email Campaigns', analytics: 'Analytics'
};

function go(page, btn) {
  currentPage = page;
  // Update sidebar
  document.querySelectorAll('.sb-link').forEach(l => l.classList.remove('active'));
  if (btn) btn.classList.add('active');
  else {
    document.querySelectorAll('.sb-link').forEach(l => {
      if (l.textContent.trim().toLowerCase().includes(page) || l.onclick?.toString().includes("'" + page + "'")) l.classList.add('active');
    });
  }
  // Update pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if (el) el.classList.add('active');
  document.getElementById('topbar-title').textContent = PAGE_TITLES[page] || page;
  // Load data for that page
  loadPageData(page);
  // Close mobile sidebar
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sb-overlay').classList.remove('open');
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sb-overlay').classList.toggle('open');
}

function refreshCurrentPage() { loadPageData(currentPage); }

// ============================================================
// DATA CACHE
// ============================================================
let allCustomers = [];
let purchasesData = [];
let referralData = [];
let profilesData = [];
let creditHistory = [];
let academyEnrollments = [];
let academyCourses = [];
let dataLoaded = false;

async function loadAllData() {
  try {
    const [purchases, referrals, profiles, credits, enrollments, courses] = await Promise.all([
      sb.from('purchases').select('*').order('purchased_at', {ascending:false}),
      sb.from('referral_codes').select('*'),
      sb.from('profiles').select('*'),
      sb.from('credit_history').select('*').order('created_at', {ascending:false}).limit(200),
      sb.from('qa_enrollments').select('*, qa_courses(id,title,slug)'),
      sb.from('qa_courses').select('*').order('sort_order')
    ]);
    purchasesData = purchases.data || [];
    referralData = referrals.data || [];
    profilesData = profiles.data || [];
    creditHistory = credits.data || [];
    academyEnrollments = enrollments.data || [];
    academyCourses = courses.data || [];

    // Build unified customer list
    buildCustomerList();
    dataLoaded = true;
  } catch (e) {
    console.error('Data load error:', e);
  }
}

function buildCustomerList() {
  const map = new Map();
  profilesData.forEach(p => {
    if (!p.email) return;
    const k = p.email.toLowerCase();
    map.set(k, {
      email: p.email, name: p.full_name || '', userId: p.id,
      hasAccount: true, createdAt: p.created_at,
      purchases: [], academyPurchases: [], fusionPurchases: [],
      hasBundle: false, hasAcademyBundle: false,
      creditBalance: 0, referralCount: 0, referralCode: '', totalEarned: 0
    });
  });
  purchasesData.forEach(p => {
    if (!p.email) return;
    const k = p.email.toLowerCase();
    if (!map.has(k)) {
      map.set(k, {
        email: p.email, name: '', userId: null, hasAccount: false,
        createdAt: p.purchased_at, purchases: [], academyPurchases: [], fusionPurchases: [],
        hasBundle: false, hasAcademyBundle: false,
        creditBalance: 0, referralCount: 0, referralCode: '', totalEarned: 0
      });
    }
    const c = map.get(k);
    if (!c.purchases.includes(p.product_id)) {
      c.purchases.push(p.product_id);
      if (isFusion(p.product_id)) c.fusionPurchases.push(p.product_id);
      if (isAcademy(p.product_id)) c.academyPurchases.push(p.product_id);
    }
    if (p.product_id === 'bundle-all') c.hasBundle = true;
    if (p.product_id === 'transformational-mastery') c.hasAcademyBundle = true;
  });
  referralData.forEach(r => {
    if (!r.email) return;
    const k = r.email.toLowerCase();
    if (!map.has(k)) {
      map.set(k, {
        email: r.email, name: '', userId: null, hasAccount: false,
        createdAt: null, purchases: [], academyPurchases: [], fusionPurchases: [],
        hasBundle: false, hasAcademyBundle: false,
        creditBalance: 0, referralCount: 0, referralCode: '', totalEarned: 0
      });
    }
    const c = map.get(k);
    c.creditBalance = Number(r.credit_balance) || 0;
    c.referralCount = r.successful_referrals || 0;
    c.referralCode = r.code || '';
    c.totalEarned = Number(r.total_earned) || 0;
  });
  allCustomers = Array.from(map.values());
}

// ============================================================
// INIT & PAGE DATA
// ============================================================
async function initAdmin() {
  await loadAllData();
  loadPageData('dashboard');
}

function loadPageData(page) {
  if (!dataLoaded && page !== 'dashboard') return;
  switch(page) {
    case 'dashboard': loadDashboard(); break;
    case 'customers': loadCustomerBrowser(); break;
    case 'academy': loadAcademyData(); break;
    case 'fusion': loadFusionData(); break;
    case 'referrals': loadReferralData(); break;
  }
}

// ============================================================
// DASHBOARD
// ============================================================
function loadDashboard() {
  if (!dataLoaded) return;
  
  // Stats
  const totalRevenue = purchasesData.reduce((s, p) => s + (Number(p.amount_paid) || 0), 0);
  const academyRevenue = purchasesData.filter(p => isAcademy(p.product_id)).reduce((s, p) => s + (Number(p.amount_paid) || 0), 0);
  const fusionRevenue = purchasesData.filter(p => isFusion(p.product_id)).reduce((s, p) => s + (Number(p.amount_paid) || 0), 0);
  const activeReferrers = referralData.filter(r => r.successful_referrals > 0).length;

  document.getElementById('ds-revenue').textContent = fmtMoney(totalRevenue);
  document.getElementById('ds-academy').textContent = fmtMoney(academyRevenue);
  document.getElementById('ds-fusion').textContent = fmtMoney(fusionRevenue);
  document.getElementById('ds-customers').textContent = allCustomers.length;
  document.getElementById('ds-enrollments').textContent = academyEnrollments.filter(e => e.status === 'active').length;
  document.getElementById('ds-referrers').textContent = activeReferrers;

  // Recent purchases
  const recent = purchasesData.slice(0, 10);
  const el = document.getElementById('dash-purchases');
  if (recent.length === 0) {
    el.innerHTML = '<div class="empty"><p>No purchases yet</p></div>';
  } else {
    el.innerHTML = recent.map(p => `
      <div class="feed-item">
        <div class="feed-dot" style="background:${isFusion(p.product_id)?'var(--purple)':'var(--accent)'}"></div>
        <div class="feed-content">
          <div class="feed-text"><strong>${esc(p.email)}</strong> purchased ${productName(p.product_id)}</div>
          <div class="feed-time">${fmtMoney(p.amount_paid)} · ${timeAgo(p.purchased_at)}</div>
        </div>
        ${productBadge(p.product_id)}
      </div>
    `).join('');
  }

  // Recent credit activity
  const recentCredits = creditHistory.slice(0, 10);
  const actEl = document.getElementById('dash-activity');
  if (recentCredits.length === 0) {
    actEl.innerHTML = '<div class="empty"><p>No recent activity</p></div>';
  } else {
    actEl.innerHTML = recentCredits.map(c => {
      const isPositive = c.amount > 0;
      return `
        <div class="feed-item">
          <div class="feed-dot" style="background:${isPositive?'var(--success)':'var(--warning)'}"></div>
          <div class="feed-content">
            <div class="feed-text"><strong>${esc(c.email)}</strong> ${isPositive ? '+' : ''}${fmtMoney(c.amount)}</div>
            <div class="feed-time">${esc(c.description || c.type)} · ${timeAgo(c.created_at)}</div>
          </div>
        </div>
      `;
    }).join('');
  }
}

// ============================================================
// CUSTOMER BROWSER
// ============================================================
let cbFiltered = [];
let cbPage = 1;
const cbPageSize = 20;

function loadCustomerBrowser() {
  cbPage = 1;
  applyCBFilter();
  updateBrowserStats();
}

function updateBrowserStats() {
  const statsEl = document.getElementById('cust-browser-stats');
  const total = allCustomers.length;
  const academy = allCustomers.filter(c => c.academyPurchases.length > 0).length;
  const fusion = allCustomers.filter(c => c.fusionPurchases.length > 0).length;
  const withCredits = allCustomers.filter(c => c.creditBalance > 0).length;
  const noPurchase = allCustomers.filter(c => c.purchases.length === 0).length;
  statsEl.innerHTML = `
    <div class="bs"><div class="bs-val" style="color:var(--text)">${total}</div><div class="bs-label">Total</div></div>
    <div class="bs"><div class="bs-val" style="color:var(--accent)">${academy}</div><div class="bs-label">Academy</div></div>
    <div class="bs"><div class="bs-val" style="color:var(--purple)">${fusion}</div><div class="bs-label">Fusion</div></div>
    <div class="bs"><div class="bs-val" style="color:var(--success)">${withCredits}</div><div class="bs-label">Credits</div></div>
    <div class="bs"><div class="bs-val" style="color:var(--text-muted)">${noPurchase}</div><div class="bs-label">No Purchase</div></div>
  `;
}

function applyCBFilter() {
  const filter = document.getElementById('cb-filter').value;
  const sort = document.getElementById('cb-sort').value;
  const search = (document.getElementById('cb-search').value || '').toLowerCase().trim();

  cbFiltered = allCustomers.filter(c => {
    if (search && !c.email.toLowerCase().includes(search) && !c.name.toLowerCase().includes(search) && !c.referralCode.toLowerCase().includes(search)) return false;
    switch(filter) {
      case 'academy': return c.academyPurchases.length > 0;
      case 'fusion': return c.fusionPurchases.length > 0;
      case 'bundle': return c.hasBundle || c.hasAcademyBundle;
      case 'no-purchase': return c.purchases.length === 0;
      case 'has-credits': return c.creditBalance > 0;
      case 'has-referrals': return c.referralCount > 0;
      default: return true;
    }
  });

  cbFiltered.sort((a, b) => {
    switch(sort) {
      case 'email-asc': return a.email.localeCompare(b.email);
      case 'recent': return (b.createdAt || '').localeCompare(a.createdAt || '');
      case 'credits': return b.creditBalance - a.creditBalance;
      case 'referrals': return b.referralCount - a.referralCount;
      default: return 0;
    }
  });

  cbPage = 1;
  renderCBTable();
}

function renderCBTable() {
  const tbody = document.getElementById('cb-tbody');
  const totalPages = Math.ceil(cbFiltered.length / cbPageSize) || 1;
  const start = (cbPage - 1) * cbPageSize;
  const pageData = cbFiltered.slice(start, start + cbPageSize);

  if (pageData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text-muted)">No customers match filters</td></tr>';
  } else {
    tbody.innerHTML = pageData.map(c => {
      const tags = [];
      if (c.hasBundle) tags.push('<span class="badge warm">Bundle</span>');
      if (c.hasAcademyBundle) tags.push('<span class="badge teal">Academy All</span>');
      if (!c.hasBundle && c.fusionPurchases.length > 0) tags.push('<span class="badge purple">' + c.fusionPurchases.length + ' Fusion</span>');
      if (!c.hasAcademyBundle && c.academyPurchases.length > 0) tags.push('<span class="badge teal">' + c.academyPurchases.length + ' Academy</span>');
      if (tags.length === 0) tags.push(c.hasAccount ? '<span class="badge muted">Registered</span>' : '<span class="badge muted">Guest</span>');

      return `<tr style="cursor:pointer" onclick="showCustomerDetail('${esc(c.email.replace(/'/g,"\\'"))}')">
        <td class="email">${esc(c.email)}${c.referralCode ? '<br><span class="mono">' + c.referralCode + '</span>' : ''}</td>
        <td class="name">${c.name ? esc(c.name) : '<span style="color:var(--text-muted)">—</span>'}</td>
        <td>${tags.join(' ')}</td>
        <td>${c.creditBalance > 0 ? '<span style="color:var(--success);font-weight:600">' + fmtMoney(c.creditBalance) + '</span>' : '<span style="color:var(--text-muted)">—</span>'}</td>
        <td>${c.referralCount > 0 ? '<span style="color:var(--accent);font-weight:600">' + c.referralCount + '</span>' : '<span style="color:var(--text-muted)">—</span>'}</td>
        <td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();showCustomerDetail('${esc(c.email.replace(/'/g,"\\'"))}')">View</button></td>
      </tr>`;
    }).join('');
  }

  document.getElementById('cb-pagination').innerHTML = `
    <span>Showing ${cbFiltered.length} customers · Page ${cbPage} of ${totalPages}</span>
    <div class="page-btns">
      <button class="btn btn-ghost btn-sm" onclick="cbPage=Math.max(1,cbPage-1);renderCBTable()" ${cbPage<=1?'disabled':''}>← Prev</button>
      <button class="btn btn-ghost btn-sm" onclick="cbPage=Math.min(${totalPages},cbPage+1);renderCBTable()" ${cbPage>=totalPages?'disabled':''}>Next →</button>
    </div>
  `;
}

// ============================================================
// CUSTOMER DETAIL
// ============================================================
function showCustomerDetail(email) {
  const c = allCustomers.find(x => x.email.toLowerCase() === email.toLowerCase());
  if (!c) return;

  // Get full purchase history for this customer
  const custPurchases = purchasesData.filter(p => p.email && p.email.toLowerCase() === email.toLowerCase());
  const custCredits = creditHistory.filter(h => h.email && h.email.toLowerCase() === email.toLowerCase());
  const custEnrollments = academyEnrollments.filter(e => e.user_id === c.userId && e.status === 'active');

  const resultEl = document.getElementById('cust-result');
  resultEl.innerHTML = `
    <div class="detail-panel">
      <button class="btn btn-ghost btn-sm" style="position:absolute;top:16px;right:16px" onclick="this.closest('.detail-panel').remove()">✕ Close</button>
      <div class="detail-header">
        <div>
          <div class="detail-email">${esc(c.email)}</div>
          <div class="detail-name">${c.name ? esc(c.name) : 'No name on file'}</div>
          ${c.userId ? '<div class="detail-id">' + c.userId + '</div>' : ''}
        </div>
        <div>${c.hasAccount ? '<span class="badge green">Active Account</span>' : '<span class="badge muted">No Account</span>'}</div>
      </div>

      <div class="detail-grid">
        <!-- Purchases -->
        <div class="detail-section">
          <h4><span class="sec-dot" style="background:var(--success)"></span> Purchases</h4>
          ${c.purchases.length > 0 ? '<div class="product-tags">' + c.purchases.map(pid => {
            const cls = isFusion(pid) ? 'fusion' : (pid.includes('bundle') || pid.includes('mastery') ? 'bundle' : 'academy');
            return '<span class="product-tag ' + cls + '">' + productName(pid) + '</span>';
          }).join('') + '</div>' : '<p style="color:var(--text-muted);font-size:13px">No purchases</p>'}
          ${custPurchases.length > 0 ? '<div style="margin-top:12px;font-size:12px;color:var(--text-secondary)">Total paid: <strong style="color:var(--success)">' + fmtMoney(custPurchases.reduce((s,p) => s + (Number(p.amount_paid)||0), 0)) + '</strong></div>' : ''}
        </div>

        <!-- Referral & Credits -->
        <div class="detail-section">
          <h4><span class="sec-dot" style="background:var(--warm)"></span> Referral & Credits</h4>
          ${c.referralCode ? '<div style="margin-bottom:10px">Code: <span class="ref-code">' + c.referralCode + '</span></div>' : '<p style="color:var(--text-muted);font-size:13px;margin-bottom:10px">No referral code</p>'}
          <div class="referral-stat-row">
            <div class="ref-stat"><div class="ref-stat-val" style="color:var(--success)">${fmtMoney(c.creditBalance)}</div><div class="ref-stat-label">Balance</div></div>
            <div class="ref-stat"><div class="ref-stat-val" style="color:var(--accent)">${c.referralCount}</div><div class="ref-stat-label">Referrals</div></div>
            <div class="ref-stat"><div class="ref-stat-val" style="color:var(--warm)">${fmtMoney(c.totalEarned)}</div><div class="ref-stat-label">Total Earned</div></div>
          </div>
          <div class="credit-actions">
            <input type="number" class="input" id="credit-amount" placeholder="$" min="0" step="1" style="width:80px">
            <button class="btn btn-success btn-sm" onclick="adjustCredit('${esc(c.email)}', 1)">+ Add</button>
            <button class="btn btn-danger btn-sm" onclick="adjustCredit('${esc(c.email)}', -1)">− Deduct</button>
          </div>
        </div>
      </div>

      ${custEnrollments.length > 0 ? `
        <div class="detail-section" style="margin-bottom:16px">
          <h4><span class="sec-dot" style="background:var(--accent)"></span> Academy Enrollments</h4>
          <div class="product-tags">
            ${custEnrollments.map(e => '<span class="product-tag academy">' + (e.qa_courses?.title || 'Course') + '</span>').join('')}
          </div>
        </div>
      ` : ''}

      ${custCredits.length > 0 ? `
        <div class="detail-section">
          <h4><span class="sec-dot" style="background:var(--warning)"></span> Credit History</h4>
          <div style="max-height:200px;overflow-y:auto">
            ${custCredits.slice(0, 10).map(h => `
              <div class="feed-item" style="padding:8px 0">
                <div class="feed-dot" style="background:${h.amount > 0 ? 'var(--success)' : 'var(--warning)'}"></div>
                <div class="feed-content">
                  <div class="feed-text">${h.amount > 0 ? '+' : ''}${fmtMoney(h.amount)} — ${esc(h.description || h.type)}</div>
                  <div class="feed-time">${timeAgo(h.created_at)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `;
  resultEl.scrollIntoView({behavior: 'smooth', block: 'start'});
}

async function adjustCredit(email, direction) {
  const amountInput = document.getElementById('credit-amount');
  const amount = Number(amountInput.value);
  if (!amount || amount <= 0) return alert('Enter a valid amount');
  
  const actualAmount = amount * direction;
  
  try {
    const { data: current } = await sb.from('referral_codes').select('credit_balance').eq('email', email.toLowerCase()).single();
    if (!current) return alert('No referral code found for this email');
    
    const newBalance = Math.max(0, Number(current.credit_balance) + actualAmount);
    await sb.from('referral_codes').update({ credit_balance: newBalance }).eq('email', email.toLowerCase());
    await sb.from('credit_history').insert({ email: email.toLowerCase(), amount: actualAmount, type: 'admin_adjustment', description: 'Admin credit adjustment', created_at: new Date().toISOString() });
    
    amountInput.value = '';
    await loadAllData();
    showCustomerDetail(email);
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// ============================================================
// CUSTOMER SEARCH (autocomplete)
// ============================================================
let custACFiltered = [];
let custACIndex = -1;

function handleCustSearch() {
  const input = document.getElementById('cust-search');
  const dropdown = document.getElementById('cust-ac');
  const q = input.value.trim().toLowerCase();
  if (q.length < 2) { dropdown.classList.remove('open'); return; }
  
  custACFiltered = allCustomers.filter(c => 
    c.email.toLowerCase().includes(q) || c.name.toLowerCase().includes(q) || (c.referralCode && c.referralCode.toLowerCase().includes(q))
  ).slice(0, 8);
  
  if (custACFiltered.length === 0) { dropdown.classList.remove('open'); return; }
  custACIndex = 0;
  renderCustAC(q);
  dropdown.classList.add('open');
}

function renderCustAC(q) {
  const dropdown = document.getElementById('cust-ac');
  dropdown.innerHTML = custACFiltered.map((c, i) => {
    const hl = (str) => str.replace(new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<span class="ac-hl">$1</span>');
    return `<div class="ac-item ${i===custACIndex?'sel':''}" onclick="selectCustAC(${i})" onmouseenter="custACIndex=${i}">
      <span class="ac-email">${hl(c.email)}</span>${c.referralCode ? '<span class="ac-code">' + hl(c.referralCode) + '</span>' : ''}
      ${c.name ? '<span class="ac-name">' + hl(c.name) + '</span>' : ''}
    </div>`;
  }).join('');
}

function handleCustKeydown(e) {
  const dd = document.getElementById('cust-ac');
  if (!dd.classList.contains('open')) { if (e.key === 'Enter') searchCustomer(); return; }
  if (e.key === 'ArrowDown') { e.preventDefault(); custACIndex = Math.min(custACIndex+1, custACFiltered.length-1); renderCustAC(document.getElementById('cust-search').value.trim().toLowerCase()); }
  if (e.key === 'ArrowUp') { e.preventDefault(); custACIndex = Math.max(custACIndex-1, 0); renderCustAC(document.getElementById('cust-search').value.trim().toLowerCase()); }
  if (e.key === 'Enter') { e.preventDefault(); selectCustAC(custACIndex); }
  if (e.key === 'Escape') dd.classList.remove('open');
}

function selectCustAC(i) {
  const c = custACFiltered[i];
  if (c) { document.getElementById('cust-search').value = c.email; document.getElementById('cust-ac').classList.remove('open'); showCustomerDetail(c.email); }
}

function searchCustomer() {
  const email = document.getElementById('cust-search').value.trim();
  if (!email) return;
  document.getElementById('cust-ac').classList.remove('open');
  showCustomerDetail(email);
}

// Close autocomplete on click outside
document.addEventListener('click', e => {
  if (!e.target.closest('#global-search-wrap')) document.getElementById('global-ac').classList.remove('open');
  if (!e.target.closest('.ac-wrap')) document.getElementById('cust-ac').classList.remove('open');
});

// ============================================================
// GLOBAL SEARCH
// ============================================================
let gACFiltered = [];
let gACIndex = -1;

function handleGlobalSearch() {
  const q = document.getElementById('global-search').value.trim().toLowerCase();
  const dd = document.getElementById('global-ac');
  if (q.length < 2) { dd.classList.remove('open'); return; }
  gACFiltered = allCustomers.filter(c => c.email.toLowerCase().includes(q) || c.name.toLowerCase().includes(q)).slice(0, 6);
  if (!gACFiltered.length) { dd.classList.remove('open'); return; }
  gACIndex = 0;
  dd.innerHTML = gACFiltered.map((c, i) => `<div class="ac-item ${i===0?'sel':''}" onclick="go('customers');setTimeout(()=>showCustomerDetail('${esc(c.email)}'),100)">
    <span class="ac-email">${esc(c.email)}</span>${c.name ? '<span class="ac-name">' + esc(c.name) + '</span>' : ''}
  </div>`).join('');
  dd.classList.add('open');
}

function handleGlobalKeydown(e) {
  const dd = document.getElementById('global-ac');
  if (!dd.classList.contains('open')) return;
  if (e.key === 'Enter' && gACFiltered[gACIndex]) { go('customers'); setTimeout(() => showCustomerDetail(gACFiltered[gACIndex].email), 100); dd.classList.remove('open'); }
  if (e.key === 'Escape') dd.classList.remove('open');
}

// ============================================================
// GRANT ACCESS
// ============================================================
async function grantAccess() {
  const email = document.getElementById('grant-email').value.trim();
  const productId = document.getElementById('grant-product').value;
  const msgEl = document.getElementById('grant-msg');
  if (!email) { showMsg(msgEl, 'error', 'Enter an email'); return; }

  try {
    const eventId = 'admin-grant-' + Date.now();
    await sb.from('purchases').upsert({
      email: email.toLowerCase(),
      product_id: productId,
      stripe_event_id: eventId,
      amount_paid: 0,
      purchased_at: new Date().toISOString()
    }, { onConflict: 'stripe_event_id' });

    // If academy product, also create enrollment
    if (isAcademy(productId)) {
      const slugs = productId === 'transformational-mastery' ? ACADEMY_SLUGS : [productId];
      const { data: profiles } = await sb.from('qa_profiles').select('id').eq('email', email.toLowerCase());
      if (profiles && profiles.length > 0) {
        const userId = profiles[0].id;
        const { data: courses } = await sb.from('qa_courses').select('id, slug').in('slug', slugs);
        if (courses) {
          for (const course of courses) {
            await sb.from('qa_enrollments').upsert({
              user_id: userId, course_id: course.id, status: 'active', enrolled_at: new Date().toISOString()
            }, { onConflict: 'user_id,course_id' });
          }
        }
      }
    }

    showMsg(msgEl, 'success', 'Access granted: ' + productName(productId) + ' → ' + email);
    document.getElementById('grant-email').value = '';
    await loadAllData();
  } catch (e) {
    showMsg(msgEl, 'error', 'Error: ' + e.message);
  }
}

function showMsg(el, type, text) {
  el.className = 'msg ' + type;
  el.textContent = text;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 5000);
}

// ============================================================
// ACADEMY
// ============================================================
function loadAcademyData() {
  if (!dataLoaded) return;
  
  const activeEnrollments = academyEnrollments.filter(e => e.status === 'active');
  const uniqueStudents = new Set(activeEnrollments.map(e => e.user_id)).size;
  const academyPurchases = purchasesData.filter(p => isAcademy(p.product_id));
  const academyRevenue = academyPurchases.reduce((s, p) => s + (Number(p.amount_paid) || 0), 0);
  const bundleCount = purchasesData.filter(p => p.product_id === 'transformational-mastery').length;

  // Stats
  document.getElementById('acad-stats').innerHTML = `
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--accent)"></span> Active Enrollments</div><div class="stat-value teal">${activeEnrollments.length}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--warm)"></span> Unique Students</div><div class="stat-value warm">${uniqueStudents}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--success)"></span> Revenue</div><div class="stat-value green">${fmtMoney(academyRevenue)}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--purple)"></span> Bundle Sales</div><div class="stat-value purple">${bundleCount}</div></div>
  `;

  // Course enrollment breakdown
  const courseEnrollCounts = {};
  activeEnrollments.forEach(e => {
    const title = e.qa_courses?.title || 'Unknown';
    courseEnrollCounts[title] = (courseEnrollCounts[title] || 0) + 1;
  });

  const coursesEl = document.getElementById('acad-courses');
  if (academyCourses.length === 0) {
    coursesEl.innerHTML = '<div class="empty"><p>No courses found</p></div>';
  } else {
    coursesEl.innerHTML = `<table class="tbl"><thead><tr><th>Course</th><th>Slug</th><th>Price</th><th>Enrollments</th><th>Status</th></tr></thead><tbody>` +
      academyCourses.map(c => `<tr>
        <td class="name">${esc(c.title)}</td>
        <td class="mono">${c.slug}</td>
        <td>${c.price_cents ? fmt$(c.price_cents) : '<span style="color:var(--success)">Free</span>'}</td>
        <td><strong style="color:var(--accent)">${courseEnrollCounts[c.title] || 0}</strong></td>
        <td>${c.status === 'published' ? '<span class="badge green">Published</span>' : '<span class="badge muted">' + (c.status || 'draft') + '</span>'}</td>
      </tr>`).join('') +
      '</tbody></table>';
  }

  // Recent academy purchases
  const recentAcad = purchasesData.filter(p => isAcademy(p.product_id)).slice(0, 10);
  const pEl = document.getElementById('acad-purchases');
  if (recentAcad.length === 0) {
    pEl.innerHTML = '<div class="empty"><p>No academy purchases yet</p></div>';
  } else {
    pEl.innerHTML = recentAcad.map(p => `
      <div class="feed-item">
        <div class="feed-dot" style="background:var(--accent)"></div>
        <div class="feed-content">
          <div class="feed-text"><strong>${esc(p.email)}</strong> → ${productName(p.product_id)}</div>
          <div class="feed-time">${fmtMoney(p.amount_paid)} · ${timeAgo(p.purchased_at)}</div>
        </div>
      </div>
    `).join('');
  }
}

// ============================================================
// FUSION SESSIONS
// ============================================================
function loadFusionData() {
  if (!dataLoaded) return;
  
  const fusionPurchases = purchasesData.filter(p => isFusion(p.product_id));
  const fusionRevenue = fusionPurchases.reduce((s, p) => s + (Number(p.amount_paid) || 0), 0);
  const bundleCount = fusionPurchases.filter(p => p.product_id === 'bundle-all').length;
  const uniqueBuyers = new Set(fusionPurchases.map(p => p.email?.toLowerCase())).size;

  // Session popularity
  const sessionCounts = {};
  fusionPurchases.forEach(p => {
    if (p.product_id !== 'bundle-all') {
      sessionCounts[p.product_id] = (sessionCounts[p.product_id] || 0) + 1;
    }
  });

  document.getElementById('fusion-stats').innerHTML = `
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--success)"></span> Fusion Revenue</div><div class="stat-value green">${fmtMoney(fusionRevenue)}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--purple)"></span> Bundle Sales</div><div class="stat-value purple">${bundleCount}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--warm)"></span> Total Buyers</div><div class="stat-value warm">${uniqueBuyers}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--accent)"></span> Individual Sales</div><div class="stat-value teal">${fusionPurchases.filter(p => p.product_id !== 'bundle-all').length}</div></div>
  `;

  const contentEl = document.getElementById('fusion-content');
  const sessionList = Object.entries(FUSION_NAMES).filter(([k]) => k !== 'bundle-all').map(([pid, name]) => ({
    pid, name, count: sessionCounts[pid] || 0
  })).sort((a, b) => b.count - a.count);

  contentEl.innerHTML = `
    <table class="tbl"><thead><tr><th>Session</th><th>Individual Sales</th></tr></thead><tbody>
    ${sessionList.map(s => `<tr><td class="name">${s.name}</td><td><strong style="color:var(--purple)">${s.count}</strong></td></tr>`).join('')}
    </tbody></table>
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
      <div class="card-title" style="margin-bottom:12px">Recent Fusion Purchases</div>
      ${fusionPurchases.slice(0, 8).map(p => `
        <div class="feed-item">
          <div class="feed-dot" style="background:var(--purple)"></div>
          <div class="feed-content">
            <div class="feed-text"><strong>${esc(p.email)}</strong> → ${productName(p.product_id)}</div>
            <div class="feed-time">${fmtMoney(p.amount_paid)} · ${timeAgo(p.purchased_at)}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// ============================================================
// REFERRALS & CREDITS
// ============================================================
function loadReferralData() {
  if (!dataLoaded) return;
  
  const totalCreditsOutstanding = referralData.reduce((s, r) => s + (Number(r.credit_balance) || 0), 0);
  const totalEarned = referralData.reduce((s, r) => s + (Number(r.total_earned) || 0), 0);
  const totalReferrals = referralData.reduce((s, r) => s + (r.successful_referrals || 0), 0);
  const activeReferrers = referralData.filter(r => r.successful_referrals > 0).length;
  const codeHolders = referralData.length;

  document.getElementById('ref-stats').innerHTML = `
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--success)"></span> Credits Outstanding</div><div class="stat-value green">${fmtMoney(totalCreditsOutstanding)}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--warm)"></span> Total Earned</div><div class="stat-value warm">${fmtMoney(totalEarned)}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--accent)"></span> Total Referrals</div><div class="stat-value teal">${totalReferrals}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--purple)"></span> Active Referrers</div><div class="stat-value purple">${activeReferrers}</div></div>
    <div class="stat-card"><div class="stat-label"><span class="dot" style="background:var(--warning)"></span> Code Holders</div><div class="stat-value" style="color:var(--warning)">${codeHolders}</div></div>
  `;

  // Top referrers
  const topReferrers = [...referralData].filter(r => r.successful_referrals > 0).sort((a, b) => b.successful_referrals - a.successful_referrals).slice(0, 10);
  const lbEl = document.getElementById('ref-leaderboard');
  if (topReferrers.length === 0) {
    lbEl.innerHTML = '<div class="empty"><p>No referrals yet</p></div>';
  } else {
    lbEl.innerHTML = `<table class="tbl"><thead><tr><th>Email</th><th>Code</th><th>Referrals</th><th>Balance</th><th>Earned</th></tr></thead><tbody>` +
      topReferrers.map(r => `<tr>
        <td class="email">${esc(r.email)}</td>
        <td class="mono">${r.code}</td>
        <td><strong style="color:var(--accent)">${r.successful_referrals}</strong></td>
        <td>${Number(r.credit_balance) > 0 ? '<span style="color:var(--success)">' + fmtMoney(r.credit_balance) + '</span>' : '—'}</td>
        <td style="color:var(--warm)">${fmtMoney(r.total_earned)}</td>
      </tr>`).join('') +
      '</tbody></table>';
  }

  // Recent credits
  const recentCreds = creditHistory.slice(0, 15);
  const actEl = document.getElementById('ref-activity');
  if (recentCreds.length === 0) {
    actEl.innerHTML = '<div class="empty"><p>No credit activity</p></div>';
  } else {
    actEl.innerHTML = recentCreds.map(c => `
      <div class="feed-item">
        <div class="feed-dot" style="background:${c.amount > 0 ? 'var(--success)' : 'var(--warning)'}"></div>
        <div class="feed-content">
          <div class="feed-text"><strong>${esc(c.email)}</strong> ${c.amount > 0 ? '+' : ''}${fmtMoney(c.amount)}</div>
          <div class="feed-time">${esc(c.description || c.type)} · ${timeAgo(c.created_at)}</div>
        </div>
      </div>
    `).join('');
  }
}
</script>
</body>
</html>
