<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quantum Physician — Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="admin.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="auth-screen" id="auth-screen"><div class="auth-box"><img src="/assets/images/QP-Logo.png" alt="QP" class="auth-logo" onerror="this.style.display='none'"><div class="auth-subtitle">Practice Management</div><div class="auth-card"><h2>Admin Access</h2><p>Sign in with your admin account</p><div class="auth-field"><label>Email</label><input type="email" id="auth-email" placeholder="admin@example.com" autocomplete="email"></div><div class="auth-field"><label>Password</label><input type="password" id="auth-pass" placeholder="Password" autocomplete="current-password" onkeypress="if(event.key==='Enter')doAuth()"></div><div class="auth-error" id="auth-error"></div><div class="auth-status" id="auth-status" style="display:none;text-align:center;padding:8px 0"><div class="spinner" style="width:20px;height:20px;margin:0 auto 6px"></div><span style="font-size:12px;color:var(--text-muted)">Verifying...</span></div><button class="auth-btn" id="auth-btn" onclick="doAuth()">Sign In</button></div></div></div>
<div class="admin-layout" id="admin-layout">
<button class="mobile-menu-btn" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
<div class="sb-overlay" id="sb-overlay" onclick="toggleSidebar()"></div>
<aside class="sidebar" id="sidebar">
<div class="sb-logo"><img src="/assets/images/QP-Logo.png" alt="Quantum Physician" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><div class="sb-logo-fallback">Quantum Physician<small>Admin Panel</small></div></div>
<nav class="sb-nav">
<div class="sb-section"><div class="sb-section-label">Overview</div>
<button class="sb-link active" onclick="go('dashboard',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard</button>
<button class="sb-link" onclick="go('customers',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Customers</button></div>
<div class="sb-divider"></div>
<div class="sb-section"><div class="sb-section-label">Products</div>
<button class="sb-link" onclick="go('academy',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>Academy</button>
<a class="sb-link" href="/academy/builder.html" target="_blank" style="font-size:12px;padding-left:38px;opacity:.7"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Course Builder ↗</a>
<button class="sb-link" onclick="go('fusion',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Fusion Sessions</button>
<button class="sb-link" onclick="go('sessions',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>1-on-1 Sessions</button>
<button class="sb-link" onclick="go('memberships',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Memberships</button></div>
<div class="sb-divider"></div>
<div class="sb-section"><div class="sb-section-label">Engage</div>
<button class="sb-link" onclick="go('community',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Community</button>
<button class="sb-link" onclick="go('referrals',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>Referrals & Credits</button>
<button class="sb-link" onclick="go('email',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email Campaigns</button>
<button class="sb-link" onclick="go('automation',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><polyline points="12 6 12 12 16 14"/></svg>Email Automation</button>
<button class="sb-link" onclick="go('promotions',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Promotions</button>
<button class="sb-link" onclick="go('orders',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>Orders</button>
<button class="sb-link" onclick="go('analytics',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Analytics</button></div>
<div class="sb-divider"></div>
<div class="sb-section"><div class="sb-section-label">System</div>
<button class="sb-link" onclick="go('audit',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>Audit Log</button>
<button class="sb-link" id="sb-admin-users" onclick="go('admin-users',this)" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2z"/><path d="M8 11V7a4 4 0 0 1 8 0v4"/></svg>Admin Users</button></div>
</nav>
<div class="sb-divider" style="margin:0 20px"></div>
<button class="sb-theme-toggle" onclick="toggleTheme()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span id="themeLabel">Light</span><div class="sb-theme-switch"></div></button>
<div class="sb-footer"><div class="sb-user"><div class="sb-avatar" id="sb-avatar">?</div><div class="sb-user-info"><div class="sb-user-name" id="sb-user-name">Loading...</div><div class="sb-user-role" id="sb-user-role">—</div></div><button class="sb-logout" onclick="doLogout()" title="Sign out"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button></div></div>
</aside>
<div class="main-content">
<div class="topbar"><div class="topbar-title" id="topbar-title">Dashboard</div><div class="topbar-right"><div class="topbar-search ac-wrap" id="global-search-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="global-search" autocomplete="off" placeholder="Search customers..." oninput="handleGlobalSearch()" onkeydown="handleGlobalKeydown(event)"><div class="ac-dropdown" id="global-ac"></div></div><button class="topbar-btn" title="Refresh" onclick="refreshCurrentPage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button></div></div>

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard"><div class="stats-grid" id="dash-stats"></div><div id="dash-suggestions" class="suggestions-panel" style="display:none"></div><div id="weekly-goals-panel" class="card" style="display:none;margin-bottom:20px"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;vertical-align:middle;margin-right:6px;color:var(--teal)"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Weekly Goals <span id="weekly-date-range" style="font-size:11px;color:var(--text-dim);font-weight:400;margin-left:8px"></span></div><span id="weekly-count" style="font-size:13px;font-weight:700;color:var(--text-muted)">0/0</span></div><div class="card-body" style="padding:16px 20px 18px"><div style="background:rgba(0,0,0,.15);border-radius:10px;height:8px;overflow:hidden;margin-bottom:14px"><div id="weekly-progress-fill" style="width:0%;height:100%;background:linear-gradient(90deg,var(--success),var(--teal));border-radius:10px;transition:width .5s ease"></div></div><div id="weekly-goal-chips" style="display:flex;flex-wrap:wrap;gap:6px"></div></div></div><div class="grid-2"><div class="card"><div class="card-header"><div class="card-title">Recent Purchases</div></div><div class="card-body" id="dash-purchases" style="max-height:380px;overflow-y:auto"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div><div class="card"><div class="card-header"><div class="card-title">Recent Activity</div></div><div class="card-body" id="dash-activity" style="max-height:380px;overflow-y:auto"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div></div>

<!-- CUSTOMERS -->
<div class="page" id="page-customers">
<div class="form-row" style="margin-bottom:20px"><div class="form-group ac-wrap" style="flex:2"><input type="text" class="input" id="cust-search" autocomplete="off" placeholder="Search by email, name, or referral code..." oninput="handleCustSearch()" onkeydown="handleCustKeydown(event)"><div class="ac-dropdown" id="cust-ac"></div></div><button class="btn btn-primary" onclick="searchCustomer()">Search</button></div>
<div class="msg" id="cust-msg"></div><div id="cust-result"></div>
<div class="card" style="margin-top:20px"><div class="card-header"><div class="card-title">All Customers</div><div style="display:flex;gap:8px"><button class="btn btn-ghost btn-sm" onclick="exportCustomers()">Export CSV</button><button class="btn btn-sm" style="background:rgba(255,107,107,.12);color:#ff6b6b;border:1px solid rgba(255,107,107,.25)" onclick="webhookRecovery()">⚠ Recovery</button><button class="btn btn-ghost btn-sm" onclick="loadCustomerBrowser()">Refresh</button></div></div><div class="card-body" style="padding:16px"><div class="browser-stats" id="cust-browser-stats"></div><div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap"><select class="input" style="width:170px" id="cb-filter" onchange="applyCBFilter()"><option value="all">All Customers</option><option value="academy">Academy Owners</option><option value="fusion">Fusion Owners</option><option value="bundle">Bundle Owners</option><option value="no-purchase">No Purchases</option><option value="has-credits">Has Credits</option><option value="has-referrals">Has Referrals</option><option value="no-referral-code">No Referral Code</option><option value="blocked">Blocked</option><option value="no-account">No Account (Guest)</option></select><select class="input" style="width:150px" id="cb-sort" onchange="applyCBFilter()"><option value="email-asc">Email A→Z</option><option value="recent">Most Recent</option><option value="credits">Highest Credits</option><option value="referrals">Most Referrals</option><option value="spent">Most Spent</option></select><input type="text" class="input" style="width:200px" id="cb-search" autocomplete="off" placeholder="Filter..." oninput="applyCBFilter()"></div><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Email</th><th>Name</th><th>Products</th><th>Spent</th><th>Credits</th><th>Referrals</th><th></th></tr></thead><tbody id="cb-tbody"></tbody></table></div><div class="pagination" id="cb-pagination"></div></div></div>
<div class="card" style="margin-top:20px"><div class="card-header"><div class="card-title">Grant Access</div></div><div class="card-body"><div class="form-row"><div class="form-group"><label>Email</label><input type="email" class="input" id="grant-email" placeholder="customer@example.com" autocomplete="off"></div><div class="form-group"><label>Product</label><select class="input" id="grant-product"><optgroup label="Fusion Sessions"><option value="bundle-all">Complete Bundle</option><option value="session-01">S1: Intolerance & Sensitivity</option><option value="session-02">S2: Anxiety & Overwhelm</option><option value="session-03">S3: Pain & Tension</option><option value="session-04">S4: Sleep & Reset</option><option value="session-05">S5: Digestion & Integration</option><option value="session-06">S6: Immune Balance</option><option value="session-07">S7: Hormonal Harmony</option><option value="session-08">S8: Phobias & Fear</option><option value="session-09">S9: Fatigue & Vitality</option><option value="session-10">S10: Weight & Self-Perception</option><option value="session-11">S11: Relationships & Boundaries</option><option value="session-12">S12: Purpose & Alignment</option></optgroup><optgroup label="Academy Courses"><option value="breaking-up-with-your-beliefs">Breaking Up with Your Beliefs</option><option value="power-of-the-question">The Power of The Question</option><option value="creative-mind-mapping">Creative Mind Mapping</option><option value="quantum-vision-boards">Quantum Vision Boards</option><option value="becoming-present">Becoming Present</option><option value="transformational-mastery">Transformational Mastery (All 5)</option></optgroup></select></div><button class="btn btn-success" onclick="grantAccess()">Grant</button></div><div class="msg" id="grant-msg"></div></div></div></div>

<!-- ACADEMY -->
<div class="page" id="page-academy"><div class="stats-grid" id="acad-stats"></div>
<div class="tab-nav"><button class="tab-btn active" onclick="switchAcadTab('courses',this)">Courses</button><button class="tab-btn" onclick="switchAcadTab('students',this)">Students</button></div>
<div class="tab-content active" id="acad-tab-courses"><div class="card"><div class="card-header"><div class="card-title">Course Management</div><button class="btn btn-ghost btn-sm" onclick="loadAcademyData()">Refresh</button></div><div class="card-body" id="acad-courses"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div>
<div class="tab-content" id="acad-tab-students"><div class="card" style="margin-bottom:16px"><div class="card-header"><div class="card-title">Enroll Student</div></div><div class="card-body"><div class="form-row"><div class="form-group"><label>Email</label><input type="email" class="input" id="enroll-email" placeholder="student@example.com" autocomplete="off"></div><div class="form-group"><label>Course</label><select class="input" id="enroll-course"></select></div><button class="btn btn-success" onclick="enrollStudent()">Enroll</button></div><div class="msg" id="enroll-msg"></div></div></div><div class="card" style="margin-bottom:16px"><div class="card-header"><div class="card-title">Bulk Enroll (CSV)</div></div><div class="card-body"><p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Upload a CSV with column <code>email</code> (required). Optionally include a <code>course</code> column with course slugs. If no course column, all students will be enrolled in the selected course below.</p><div class="form-row"><div class="form-group"><label>CSV File</label><input type="file" class="input" id="bulk-csv" accept=".csv" style="padding:6px"></div><div class="form-group"><label>Default Course</label><select class="input" id="bulk-course"></select></div><button class="btn btn-primary" onclick="bulkEnrollCSV()">Bulk Enroll</button></div><div class="msg" id="bulk-msg"></div></div></div><div class="card"><div class="card-header"><div class="card-title">Student Management</div><button class="btn btn-ghost btn-sm" onclick="loadAcadStudents()">Refresh</button></div><div class="card-body"><div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap"><select class="input" style="width:220px" id="stu-course" onchange="stuPage=1;renderStudentTable()"><option value="all">All Courses</option></select><select class="input" style="width:140px" id="stu-status" onchange="stuPage=1;renderStudentTable()"><option value="all">All Status</option><option value="active">Active</option><option value="granted">Granted</option><option value="revoked">Revoked</option></select><select class="input" style="width:140px" id="stu-sort" onchange="renderStudentTable()"><option value="enrolled-desc">Newest First</option><option value="enrolled-asc">Oldest First</option><option value="progress-desc">Most Progress</option><option value="progress-asc">Least Progress</option><option value="email-asc">Email A→Z</option><option value="name-asc">Name A→Z</option><option value="paid-desc">Most Paid</option></select><input type="text" class="input" style="width:220px" id="stu-search" autocomplete="off" placeholder="Search email or name..." oninput="stuPage=1;renderStudentTable()"></div><div style="overflow-x:auto" id="acad-students-table"><div class="loading-center"><div class="spinner"></div>Loading...</div></div><div class="pagination" id="stu-pagination"></div></div></div></div></div>

<!-- FUSION -->
<div class="page" id="page-fusion"><div class="stats-grid" id="fusion-stats"></div><div class="card"><div class="card-header"><div class="card-title">Session Purchases</div><button class="btn btn-ghost btn-sm" onclick="loadFusionData()">Refresh</button></div><div class="card-body" id="fusion-content"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div>

<!-- PLACEHOLDERS -->
<!-- 1-ON-1 SESSIONS (Session 23) -->
<div class="page" id="page-sessions">
<div class="stats-grid" id="sess-stats"></div>

<!-- Cycle Status Banner -->
<div class="card" id="sess-cycle-banner" style="margin-bottom:20px;display:none">
<div class="card-body" style="padding:16px 20px">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
<div><div style="font-size:16px;font-weight:600;color:var(--text)" id="sess-cycle-name-display">No Active Cycle</div>
<div style="font-size:12px;color:var(--text-dim);margin-top:2px" id="sess-cycle-dates"></div></div>
<div style="display:flex;align-items:center;gap:8px" id="sess-cycle-status-wrap"></div></div>
<div id="sess-cycle-pipeline" style="display:flex;gap:4px;margin-top:14px"></div>
</div></div>

<!-- Tabs -->
<div class="tab-nav">
<button class="tab-btn active" onclick="switchSessTab('cycles',this)">Cycles</button>
<button class="tab-btn" onclick="switchSessTab('availability',this)">Availability</button>
<button class="tab-btn" onclick="switchSessTab('clients',this)">Clients</button>
<button class="tab-btn" onclick="switchSessTab('bookings',this)">Bookings</button>
<button class="tab-btn" onclick="switchSessTab('public',this)">Public &amp; Waitlist</button>
</div>

<!-- TAB: Cycles -->
<div class="tab-content active" id="sess-tab-cycles">
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div class="card-title">Create New Cycle</div></div>
<div class="card-body">
<div class="form-row">
<div class="form-group"><label>Cycle Name</label><input type="text" class="input" id="sess-cycle-name-input" placeholder="e.g. Spring 2026"></div>
<div class="form-group"><label>Start Date</label><input type="date" class="input" id="sess-cycle-start"></div>
<div class="form-group"><label>End Date</label><input type="date" class="input" id="sess-cycle-end"></div>
<button class="btn btn-primary" onclick="createCycle()">Create Cycle</button>
</div></div></div>
<div class="card">
<div class="card-header"><div class="card-title">All Cycles</div><button class="btn btn-ghost btn-sm" onclick="loadSessionsData()">Refresh</button></div>
<div class="card-body" id="sess-cycles-list"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
</div></div>

<!-- TAB: Availability -->
<div class="tab-content" id="sess-tab-availability">
<div class="card" style="margin-bottom:16px">
<div class="card-header">
<div class="card-title">Availability Calendar</div>
<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
<select class="input" style="width:200px" id="sess-avail-cycle" onchange="loadAvailabilityCalendar()"></select>
<button class="btn btn-ghost btn-sm" onclick="sessAvailPrevMonth()">&#9664;</button>
<span id="sess-avail-month-label" style="font-size:13px;font-weight:600;min-width:120px;text-align:center"></span>
<button class="btn btn-ghost btn-sm" onclick="sessAvailNextMonth()">&#9654;</button>
</div></div>
<div class="card-body">
<div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;font-size:11px;color:var(--text-dim)">
<span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--success);vertical-align:middle;margin-right:4px"></span>Available</span>
<span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--danger);vertical-align:middle;margin-right:4px"></span>Blocked</span>
<span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--warning);vertical-align:middle;margin-right:4px"></span>Teaching</span>
<span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--teal);vertical-align:middle;margin-right:4px"></span>Travel</span>
<span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--purple);vertical-align:middle;margin-right:4px"></span>Personal</span>
</div>
<div id="sess-avail-calendar" class="sess-calendar"></div>
</div></div>
<div class="card">
<div class="card-header"><div class="card-title">Bulk Actions</div></div>
<div class="card-body">
<div class="form-row">
<div class="form-group"><label>Action</label>
<select class="input" id="sess-bulk-action"><option value="available">Mark Available</option><option value="blocked">Mark Blocked</option><option value="teaching">Mark Teaching</option><option value="travel">Mark Travel</option><option value="personal">Mark Personal</option></select></div>
<div class="form-group"><label>Apply To</label>
<select class="input" id="sess-bulk-target"><option value="all-tue">All Tuesdays</option><option value="all-wed">All Wednesdays</option><option value="all-thu">All Thursdays</option><option value="all-twt">All Tue/Wed/Thu</option><option value="range">Date Range&#8230;</option></select></div>
<div class="form-group" id="sess-bulk-range-wrap" style="display:none"><label>From / To</label>
<div style="display:flex;gap:6px"><input type="date" class="input" id="sess-bulk-from"><input type="date" class="input" id="sess-bulk-to"></div></div>
<div class="form-group"><label>Time Slots</label>
<div style="display:flex;gap:6px"><input type="time" class="input" id="sess-bulk-start" value="09:00"><input type="time" class="input" id="sess-bulk-end" value="17:00"></div></div>
<button class="btn btn-primary" onclick="bulkAvailability()">Apply</button>
</div>
<div class="form-row" style="margin-top:8px">
<div class="form-group"><label>Notes (optional)</label><input type="text" class="input" id="sess-bulk-notes" placeholder="e.g. Teaching BodyTalk Access in Toronto"></div>
<button class="btn btn-ghost" onclick="importPrevCycleAvailability()">Import from Previous Cycle</button>
</div></div></div>
</div>

<!-- TAB: Clients -->
<div class="tab-content" id="sess-tab-clients">
<div class="card" style="margin-bottom:16px">
<div class="card-header"><div class="card-title">Add Client</div></div>
<div class="card-body">
<div class="form-row">
<div class="form-group"><label>Email</label><input type="email" class="input" id="sess-client-email" placeholder="client@example.com"></div>
<div class="form-group"><label>Name</label><input type="text" class="input" id="sess-client-name" placeholder="Full name"></div>
<div class="form-group" style="min-width:130px"><label>Frequency</label>
<select class="input" id="sess-client-freq"><option value="weekly">Weekly</option><option value="biweekly">Biweekly</option><option value="monthly" selected>Monthly</option><option value="every_2_months">Every 2 Months</option></select></div>
<div class="form-group" style="min-width:120px"><label>Preferred Day</label>
<select class="input" id="sess-client-day"><option value="monday">Monday</option><option value="tuesday" selected>Tuesday</option><option value="wednesday">Wednesday</option><option value="thursday">Thursday</option><option value="friday">Friday</option></select></div>
<div class="form-group" style="min-width:100px"><label>Preferred Time</label>
<input type="time" class="input" id="sess-client-time" value="10:00"></div>
<button class="btn btn-primary" onclick="addSessionClient()">Add Client</button>
</div></div></div>
<div class="card">
<div class="card-header"><div class="card-title">Client Roster</div>
<div style="display:flex;gap:8px">
<select class="input" style="width:130px" id="sess-client-filter" onchange="renderClientRoster()"><option value="active">Active</option><option value="paused">Paused</option><option value="all">All</option></select>
<button class="btn btn-ghost btn-sm" onclick="loadSessionsData()">Refresh</button>
</div></div>
<div class="card-body" id="sess-clients-list"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
</div></div>

<!-- TAB: Bookings -->
<div class="tab-content" id="sess-tab-bookings">
<div class="card" style="margin-bottom:16px">
<div class="card-header"><div class="card-title">Auto-Populate &amp; Manage</div>
<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
<select class="input" style="width:200px" id="sess-book-cycle" onchange="loadBookingsForCycle()"></select>
<button class="btn btn-primary btn-sm" onclick="autoPopulate()">&#9889; Auto-Populate</button>
<button class="btn btn-ghost btn-sm" onclick="sendAllConfirmations()">&#9993; Send Confirmations</button>
</div></div>
<div class="card-body">
<div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
<select class="input" style="width:140px" id="sess-book-status" onchange="renderBookingsGrid()"><option value="all">All Status</option><option value="proposed">Proposed</option><option value="confirmed">Confirmed</option><option value="declined">Declined</option><option value="cancelled">Cancelled</option><option value="completed">Completed</option></select>
<select class="input" style="width:120px" id="sess-book-type" onchange="renderBookingsGrid()"><option value="all">All Types</option><option value="recurring">Recurring</option><option value="public">Public</option><option value="manual">Manual</option></select>
<input type="text" class="input" style="width:200px" id="sess-book-search" placeholder="Search by email..." oninput="renderBookingsGrid()">
</div>
<div id="sess-confirm-tracker" style="margin-bottom:12px"></div>
<div id="sess-bookings-grid"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
<div class="pagination" id="sess-book-pagination"></div>
</div></div>
</div>

<!-- TAB: Public & Waitlist -->
<div class="tab-content" id="sess-tab-public">
<div class="card" style="margin-bottom:16px">
<div class="card-header"><div class="card-title">Public Booking Controls</div></div>
<div class="card-body" id="sess-public-config"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
</div>
<div class="card">
<div class="card-header"><div class="card-title">Waitlist</div><button class="btn btn-ghost btn-sm" onclick="loadSessionsData()">Refresh</button></div>
<div class="card-body" id="sess-waitlist-list"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
</div>
</div>

</div>
<div class="page" id="page-memberships"><div class="card"><div class="card-body"><div class="empty"><p>Membership tiers coming in a future session.</p></div></div></div></div>

<!-- COMMUNITY -->
<div class="page" id="page-community"><div class="stats-grid" id="comm-stats"></div>
<div class="tab-nav"><button class="tab-btn active" onclick="switchCommTab('academy',this)">Academy Discussions</button><button class="tab-btn" onclick="switchCommTab('fusion',this)">Fusion Community</button><button class="tab-btn" onclick="switchCommTab('moderators',this)">Moderators</button></div>
<div class="tab-content active" id="comm-tab-academy"><div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap"><select class="input" style="width:150px" id="comm-acad-filter" onchange="loadAcadDiscussions()"><option value="all">All</option><option value="visible">Visible</option><option value="hidden">Hidden</option><option value="pinned">Pinned</option></select><input type="text" class="input" style="width:200px" id="comm-acad-search" autocomplete="off" placeholder="Search..." oninput="loadAcadDiscussions()"></div><div id="comm-acad-posts"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div>
<div class="tab-content" id="comm-tab-fusion"><div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap"><select class="input" style="width:150px" id="comm-fus-filter" onchange="loadFusionPosts()"><option value="all">All</option><option value="visible">Visible</option><option value="hidden">Hidden</option><option value="pinned">Pinned</option></select><input type="text" class="input" style="width:200px" id="comm-fus-search" autocomplete="off" placeholder="Search..." oninput="loadFusionPosts()"></div><div id="comm-fus-posts"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div><div class="tab-content" id="comm-tab-moderators"><div class="card" style="margin-bottom:16px"><div class="card-body"><p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Moderators can hide, pin, and delete posts. Assign roles to trusted community members.</p><div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap"><div class="ac-wrap" style="flex:1;min-width:200px"><input type="text" class="input" id="mod-email" placeholder="Search by email..." autocomplete="off" oninput="handleModSearch()" onkeydown="handleModKeydown(event)"><div class="ac-dropdown" id="mod-ac"></div></div><select class="input" style="width:200px" id="mod-role"><option value="moderator">Moderator — Can moderate posts</option><option value="admin">Community Admin — Full community control</option></select><button class="btn btn-primary btn-sm" onclick="assignMod()">Assign Role</button></div><div class="msg" id="mod-msg" style="display:none;margin-top:10px"></div></div></div><div id="mod-list"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div>

<!-- REFERRALS -->
<div class="page" id="page-referrals"><div class="stats-grid" id="ref-stats"></div><div class="grid-2" style="margin-bottom:20px"><div class="card"><div class="card-header"><div class="card-title">Top Referrers</div></div><div class="card-body" style="max-height:380px;overflow-y:auto" id="ref-leaderboard"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div><div class="card"><div class="card-header"><div class="card-title">Recent Credit Activity</div></div><div class="card-body" style="max-height:380px;overflow-y:auto" id="ref-activity"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div></div>

<!-- EMAIL & ANALYTICS -->
<!-- EMAIL CENTER -->
<div class="page" id="page-email">
<div class="page-header"><h1>Email Center</h1><p>Send marketing emails to customers. Only sends to users who opted in to marketing communications.</p></div>

<!-- Email Stats -->
<div class="stats-grid" id="email-stats"></div>

<!-- Email Student List Panel -->
<div class="card" id="email-student-panel" style="display:none;margin-bottom:20px">
<div class="card-header"><div class="card-title" id="email-student-title">Students</div><button class="btn btn-ghost btn-sm" onclick="closeEmailStudentList()">✕ Close</button></div>
<div class="card-body"><input type="text" class="input" id="email-student-search" autocomplete="off" placeholder="Filter by name or email..." oninput="filterEmailStudentList()" style="margin-bottom:12px"><div id="email-student-table-wrap"></div></div></div>

<!-- Weekly Email Limit -->
<div class="card" style="margin-bottom:20px"><div class="card-body" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:14px 20px">
<span style="font-size:12px;font-weight:600;color:var(--text-muted)">Weekly Promo Limit:</span>
<input type="number" class="input" id="weekly-email-limit" value="3" min="1" max="10" style="width:70px" onchange="saveWeeklyEmailLimit()">
<span style="font-size:11px;color:var(--text-dim)">per user / rolling 7 days · Only counts promotional campaigns</span>
</div></div>

<!-- Compose Card -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div class="card-title">Compose Email</div></div><div class="card-body">

<!-- Audience -->
<div class="form-group" style="margin-bottom:16px"><label>Audience</label>
<select class="input" id="email-audience" onchange="updateAudiencePreview()">
<optgroup label="General Audiences">
<option value="all-opted-in">All Opted-In Subscribers</option>
<option value="bundle-owners">Bundle Owners Only</option>
<option value="single-session">Single Session Buyers (No Bundle)</option>
<option value="no-purchase">Registered but No Purchase</option>
</optgroup>
<optgroup label="Fusion Session Owners">
<option value="session-01">Session 1 - Intolerance & Sensitivity</option>
<option value="session-02">Session 2 - Anxiety & Overwhelm</option>
<option value="session-03">Session 3 - Pain & Tension</option>
<option value="session-04">Session 4 - Sleep & Reset</option>
<option value="session-05">Session 5 - Digestion & Integration</option>
<option value="session-06">Session 6 - Immune Balance</option>
<option value="session-07">Session 7 - Hormonal Harmony</option>
<option value="session-08">Session 8 - Phobias & Fear</option>
<option value="session-09">Session 9 - Fatigue & Vitality</option>
<option value="session-10">Session 10 - Weight & Self-Perception</option>
<option value="session-11">Session 11 - Relationships & Boundaries</option>
<option value="session-12">Session 12 - Purpose & Alignment</option>
</optgroup>
<optgroup label="Academy">
<option value="academy-all">All Academy Students</option>
<option value="academy-transformational-mastery">Transformational Mastery (Bundle)</option>
<option value="academy-quantum-vision-boards">Quantum Vision Boards</option>
<option value="academy-becoming-present">Becoming Present</option>
<option value="academy-breaking-up-with-your-beliefs">Breaking Up with Your Beliefs</option>
<option value="academy-creative-mind-mapping">Creative Mind Mapping</option>
<option value="academy-power-of-the-question">The Power of The Question</option>
</optgroup>
<optgroup label="Custom">
<option value="custom">Custom Email List</option>
</optgroup>
</select></div>

<!-- Custom Emails -->
<div class="form-group" id="custom-emails-group" style="display:none;margin-bottom:16px"><label>Custom Email List (one per line)</label>
<textarea class="input" id="custom-emails" placeholder="email1@example.com&#10;email2@example.com" rows="4"></textarea></div>

<!-- Audience Preview -->
<div id="audience-preview" style="background:rgba(0,0,0,.15);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--text-muted)">Select an audience to see recipient count</div>

<!-- From Address -->
<div class="form-group" style="margin-bottom:16px"><label>From Address</label>
<select class="input" id="email-from">
<option value="hello@quantumphysician.com"><template class="__cf_email__" data-cfemail="bdd5d8d1d1d2fdccc8dcd3c9c8d0cdd5c4ced4ded4dcd393ded2d0">[email&#160;protected]</template> (Marketing)</option>
<option value="tracey@quantumphysician.com"><template class="__cf_email__" data-cfemail="a2d6d0c3c1c7dbe2d3d7c3ccd6d7cfd2cadbd1cbc1cbc3cc8cc1cdcf">[email&#160;protected]</template> (Personal)</option>
</select></div>

<!-- Email Type -->
<div class="form-group" style="margin-bottom:16px"><label>Email Type</label>
<select class="input" id="email-type-select" onchange="updateEmailTypeHint()">
<option value="promotional">Promotional — Sales, discounts, re-enrollment, newsletters</option>
<option value="automated">Automated/Course — Session reminders, zoom links, course follow-ups</option>
<option value="transactional">Transactional — Purchase confirmations, password resets, welcome</option>
</select>
<div id="email-type-hint" style="font-size:11px;color:var(--warning);margin-top:6px">Promotional emails count toward the weekly limit and respect opt-out preferences.</div></div>

<!-- Rich HTML Toggle -->
<div class="form-group" style="margin-bottom:16px">
<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
<label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0"><input type="checkbox" id="rich-email-toggle" checked onchange="toggleRichEmailOptions()"><span style="font-size:13px;font-weight:600">Send as Rich HTML</span></label>
<span style="font-size:11px;color:var(--text-dim)">Styled email with branding, tracking pixels &amp; CTA buttons</span>
</div>
</div>

<!-- Email Brand + Discount Config (shown when rich HTML enabled) -->
<div id="rich-email-options" style="margin-bottom:16px;padding:14px;background:rgba(0,0,0,.15);border:1px solid var(--border);border-radius:var(--radius-sm)">

<!-- Email Brand Selector -->
<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap">
<span style="font-size:12px;font-weight:600;color:var(--text-muted)">Template:</span>
<select class="input" id="email-brand-select" style="width:auto;font-size:12px" onchange="ecAutoPreview()">
<option value="fusion">Fusion Sessions</option>
<option value="academy">Academy</option>
</select>
</div>

<!-- Discount Card Controls -->
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
<label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0"><input type="checkbox" id="discount-toggle" onchange="toggleDiscountConfig();ecAutoPreview()"><span style="font-size:12px;font-weight:600;color:var(--warning)">Include Discount Card</span></label>
<button class="btn btn-ghost btn-sm" onclick="insertDiscountBlock()" style="font-size:11px" title="Inserts a --- divider and discount template at the end of your email body">Insert into Body</button>
</div>
<div id="discount-config" style="display:none;gap:10px;flex-wrap:wrap;align-items:end">
<div style="flex:1;min-width:150px"><label style="font-size:11px;color:var(--text-dim);display:block;margin-bottom:4px">Promo Code</label>
<select class="input" id="discount-promo-select" style="font-size:12px"><option value="">Select promotion...</option></select></div>
<div style="flex:1;min-width:120px"><label style="font-size:11px;color:var(--text-dim);display:block;margin-bottom:4px">Or enter code</label>
<input type="text" class="input" id="discount-promo-custom" placeholder="CUSTOM_CODE" style="font-size:12px"></div>
</div>
<div style="margin-top:10px;font-size:11px;color:var(--text-dim)"><strong>Tip:</strong> Use <code style="background:rgba(255,255,255,.06);padding:2px 6px;border-radius:4px">---</code> on its own line to separate main body from discount card content. Use <code style="background:rgba(255,255,255,.06);padding:2px 6px;border-radius:4px">{{qr_code}}</code> in the discount section for a QR code.</div>
</div>

<!-- Subject -->
<div class="form-group" style="margin-bottom:16px"><label>Subject Line</label>
<input type="text" class="input" id="email-subject" placeholder="Your subject line..." maxlength="100">
<div style="text-align:right;font-size:10px;color:var(--text-dim);margin-top:4px"><span id="subject-count">0</span>/100</div></div>

<!-- Body with merge tag toolbar -->
<div class="form-group" style="margin-bottom:16px"><label>Email Body</label>
<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
<button class="btn btn-ghost btn-sm" type="button" onclick="insertEmailVar('{{name}}')">Name</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="insertEmailVar('{{email}}')">Email</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="insertEmailVar('{{referral_code}}')">Referral Code</button>
</div>
<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
<span style="font-size:10px;color:var(--text-dim);align-self:center;margin-right:2px">CTA Buttons:</span>
<button class="btn btn-ghost btn-sm" type="button" onclick="ecInsertCTA('watch')" style="font-size:10px;border-color:var(--purple);color:var(--purple)">Watch Sessions</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="ecInsertCTA('dashboard')" style="font-size:10px;border-color:var(--teal);color:var(--teal)">Go to Dashboard</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="ecInsertCTA('referral')" style="font-size:10px;border-color:var(--success);color:var(--success)">Referral Hub</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="ecInsertCTA('academy')" style="font-size:10px;border-color:var(--warning);color:var(--warning)">Explore Academy</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="ecInsertCTA('community')" style="font-size:10px;border-color:var(--taupe);color:var(--taupe)">Join Community</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="ecInsertCTA('custom')" style="font-size:10px">Custom CTA...</button>
</div>
<!-- Rich editor mounts here dynamically -->
<div id="ec-editor-mount"></div>
<textarea class="input" id="email-body" placeholder="Write your email message here..." rows="10" oninput="ecAutoPreview()" style="display:none"></textarea>
<div id="ec-section-controls" style="display:none;margin-top:8px;margin-bottom:8px"><div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">Cards & CTAs <span style="opacity:.5">(drag to reorder)</span></div><div id="ec-card-pills" style="display:flex;flex-wrap:wrap;gap:6px"></div></div>
</div>

<!-- Actions -->
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
<button class="btn btn-ghost" onclick="previewEmail()">Preview</button>
<button class="btn btn-ghost" onclick="ecSendTestEmail()" style="border-color:var(--warning);color:var(--warning)">Send Test</button>
<button class="btn btn-primary" onclick="prepareToSend()" id="send-btn">Send to <span id="send-count">0</span> Recipients</button>
</div>




<!-- Card Library Button -->
<div style="margin-bottom:16px;padding-top:12px;border-top:1px solid var(--border)"><button class="btn btn-sm" style="background:linear-gradient(135deg,var(--purple),#8338ec);color:#fff;font-weight:600;letter-spacing:.5px;border:none" onclick="ecOpenCardLibrary()">CARD LIBRARY</button><span style="font-size:11px;color:var(--text-dim);margin-left:8px">Pre-built card blocks to add to your email</span></div>
<div id="ec-card-library-slot"></div>

<!-- Live Preview -->
<div id="ec-preview-area" style="margin-bottom:16px"></div>

<!-- Send Progress Log -->
<div id="email-log" style="display:none;margin-bottom:16px">
<div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);margin-bottom:8px">Send Progress</div>
<div style="height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;margin-bottom:8px"><div id="progress-fill" style="height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-light));width:0;transition:width .3s"></div></div>
<div id="progress-text" style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Preparing...</div>
<div id="email-log-entries" style="max-height:200px;overflow-y:auto;font-size:12px;font-family:monospace;color:var(--text-dim)"></div>
</div>

<div class="msg" id="email-message"></div>
</div></div>

<!-- Templates -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div class="card-title">Quick Templates</div><span style="font-size:11px;color:var(--text-dim)">Click to load · Right-click to edit</span></div>
<div class="card-body"><div id="template-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px"></div></div></div>

<!-- Campaign History -->
<div class="card"><div class="card-header"><div class="card-title">Campaign History</div><button class="btn btn-ghost btn-sm" onclick="loadCampaignHistory()">Refresh</button></div>
<div class="card-body">
<div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap">
<button class="btn btn-ghost btn-sm ec-filter active" onclick="filterCampaignHistory('all',this)">All</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('no_purchase',this)">Welcome</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('upsell_bundle',this)">Upsell</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('promote_session',this)">Promote</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('credit_reminder',this)">Credits</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('referral_nudge',this)">Referral</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('custom',this)">Custom</button>
</div>
<div id="campaign-history-list"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
</div></div>
</div>

<!-- Email Automation Page -->
<div class="page" id="page-automation">
<div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px"><div><h1>Email Automation</h1><p>Manage scheduled emails, view send logs, and configure session reminders.</p></div><button class="btn btn-primary" onclick="createScheduledEmail()">+ Schedule Email</button></div>

<!-- Automation Stats -->
<div class="stats-grid" style="margin-bottom:24px">
<div class="stat-card"><div class="stat-val" id="auto-stat-pending">-</div><div class="stat-label">Pending</div></div>
<div class="stat-card"><div class="stat-val" id="auto-stat-sent">-</div><div class="stat-label">Sent (30d)</div></div>
<div class="stat-card"><div class="stat-val" id="auto-stat-failed">-</div><div class="stat-label">Failed</div></div>
<div class="stat-card"><div class="stat-val" id="auto-stat-next">-</div><div class="stat-label">Next Session</div></div>
</div>

<!-- Sub-tabs -->
<div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">
<button class="btn btn-ghost btn-sm auto-tab-btn active" onclick="switchAutoTab('scheduled',this)">Scheduled Emails</button>
<button class="btn btn-ghost btn-sm auto-tab-btn" onclick="switchAutoTab('logs',this)">Email Logs</button>
<button class="btn btn-ghost btn-sm auto-tab-btn" onclick="switchAutoTab('sessions',this)">Session Schedule</button>
</div>

<!-- Scheduled Emails Tab -->
<div class="card auto-tab-panel" id="autotab-scheduled" style="margin-bottom:20px">
<div class="card-header"><div class="card-title">Scheduled Emails</div><button class="btn btn-ghost btn-sm" onclick="loadScheduledEmails()">Refresh</button></div>
<div class="card-body">
<div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
<select class="input" id="filter-sched-status" onchange="loadScheduledEmails()" style="width:auto;font-size:12px"><option value="all">All Status</option><option value="pending">Pending</option><option value="sent">Sent</option><option value="failed">Failed</option><option value="cancelled">Cancelled</option></select>
<select class="input" id="filter-sched-type" onchange="loadScheduledEmails()" style="width:auto;font-size:12px"><option value="all">All Types</option><option value="reminder_7day">7-Day Reminder</option><option value="reminder_1day">1-Day Reminder</option><option value="reminder_2hr">2-Hour Reminder</option><option value="promo">Promo</option><option value="custom">Custom</option></select>
</div>
<div id="scheduled-emails-list"><div class="empty"><p>Loading...</p></div></div>
</div></div>

<!-- Email Logs Tab -->
<div class="card auto-tab-panel" id="autotab-logs" style="display:none;margin-bottom:20px">
<div class="card-header"><div class="card-title">Email Logs</div><button class="btn btn-ghost btn-sm" onclick="loadEmailLogs()">Refresh</button></div>
<div class="card-body">
<div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
<input type="text" class="input" id="filter-log-email" placeholder="Filter by email..." style="width:200px;font-size:12px" onkeyup="loadEmailLogs()">
<select class="input" id="filter-log-status" onchange="loadEmailLogs()" style="width:auto;font-size:12px"><option value="all">All Status</option><option value="sent">Sent</option><option value="failed">Failed</option></select>
</div>
<div id="email-logs-list"><div class="empty"><p>Loading...</p></div></div>
</div></div>

<!-- Session Schedule Tab -->
<div class="card auto-tab-panel" id="autotab-sessions" style="display:none;margin-bottom:20px">
<div class="card-header"><div class="card-title">Session Schedule</div></div>
<div class="card-body">
<div id="session-schedule-list"><div class="empty"><p>Loading...</p></div></div>
</div></div>
</div>

<!-- Scheduled Email Edit Modal -->
<div class="modal-overlay" id="sched-edit-modal" style="display:none" onclick="if(event.target===this)closeSchedEditModal()">
<div class="modal-box" style="max-width:600px">
<button class="modal-x" onclick="closeSchedEditModal()">&times;</button>
<h3 id="sched-edit-title" style="margin:0 0 14px;font-size:16px;color:var(--text)">Edit Scheduled Email</h3>
<input type="hidden" id="sched-edit-id">
<div class="form-group" style="margin-bottom:12px"><label style="font-size:12px">Scheduled For</label><input type="datetime-local" class="input" id="sched-edit-datetime"></div>
<div class="form-group" style="margin-bottom:12px"><label style="font-size:12px">Audience</label>
<select class="input" id="sched-edit-audience"><option value="session-owners">Session Owners</option><option value="bundle-owners">Bundle Owners</option><option value="all">All Opted-In</option></select></div>
<div class="form-group" style="margin-bottom:12px"><label style="font-size:12px">Subject</label><input type="text" class="input" id="sched-edit-subject"></div>
<div class="form-group" style="margin-bottom:12px"><label style="font-size:12px">Body</label><textarea class="input" id="sched-edit-body" rows="10" style="font-family:inherit"></textarea></div>
<div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeSchedEditModal()">Cancel</button><button class="btn btn-primary" onclick="saveScheduledEmail()">Save Changes</button></div>
</div></div>

<!-- Scheduled Email Preview Modal -->
<div class="modal-overlay" id="sched-preview-modal" style="display:none" onclick="if(event.target===this)closeSchedPreviewModal()">
<div class="modal-box" style="max-width:700px">
<button class="modal-x" onclick="closeSchedPreviewModal()">&times;</button>
<h3 style="margin:0 0 14px;font-size:16px;color:var(--text)">Email Preview</h3>
<div id="sched-preview-content" style="background:#fff;color:#333;padding:20px;border-radius:8px;max-height:60vh;overflow-y:auto"></div>
</div></div>

<div class="page" id="page-analytics">
<div class="stats-grid" id="analytics-stats"></div>

<!-- Global Time Range (sticky) -->
<div id="analytics-time-bar" style="display:flex;justify-content:space-between;align-items:center;gap:8px;position:sticky;top:60px;z-index:40;background:var(--navy);border-bottom:1px solid var(--border);margin:0 0 16px;padding:10px 8px;flex-wrap:wrap">
<div style="display:flex;gap:4px">
<button class="btn btn-ghost btn-sm" onclick="document.getElementById('analytics-chart-grid').scrollIntoView({behavior:'smooth',block:'start'})" style="font-size:11px;gap:4px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Charts</button>
<button class="btn btn-ghost btn-sm" onclick="document.getElementById('analytics-key-metrics').scrollIntoView({behavior:'smooth',block:'start'})" style="font-size:11px">Key Metrics</button>
<button class="btn btn-ghost btn-sm" onclick="document.getElementById('analytics-reports-card').scrollIntoView({behavior:'smooth',block:'start'})" style="font-size:11px;gap:4px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Reports</button>
<button class="btn btn-ghost btn-sm" onclick="document.getElementById('analytics-query-card').scrollIntoView({behavior:'smooth',block:'start'})" style="font-size:11px;gap:4px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>Custom Query</button>
</div>
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text-dim)">Time Range</span>
<div style="display:flex;gap:3px">
<button class="btn btn-ghost btn-sm trng" onclick="setTimeRange('day',this)">Day</button>
<button class="btn btn-ghost btn-sm trng" onclick="setTimeRange('week',this)">Week</button>
<button class="btn btn-ghost btn-sm trng active" onclick="setTimeRange('month',this)">Month</button>
<button class="btn btn-ghost btn-sm trng" onclick="setTimeRange('all',this)">All Time</button>
</div>
</div>
</div>

<!-- All Charts in 3-column grid -->
<div class="grid-3" style="margin-bottom:20px" id="analytics-chart-grid">

<div class="card chart-card"><div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Revenue Over Time</div><div style="display:flex;gap:4px;align-items:center"><button class="btn btn-ghost btn-sm chart-sw active" onclick="switchQPChart('chart-rev-time','bar',this)">Bar</button><button class="btn btn-ghost btn-sm chart-sw" onclick="switchQPChart('chart-rev-time','line',this)">Line</button><button class="chart-expand-btn" onclick="toggleChartExpand(this)" title="Expand">⤢</button></div></div><div class="card-body"><canvas id="chart-rev-time"></canvas></div></div>

<div class="card chart-card"><div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>Product Mix</div><div style="display:flex;gap:4px;align-items:center"><button class="chart-expand-btn" onclick="toggleChartExpand(this)" title="Expand">⤢</button></div></div><div class="card-body"><canvas id="chart-product-mix"></canvas></div></div>

<div class="card chart-card"><div class="card-header"><div class="card-title">Purchase Timeline</div><div style="display:flex;gap:4px;align-items:center"><button class="btn btn-ghost btn-sm chart-sw active" onclick="switchQPChart('chart-purch-time','bar',this)">Bar</button><button class="btn btn-ghost btn-sm chart-sw" onclick="switchQPChart('chart-purch-time','line',this)">Line</button><button class="chart-expand-btn" onclick="toggleChartExpand(this)" title="Expand">⤢</button></div></div><div class="card-body"><canvas id="chart-purch-time"></canvas></div></div>

<div class="card chart-card"><div class="card-header"><div class="card-title">Session Popularity</div><div style="display:flex;gap:4px;align-items:center"><button class="chart-expand-btn" onclick="toggleChartExpand(this)" title="Expand">⤢</button></div></div><div class="card-body"><canvas id="chart-session-pop"></canvas></div></div>

<div class="card chart-card"><div class="card-header"><div class="card-title">Customer Segments</div><div style="display:flex;gap:4px;align-items:center"><button class="chart-expand-btn" onclick="toggleChartExpand(this)" title="Expand">⤢</button></div></div><div class="card-body"><canvas id="chart-cust-seg"></canvas></div></div>

<div class="card chart-card"><div class="card-header"><div class="card-title">Referral vs Direct</div><div style="display:flex;gap:4px;align-items:center"><button class="btn btn-ghost btn-sm chart-sw active" onclick="switchQPChart('chart-ref-impact','bar',this)">Bar</button><button class="btn btn-ghost btn-sm chart-sw" onclick="switchQPChart('chart-ref-impact','doughnut',this)">Donut</button><button class="chart-expand-btn" onclick="toggleChartExpand(this)" title="Expand">⤢</button></div></div><div class="card-body"><canvas id="chart-ref-impact"></canvas></div></div>

<div class="card chart-card"><div class="card-header"><div class="card-title">Credit Economy</div><div style="display:flex;gap:4px;align-items:center"><button class="chart-expand-btn" onclick="toggleChartExpand(this)" title="Expand">⤢</button></div></div><div class="card-body"><canvas id="chart-credit-eco"></canvas></div></div>

<div class="card chart-card"><div class="card-header"><div class="card-title">Academy vs Fusion</div><div style="display:flex;gap:4px;align-items:center"><button class="btn btn-ghost btn-sm chart-sw active" onclick="switchQPChart('chart-platform-rev','bar',this)">Bar</button><button class="btn btn-ghost btn-sm chart-sw" onclick="switchQPChart('chart-platform-rev','line',this)">Line</button><button class="chart-expand-btn" onclick="toggleChartExpand(this)" title="Expand">⤢</button></div></div><div class="card-body"><canvas id="chart-platform-rev"></canvas></div></div>

<div class="card chart-card" style="grid-column:1/-1"><div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Campaign Performance</div></div>
<div class="card-body">
<div id="campaign-charts-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div><div style="font-size:11px;font-weight:600;color:var(--text-dim);margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em">Send / Open / Click / Convert</div><canvas id="chart-camp-overview" height="180"></canvas></div>
<div><div style="font-size:11px;font-weight:600;color:var(--text-dim);margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em">Rates (%)</div><canvas id="chart-camp-rates" height="180"></canvas></div>
</div>
<div id="no-campaigns-msg" style="display:none" class="empty"><p>No campaigns sent yet.</p></div>
</div></div>

</div>

<!-- Key Metrics Summary -->
<div class="card"><div class="card-header"><div class="card-title">Key Metrics</div></div><div class="card-body" id="analytics-key-metrics"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div>

<!-- Reports -->
<div class="card" id="analytics-reports-card" style="margin-top:20px"><div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Reports</div><span style="font-size:11px;color:var(--text-dim)">Download as CSV for spreadsheets & printing</span></div>
<div class="card-body"><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">
<button class="btn btn-ghost" onclick="generateReport('revenue')" style="justify-content:flex-start;padding:14px 16px"><svg viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><div style="text-align:left"><div style="font-weight:600;font-size:12px;color:var(--text)">Revenue Summary</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">All purchases with totals</div></div></button>
<button class="btn btn-ghost" onclick="generateReport('customers')" style="justify-content:flex-start;padding:14px 16px"><svg viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><div style="text-align:left"><div style="font-weight:600;font-size:12px;color:var(--text)">Customer Report</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">All customers with products & spend</div></div></button>
<button class="btn btn-ghost" onclick="generateReport('referrals')" style="justify-content:flex-start;padding:14px 16px"><svg viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/></svg><div style="text-align:left"><div style="font-weight:600;font-size:12px;color:var(--text)">Referral Report</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">Codes, balances, referral counts</div></div></button>
<button class="btn btn-ghost" onclick="generateReport('enrollments')" style="justify-content:flex-start;padding:14px 16px"><svg viewBox="0 0 24 24" fill="none" stroke="var(--taupe)" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/></svg><div style="text-align:left"><div style="font-weight:600;font-size:12px;color:var(--text)">Enrollment Report</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">Academy students & progress</div></div></button>
<button class="btn btn-ghost" onclick="generateReport('monthly')" style="justify-content:flex-start;padding:14px 16px"><svg viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><div style="text-align:left"><div style="font-weight:600;font-size:12px;color:var(--text)">Monthly Breakdown</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">Revenue by month & product</div></div></button>
<button class="btn btn-ghost" onclick="generateReport('campaigns')" style="justify-content:flex-start;padding:14px 16px"><svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" style="width:18px;height:18px;flex-shrink:0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><div style="text-align:left"><div style="font-weight:600;font-size:12px;color:var(--text)">Campaign Report</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">Email campaigns with open/click rates</div></div></button>
</div></div></div>

<!-- Custom Analytics Query Builder -->
<div class="card" id="analytics-query-card" style="margin-top:20px"><div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>Custom Analytics Query</div></div>
<div class="card-body">
<p style="font-size:12px;color:var(--text-muted);margin-bottom:14px">Build custom queries to explore your data. Select a data source, choose what to measure, and optionally filter and group.</p>
<div class="form-row">
<div class="form-group"><label>Data Source</label>
<select class="input" id="caq-source" onchange="updateCaqFields()">
<optgroup label="Revenue &amp; Orders">
<option value="purchases">All Purchases</option>
<option value="purchases-paid">Paid Purchases Only</option>
<option value="purchases-fusion">Fusion Purchases</option>
<option value="purchases-academy">Academy Purchases</option>
</optgroup>
<optgroup label="Users &amp; Engagement">
<option value="profiles">User Profiles</option>
<option value="referrals">Referral Codes</option>
<option value="credits">Credit History</option>
<option value="enrollments">Academy Enrollments</option>
<option value="progress">Lesson Progress</option>
</optgroup>
<optgroup label="Marketing">
<option value="campaigns">Email Campaigns</option>
<option value="tracking">Email Tracking</option>
<option value="promotions">Promotions</option>
</optgroup>
<optgroup label="Community">
<option value="posts">Discussion Posts</option>
</optgroup>
</select></div>
<div class="form-group"><label>Measure</label>
<select class="input" id="caq-measure">
<option value="count">Count</option>
<option value="sum_amount">Sum of Amount</option>
<option value="avg_amount">Average Amount</option>
<option value="unique_emails">Unique Emails</option>
</select></div>
<div class="form-group"><label>Group By</label>
<select class="input" id="caq-group">
<option value="none">No Grouping</option>
<option value="month">Month</option>
<option value="week">Week</option>
<option value="product">Product</option>
<option value="email">Email</option>
</select></div>
</div>
<div class="form-row">
<div class="form-group"><label>Filter Field</label>
<select class="input" id="caq-filter-field">
<option value="none">No Filter</option>
<option value="product_id">Product</option>
<option value="email">Email (contains)</option>
<option value="referral_code_used">Has Referral Code</option>
<option value="amount_paid_gt">Amount > $</option>
<option value="amount_paid_eq">Amount = $0 (Free)</option>
<option value="date_after">Date After</option>
<option value="date_before">Date Before</option>
</select></div>
<div class="form-group" id="caq-filter-val-grp"><label>Filter Value</label>
<input class="input" id="caq-filter-val" placeholder="e.g. bundle-all, or 50"></div>
<div class="form-group"><label>Chart Type</label>
<select class="input" id="caq-chart-type">
<option value="bar">Bar</option>
<option value="line">Line</option>
<option value="doughnut">Doughnut</option>
<option value="table">Table Only</option>
</select></div>
</div>
<div style="display:flex;gap:10px;margin-bottom:16px">
<button class="btn btn-primary" onclick="runCustomQuery()">Run Query</button>
<button class="btn btn-ghost" onclick="clearCustomQuery()">Clear</button>
<button class="btn btn-ghost" onclick="saveQueryPreset()" style="margin-left:auto">💾 Save Preset</button>
</div>
<div id="caq-presets" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px"></div>
<div id="caq-result" style="display:none">
<div style="max-height:320px;position:relative"><canvas id="caq-chart" style="margin-bottom:16px"></canvas></div>
<div id="caq-table" style="max-height:300px;overflow-y:auto"></div>
</div>
<div id="caq-empty" class="empty" style="display:none"><p>No data matches your query.</p></div>
</div></div>

</div>


<!-- PROMOTIONS MANAGER -->
<div class="page" id="page-promotions">
<div class="stats-grid" id="promo-stats"></div>
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> Create New Promotion</div></div>
<div class="card-body">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="form-group"><label>Promotion Name *</label><input type="text" class="input" id="promo-name" placeholder="e.g. February Welcome Offer"></div>
<div class="form-group"><label>Promo Code *</label><input type="text" class="input" id="promo-coupon-id" placeholder="e.g. WELCOME10" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')" style="text-transform:uppercase"></div>
<div class="form-group"><label>Discount Type</label><select class="input" id="promo-discount-type" onchange="updatePromoDiscountUI()"><option value="percent">Percentage Off</option><option value="fixed">Fixed Dollar Off</option><option value="set_price">Set Price (override)</option></select></div>
<div class="form-group" id="promo-percent-group"><label>Discount Amount *</label><select class="input" id="promo-percent"><option value="5">5% off</option><option value="10">10% off</option><option value="15">15% off</option><option value="20">20% off</option><option value="25">25% off</option><option value="30">30% off</option><option value="40">40% off</option><option value="50">50% off</option><option value="75">75% off</option></select></div>
<div class="form-group" id="promo-fixed-group" style="display:none"><label>Dollar Amount Off *</label><input type="number" class="input" id="promo-fixed-amount" placeholder="e.g. 15" min="1" max="500"></div>
<div class="form-group" id="promo-setprice-group" style="display:none"><label>Set Price To *</label><input type="number" class="input" id="promo-set-price" placeholder="e.g. 399" min="1" max="500"></div>
<div class="form-group"><label>Applies To</label><select class="input" id="promo-product"><option value="any">Any Product (site-wide)</option><option value="bundle-all">Complete Bundle Only</option><option value="sessions-only">Individual Sessions Only</option><option value="session-01">Session 1: Intolerance &amp; Sensitivity</option><option value="session-02">Session 2: Anxiety &amp; Overwhelm</option><option value="session-03">Session 3: Pain &amp; Tension</option><option value="session-04">Session 4: Sleep &amp; Rest</option><option value="session-05">Session 5: Digestion &amp; Integration</option><option value="session-06">Session 6: Immune Balance</option><option value="session-07">Session 7: Hormonal Harmony</option><option value="session-08">Session 8: Phobias &amp; Fear</option><option value="session-09">Session 9: Fatigue &amp; Vitality</option><option value="session-10">Session 10: Weight &amp; Self-Perception</option><option value="session-11">Session 11: Relationships &amp; Boundaries</option><option value="session-12">Session 12: Purpose &amp; Alignment</option></select></div>
<div class="form-group"><label>Distribution Method</label><select class="input" id="promo-method"><option value="both">Link &amp; Code (recommended)</option><option value="link">Link Only (auto-applied via URL)</option><option value="code">Code Only (typed at checkout)</option></select></div>
<div class="form-group"><label>Expires (optional)</label><input type="date" class="input" id="promo-expires" style="color-scheme:dark"></div>
<div class="form-group"><label>Max Uses <span style="font-size:10px;color:var(--text-dim)">(0 = unlimited)</span></label><input type="number" class="input" id="promo-max-uses" value="0" min="0"></div>
<div class="form-group"><label>Min Purchase <span style="font-size:10px;color:var(--text-dim)">(0 = none)</span></label><input type="number" class="input" id="promo-min-purchase" value="0" min="0" placeholder="e.g. 50"></div>
<div class="form-group"><label>Restrictions</label><select class="input" id="promo-restrictions"><option value="none">No restrictions</option><option value="first_purchase">First-time buyers only</option><option value="no_bundle_owners">Non-bundle owners only</option></select></div>
</div>
<div style="display:flex;gap:16px;margin-top:14px;flex-wrap:wrap;align-items:center">
<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--text-muted)"><input type="checkbox" id="promo-stackable" style="accent-color:var(--success);width:15px;height:15px"> Stackable with referral credits</label>
<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--text-muted)"><input type="checkbox" id="promo-one-per-user" checked style="accent-color:var(--warning);width:15px;height:15px"> One use per customer</label>
</div>
<div class="form-group" style="margin-top:12px"><label>Internal Notes <span style="font-size:10px;color:var(--text-dim)">(not shown to customers)</span></label><input type="text" class="input" id="promo-notes" placeholder="e.g. For podcast campaign"></div>
<div style="margin-top:14px"><button class="btn btn-primary" onclick="createPromotion()">Create Promotion</button></div>
</div></div>
<div class="card">
<div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg> All Promotions</div><div style="display:flex;gap:6px"><button class="btn btn-ghost btn-sm promo-filter-btn active" onclick="filterPromos('active',this)">Active</button><button class="btn btn-ghost btn-sm promo-filter-btn" onclick="filterPromos('inactive',this)">Inactive</button><button class="btn btn-ghost btn-sm promo-filter-btn" onclick="filterPromos('archived',this)">Archived</button><button class="btn btn-ghost btn-sm promo-filter-btn" onclick="filterPromos('all',this)">All</button></div></div>
<div class="card-body" id="promotions-list"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
</div></div>

<!-- ORDERS -->
<div class="page" id="page-orders">
<div class="stats-grid" id="orders-stats"></div>
<div class="card"><div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg> All Transactions</div><div style="display:flex;gap:8px;flex-wrap:wrap"><select class="input" style="width:140px" id="orders-filter" onchange="filterOrders()"><option value="all">All Products</option><option value="bundle-all">Bundle</option><option value="fusion-only">Fusion Sessions</option><option value="academy-only">Academy</option><option value="admin-graue="oldest">Oldest First</option><option value="amount-high">Highest Amount</option><option value="amount-low">Lowest Amount</option></select><div class="ac-wrap" style="position:relative;display:inline-block"><input type="text" class="input" style="width:200px" id="orders-search" placeholder="Search by email..." autocomplete="off" oninput="handleOrdersAC()" onkeydown="handleOrdersKeydown(event)"><div class="ac-dropdown" id="orders-ac"></div></div><button class="btn btn-ghost btn-sm" onclick="exportOrders()">Export CSV</button></div></div><div class="card-body"><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Date</th><th>Email</th><th>Product</th><th>Amount</th><th>Referral</th><th>Stripe ID</th><th></th></tr></thead><tbody id="orders-tbody"></tbody></table></div><div class="pagination" id="orders-pagination"></div></div></div></div>

<!-- AUDIT LOG -->

<!-- ADMIN USERS (super_admin only) -->
<div class="page" id="page-admin-users">
<div class="stats-grid" id="adm-stats"></div>
<div class="card" style="margin-bottom:20px">
<div class="card-header"><div class="card-title">Add Admin User</div></div>
<div class="card-body">
<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end">
<div style="flex:1;min-width:200px"><label class="label-sm">Email</label><input type="email" class="input" id="adm-email" placeholder="email@example.com"></div>
<div style="min-width:140px"><label class="label-sm">Name</label><input type="text" class="input" id="adm-name" placeholder="Full name"></div>
<div style="min-width:130px"><label class="label-sm">Role</label><select class="input" id="adm-role"><option value="assistant">Assistant</option><option value="admin">Admin</option><option value="super_admin">Super Admin</option></select></div>
<button class="btn btn-primary btn-sm" onclick="addAdminUser()">Add</button>
</div>
<div class="msg" id="adm-msg" style="display:none;margin-top:10px"></div>
</div></div>
<div class="card"><div class="card-header"><div class="card-title">Admin Users</div><button class="btn btn-ghost btn-sm" onclick="loadAdminUsers()">Refresh</button></div>
<div class="card-body" id="adm-list"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div>
</div>

<div class="page" id="page-audit">
<div class="stats-grid" id="audit-stats"></div>
<div class="card"><div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Activity Log</div><div style="display:flex;gap:8px"><select class="input" style="width:160px" id="audit-filter" onchange="loadAuditLog()"><option value="all">All Actions</option><option value="grant_access">Grant Access</option><option value="revoke_access">Revoke Access</option><option value="block_user">Block/Unblock</option><option value="adjust_credit">Credit Adjust</option><option value="set_credit">Credit Set</option><option value="create_referral">Create Referral</option><option value="enroll_student">Enroll</option><option value="unenroll_student">Unenroll</option><option value="reset_password">Reset Password</option><option value="reset_progress">Reset Progress</option><option value="delete_account">Archive Account</option><option value="revoke_all">Revoke All</option><option value="add_note">Add Note</option><option value="delete_note">Delete Note</option><option value="bulk_enroll">Bulk Enroll</option><option value="send_email">Send Email</option><option value="create_promo">Create Promo</option><option value="update_promo">Update Promo</option><option value="delete_promo">Delete Promo</option><option value="assign_mod">Assign Mod</option><option value="remove_mod">Remove Mod</option><option value="add_admin">Add Admin</option><option value="edit_admin">Edit Admin</option><option value="login_as">Login As</option></select><div class="ac-wrap" style="position:relative;display:inline-block"><input type="text" class="input" style="width:200px" id="audit-search" placeholder="Search by email..." autocomplete="off" oninput="handleAuditAC()" onkeydown="handleAuditKeydown(event)"><div class="ac-dropdown" id="audit-ac"></div></div></form><button class="btn btn-ghost btn-sm" onclick="loadAuditLog()">Refresh</button></div></div><div class="card-body"><div id="audit-log-content"><div class="loading-center"><div class="spinner"></div>Loading...</div></div><div class="pagination" id="audit-pagination"></div></div></div></div>

</div></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="admin.js"></script>

</body>
</html>
