<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quantum Physician â€” Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{--sidebar-w:260px;--teal:#5ba8b2;--teal-light:#4acfd9;--teal-soft:rgba(91,168,178,.1);--teal-glow:rgba(91,168,178,.15);--taupe:#ad9b84;--taupe-soft:rgba(173,155,132,.1);--navy:#0a1e33;--navy-deep:#071825;--navy-mid:#0f2942;--navy-card:#112a42;--navy-hover:#153450;--border:rgba(91,168,178,.12);--border-hover:rgba(91,168,178,.3);--text:rgba(255,255,255,.88);--text-muted:rgba(255,255,255,.5);--text-dim:rgba(255,255,255,.3);--purple:#a78bfa;--purple-soft:rgba(167,139,250,.1);--success:#3dd68c;--success-soft:rgba(61,214,140,.1);--danger:#ef5350;--danger-soft:rgba(239,83,80,.1);--warning:#f0b429;--warning-soft:rgba(240,180,41,.1);--radius:12px;--radius-sm:8px;--ease:.3s cubic-bezier(.22,1,.36,1)}
[data-theme="light"]{--navy:#f5f3ef;--navy-deep:#ebe8e2;--navy-mid:#fff;--navy-card:#fff;--navy-hover:#f0ede8;--border:rgba(173,155,132,.2);--border-hover:rgba(173,155,132,.4);--text:#1a1a2e;--text-muted:rgba(26,26,46,.5);--text-dim:rgba(26,26,46,.3)}
[data-theme="light"] .auth-screen{background:var(--navy)}[data-theme="light"] .stat-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.06)}[data-theme="light"] .card{box-shadow:0 1px 3px rgba(0,0,0,.04)}[data-theme="light"] .detail-section{background:rgba(0,0,0,.02);border-color:rgba(0,0,0,.06)}[data-theme="light"] .tbl tr:hover td{background:rgba(0,0,0,.02)}[data-theme="light"] .feed-item{border-bottom-color:rgba(0,0,0,.05)}[data-theme="light"] .tbl td{border-bottom-color:rgba(0,0,0,.05)}[data-theme="light"] .sb-link:hover{background:rgba(0,0,0,.03)}[data-theme="light"] .sb-link.active{background:rgba(91,168,178,.08)}[data-theme="light"] .bs{background:rgba(0,0,0,.02);border-color:rgba(0,0,0,.06)}[data-theme="light"] .ref-stat{background:rgba(0,0,0,.03)}[data-theme="light"] .input{background:rgba(0,0,0,.03)}[data-theme="light"] select.input option{background:#fff;color:#1a1a2e}[data-theme="light"] .post-card{border-color:rgba(0,0,0,.08)}[data-theme="light"] .note-item{background:rgba(0,0,0,.02);border-color:rgba(0,0,0,.06)}
*{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}body{font-family:'Inter',sans-serif;background:var(--navy);color:var(--text);font-size:14px;line-height:1.6;min-height:100vh}a{color:inherit;text-decoration:none}img{max-width:100%;display:block}
.auth-screen{position:fixed;inset:0;background:var(--navy);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px}.auth-box{width:100%;max-width:380px;text-align:center}.auth-logo{height:70px;width:auto;margin:0 auto 10px;opacity:.9}.auth-subtitle{font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--text-dim);margin-bottom:32px}.auth-card{background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius);padding:32px 28px}.auth-card h2{font-family:"Playfair Display",serif;font-size:24px;font-weight:600;margin-bottom:4px}.auth-card p{font-size:13px;color:var(--text-muted);margin-bottom:24px}.auth-field{margin-bottom:14px;text-align:left}.auth-field label{display:block;font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:6px}.auth-field input{width:100%;padding:11px 14px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px;font-family:'Inter',sans-serif;transition:all var(--ease)}.auth-field input:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px var(--teal-glow)}.auth-field input::placeholder{color:var(--text-dim)}.auth-error{color:var(--danger);font-size:12px;margin-bottom:14px;display:none}.auth-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--teal),var(--teal-light));color:#fff;border:none;border-radius:var(--radius-sm);font-size:12px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all var(--ease);font-family:'Inter',sans-serif;box-shadow:0 4px 16px rgba(91,168,178,.3)}.auth-btn:hover{box-shadow:0 6px 24px rgba(91,168,178,.5);transform:translateY(-1px)}
.admin-layout{min-height:100vh;display:none}.sidebar{position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);background:var(--navy-deep);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:50;overflow-y:auto}.main-content{margin-left:var(--sidebar-w);min-height:100vh}
.sb-logo{padding:24px 20px 16px;border-bottom:1px solid var(--border);text-align:center}.sb-logo img{max-width:150px;height:auto;display:block;margin:0 auto;transition:opacity .2s}.sb-logo img:hover{opacity:.8}.sb-logo-fallback{display:none;font-family:"Playfair Display",serif;font-size:18px;color:var(--text);line-height:1.2;padding:4px 0}.sb-logo-fallback small{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--teal);display:block;margin-top:4px}
.sb-nav{flex:1;padding:12px 0}.sb-section{margin-bottom:16px}.sb-section-label{font-size:9px;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--text-dim);padding:0 20px;margin-bottom:6px}.sb-link{display:flex;align-items:center;gap:10px;padding:11px 20px;color:var(--text-muted);font-size:13px;font-weight:400;cursor:pointer;border:none;background:none;width:100%;text-align:left;font-family:'Inter',sans-serif;transition:all .15s;border-left:3px solid transparent;position:relative}.sb-link:hover{color:var(--text);background:rgba(255,255,255,.02)}.sb-link.active{color:var(--teal);background:rgba(91,168,178,.06);border-left-color:var(--teal);font-weight:500}.sb-link svg{width:17px;height:17px;stroke:currentColor;opacity:.7;flex-shrink:0}.sb-link.active svg{opacity:1}.sb-link .badge{margin-left:auto;background:var(--danger);color:#fff;font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;min-width:16px;text-align:center}.sb-divider{height:1px;background:var(--border);margin:8px 20px}
.sb-footer{padding:14px 20px;border-top:1px solid var(--border)}.sb-user{display:flex;align-items:center;gap:10px}.sb-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--teal-light));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;flex-shrink:0;font-family:"Playfair Display",serif}.sb-user-info{flex:1;min-width:0}.sb-user-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.sb-user-role{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em}.sb-logout{background:none;border:none;color:var(--text-dim);cursor:pointer;padding:6px;border-radius:var(--radius-sm);transition:all .15s}.sb-logout:hover{color:var(--danger);background:var(--danger-soft)}.sb-logout svg{width:16px;height:16px}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:18px 32px;border-bottom:1px solid var(--border);background:var(--navy);position:sticky;top:0;z-index:40}.topbar-title{font-family:"Playfair Display",serif;font-size:22px;font-weight:600}.topbar-right{display:flex;align-items:center;gap:10px}.topbar-search{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 14px;min-width:260px;transition:all var(--ease)}.topbar-search:focus-within{border-color:var(--teal);box-shadow:0 0 0 3px var(--teal-glow)}.topbar-search svg{width:15px;height:15px;color:var(--text-dim);flex-shrink:0}.topbar-search input{border:none;background:none;color:var(--text);font-size:13px;font-family:'Inter',sans-serif;flex:1;outline:none}.topbar-search input::placeholder{color:var(--text-dim)}.topbar-btn{width:34px;height:34px;border-radius:var(--radius-sm);background:rgba(255,255,255,.04);border:1px solid var(--border);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}.topbar-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--navy-hover)}.topbar-btn svg{width:16px;height:16px}
.page{display:none;padding:32px 36px 80px}.page.active{display:block}.page-header{margin-bottom:24px}.page-header h1{font-family:"Playfair Display",serif;font-size:28px;font-weight:600;background:linear-gradient(135deg,var(--text),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:fadeIn .6s ease}.page-header p{font-size:13px;color:var(--text-muted);margin-top:4px}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}@keyframes slideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}@keyframes spin{to{transform:rotate(360deg)}}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:24px}.stat-card{background:var(--navy-card);border:1px solid var(--border);border-radius:10px;padding:16px 18px;display:flex;align-items:center;gap:12px;transition:all .25s;animation:fadeUp .5s ease both}.stat-card:nth-child(1){animation-delay:.05s}.stat-card:nth-child(2){animation-delay:.1s}.stat-card:nth-child(3){animation-delay:.15s}.stat-card:nth-child(4){animation-delay:.2s}.stat-card:hover{border-color:var(--border-hover);transform:translateY(-2px)}.stat-ico{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}.stat-ico svg{width:18px;height:18px}.stat-ico.teal{background:var(--teal-soft)}.stat-ico.teal svg{stroke:var(--teal)}.stat-ico.warm{background:var(--taupe-soft)}.stat-ico.warm svg{stroke:var(--taupe)}.stat-ico.purple{background:var(--purple-soft)}.stat-ico.purple svg{stroke:var(--purple)}.stat-ico.green{background:var(--success-soft)}.stat-ico.green svg{stroke:var(--success)}.stat-val{font-family:"Playfair Display",serif;font-size:22px;font-weight:700;line-height:1}.stat-lbl{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-top:2px}
.card{background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;animation:fadeUp .5s ease both}.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}.card-title{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);display:flex;align-items:center;gap:8px}.card-title svg{width:14px;height:14px;stroke:var(--teal)}.card-body{padding:20px}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}@media(max-width:900px){.grid-2{grid-template-columns:1fr}}
.tbl{width:100%;border-collapse:collapse}.tbl th{text-align:left;font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);padding:10px 14px;border-bottom:1px solid var(--border)}.tbl td{padding:11px 14px;border-bottom:1px solid rgba(255,255,255,.04);font-size:13px;color:var(--text-muted)}.tbl tr:last-child td{border-bottom:none}.tbl tr:hover td{background:rgba(255,255,255,.015)}.tbl .email{color:var(--teal);font-weight:500}.tbl .name{color:var(--text)}.tbl .mono{font-family:monospace;font-size:12px;color:var(--text-dim)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:9px;font-weight:600;letter-spacing:.03em;text-transform:uppercase}.badge.teal{background:var(--teal-soft);color:var(--teal)}.badge.green{background:var(--success-soft);color:var(--success)}.badge.taupe{background:var(--taupe-soft);color:var(--taupe)}.badge.purple{background:var(--purple-soft);color:var(--purple)}.badge.danger{background:var(--danger-soft);color:var(--danger)}.badge.muted{background:rgba(255,255,255,.05);color:var(--text-dim)}.badge.yellow{background:var(--warning-soft);color:var(--warning)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;border:1px solid transparent;font-family:'Inter',sans-serif;letter-spacing:.02em}.btn-primary{background:linear-gradient(135deg,var(--teal),var(--teal-light));color:#fff;border-color:var(--teal);box-shadow:0 2px 8px rgba(91,168,178,.2)}.btn-primary:hover{box-shadow:0 4px 16px rgba(91,168,178,.4);transform:translateY(-1px)}.btn-ghost{background:transparent;color:var(--text-muted);border-color:var(--border)}.btn-ghost:hover{background:rgba(255,255,255,.03);color:var(--text);border-color:var(--border-hover)}.btn-danger{background:var(--danger-soft);color:var(--danger);border-color:rgba(239,83,80,.2)}.btn-danger:hover{background:rgba(239,83,80,.15)}.btn-success{background:var(--success-soft);color:var(--success);border-color:rgba(61,214,140,.2)}.btn-success:hover{background:rgba(61,214,140,.15)}.btn-sm{padding:5px 10px;font-size:10px}
.input{width:100%;padding:9px 14px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px;font-family:'Inter',sans-serif;transition:all var(--ease)}.input:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 3px var(--teal-glow)}.input::placeholder{color:var(--text-dim)}select.input{cursor:pointer;appearance:auto}select.input option{background:var(--navy-card);color:var(--text)}textarea.input{resize:vertical;min-height:60px}.form-row{display:flex;gap:12px;align-items:end;margin-bottom:16px;flex-wrap:wrap}.form-group{flex:1;min-width:120px}.form-group label{display:block;font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--text-dim);margin-bottom:6px}
.feed-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04)}.feed-item:last-child{border-bottom:none}.feed-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}.feed-content{flex:1;min-width:0}.feed-text{font-size:13px;color:var(--text-muted)}.feed-text strong{color:var(--text);font-weight:500}.feed-time{font-size:11px;color:var(--text-dim);margin-top:2px}
.detail-panel{background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;padding-top:48px;margin-bottom:20px;position:relative;animation:slideIn .25s ease}.detail-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}.detail-email{font-family:"Playfair Display",serif;font-size:20px;font-weight:600;color:var(--teal)}.detail-name{font-size:13px;color:var(--text-muted);margin-top:2px}.detail-id{font-size:11px;color:var(--text-dim);font-family:monospace;margin-top:2px}.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}@media(max-width:700px){.detail-grid{grid-template-columns:1fr}}.detail-section{background:rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.04);border-radius:10px;padding:16px}.detail-section h4{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:12px;display:flex;align-items:center;gap:6px}.detail-section h4 .dot{width:5px;height:5px;border-radius:50%}.product-tags{display:flex;flex-wrap:wrap;gap:6px}.product-tag{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600}.product-tag.fusion{background:var(--purple-soft);color:var(--purple)}.product-tag.academy{background:var(--teal-soft);color:var(--teal)}.product-tag.bundle{background:var(--taupe-soft);color:var(--taupe)}
.ref-stat-row{display:flex;gap:10px;margin-bottom:10px}.ref-stat{flex:1;text-align:center;padding:10px;background:rgba(0,0,0,.2);border-radius:var(--radius-sm)}.ref-stat-val{font-family:"Playfair Display",serif;font-size:20px;font-weight:700;line-height:1}.ref-stat-label{font-size:9px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-dim);margin-top:4px}.ref-code{font-family:monospace;font-size:16px;letter-spacing:.12em;font-weight:700;color:var(--teal);background:var(--teal-soft);padding:6px 14px;border-radius:var(--radius-sm);display:inline-block}.credit-actions{display:flex;gap:8px;align-items:center;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.04);flex-wrap:wrap}.credit-actions input{width:80px}
.note-item{background:rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.04);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:8px}.note-item:last-child{margin-bottom:0}.note-text{font-size:13px;color:var(--text-muted);white-space:pre-wrap;word-break:break-word}.note-meta{font-size:10px;color:var(--text-dim);margin-top:4px;display:flex;justify-content:space-between;align-items:center}.note-delete{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:11px;padding:2px 6px;border-radius:4px;transition:all .15s}.note-delete:hover{color:var(--danger);background:var(--danger-soft)}
.ac-wrap{position:relative}.ac-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--navy-card);border:1px solid var(--teal);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);max-height:260px;overflow-y:auto;z-index:100;display:none;box-shadow:0 8px 32px rgba(0,0,0,.4)}.ac-dropdown.open{display:block}.ac-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s}.ac-item:hover,.ac-item.sel{background:var(--teal-soft)}.ac-item:last-child{border-bottom:none}.ac-item .ac-email{color:var(--teal);font-weight:500;font-size:13px}.ac-item .ac-code{color:var(--taupe);font-size:11px;font-family:monospace;margin-left:8px}.ac-item .ac-name{color:var(--text-dim);font-size:11px;display:block;margin-top:1px}.ac-hl{background:rgba(91,168,178,.25);color:#fff;border-radius:2px}
.browser-stats{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}.bs{flex:1;min-width:80px;text-align:center;padding:12px 8px;background:rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.04);border-radius:var(--radius-sm)}.bs-val{font-family:"Playfair Display",serif;font-size:22px;font-weight:700}.bs-label{font-size:9px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-dim);margin-top:2px}.pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 0;font-size:12px;color:var(--text-dim)}.pagination .page-btns{display:flex;gap:6px}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:9999;animation:fadeIn .2s ease}.modal-box{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:28px 32px;max-width:440px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.4)}.modal-title{font-family:"Playfair Display",serif;font-size:18px;font-weight:600;color:var(--text);margin-bottom:8px}.modal-msg{font-size:13px;color:var(--text-muted);line-height:1.6;margin-bottom:24px;white-space:pre-line}.modal-actions{display:flex;justify-content:flex-end;gap:8px}.modal-input{width:100%;margin-bottom:16px}
.toast{position:fixed;top:24px;right:24px;padding:14px 22px;border-radius:var(--radius-sm);font-size:13px;color:var(--text);z-index:10000;animation:fadeIn .3s ease;max-width:380px;box-shadow:0 8px 32px rgba(0,0,0,.3)}.toast.success{background:linear-gradient(135deg,rgba(76,175,80,.15),rgba(76,175,80,.05));border:1px solid rgba(76,175,80,.3)}.toast.error{background:linear-gradient(135deg,rgba(239,83,80,.15),rgba(239,83,80,.05));border:1px solid rgba(239,83,80,.3)}.toast.info{background:linear-gradient(135deg,rgba(100,181,183,.15),rgba(100,181,183,.05));border:1px solid rgba(100,181,183,.3)}
.post-card{background:var(--navy-mid);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px;transition:border-color .15s}.post-card:hover{border-color:var(--border-hover)}.post-card.hidden-post{opacity:.6}.post-card.pinned-post{border-left:3px solid var(--teal)}.post-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:8px;flex-wrap:wrap}.post-author{display:flex;align-items:center;gap:8px}.post-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--teal-light));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}.post-body{font-size:13px;color:var(--text-muted);line-height:1.6;margin-bottom:8px}.post-meta{display:flex;gap:12px;font-size:11px;color:var(--text-dim);margin-bottom:10px;flex-wrap:wrap}.post-actions{display:flex;gap:6px;flex-wrap:wrap}
.tab-nav{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0}.tab-btn{padding:10px 16px;font-size:12px;font-weight:500;color:var(--text-muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;font-family:'Inter',sans-serif;transition:all .15s;margin-bottom:-1px}.tab-btn:hover{color:var(--text)}.tab-btn.active{color:var(--teal);border-bottom-color:var(--teal)}.tab-content{display:none}.tab-content.active{display:block}
.empty{text-align:center;padding:40px 20px;color:var(--text-dim)}.empty svg{width:40px;height:40px;margin:0 auto 12px;display:block;opacity:.3}.empty p{font-size:13px;line-height:1.7}.empty code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:4px;font-size:12px}.spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,.1);border-top-color:var(--teal);border-radius:50%;animation:spin .6s linear infinite;display:inline-block}.loading-center{display:flex;flex-direction:column;align-items:center;gap:12px;padding:40px;color:var(--text-muted);font-size:13px}.msg{padding:10px 14px;border-radius:var(--radius-sm);font-size:13px;margin-bottom:14px;display:none}.msg.success{display:block;background:var(--success-soft);color:var(--success);border:1px solid rgba(61,214,140,.2)}.msg.error{display:block;background:var(--danger-soft);color:var(--danger);border:1px solid rgba(239,83,80,.2)}
.sb-theme-toggle{display:flex;align-items:center;gap:10px;padding:11px 20px;font-size:13px;color:var(--text-muted);cursor:pointer;border:none;background:none;width:100%;text-align:left;font-family:'Inter',sans-serif;transition:all .15s}.sb-theme-toggle:hover{color:var(--text);background:rgba(255,255,255,.02)}[data-theme="light"] .sb-theme-toggle:hover{background:rgba(0,0,0,.03)}.sb-theme-toggle svg{width:17px;height:17px;stroke:currentColor;opacity:.7}.sb-theme-switch{margin-left:auto;width:36px;height:20px;background:var(--border);border-radius:10px;position:relative;transition:background .3s;flex-shrink:0}.sb-theme-switch::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:var(--teal);transition:transform .3s}[data-theme="light"] .sb-theme-switch{background:var(--taupe)}[data-theme="light"] .sb-theme-switch::after{transform:translateX(16px);background:#fff}
.mobile-menu-btn{display:none;position:fixed;top:14px;left:14px;z-index:60;width:38px;height:38px;border-radius:var(--radius-sm);background:var(--navy-card);border:1px solid var(--border);color:var(--text);cursor:pointer;align-items:center;justify-content:center}.mobile-menu-btn svg{width:18px;height:18px}.sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:45}@media(max-width:900px){.sidebar{transform:translateX(-100%);transition:transform .3s ease}.sidebar.open{transform:translateX(0)}.sb-overlay.open{display:block}.main-content{margin-left:0}.mobile-menu-btn{display:flex}.topbar{padding-left:60px}.stats-grid{grid-template-columns:1fr 1fr}}@media(max-width:500px){.stats-grid{grid-template-columns:1fr}.page{padding:20px}.topbar{padding:14px 16px 14px 56px}.topbar-search{display:none}}
.ec-filter.active{background:var(--teal-soft);color:var(--teal);border-color:var(--teal)}
.template-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:14px 8px;background:rgba(0,0,0,.15);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;text-align:center;font-family:'Inter',sans-serif;color:var(--text-muted);font-size:11px;position:relative}.template-btn:hover{border-color:var(--border-hover);background:rgba(0,0,0,.25);color:var(--text)}.template-btn.custom{border-color:rgba(167,139,250,.2)}.template-btn .template-icon{font-size:22px}.template-btn .template-name{font-size:10px}.template-btn .edit-icon{position:absolute;top:4px;right:4px;font-size:10px;opacity:0;transition:opacity .15s}.template-btn:hover .edit-icon{opacity:.6}
.campaign-item{background:rgba(0,0,0,.15);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;overflow:hidden;transition:border-color .15s}.campaign-item:hover{border-color:var(--border-hover)}.campaign-item-header{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;flex-wrap:wrap}.campaign-item-header:hover{background:rgba(255,255,255,.015)}.campaign-item-body{display:none;padding:0 16px 16px;border-top:1px solid var(--border)}.campaign-item.expanded .campaign-item-body{display:block}.campaign-item.expanded{border-color:var(--teal)}
.campaign-type-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.04em}.campaign-type-badge.no_purchase{background:rgba(239,83,80,.1);color:var(--danger)}.campaign-type-badge.upsell_bundle{background:var(--success-soft);color:var(--success)}.campaign-type-badge.promote_session{background:var(--purple-soft);color:var(--purple)}.campaign-type-badge.credit_reminder{background:var(--warning-soft);color:var(--warning)}.campaign-type-badge.referral_nudge{background:var(--teal-soft);color:var(--teal)}.campaign-type-badge.custom{background:rgba(255,255,255,.06);color:var(--text-dim)}.campaign-type-badge.promotional{background:var(--purple-soft);color:var(--purple)}
.log-entry{padding:2px 0}.log-entry.success{color:var(--success)}.log-entry.error{color:var(--danger)}.log-entry.skip{color:var(--warning)}.log-entry.info{color:var(--text-dim)}
.email-detail-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:12px;cursor:pointer;transition:background .1s}.email-detail-row:hover{background:rgba(255,255,255,.02)}.email-status-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}.email-status-dot.sent{background:var(--text-dim)}.email-status-dot.opened{background:var(--purple)}.email-status-dot.clicked{background:var(--success)}
</style>
</head>
<body>
<div class="auth-screen" id="auth-screen"><div class="auth-box"><img src="/assets/images/QP-Logo.png" alt="QP" class="auth-logo" onerror="this.style.display='none'"><div class="auth-subtitle">Practice Management</div><div class="auth-card"><h2>Admin Access</h2><p>Enter your credentials to continue</p><div class="auth-field"><label>Username</label><input type="text" id="auth-user" placeholder="Username" autocomplete="username"></div><div class="auth-field"><label>Password</label><input type="password" id="auth-pass" placeholder="Password" autocomplete="current-password" onkeypress="if(event.key==='Enter')doAuth()"></div><div class="auth-error" id="auth-error">Invalid credentials</div><button class="auth-btn" onclick="doAuth()">Sign In</button></div></div></div>
<div class="admin-layout" id="admin-layout">
<button class="mobile-menu-btn" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
<div class="sb-overlay" id="sb-overlay" onclick="toggleSidebar()"></div>
<aside class="sidebar" id="sidebar">
<div class="sb-logo"><img src="/assets/images/QP-Logo.png" alt="Quantum Physician" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><div class="sb-logo-fallback">Quantum Physician<small>Admin Panel</small></div></div>
<nav class="sb-nav">
<div class="sb-section"><div class="sb-section-label">Overview</div>
<button class="sb-link active" onclick="go('dashboard',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard</button>
<button class="sb-link" onclick="go('customers',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Customers</button></div>
<div class="sb-divider"></div>
<div class="sb-section"><div class="sb-section-label">Products</div>
<button class="sb-link" onclick="go('academy',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>Academy</button>
<button class="sb-link" onclick="go('fusion',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Fusion Sessions</button>
<button class="sb-link" onclick="go('sessions',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>1-on-1 Sessions</button>
<button class="sb-link" onclick="go('memberships',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Memberships</button></div>
<div class="sb-divider"></div>
<div class="sb-section"><div class="sb-section-label">Engage</div>
<button class="sb-link" onclick="go('community',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Community</button>
<button class="sb-link" onclick="go('referrals',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>Referrals & Credits</button>
<button class="sb-link" onclick="go('email',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email Campaigns</button>
<button class="sb-link" onclick="go('analytics',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Analytics</button></div>
<div class="sb-divider"></div>
<div class="sb-section"><div class="sb-section-label">System</div>
<button class="sb-link" onclick="go('audit',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>Audit Log</button></div>
</nav>
<div class="sb-divider" style="margin:0 20px"></div>
<button class="sb-theme-toggle" onclick="toggleTheme()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span id="themeLabel">Light</span><div class="sb-theme-switch"></div></button>
<div class="sb-footer"><div class="sb-user"><div class="sb-avatar">TC</div><div class="sb-user-info"><div class="sb-user-name">Dr. Tracey Clark</div><div class="sb-user-role">Administrator</div></div><button class="sb-logout" onclick="doLogout()" title="Sign out"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button></div></div>
</aside>
<div class="main-content">
<div class="topbar"><div class="topbar-title" id="topbar-title">Dashboard</div><div class="topbar-right"><div class="topbar-search ac-wrap" id="global-search-wrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="global-search" placeholder="Search customers..." autocomplete="off" oninput="handleGlobalSearch()" onkeydown="handleGlobalKeydown(event)"><div class="ac-dropdown" id="global-ac"></div></div><button class="topbar-btn" title="Refresh" onclick="refreshCurrentPage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button></div></div>

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard"><div class="stats-grid" id="dash-stats"></div><div class="grid-2"><div class="card"><div class="card-header"><div class="card-title">Recent Purchases</div></div><div class="card-body" id="dash-purchases" style="max-height:380px;overflow-y:auto"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div><div class="card"><div class="card-header"><div class="card-title">Recent Activity</div></div><div class="card-body" id="dash-activity" style="max-height:380px;overflow-y:auto"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div></div>

<!-- CUSTOMERS -->
<div class="page" id="page-customers">
<div class="form-row" style="margin-bottom:20px"><div class="form-group ac-wrap" style="flex:2"><input type="text" class="input" id="cust-search" placeholder="Search by email, name, or referral code..." autocomplete="off" oninput="handleCustSearch()" onkeydown="handleCustKeydown(event)"><div class="ac-dropdown" id="cust-ac"></div></div><button class="btn btn-primary" onclick="searchCustomer()">Search</button></div>
<div class="msg" id="cust-msg"></div><div id="cust-result"></div>
<div class="card" style="margin-top:20px"><div class="card-header"><div class="card-title">All Customers</div><div style="display:flex;gap:8px"><button class="btn btn-ghost btn-sm" onclick="exportCustomers()">Export CSV</button><button class="btn btn-ghost btn-sm" onclick="loadCustomerBrowser()">Refresh</button></div></div><div class="card-body" style="padding:16px"><div class="browser-stats" id="cust-browser-stats"></div><div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap"><select class="input" style="width:170px" id="cb-filter" onchange="applyCBFilter()"><option value="all">All Customers</option><option value="academy">Academy Owners</option><option value="fusion">Fusion Owners</option><option value="bundle">Bundle Owners</option><option value="no-purchase">No Purchases</option><option value="has-credits">Has Credits</option><option value="has-referrals">Has Referrals</option><option value="no-referral-code">No Referral Code</option><option value="blocked">Blocked</option><option value="no-account">No Account (Guest)</option></select><select class="input" style="width:150px" id="cb-sort" onchange="applyCBFilter()"><option value="email-asc">Email Aâ†’Z</option><option value="recent">Most Recent</option><option value="credits">Highest Credits</option><option value="referrals">Most Referrals</option><option value="spent">Most Spent</option></select><input type="text" class="input" style="width:200px" id="cb-search" placeholder="Filter..." oninput="applyCBFilter()"></div><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Email</th><th>Name</th><th>Products</th><th>Spent</th><th>Credits</th><th>Referrals</th><th></th></tr></thead><tbody id="cb-tbody"></tbody></table></div><div class="pagination" id="cb-pagination"></div></div></div>
<div class="card" style="margin-top:20px"><div class="card-header"><div class="card-title">Grant Access</div></div><div class="card-body"><div class="form-row"><div class="form-group"><label>Email</label><input type="email" class="input" id="grant-email" placeholder="customer@example.com"></div><div class="form-group"><label>Product</label><select class="input" id="grant-product"><optgroup label="Fusion Sessions"><option value="bundle-all">Complete Bundle</option><option value="session-01">S1: Intolerance & Sensitivity</option><option value="session-02">S2: Anxiety & Overwhelm</option><option value="session-03">S3: Pain & Tension</option><option value="session-04">S4: Sleep & Reset</option><option value="session-05">S5: Digestion & Integration</option><option value="session-06">S6: Immune Balance</option><option value="session-07">S7: Hormonal Harmony</option><option value="session-08">S8: Phobias & Fear</option><option value="session-09">S9: Fatigue & Vitality</option><option value="session-10">S10: Weight & Self-Perception</option><option value="session-11">S11: Relationships & Boundaries</option><option value="session-12">S12: Purpose & Alignment</option></optgroup><optgroup label="Academy Courses"><option value="breaking-up-with-your-beliefs">Breaking Up with Your Beliefs</option><option value="power-of-the-question">The Power of The Question</option><option value="creative-mind-mapping">Creative Mind Mapping</option><option value="quantum-vision-boards">Quantum Vision Boards</option><option value="becoming-present">Becoming Present</option><option value="transformational-mastery">Transformational Mastery (All 5)</option></optgroup></select></div><button class="btn btn-success" onclick="grantAccess()">Grant</button></div><div class="msg" id="grant-msg"></div></div></div></div>

<!-- ACADEMY -->
<div class="page" id="page-academy"><div class="stats-grid" id="acad-stats"></div>
<div class="tab-nav"><button class="tab-btn active" onclick="switchAcadTab('courses',this)">Courses</button><button class="tab-btn" onclick="switchAcadTab('students',this)">Students</button></div>
<div class="tab-content active" id="acad-tab-courses"><div class="card"><div class="card-header"><div class="card-title">Course Management</div><button class="btn btn-ghost btn-sm" onclick="loadAcademyData()">Refresh</button></div><div class="card-body" id="acad-courses"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div>
<div class="tab-content" id="acad-tab-students"><div class="card" style="margin-bottom:16px"><div class="card-header"><div class="card-title">Enroll Student</div></div><div class="card-body"><div class="form-row"><div class="form-group"><label>Email</label><input type="email" class="input" id="enroll-email" placeholder="student@example.com"></div><div class="form-group"><label>Course</label><select class="input" id="enroll-course"></select></div><button class="btn btn-success" onclick="enrollStudent()">Enroll</button></div><div class="msg" id="enroll-msg"></div></div></div><div class="card" style="margin-bottom:16px"><div class="card-header"><div class="card-title">Bulk Enroll (CSV)</div></div><div class="card-body"><p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Upload a CSV with column <code>email</code> (required). Optionally include a <code>course</code> column with course slugs. If no course column, all students will be enrolled in the selected course below.</p><div class="form-row"><div class="form-group"><label>CSV File</label><input type="file" class="input" id="bulk-csv" accept=".csv" style="padding:6px"></div><div class="form-group"><label>Default Course</label><select class="input" id="bulk-course"></select></div><button class="btn btn-primary" onclick="bulkEnrollCSV()">Bulk Enroll</button></div><div class="msg" id="bulk-msg"></div></div></div><div class="card"><div class="card-header"><div class="card-title">Student Management</div><button class="btn btn-ghost btn-sm" onclick="loadAcadStudents()">Refresh</button></div><div class="card-body"><div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap"><select class="input" style="width:220px" id="stu-course" onchange="stuPage=1;renderStudentTable()"><option value="all">All Courses</option></select><select class="input" style="width:140px" id="stu-status" onchange="stuPage=1;renderStudentTable()"><option value="all">All Status</option><option value="active">Active</option><option value="granted">Granted</option><option value="revoked">Revoked</option></select><select class="input" style="width:140px" id="stu-sort" onchange="renderStudentTable()"><option value="enrolled-desc">Newest First</option><option value="enrolled-asc">Oldest First</option><option value="progress-desc">Most Progress</option><option value="progress-asc">Least Progress</option><option value="email-asc">Email Aâ†’Z</option><option value="name-asc">Name Aâ†’Z</option><option value="paid-desc">Most Paid</option></select><input type="text" class="input" style="width:220px" id="stu-search" placeholder="Search email or name..." oninput="stuPage=1;renderStudentTable()"></div><div style="overflow-x:auto" id="acad-students-table"><div class="loading-center"><div class="spinner"></div>Loading...</div></div><div class="pagination" id="stu-pagination"></div></div></div></div></div>

<!-- FUSION -->
<div class="page" id="page-fusion"><div class="stats-grid" id="fusion-stats"></div><div class="card"><div class="card-header"><div class="card-title">Session Purchases</div><button class="btn btn-ghost btn-sm" onclick="loadFusionData()">Refresh</button></div><div class="card-body" id="fusion-content"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div>

<!-- PLACEHOLDERS -->
<div class="page" id="page-sessions"><div class="card"><div class="card-body"><div class="empty"><p>Session booking system coming soon.</p></div></div></div></div>
<div class="page" id="page-memberships"><div class="card"><div class="card-body"><div class="empty"><p>Membership tiers coming in a future session.</p></div></div></div></div>

<!-- COMMUNITY -->
<div class="page" id="page-community"><div class="stats-grid" id="comm-stats"></div>
<div class="tab-nav"><button class="tab-btn active" onclick="switchCommTab('academy',this)">Academy Discussions</button><button class="tab-btn" onclick="switchCommTab('fusion',this)">Fusion Community</button></div>
<div class="tab-content active" id="comm-tab-academy"><div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap"><select class="input" style="width:150px" id="comm-acad-filter" onchange="loadAcadDiscussions()"><option value="all">All</option><option value="visible">Visible</option><option value="hidden">Hidden</option><option value="pinned">Pinned</option></select><input type="text" class="input" style="width:200px" id="comm-acad-search" placeholder="Search..." oninput="loadAcadDiscussions()"></div><div id="comm-acad-posts"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div>
<div class="tab-content" id="comm-tab-fusion"><div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap"><select class="input" style="width:150px" id="comm-fus-filter" onchange="loadFusionPosts()"><option value="all">All</option><option value="visible">Visible</option><option value="hidden">Hidden</option><option value="pinned">Pinned</option></select><input type="text" class="input" style="width:200px" id="comm-fus-search" placeholder="Search..." oninput="loadFusionPosts()"></div><div id="comm-fus-posts"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div>

<!-- REFERRALS -->
<div class="page" id="page-referrals"><div class="stats-grid" id="ref-stats"></div><div class="grid-2" style="margin-bottom:20px"><div class="card"><div class="card-header"><div class="card-title">Top Referrers</div></div><div class="card-body" style="max-height:380px;overflow-y:auto" id="ref-leaderboard"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div><div class="card"><div class="card-header"><div class="card-title">Recent Credit Activity</div></div><div class="card-body" style="max-height:380px;overflow-y:auto" id="ref-activity"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div></div>

<!-- EMAIL & ANALYTICS -->
<!-- EMAIL CENTER -->
<div class="page" id="page-email">
<div class="page-header"><h1>Email Center</h1><p>Send marketing emails to customers. Only sends to users who opted in to marketing communications.</p></div>

<!-- Email Stats -->
<div class="stats-grid" id="email-stats"></div>

<!-- Email Student List Panel -->
<div class="card" id="email-student-panel" style="display:none;margin-bottom:20px">
<div class="card-header"><div class="card-title" id="email-student-title">Students</div><button class="btn btn-ghost btn-sm" onclick="closeEmailStudentList()">âœ• Close</button></div>
<div class="card-body"><input type="text" class="input" id="email-student-search" placeholder="Filter by name or email..." oninput="filterEmailStudentList()" style="margin-bottom:12px"><div id="email-student-table-wrap"></div></div></div>

<!-- Weekly Email Limit -->
<div class="card" style="margin-bottom:20px"><div class="card-body" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:14px 20px">
<span style="font-size:12px;font-weight:600;color:var(--text-muted)">ðŸ“¬ Weekly Promo Limit:</span>
<input type="number" class="input" id="weekly-email-limit" value="3" min="1" max="10" style="width:70px" onchange="saveWeeklyEmailLimit()">
<span style="font-size:11px;color:var(--text-dim)">per user / rolling 7 days Â· Only counts promotional campaigns</span>
</div></div>

<!-- Compose Card -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div class="card-title">Compose Email</div></div><div class="card-body">

<!-- Audience -->
<div class="form-group" style="margin-bottom:16px"><label>Audience</label>
<select class="input" id="email-audience" onchange="updateAudiencePreview()">
<optgroup label="General Audiences">
<option value="all-opted-in">All Opted-In Subscribers</option>
<option value="bundle-owners">Bundle Owners Only</option>
<option value="single-session">Single Session Buyers (No Bundle)</option>
<option value="no-purchase">Registered but No Purchase</option>
</optgroup>
<optgroup label="Fusion Session Owners">
<option value="session-01">Session 1 - Intolerance & Sensitivity</option>
<option value="session-02">Session 2 - Anxiety & Overwhelm</option>
<option value="session-03">Session 3 - Pain & Tension</option>
<option value="session-04">Session 4 - Sleep & Reset</option>
<option value="session-05">Session 5 - Digestion & Integration</option>
<option value="session-06">Session 6 - Immune Balance</option>
<option value="session-07">Session 7 - Hormonal Harmony</option>
<option value="session-08">Session 8 - Phobias & Fear</option>
<option value="session-09">Session 9 - Fatigue & Vitality</option>
<option value="session-10">Session 10 - Weight & Self-Perception</option>
<option value="session-11">Session 11 - Relationships & Boundaries</option>
<option value="session-12">Session 12 - Purpose & Alignment</option>
</optgroup>
<optgroup label="Academy">
<option value="academy-all">All Academy Students</option>
</optgroup>
<optgroup label="Custom">
<option value="custom">Custom Email List</option>
</optgroup>
</select></div>

<!-- Custom Emails -->
<div class="form-group" id="custom-emails-group" style="display:none;margin-bottom:16px"><label>Custom Email List (one per line)</label>
<textarea class="input" id="custom-emails" placeholder="email1@example.com&#10;email2@example.com" rows="4"></textarea></div>

<!-- Audience Preview -->
<div id="audience-preview" style="background:rgba(0,0,0,.15);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--text-muted)">Select an audience to see recipient count</div>

<!-- From Address -->
<div class="form-group" style="margin-bottom:16px"><label>From Address</label>
<select class="input" id="email-from">
<option value="hello@quantumphysician.com">hello@quantumphysician.com (Marketing)</option>
<option value="tracey@quantumphysician.com">tracey@quantumphysician.com (Personal)</option>
</select></div>

<!-- Email Type -->
<div class="form-group" style="margin-bottom:16px"><label>Email Type</label>
<select class="input" id="email-type-select" onchange="updateEmailTypeHint()">
<option value="promotional">ðŸ“£ Promotional â€” Sales, discounts, re-enrollment, newsletters</option>
<option value="automated">ðŸ¤– Automated/Course â€” Session reminders, zoom links, course follow-ups</option>
<option value="transactional">ðŸ”’ Transactional â€” Purchase confirmations, password resets, welcome</option>
</select>
<div id="email-type-hint" style="font-size:11px;color:var(--warning);margin-top:6px">âš ï¸ Promotional emails count toward the weekly limit and respect opt-out preferences.</div></div>

<!-- Subject -->
<div class="form-group" style="margin-bottom:16px"><label>Subject Line</label>
<input type="text" class="input" id="email-subject" placeholder="Your subject line..." maxlength="100">
<div style="text-align:right;font-size:10px;color:var(--text-dim);margin-top:4px"><span id="subject-count">0</span>/100</div></div>

<!-- Body with merge tag toolbar -->
<div class="form-group" style="margin-bottom:16px"><label>Email Body</label>
<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
<button class="btn btn-ghost btn-sm" type="button" onclick="insertEmailVar('{{name}}')">ðŸ‘¤ Name</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="insertEmailVar('{{email}}')">ðŸ“§ Email</button>
<button class="btn btn-ghost btn-sm" type="button" onclick="insertEmailVar('{{referral_code}}')">ðŸŽ Referral Code</button>
</div>
<textarea class="input" id="email-body" placeholder="Write your email message here...&#10;&#10;Use {{name}} to personalize with recipient's name.&#10;Use {{referral_code}} to include their referral code." rows="10"></textarea></div>

<!-- Actions -->
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px">
<button class="btn btn-ghost" onclick="previewEmail()">ðŸ‘ï¸ Preview</button>
<button class="btn btn-primary" onclick="prepareToSend()" id="send-btn">ðŸ“¤ Send to <span id="send-count">0</span> Recipients</button>
</div>

<!-- Preview Box -->
<div id="email-preview-box" style="display:none;background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;margin-bottom:16px">
<div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);margin-bottom:12px">Email Preview</div>
<p style="font-size:12px;margin-bottom:4px"><strong style="color:var(--text-dim)">From:</strong> <span id="preview-from"></span></p>
<p style="font-size:12px;margin-bottom:4px"><strong style="color:var(--text-dim)">To:</strong> <span id="preview-to"></span></p>
<p style="font-size:12px;margin-bottom:12px"><strong style="color:var(--text-dim)">Subject:</strong> <span id="preview-subject" style="color:var(--teal)"></span></p>
<div id="preview-body" style="font-size:13px;color:var(--text-muted);white-space:pre-wrap;line-height:1.7;padding:16px;background:rgba(0,0,0,.15);border-radius:var(--radius-sm);max-height:300px;overflow-y:auto"></div>
<button class="btn btn-ghost btn-sm" style="margin-top:12px" onclick="document.getElementById('email-preview-box').style.display='none'">Close Preview</button>
</div>

<!-- Send Progress Log -->
<div id="email-log" style="display:none;margin-bottom:16px">
<div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);margin-bottom:8px">Send Progress</div>
<div style="height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;margin-bottom:8px"><div id="progress-fill" style="height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-light));width:0;transition:width .3s"></div></div>
<div id="progress-text" style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Preparing...</div>
<div id="email-log-entries" style="max-height:200px;overflow-y:auto;font-size:12px;font-family:monospace;color:var(--text-dim)"></div>
</div>

<div class="msg" id="email-message"></div>
</div></div>

<!-- Templates -->
<div class="card" style="margin-bottom:20px"><div class="card-header"><div class="card-title">Quick Templates</div><span style="font-size:11px;color:var(--text-dim)">Click to load Â· Right-click to edit</span></div>
<div class="card-body"><div id="template-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px"></div></div></div>

<!-- Campaign History -->
<div class="card"><div class="card-header"><div class="card-title">Campaign History</div><button class="btn btn-ghost btn-sm" onclick="loadCampaignHistory()">Refresh</button></div>
<div class="card-body">
<div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap">
<button class="btn btn-ghost btn-sm ec-filter active" onclick="filterCampaignHistory('all',this)">All</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('no_purchase',this)">Welcome</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('upsell_bundle',this)">Upsell</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('promote_session',this)">Promote</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('credit_reminder',this)">Credits</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('referral_nudge',this)">Referral</button>
<button class="btn btn-ghost btn-sm ec-filter" onclick="filterCampaignHistory('custom',this)">Custom</button>
</div>
<div id="campaign-history-list"><div class="loading-center"><div class="spinner"></div>Loading...</div></div>
</div></div>
</div>
<div class="page" id="page-analytics"><div class="card"><div class="card-body"><div class="empty"><p>Full analytics dashboard coming in Session 5.</p></div></div></div></div>

<!-- AUDIT LOG -->
<div class="page" id="page-audit">
<div class="stats-grid" id="audit-stats"></div>
<div class="card"><div class="card-header"><div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Activity Log</div><div style="display:flex;gap:8px"><select class="input" style="width:160px" id="audit-filter" onchange="loadAuditLog()"><option value="all">All Actions</option><option value="grant_access">Grant Access</option><option value="revoke_access">Revoke Access</option><option value="block_user">Block/Unblock</option><option value="adjust_credit">Credit Adjust</option><option value="set_credit">Credit Set</option><option value="create_referral">Create Referral</option><option value="enroll_student">Enroll</option><option value="unenroll_student">Unenroll</option><option value="reset_password">Reset Password</option><option value="reset_progress">Reset Progress</option><option value="delete_account">Archive Account</option><option value="revoke_all">Revoke All</option><option value="add_note">Add Note</option><option value="delete_note">Delete Note</option><option value="bulk_enroll">Bulk Enroll</option><option value="send_email">Send Email</option></select><input type="text" class="input" style="width:200px" id="audit-search" placeholder="Search by email..." oninput="loadAuditLog()"><button class="btn btn-ghost btn-sm" onclick="loadAuditLog()">Refresh</button></div></div><div class="card-body"><div id="audit-log-content"><div class="loading-center"><div class="spinner"></div>Loading...</div></div><div class="pagination" id="audit-pagination"></div></div></div></div>

</div></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const ADMIN_USERNAME='QPadmin',ADMIN_PASSWORD='QPfs#2026';
const SUPABASE_URL='https://rihlrfiqokqrlmzjjyxj.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpaGxyZmlxb2txcmxtempqeXhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MTU2NDYsImV4cCI6MjA4NDA5MTY0Nn0.G2TQKSmQpPYb8Cyzo7R833G7xkr0855faLRjrJ9ov-4';
const SUPABASE_SERVICE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpaGxyZmlxb2txcmxtempqeXhqIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODUxNTY0NiwiZXhwIjoyMDg0MDkxNjQ2fQ.WUn_BCkEWWfRFun1d_LDmLj6SXHQpm8mhNAjYBixGY4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const sbAdmin=window.supabase.createClient(SUPABASE_URL,SUPABASE_SERVICE_KEY);
function toggleTheme(){var c=document.documentElement.getAttribute('data-theme')||'dark',n=c==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',n);localStorage.setItem('qa-theme',n);var l=document.getElementById('themeLabel');if(l)l.textContent=n==='dark'?'Light':'Dark'}
(function(){var s=localStorage.getItem('qa-theme');if(s){document.documentElement.setAttribute('data-theme',s);var l=document.getElementById('themeLabel');if(l)l.textContent=s==='dark'?'Light':'Dark'}})();
const FUSION_NAMES={'bundle-all':'Complete Bundle','session-01':'S1: Intolerance & Sensitivity','session-02':'S2: Anxiety & Overwhelm','session-03':'S3: Pain & Tension','session-04':'S4: Sleep & Reset','session-05':'S5: Digestion & Integration','session-06':'S6: Immune Balance','session-07':'S7: Hormonal Harmony','session-08':'S8: Phobias & Fear','session-09':'S9: Fatigue & Vitality','session-10':'S10: Weight & Self-Perception','session-11':'S11: Relationships & Boundaries','session-12':'S12: Purpose & Alignment'};
const ACADEMY_NAMES={'quantum-vision-boards':'Quantum Vision Boards','becoming-present':'Becoming Present','breaking-up-with-your-beliefs':'Breaking Up with Your Beliefs','creative-mind-mapping':'Creative Mind Mapping','power-of-the-question':'The Power of The Question','transformational-mastery':'Transformational Mastery'};
const ACADEMY_SLUGS=['breaking-up-with-your-beliefs','power-of-the-question','creative-mind-mapping','quantum-vision-boards','becoming-present'];
function isFusion(p){return p&&(p.startsWith('session-')||p==='bundle-all')}
function isAcademy(p){return p&&ACADEMY_NAMES[p]}
function productName(p){if(p&&p.startsWith('revoked__'))return productName(p.replace('revoked__',''))+' (REVOKED)';return FUSION_NAMES[p]||ACADEMY_NAMES[p]||p}
function isRevoked(p){return p&&p.startsWith('revoked__')}
function productBadge(p){if(p==='bundle-all')return'<span class="badge taupe">Bundle</span>';if(p==='transformational-mastery')return'<span class="badge taupe">Academy Bundle</span>';if(isFusion(p))return'<span class="badge purple">Fusion</span>';if(isAcademy(p))return'<span class="badge teal">Academy</span>';return'<span class="badge muted">Unknown</span>'}
function fmtMoney(v){return'$'+Number(v||0).toFixed(2).replace(/\.00$/,'')}
function fmt$(c){if(!c)return'$0';return'$'+(c/100||c).toFixed(2).replace(/\.00$/,'')}
function timeAgo(d){if(!d)return'\u2014';const s=Math.floor((Date.now()-new Date(d))/1000);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';if(s<604800)return Math.floor(s/86400)+'d ago';return new Date(d).toLocaleDateString()}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function showToast(msg,type){type=type||'info';var t=document.createElement('div');t.className='toast '+type;t.textContent=msg;document.body.appendChild(t);setTimeout(function(){t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(function(){t.remove()},300)},3000)}
function showModal(opts){return new Promise(function(resolve){var o=document.createElement('div');o.className='modal-overlay';var html='<div class="modal-box">';if(opts.title)html+='<div class="modal-title">'+esc(opts.title)+'</div>';html+='<div class="modal-msg">'+esc(opts.message)+'</div>';if(opts.input){html+='<input type="text" class="input modal-input" id="modal-input-field" placeholder="'+(opts.placeholder||'')+'">';}html+='<div class="modal-actions">';if(opts.type==='confirm'||opts.type==='prompt'){html+='<button class="btn btn-ghost btn-sm" id="modal-cancel">Cancel</button>'}if(opts.danger){html+='<button class="btn btn-danger btn-sm" id="modal-ok">'+(opts.okText||'OK')+'</button>'}else{html+='<button class="btn btn-primary btn-sm" id="modal-ok">'+(opts.okText||'OK')+'</button>'}html+='</div></div>';o.innerHTML=html;document.body.appendChild(o);var inp=document.getElementById('modal-input-field');if(inp)inp.focus();document.getElementById('modal-ok').onclick=function(){var val=inp?inp.value:true;o.remove();resolve(val)};var cancel=document.getElementById('modal-cancel');if(cancel)cancel.onclick=function(){o.remove();resolve(false)};o.onclick=function(e){if(e.target===o){o.remove();resolve(false)}}})}
function qpAlert(msg,type){showToast(msg,type||'info')}
function qpConfirm(title,msg,opts){return showModal(Object.assign({title:title,message:msg,type:'confirm'},opts||{}))}
function qpPrompt(title,msg,placeholder){return showModal({title:title,message:msg,type:'prompt',input:true,placeholder:placeholder})}
function showMsg(el,t,txt){el.className='msg '+t;el.textContent=txt;el.style.display='block';setTimeout(()=>{el.style.display='none'},5000)}
function doAuth(){const u=document.getElementById('auth-user').value,p=document.getElementById('auth-pass').value;if(u===ADMIN_USERNAME&&p===ADMIN_PASSWORD){document.getElementById('auth-screen').style.display='none';document.getElementById('admin-layout').style.display='block';sessionStorage.setItem('qp_admin_auth','true');initAdmin()}else{document.getElementById('auth-error').style.display='block'}}
function doLogout(){sessionStorage.removeItem('qp_admin_auth');location.reload()}
if(sessionStorage.getItem('qp_admin_auth')==='true'){document.getElementById('auth-screen').style.display='none';document.getElementById('admin-layout').style.display='block';setTimeout(initAdmin,50)}
let currentPage='dashboard';
const TITLES={dashboard:'Dashboard',customers:'Customers',academy:'Academy',fusion:'Fusion Sessions',sessions:'1-on-1 Sessions',memberships:'Memberships',community:'Community',referrals:'Referrals & Credits',email:'Email Campaigns',analytics:'Analytics',audit:'Audit Log'};
function go(page,btn){currentPage=page;document.querySelectorAll('.sb-link').forEach(l=>l.classList.remove('active'));if(btn)btn.classList.add('active');document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));var el=document.getElementById('page-'+page);if(el)el.classList.add('active');document.getElementById('topbar-title').textContent=TITLES[page]||page;loadPageData(page);document.getElementById('sidebar').classList.remove('open');document.getElementById('sb-overlay').classList.remove('open')}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sb-overlay').classList.toggle('open')}
function refreshCurrentPage(){loadAllData().then(function(){loadPageData(currentPage)})}
let allCustomers=[],purchasesData=[],referralData=[],profilesData=[],creditHistory=[],academyEnrollments=[],academyCourses=[],lessonProgress=[],adminNotesData=[],authUsersMap=new Map(),allFusionPosts=[],allAcadPosts=[],emailCampaignsData=[],emailTrackingData=[],dataLoaded=false;
async function loadAllData(){try{var r=await Promise.all([sb.from('purchases').select('*').order('purchased_at',{ascending:false}),sb.from('referral_codes').select('*'),sb.from('profiles').select('*'),sb.from('credit_history').select('*').order('created_at',{ascending:false}).limit(200),sb.from('qa_enrollments').select('*, qa_courses(id,title,slug)'),sb.from('qa_courses').select('*').order('sort_order'),sb.from('qa_lesson_progress').select('*'),sbAdmin.from('admin_notes').select('*').order('created_at',{ascending:false}),sb.from('discussion_posts').select('id,user_email'),sb.from('qa_discussions').select('id,user_email'),sb.from('email_campaigns').select('*').order('sent_at',{ascending:false}).limit(50),sb.from('email_tracking').select('id,campaign_id,recipient_email,tracking_id,status,opened_at,clicked_at,sent_at,email_type').order('sent_at',{ascending:false}).limit(500)]);purchasesData=r[0].data||[];referralData=r[1].data||[];profilesData=r[2].data||[];creditHistory=r[3].data||[];academyEnrollments=r[4].data||[];academyCourses=r[5].data||[];lessonProgress=r[6].data||[];adminNotesData=r[7].data||[];allFusionPosts=r[8].data||[];allAcadPosts=r[9].data||[];emailCampaignsData=r[10].data||[];emailTrackingData=r[11].data||[];await loadAuthUsers();buildCustomerList();dataLoaded=true}catch(e){console.error('Load error:',e)}}
async function loadAuthUsers(){try{var page=1,allUsers=[];while(true){var res=await fetch(SUPABASE_URL+'/auth/v1/admin/users?page='+page+'&per_page=500',{headers:{'apikey':SUPABASE_SERVICE_KEY,'Authorization':'Bearer '+SUPABASE_SERVICE_KEY}});if(!res.ok){console.warn('Auth users fetch failed:',res.status);break}var data=await res.json();var users=data.users||data||[];if(!Array.isArray(users)||!users.length)break;allUsers=allUsers.concat(users);if(users.length<500)break;page++}authUsersMap=new Map();allUsers.forEach(function(u){if(u.email)authUsersMap.set(u.email.toLowerCase(),u)})}catch(e){console.error('Auth users load error:',e)}}
function buildCustomerList(){var map=new Map();profilesData.forEach(function(p){if(!p.email)return;var k=p.email.toLowerCase();map.set(k,{email:p.email,name:p.full_name||'',userId:p.id,hasAccount:true,isBlocked:p.is_blocked||false,createdAt:p.created_at,purchases:[],academyPurchases:[],fusionPurchases:[],hasBundle:false,hasAcademyBundle:false,creditBalance:0,referralCount:0,referralCode:'',totalEarned:0,totalSpent:0})});purchasesData.forEach(function(p){if(!p.email)return;var k=p.email.toLowerCase();if(!map.has(k))map.set(k,{email:p.email,name:'',userId:null,hasAccount:false,isBlocked:false,createdAt:p.purchased_at,purchases:[],academyPurchases:[],fusionPurchases:[],hasBundle:false,hasAcademyBundle:false,creditBalance:0,referralCount:0,referralCode:'',totalEarned:0,totalSpent:0});var c=map.get(k);if(!c.purchases.includes(p.product_id)){c.purchases.push(p.product_id);if(isFusion(p.product_id))c.fusionPurchases.push(p.product_id);if(isAcademy(p.product_id))c.academyPurchases.push(p.product_id)}if(p.product_id==='bundle-all')c.hasBundle=true;if(p.product_id==='transformational-mastery')c.hasAcademyBundle=true;c.totalSpent+=(Number(p.amount_paid)||0)});referralData.forEach(function(r){if(!r.email)return;var k=r.email.toLowerCase();if(!map.has(k))map.set(k,{email:r.email,name:'',userId:null,hasAccount:false,isBlocked:false,createdAt:null,purchases:[],academyPurchases:[],fusionPurchases:[],hasBundle:false,hasAcademyBundle:false,creditBalance:0,referralCount:0,referralCode:'',totalEarned:0,totalSpent:0});var c=map.get(k);c.creditBalance=Number(r.credit_balance)||0;c.referralCount=r.successful_referrals||0;c.referralCode=r.code||'';c.totalEarned=Number(r.total_earned)||0});allCustomers=Array.from(map.values())}
async function initAdmin(){await loadAllData();loadPageData('dashboard')}
function loadPageData(page){if(!dataLoaded&&page!=='dashboard')return;switch(page){case'dashboard':loadDashboard();break;case'customers':loadCustomerBrowser();break;case'academy':loadAcademyData();break;case'fusion':loadFusionData();break;case'referrals':loadReferralData();break;case'community':loadCommunityData();break;case'email':loadEmailPage();break;case'audit':loadAuditLog();break}}
function getAdminNotes(email){return adminNotesData.filter(function(n){return n.target_email&&n.target_email.toLowerCase()===email.toLowerCase()})}
async function saveAdminNote(email,text){try{await sbAdmin.from('admin_notes').insert({target_email:email.toLowerCase(),note_text:text});await logAudit('add_note',email,'Added note: '+text.substring(0,80));var r=await sbAdmin.from('admin_notes').select('*').order('created_at',{ascending:false});adminNotesData=r.data||[]}catch(e){showToast('Error saving note: '+e.message,'error')}}
async function deleteAdminNote(email,id){try{await sbAdmin.from('admin_notes').delete().eq('id',id);await logAudit('delete_note',email,'Deleted a note');var r=await sbAdmin.from('admin_notes').select('*').order('created_at',{ascending:false});adminNotesData=r.data||[]}catch(e){showToast('Error deleting note: '+e.message,'error')}}
async function logAudit(action,targetEmail,details,metadata){try{var res=await sbAdmin.from('admin_audit_log').insert({action:action,target_email:targetEmail?targetEmail.toLowerCase():null,details:details||'',metadata:metadata||{}});if(res.error)console.error('Audit insert error:',res.error)}catch(e){console.error('Audit log error:',e)}}

function loadDashboard(){if(!dataLoaded)return;var tr=purchasesData.reduce(function(s,p){return s+(Number(p.amount_paid)||0)},0);var ar=purchasesData.filter(function(p){return isAcademy(p.product_id)}).reduce(function(s,p){return s+(Number(p.amount_paid)||0)},0);var fr=purchasesData.filter(function(p){return isFusion(p.product_id)}).reduce(function(s,p){return s+(Number(p.amount_paid)||0)},0);var ae=academyEnrollments.filter(function(e){return e.status==='active'}).length;var rr=referralData.filter(function(r){return r.successful_referrals>0}).length;
document.getElementById('dash-stats').innerHTML='<div class="stat-card"><div class="stat-ico green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div><div class="stat-val">'+fmtMoney(tr)+'</div><div class="stat-lbl">Total Revenue</div></div></div><div class="stat-card"><div class="stat-ico teal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/></svg></div><div><div class="stat-val">'+fmtMoney(ar)+'</div><div class="stat-lbl">Academy Sales</div></div></div><div class="stat-card"><div class="stat-ico purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg></div><div><div class="stat-val">'+fmtMoney(fr)+'</div><div class="stat-lbl">Fusion Sales</div></div></div><div class="stat-card"><div class="stat-ico warm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div><div class="stat-val">'+allCustomers.length+'</div><div class="stat-lbl">Total Customers</div></div></div><div class="stat-card"><div class="stat-ico teal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/></svg></div><div><div class="stat-val">'+ae+'</div><div class="stat-lbl">Enrollments</div></div></div><div class="stat-card"><div class="stat-ico warm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/></svg></div><div><div class="stat-val">'+rr+'</div><div class="stat-lbl">Active Referrers</div></div></div>';
var rp=purchasesData.slice(0,10);document.getElementById('dash-purchases').innerHTML=rp.length?rp.map(function(p){return'<div class="feed-item"><div class="feed-dot" style="background:'+(isFusion(p.product_id)?'var(--purple)':'var(--teal)')+'"></div><div class="feed-content"><div class="feed-text"><strong>'+esc(p.email)+'</strong> purchased '+productName(p.product_id)+'</div><div class="feed-time">'+fmtMoney(p.amount_paid)+' \u00b7 '+timeAgo(p.purchased_at)+'</div></div>'+productBadge(p.product_id)+'</div>'}).join(''):'<div class="empty"><p>No purchases</p></div>';
var rc=creditHistory.slice(0,10);document.getElementById('dash-activity').innerHTML=rc.length?rc.map(function(c){return'<div class="feed-item"><div class="feed-dot" style="background:'+(c.amount>0?'var(--success)':'var(--warning)')+'"></div><div class="feed-content"><div class="feed-text"><strong>'+esc(c.email)+'</strong> '+(c.amount>0?'+':'')+fmtMoney(c.amount)+'</div><div class="feed-time">'+esc(c.description||c.type)+' \u00b7 '+timeAgo(c.created_at)+'</div></div></div>'}).join(''):'<div class="empty"><p>No activity</p></div>'}

var cbFiltered=[],cbPage=1,cbPS=20;
function loadCustomerBrowser(){cbPage=1;applyCBFilter();updateBrowserStats()}
function updateBrowserStats(){var ac=allCustomers.filter(function(c){return c.academyPurchases.length>0}).length;var fc=allCustomers.filter(function(c){return c.fusionPurchases.length>0}).length;var cr=allCustomers.filter(function(c){return c.creditBalance>0}).length;var np=allCustomers.filter(function(c){return c.purchases.length===0}).length;document.getElementById('cust-browser-stats').innerHTML='<div class="bs"><div class="bs-val" style="color:var(--text)">'+allCustomers.length+'</div><div class="bs-label">Total</div></div><div class="bs"><div class="bs-val" style="color:var(--teal)">'+ac+'</div><div class="bs-label">Academy</div></div><div class="bs"><div class="bs-val" style="color:var(--purple)">'+fc+'</div><div class="bs-label">Fusion</div></div><div class="bs"><div class="bs-val" style="color:var(--success)">'+cr+'</div><div class="bs-label">Credits</div></div><div class="bs"><div class="bs-val" style="color:var(--text-dim)">'+np+'</div><div class="bs-label">No Purchase</div></div>'}
function applyCBFilter(){var f=document.getElementById('cb-filter').value,s=document.getElementById('cb-sort').value,q=(document.getElementById('cb-search').value||'').toLowerCase().trim();cbFiltered=allCustomers.filter(function(c){if(q&&c.email.toLowerCase().indexOf(q)<0&&c.name.toLowerCase().indexOf(q)<0&&c.referralCode.toLowerCase().indexOf(q)<0)return false;switch(f){case'academy':return c.academyPurchases.length>0;case'fusion':return c.fusionPurchases.length>0;case'bundle':return c.hasBundle||c.hasAcademyBundle;case'no-purchase':return c.purchases.length===0;case'has-credits':return c.creditBalance>0;case'has-referrals':return c.referralCount>0;case'no-referral-code':return!c.referralCode;case'blocked':return c.isBlocked;case'no-account':return!c.hasAccount;default:return true}});cbFiltered.sort(function(a,b){switch(s){case'email-asc':return a.email.localeCompare(b.email);case'recent':return(b.createdAt||'').localeCompare(a.createdAt||'');case'credits':return b.creditBalance-a.creditBalance;case'referrals':return b.referralCount-a.referralCount;case'spent':return b.totalSpent-a.totalSpent;default:return 0}});cbPage=1;renderCBTable()}
function renderCBTable(){var tbody=document.getElementById('cb-tbody'),tp=Math.ceil(cbFiltered.length/cbPS)||1,start=(cbPage-1)*cbPS,pd=cbFiltered.slice(start,start+cbPS);if(!pd.length){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--text-dim)">No customers match filters</td></tr>'}else{tbody.innerHTML=pd.map(function(c){var tags=[];if(c.hasBundle)tags.push('<span class="badge taupe">Bundle</span>');if(c.hasAcademyBundle)tags.push('<span class="badge teal">Academy All</span>');if(!c.hasBundle&&c.fusionPurchases.length>0)tags.push('<span class="badge purple">'+c.fusionPurchases.length+' Fusion</span>');if(!c.hasAcademyBundle&&c.academyPurchases.length>0)tags.push('<span class="badge teal">'+c.academyPurchases.length+' Academy</span>');if(c.isBlocked)tags.unshift('<span class="badge danger">BLOCKED</span>');if(!tags.length)tags.push(c.hasAccount?'<span class="badge muted">Registered</span>':'<span class="badge muted">Guest</span>');var e2=esc(c.email.replace(/'/g,"\\'"));return'<tr style="cursor:pointer;'+(c.isBlocked?'opacity:.55;background:rgba(239,83,80,.03)':'')+'" onclick="showCustomerDetail(\''+e2+'\')"><td class="email">'+esc(c.email)+(c.referralCode?'<br><span class="mono">'+c.referralCode+'</span>':'')+'</td><td class="name">'+(c.name?esc(c.name):'<span style="color:var(--text-dim)">\u2014</span>')+'</td><td>'+tags.join(' ')+'</td><td>'+(c.totalSpent>0?'<span style="color:var(--success)">'+fmtMoney(c.totalSpent)+'</span>':'\u2014')+'</td><td>'+(c.creditBalance>0?'<span style="color:var(--success);font-weight:600">'+fmtMoney(c.creditBalance)+'</span>':'\u2014')+'</td><td>'+(c.referralCount>0?'<span style="color:var(--teal);font-weight:600">'+c.referralCount+'</span>':'\u2014')+'</td><td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();showCustomerDetail(\''+e2+'\')">View</button></td></tr>'}).join('')}document.getElementById('cb-pagination').innerHTML='<span>'+cbFiltered.length+' customers \u00b7 Page '+cbPage+'/'+tp+'</span><div class="page-btns"><button class="btn btn-ghost btn-sm" onclick="cbPage=Math.max(1,cbPage-1);renderCBTable()" '+(cbPage<=1?'disabled':'')+'>Prev</button><button class="btn btn-ghost btn-sm" onclick="cbPage=Math.min('+tp+',cbPage+1);renderCBTable()" '+(cbPage>=tp?'disabled':'')+'>Next</button></div>'}
function exportCustomers(){var csv=['Email,Name,Products,Spent,Credits,Code,Referrals'];cbFiltered.forEach(function(c){csv.push([c.email,'"'+(c.name||'')+'"','"'+c.purchases.map(productName).join('; ')+'"',c.totalSpent,c.creditBalance,c.referralCode,c.referralCount].join(','))});var b=new Blob([csv.join('\n')],{type:'text/csv'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='qp-customers.csv';a.click()}

function showCustomerDetail(email){var c=allCustomers.find(function(x){return x.email.toLowerCase()===email.toLowerCase()});if(!c)return;var cp=purchasesData.filter(function(p){return p.email&&p.email.toLowerCase()===email.toLowerCase()});var cc=creditHistory.filter(function(h){return h.email&&h.email.toLowerCase()===email.toLowerCase()});var ce=academyEnrollments.filter(function(e){return e.user_id===c.userId&&e.status==='active'});var notes=getAdminNotes(email);var e2=esc(email.replace(/'/g,"\\'"));
var html='<div class="detail-panel"><button class="btn btn-ghost btn-sm" style="position:absolute;top:16px;right:16px;z-index:10" onclick="this.closest(\'.detail-panel\').remove()">\u2715 Close</button>';
html+='<div class="detail-header"><div style="flex:1"><div class="detail-email">'+esc(c.email)+'</div><div class="detail-name">'+(c.name?esc(c.name):'No name on file')+'</div>'+(c.userId?'<div class="detail-id">ID: '+c.userId+'</div>':'')+'</div><div style="display:flex;flex-wrap:wrap;gap:6px;align-items:flex-start;padding-top:4px">'+(c.isBlocked?'<span class="badge danger">Blocked</span>':c.hasAccount?'<span class="badge green">Active Account</span>':'<span class="badge muted">No Account</span>');
var authUser=authUsersMap.get(c.email.toLowerCase());if(authUser){if(authUser.email_confirmed_at)html+='<span class="badge green" title="Confirmed '+new Date(authUser.email_confirmed_at).toLocaleDateString()+'">Email Verified</span>';else html+='<span class="badge yellow">Unverified</span>';if(authUser.last_sign_in_at)html+='<span class="badge muted" title="'+new Date(authUser.last_sign_in_at).toLocaleString()+'">Last login: '+timeAgo(authUser.last_sign_in_at)+'</span>';var optIn=true;if(authUser.raw_user_meta_data&&authUser.raw_user_meta_data.marketing_opt_in===false)optIn=false;html+=optIn?'<span class="badge teal">Opted In</span>':'<span class="badge muted">Opted Out</span>'}
var postCount=(function(){var fp=0,ap=0;try{purchasesData.forEach(function(){});fp=document.querySelectorAll?0:0}catch(e){}return{fusion:0,academy:0}})();
try{var fposts=allFusionPosts?allFusionPosts.filter(function(p){return p.user_email&&p.user_email.toLowerCase()===c.email.toLowerCase()}).length:0;var aposts=allAcadPosts?allAcadPosts.filter(function(p){return(p.user_email&&p.user_email.toLowerCase()===c.email.toLowerCase())}).length:0;if(fposts||aposts)html+='<span class="badge purple">'+(fposts+aposts)+' posts</span>'}catch(e){}
html+='</div></div>';
html+='<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">';
if(c.userId){html+='<div style="position:relative;display:inline-block" class="login-as-wrap"><button class="btn btn-ghost btn-sm" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'block\'?\'none\':\'block\'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Login As \u25BE</button><div style="display:none;position:absolute;top:100%;left:0;margin-top:4px;background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;z-index:100;min-width:160px;box-shadow:0 8px 24px rgba(0,0,0,.3)"><button class="btn btn-ghost btn-sm" style="width:100%;border-radius:0;justify-content:flex-start;border-bottom:1px solid var(--border)" onclick="loginAsUser(\''+e2+'\',\'fusion\');this.parentElement.style.display=\'none\'"><span class="badge purple" style="margin-right:6px">Fusion</span> Sessions Site</button><button class="btn btn-ghost btn-sm" style="width:100%;border-radius:0;justify-content:flex-start" onclick="loginAsUser(\''+e2+'\',\'academy\');this.parentElement.style.display=\'none\'"><span class="badge teal" style="margin-right:6px">Academy</span> Learning Site</button></div></div>';html+='<button class="btn btn-ghost btn-sm" onclick="resetUserPW(\''+e2+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg> Reset PW</button>'}
html+='<button class="btn btn-ghost btn-sm" onclick="emailCustomer(\''+e2+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Email</button>';
html+='<button class="btn btn-ghost btn-sm" onclick="navigator.clipboard.writeText(\''+esc(c.userId||c.email)+'\');this.innerHTML=\'Copied!\'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy ID</button>';
if(c.userId){var isBlocked=c.isBlocked||false;html+='<button class="btn '+(isBlocked?'btn-success':'btn-danger')+' btn-sm" onclick="toggleBlockUser(\''+c.userId+'\','+(!isBlocked)+',\''+e2+'\')">'+(isBlocked?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="20 6 9 17 4 12"/></svg> Unblock':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Block')+'</button>'}
html+='</div>';
var fpurch=cp.filter(function(p){return isFusion(p.product_id)});var apurch=cp.filter(function(p){return isAcademy(p.product_id)});
var userProg={};lessonProgress.filter(function(lp){return lp.user_id===c.userId}).forEach(function(lp){var cid=lp.course_id;if(!userProg[cid])userProg[cid]={total:0,completed:0};userProg[cid].total++;if(lp.completed)userProg[cid].completed++});

var notesHtml='<div class="detail-section" style="margin-bottom:16px"><h4><span class="dot" style="background:var(--taupe)"></span> Admin Notes</h4><div style="display:flex;gap:8px;margin-bottom:10px"><input type="text" class="input" id="note-input" placeholder="Add a note..." style="flex:1" onkeypress="if(event.key===\'Enter\')addNote(\''+e2+'\')"><button class="btn btn-primary btn-sm" onclick="addNote(\''+e2+'\')">Add</button></div><div id="notes-list">';
if(notes.length){notes.forEach(function(n){notesHtml+='<div class="note-item"><div class="note-text">'+esc(n.note_text)+'</div><div class="note-meta"><span>'+timeAgo(n.created_at)+'</span><button class="note-delete" onclick="deleteNote(\''+e2+'\',\''+n.id+'\')">Delete</button></div></div>'})}else{notesHtml+='<p style="color:var(--text-dim);font-size:12px">No notes yet</p>'}
notesHtml+='</div></div>';

var creditsHtml='<div class="detail-section" style="margin-bottom:16px"><h4><span class="dot" style="background:var(--teal)"></span> Referral & Credits</h4>';
if(c.referralCode){creditsHtml+='<div style="margin-bottom:10px">Code: <span class="ref-code">'+c.referralCode+'</span></div>'}else{creditsHtml+='<div style="margin-bottom:10px;display:flex;align-items:center;gap:10px"><span style="color:var(--text-dim);font-size:13px">No referral code</span><button class="btn btn-ghost btn-sm" onclick="createReferralCode(\''+e2+'\')">+ Create Code</button></div>'}
creditsHtml+='<div class="ref-stat-row"><div class="ref-stat"><div class="ref-stat-val" style="color:var(--success)">'+fmtMoney(c.creditBalance)+'</div><div class="ref-stat-label">Balance</div></div><div class="ref-stat"><div class="ref-stat-val" style="color:var(--teal)">'+c.referralCount+'</div><div class="ref-stat-label">Referrals</div></div><div class="ref-stat"><div class="ref-stat-val" style="color:var(--taupe)">'+fmtMoney(c.totalEarned)+'</div><div class="ref-stat-label">Earned</div></div></div>';
creditsHtml+='<div class="credit-actions"><input type="number" class="input" id="credit-amount" placeholder="$" min="0" step="1" style="width:80px"><button class="btn btn-success btn-sm" onclick="adjustCredit(\''+e2+'\',1)">+ Add</button><button class="btn btn-danger btn-sm" onclick="adjustCredit(\''+e2+'\',-1)">\u2212 Deduct</button><button class="btn btn-ghost btn-sm" onclick="setCredit(\''+e2+'\')">Set</button></div></div>';

html+='<div class="tab-nav" style="margin-bottom:0"><button class="tab-btn active" onclick="switchDetailTab(\'all\',this)">All</button><button class="tab-btn" onclick="switchDetailTab(\'academy\',this)">Academy</button><button class="tab-btn" onclick="switchDetailTab(\'fusion\',this)">Fusion</button></div>';

html+='<div class="detail-tab" data-dtab="all" style="margin-top:16px">';
html+='<div class="detail-grid"><div class="detail-section"><h4><span class="dot" style="background:var(--success)"></span> Purchases ('+cp.length+')</h4>';
if(cp.length){html+='<div style="max-height:200px;overflow-y:auto">';cp.forEach(function(p){var revoked=isRevoked(p.product_id);html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);'+(revoked?'opacity:.5':'')+'"><div><span style="color:'+(revoked?'var(--danger)':'var(--text)')+';font-size:13px;'+(revoked?'text-decoration:line-through':'')+'">'+productName(p.product_id)+'</span> '+productBadge(p.product_id)+'<div style="font-size:10px;color:var(--text-dim);margin-top:2px">'+timeAgo(p.purchased_at)+(p.stripe_event_id&&p.stripe_event_id.indexOf('admin-grant')===0?' <span class="badge muted">Granted</span>':'')+'</div></div><div style="font-weight:600;color:'+(revoked?'var(--danger)':'var(--success)')+'">'+fmtMoney(p.amount_paid)+'</div></div>'});html+='</div><div style="margin-top:8px;font-size:12px;color:var(--text-muted)">Total: <strong style="color:var(--success)">'+fmtMoney(c.totalSpent)+'</strong></div>'}else{html+='<p style="color:var(--text-dim);font-size:13px">No purchases</p>'}
html+='</div>'+creditsHtml+'</div>';
html+=notesHtml;
if(cc.length){html+='<div class="detail-section"><h4><span class="dot" style="background:var(--warning)"></span> Credit History</h4><div style="max-height:150px;overflow-y:auto">';cc.slice(0,10).forEach(function(h){html+='<div class="feed-item" style="padding:6px 0"><div class="feed-dot" style="background:'+(h.amount>0?'var(--success)':'var(--warning)')+'"></div><div class="feed-content"><div class="feed-text" style="font-size:12px">'+(h.amount>0?'+':'')+fmtMoney(h.amount)+' \u2014 '+esc(h.description||h.type)+'</div><div class="feed-time">'+timeAgo(h.created_at)+'</div></div></div>'});html+='</div></div>'}
/* Email History in detail panel */
var custEmailTracking=emailTrackingData.filter(function(t){return t.recipient_email&&t.recipient_email.toLowerCase()===email.toLowerCase()});if(custEmailTracking.length){var campMap={};emailCampaignsData.forEach(function(c2){campMap[c2.id]=c2});html+='<div class="detail-section"><h4><span class="dot" style="background:var(--purple)"></span> Email History ('+custEmailTracking.length+')</h4><div style="max-height:160px;overflow-y:auto">';custEmailTracking.slice(0,20).forEach(function(t){var camp=campMap[t.campaign_id]||{};var subj=camp.subject||camp.campaign_name||'Email';var statusDot=t.clicked_at?'clicked':(t.opened_at?'opened':'sent');var statusLabel=t.clicked_at?'Clicked':(t.opened_at?'Opened':'Sent');var date=t.sent_at?new Date(t.sent_at).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'-';html+='<div class="email-detail-row"><span class="email-status-dot '+statusDot+'" title="'+statusLabel+'"></span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(subj)+'</span><span style="color:var(--text-dim);flex-shrink:0;font-size:11px">'+date+'</span></div>'});html+='</div></div>'}
html+='</div>';

html+='<div class="detail-tab" data-dtab="academy" style="display:none;margin-top:16px">';
html+='<div class="detail-section" style="margin-bottom:16px"><h4><span class="dot" style="background:var(--teal)"></span> Enrollments & Progress</h4>';
if(ce.length){html+='<table class="tbl"><thead><tr><th>Course</th><th>Progress</th><th>Enrolled</th><th></th></tr></thead><tbody>';ce.forEach(function(e){var cid=e.qa_courses&&e.qa_courses.id||e.course_id;var prog=userProg[cid]||{total:0,completed:0};var pct=prog.total?Math.round(prog.completed/prog.total*100):0;html+='<tr><td class="name">'+(e.qa_courses&&e.qa_courses.title||'Course')+'</td><td><div style="display:flex;align-items:center;gap:6px;min-width:100px"><div style="flex:1;height:5px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,var(--teal),var(--teal-light));border-radius:3px"></div></div><span style="font-size:10px;font-weight:600;color:var(--teal)">'+prog.completed+'/'+prog.total+'</span></div></td><td>'+timeAgo(e.enrolled_at)+'</td><td style="white-space:nowrap"><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();resetStudentProgress(\''+c.userId+'\',\''+cid+'\',\''+(e.qa_courses&&e.qa_courses.title?esc(e.qa_courses.title.replace(/'/g,"\\'")):'')+'\',\''+e2+'\')" title="Reset progress">Reset</button> <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();unenrollStudent(\''+e.id+'\',\''+e2+'\')">Unenroll</button></td></tr>'});html+='</tbody></table>'}else{html+='<p style="color:var(--text-dim);font-size:13px;margin-bottom:8px">No enrollments</p>'}
var enrolledSlugs=ce.map(function(e){return e.qa_courses&&e.qa_courses.slug||''});var avail=academyCourses.filter(function(c){return enrolledSlugs.indexOf(c.slug)<0});if(avail.length){html+='<div style="display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.04);align-items:center"><select class="input" style="width:auto;flex:1" id="detail-enroll-course">';avail.forEach(function(c){html+='<option value="'+c.slug+'">'+esc(c.title)+'</option>'});html+='</select><button class="btn btn-success btn-sm" onclick="enrollFromDetail(\''+e2+'\')">+ Enroll</button></div>'}
html+='</div>';
if(apurch.length){html+='<div class="detail-section" style="margin-bottom:16px"><h4><span class="dot" style="background:var(--teal)"></span> Academy Purchases</h4><div style="max-height:150px;overflow-y:auto">';apurch.forEach(function(p){html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04)"><div><span style="font-size:13px">'+productName(p.product_id)+'</span><span style="font-size:10px;color:var(--text-dim);margin-left:8px">'+timeAgo(p.purchased_at)+'</span>'+(p.stripe_event_id&&p.stripe_event_id.indexOf('admin-grant')===0?' <span class="badge muted">Granted</span>':'')+'</div><div style="font-weight:600;color:var(--success)">'+fmtMoney(p.amount_paid)+'</div></div>'});html+='</div></div>'}
html+=creditsHtml;
html+=notesHtml;
html+='</div>';

html+='<div class="detail-tab" data-dtab="fusion" style="display:none;margin-top:16px">';
html+='<div class="detail-section" style="margin-bottom:16px"><h4><span class="dot" style="background:var(--purple)"></span> Session Access ('+fpurch.length+')</h4>';
if(fpurch.length){html+='<table class="tbl"><thead><tr><th>Session</th><th>Date</th><th>Paid</th><th></th></tr></thead><tbody>';fpurch.forEach(function(p){var isGranted=p.stripe_event_id&&p.stripe_event_id.indexOf('admin-grant')===0;html+='<tr><td class="name">'+productName(p.product_id)+'</td><td>'+timeAgo(p.purchased_at)+'</td><td>'+(Number(p.amount_paid)>0?'<span style="color:var(--success)">'+fmtMoney(p.amount_paid)+'</span>':(isGranted?'<span class="badge muted">Granted</span>':'$0'))+'</td><td><button class="btn btn-danger btn-sm" onclick="revokeFusion(\''+p.product_id+'\',\''+e2+'\')">Revoke</button></td></tr>'});html+='</tbody></table>'}else{html+='<p style="color:var(--text-dim);font-size:13px;margin-bottom:8px">No Fusion sessions</p>'}
var ownedFusion=fpurch.map(function(p){return p.product_id});var hasBundleAll=ownedFusion.indexOf('bundle-all')>=0;var availFusion=Object.keys(FUSION_NAMES).filter(function(k){return!hasBundleAll&&ownedFusion.indexOf(k)<0});if(availFusion.length){html+='<div style="display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.04);align-items:center"><select class="input" style="width:auto;flex:1" id="detail-grant-fusion">';availFusion.forEach(function(k){html+='<option value="'+k+'">'+FUSION_NAMES[k]+'</option>'});html+='</select><button class="btn btn-success btn-sm" onclick="grantFusionFromDetail(\''+e2+'\')">+ Grant</button></div>'}else if(hasBundleAll){html+='<div style="margin-top:8px;font-size:12px;color:var(--text-muted)"><span class="badge taupe">Complete Bundle</span> \u2014 all sessions</div>'}
html+='</div>';
html+=creditsHtml;
html+=notesHtml;
html+='</div>';

html+='<div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(239,83,80,.15)">';
html+='<div style="display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap">';
html+='<button class="btn btn-danger btn-sm" onclick="revokeAllAccess(\''+e2+'\')">Revoke All Access</button>';
if(c.userId){html+='<button class="btn btn-danger btn-sm" onclick="archiveAccount(\''+e2+'\',\''+c.userId+'\')">Archive Account</button>'}
html+='</div></div>';

document.getElementById('cust-result').innerHTML=html;setTimeout(function(){var el=document.getElementById('cust-result');if(el){var top=el.getBoundingClientRect().top+window.scrollY-80;window.scrollTo({top:top,behavior:'smooth'})}},50)}
async function addNote(email){var inp=document.getElementById('note-input');var t=inp.value.trim();if(!t)return;await saveAdminNote(email,t);showCustomerDetail(email)}
function switchDetailTab(tab,btn){var panel=btn.closest('.detail-panel');if(!panel)return;panel.querySelectorAll('.detail-tab').forEach(function(t){t.style.display='none'});panel.querySelectorAll('.detail-tab[data-dtab="'+tab+'"]').forEach(function(t){t.style.display='block'});btn.closest('.tab-nav').querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active')});btn.classList.add('active')}
async function deleteNote(email,id){await deleteAdminNote(email,id);showCustomerDetail(email)}
async function adjustCredit(email,dir){var amt=Number(document.getElementById('credit-amount').value);if(!amt||amt<=0)return showToast('Enter a valid amount','error');try{var res=await sb.from('referral_codes').select('credit_balance').eq('email',email.toLowerCase()).single();if(!res.data)return showToast('No referral code found','error');var nb=Math.max(0,Number(res.data.credit_balance)+amt*dir);await sb.from('referral_codes').update({credit_balance:nb}).eq('email',email.toLowerCase());await sb.from('credit_history').insert({email:email.toLowerCase(),amount:amt*dir,type:'admin_adjustment',description:'Admin credit adjustment',created_at:new Date().toISOString()});await logAudit('adjust_credit',email,(dir>0?'Added':'Deducted')+' $'+amt+' credits (new balance: $'+nb+')',{amount:amt*dir,new_balance:nb});document.getElementById('credit-amount').value='';await loadAllData();showCustomerDetail(email)}catch(e){showToast('Error: '+e.message,'error')}}
async function setCredit(email){var amt=Number(document.getElementById('credit-amount').value);if(isNaN(amt)||amt<0)return showToast('Enter a valid amount','error');try{var res=await sb.from('referral_codes').select('credit_balance').eq('email',email.toLowerCase()).single();if(!res.data)return showToast('No referral code found','error');var old=Number(res.data.credit_balance)||0;await sb.from('referral_codes').update({credit_balance:amt}).eq('email',email.toLowerCase());await sb.from('credit_history').insert({email:email.toLowerCase(),amount:amt-old,type:'admin_set',description:'Admin set credit to $'+amt+' (was $'+old+')',created_at:new Date().toISOString()});await logAudit('set_credit',email,'Set credit balance to $'+amt+' (was $'+old+')',{old_balance:old,new_balance:amt});document.getElementById('credit-amount').value='';await loadAllData();showCustomerDetail(email)}catch(e){showToast('Error: '+e.message,'error')}}
async function unenrollStudent(enrollmentId,email){if(!await qpConfirm('Confirm','Remove this enrollment?'))return;try{await sb.from('qa_enrollments').update({status:'revoked'}).eq('id',enrollmentId);await logAudit('unenroll_student',email,'Unenrolled from detail panel',{enrollment_id:enrollmentId});await loadAllData();showCustomerDetail(email)}catch(e){showToast('Error: '+e.message,'error')}}
async function enrollFromDetail(email){var sel=document.getElementById('detail-enroll-course');if(!sel)return;var slug=sel.value;try{var prof=await sb.from('qa_profiles').select('id').eq('email',email.toLowerCase());if(!prof.data||!prof.data.length){showToast('No Academy account found for '+email,'error');return}var uid=prof.data[0].id;var course=await sb.from('qa_courses').select('id').eq('slug',slug).single();if(!course.data){showToast('Course not found','error');return}await sb.from('qa_enrollments').upsert({user_id:uid,course_id:course.data.id,status:'active',enrolled_at:new Date().toISOString()},{onConflict:'user_id,course_id'});await logAudit('enroll_student',email,'Enrolled in '+productName(slug)+' from detail panel',{course_slug:slug});await loadAllData();showCustomerDetail(email)}catch(e){showToast('Error: '+e.message,'error')}}
async function grantFusionFromDetail(email){var sel=document.getElementById('detail-grant-fusion');if(!sel)return;var pid=sel.value;try{await sb.from('purchases').upsert({email:email.toLowerCase(),product_id:pid,stripe_event_id:'admin-grant-'+Date.now(),amount_paid:0,purchased_at:new Date().toISOString()},{onConflict:'stripe_event_id'});await logAudit('grant_access',email,'Granted Fusion access: '+productName(pid),{product_id:pid});await loadAllData();showCustomerDetail(email);setTimeout(function(){var btn=document.querySelector('.detail-panel .tab-btn:nth-child(3)');if(btn)switchDetailTab('fusion',btn)},50)}catch(e){showToast('Error: '+e.message,'error')}}
async function revokeFusion(productId,email){if(!await qpConfirm('Revoke Access','Revoke access to '+productName(productId)+' for '+email+'?',{danger:true,okText:'Revoke'}))return;try{await sb.from('purchases').delete().eq('email',email.toLowerCase()).eq('product_id',productId);await logAudit('revoke_access',email,'Revoked Fusion access: '+productName(productId),{product_id:productId});await loadAllData();showCustomerDetail(email);setTimeout(function(){var btn=document.querySelector('.detail-panel .tab-btn:nth-child(3)');if(btn)switchDetailTab('fusion',btn)},50)}catch(e){showToast('Error: '+e.message,'error')}}
async function loginAsUser(email,dest){var destName=dest==='academy'?'Academy':'Fusion Sessions';if(!await qpConfirm('Login As User','Generate a magic login link for '+email+' on '+destName+'?',{okText:'Generate Link'}))return;try{var redirectUrl=dest==='academy'?'https://academy.quantumphysician.com':'https://fusionsessions.quantumphysician.com';var res=await fetch(SUPABASE_URL+'/auth/v1/admin/generate_link',{method:'POST',headers:{'Content-Type':'application/json','apikey':SUPABASE_SERVICE_KEY,'Authorization':'Bearer '+SUPABASE_SERVICE_KEY},body:JSON.stringify({type:'magiclink',email:email,options:{redirect_to:redirectUrl}})});var data=await res.json();var link=data.properties&&data.properties.action_link||data.action_link;await logAudit('login_as',email,'Login As on '+destName,{destination:dest});if(link){window.open(link,'_blank')}else{showToast('Could not generate link','error')}}catch(e){showToast('Error: '+e.message,'error')}}
async function resetUserPW(email){if(!await qpConfirm('Reset Password','Send a password reset link for '+email+'?',{okText:'Reset'}))return;try{var res=await fetch(SUPABASE_URL+'/auth/v1/admin/generate_link',{method:'POST',headers:{'Content-Type':'application/json','apikey':SUPABASE_SERVICE_KEY,'Authorization':'Bearer '+SUPABASE_SERVICE_KEY},body:JSON.stringify({type:'recovery',email:email})});var data=await res.json();await logAudit('reset_password',email,'Generated password reset link');if(data.properties&&data.properties.action_link){if(await qpConfirm('Reset Link Ready','Link generated. Open now, or cancel to copy.',{okText:'Open Link'})){window.open(data.properties.action_link,'_blank')}else{navigator.clipboard.writeText(data.properties.action_link);showToast('Link copied to clipboard','success')}}else if(data.action_link){navigator.clipboard.writeText(data.action_link);showToast('Reset link copied to clipboard','success')}else{showToast('Could not generate reset link','error')}}catch(e){showToast('Error: '+e.message,'error')}}
async function toggleBlockUser(userId,block,email){var action=block?'block':'unblock';if(!await qpConfirm(action.charAt(0).toUpperCase()+action.slice(1)+' User',action.charAt(0).toUpperCase()+action.slice(1)+' '+email+'?',{danger:block,okText:action.charAt(0).toUpperCase()+action.slice(1)}))return;try{var res=await fetch(SUPABASE_URL+'/auth/v1/admin/users/'+userId,{method:'PUT',headers:{'Content-Type':'application/json','apikey':SUPABASE_SERVICE_KEY,'Authorization':'Bearer '+SUPABASE_SERVICE_KEY},body:JSON.stringify({ban_duration:block?'876600h':'none'})});if(!res.ok){var errData=await res.json().catch(function(){return{}});console.error('Auth ban/unban error:',res.status,errData);showToast('Auth update failed ('+res.status+') - updating profile only','error')}await sbAdmin.from('profiles').update({is_blocked:block}).eq('id',userId);await logAudit('block_user',email,(block?'Blocked':'Unblocked')+' user',{user_id:userId});await loadAllData();showCustomerDetail(email);showToast((block?'Blocked':'Unblocked')+' '+email,'success')}catch(e){showToast('Error: '+e.message,'error')}}
var custACF=[],custACI=-1;
function handleCustSearch(){var q=document.getElementById('cust-search').value.trim().toLowerCase(),dd=document.getElementById('cust-ac');if(q.length<2){dd.classList.remove('open');return}custACF=allCustomers.filter(function(c){return c.email.toLowerCase().indexOf(q)>=0||c.name.toLowerCase().indexOf(q)>=0||(c.referralCode&&c.referralCode.toLowerCase().indexOf(q)>=0)}).slice(0,8);if(!custACF.length){dd.classList.remove('open');return}custACI=0;renderCustAC(q);dd.classList.add('open')}
function renderCustAC(q){var dd=document.getElementById('cust-ac');var re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');dd.innerHTML=custACF.map(function(c,i){return'<div class="ac-item '+(i===custACI?'sel':'')+'" onclick="selCustAC('+i+')"><span class="ac-email">'+c.email.replace(re,'<span class="ac-hl">$1</span>')+'</span>'+(c.referralCode?'<span class="ac-code">'+c.referralCode+'</span>':'')+(c.name?'<span class="ac-name">'+esc(c.name)+'</span>':'')+'</div>'}).join('')}
function handleCustKeydown(e){var dd=document.getElementById('cust-ac');if(!dd.classList.contains('open')){if(e.key==='Enter')searchCustomer();return}if(e.key==='ArrowDown'){e.preventDefault();custACI=Math.min(custACI+1,custACF.length-1);renderCustAC(document.getElementById('cust-search').value.trim().toLowerCase())}if(e.key==='ArrowUp'){e.preventDefault();custACI=Math.max(custACI-1,0);renderCustAC(document.getElementById('cust-search').value.trim().toLowerCase())}if(e.key==='Enter'){e.preventDefault();selCustAC(custACI)}if(e.key==='Escape')dd.classList.remove('open')}
function selCustAC(i){var c=custACF[i];if(c){document.getElementById('cust-search').value=c.email;document.getElementById('cust-ac').classList.remove('open');showCustomerDetail(c.email)}}
function searchCustomer(){var e=document.getElementById('cust-search').value.trim();if(!e)return;document.getElementById('cust-ac').classList.remove('open');showCustomerDetail(e)}
function handleGlobalSearch(){var q=document.getElementById('global-search').value.trim().toLowerCase(),dd=document.getElementById('global-ac');if(q.length<2){dd.classList.remove('open');return}var f=allCustomers.filter(function(c){return c.email.toLowerCase().indexOf(q)>=0||c.name.toLowerCase().indexOf(q)>=0}).slice(0,6);if(!f.length){dd.classList.remove('open');return}dd.innerHTML=f.map(function(c,i){return'<div class="ac-item'+(i===0?' sel':'')+'" onclick="go(\'customers\');setTimeout(function(){showCustomerDetail(\''+esc(c.email)+'\')},100)"><span class="ac-email">'+esc(c.email)+'</span>'+(c.name?'<span class="ac-name">'+esc(c.name)+'</span>':'')+'</div>'}).join('');dd.classList.add('open')}
function handleGlobalKeydown(e){if(e.key==='Escape')document.getElementById('global-ac').classList.remove('open')}
document.addEventListener('click',function(e){if(!e.target.closest('#global-search-wrap'))document.getElementById('global-ac').classList.remove('open');if(!e.target.closest('.ac-wrap')){var dd=document.getElementById('cust-ac');if(dd)dd.classList.remove('open')}});
async function grantAccess(){var email=document.getElementById('grant-email').value.trim(),pid=document.getElementById('grant-product').value,msg=document.getElementById('grant-msg');if(!email){showMsg(msg,'error','Enter an email');return}try{await sb.from('purchases').upsert({email:email.toLowerCase(),product_id:pid,stripe_event_id:'admin-grant-'+Date.now(),amount_paid:0,purchased_at:new Date().toISOString()},{onConflict:'stripe_event_id'});if(isAcademy(pid)){var slugs=pid==='transformational-mastery'?ACADEMY_SLUGS:[pid];var prof=await sb.from('qa_profiles').select('id').eq('email',email.toLowerCase());if(prof.data&&prof.data.length){var uid=prof.data[0].id;var courses=await sb.from('qa_courses').select('id,slug').in('slug',slugs);if(courses.data)for(var i=0;i<courses.data.length;i++)await sb.from('qa_enrollments').upsert({user_id:uid,course_id:courses.data[i].id,status:'active',enrolled_at:new Date().toISOString()},{onConflict:'user_id,course_id'})}}showMsg(msg,'success','Access granted: '+productName(pid)+' \u2192 '+email);document.getElementById('grant-email').value='';await logAudit('grant_access',email,'Granted access to '+productName(pid),{product_id:pid});await loadAllData()}catch(e){showMsg(msg,'error','Error: '+e.message)}}

function switchAcadTab(tab,btn){document.querySelectorAll('#page-academy .tab-content').forEach(function(t){t.classList.remove('active')});document.getElementById('acad-tab-'+tab).classList.add('active');btn.closest('.tab-nav').querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');if(tab==='students')loadAcadStudents()}
function loadAcademyData(){if(!dataLoaded)return;var ae=academyEnrollments.filter(function(e){return e.status==='active'});var us=new Set(ae.map(function(e){return e.user_id})).size;var ap=purchasesData.filter(function(p){return isAcademy(p.product_id)});var ar=ap.reduce(function(s,p){return s+(Number(p.amount_paid)||0)},0);var bc=purchasesData.filter(function(p){return p.product_id==='transformational-mastery'}).length;
document.getElementById('acad-stats').innerHTML='<div class="stat-card" style="cursor:pointer" onclick="acadStatClick(\'active\')"><div class="stat-ico teal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/></svg></div><div><div class="stat-val">'+ae.length+'</div><div class="stat-lbl">Active Enrollments</div></div></div><div class="stat-card" style="cursor:pointer" onclick="acadStatClick(\'students\')"><div class="stat-ico warm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div><div class="stat-val">'+us+'</div><div class="stat-lbl">Unique Students</div></div></div><div class="stat-card" style="cursor:pointer" onclick="acadStatClick(\'revenue\')"><div class="stat-ico green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div><div class="stat-val">'+fmtMoney(ar)+'</div><div class="stat-lbl">Revenue</div></div></div><div class="stat-card" style="cursor:pointer" onclick="acadStatClick(\'bundles\')"><div class="stat-ico purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/></svg></div><div><div class="stat-val">'+bc+'</div><div class="stat-lbl">Bundle Sales</div></div></div>';
var ec={};ae.forEach(function(e){var t=e.qa_courses&&e.qa_courses.title||'Unknown';ec[t]=(ec[t]||0)+1});
document.getElementById('acad-courses').innerHTML=academyCourses.length?'<table class="tbl"><thead><tr><th>Course</th><th>Slug</th><th>Price</th><th>Enrolled</th><th>Status</th><th></th></tr></thead><tbody>'+academyCourses.map(function(c){return'<tr><td class="name">'+esc(c.title)+'</td><td class="mono">'+c.slug+'</td><td><input type="number" value="'+(c.price_cents||0)+'" style="width:80px;padding:4px 8px;font-size:12px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:Inter,sans-serif" id="price-'+c.id+'"> <span style="font-size:10px;color:var(--text-dim)">\u00a2</span></td><td><strong style="color:var(--teal)">'+(ec[c.title]||0)+'</strong></td><td><select style="padding:4px 8px;font-size:12px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:Inter,sans-serif" id="status-'+c.id+'"><option value="published" '+(c.status==='published'?'selected':'')+'>Published</option><option value="draft" '+(c.status==='draft'?'selected':'')+'>Draft</option><option value="archived" '+(c.status==='archived'?'selected':'')+'>Archived</option></select></td><td><button class="btn btn-primary btn-sm" onclick="updateCourse(\''+c.id+'\')">Save</button></td></tr>'}).join('')+'</tbody></table>':'<div class="empty"><p>No courses</p></div>'}
async function updateCourse(id){var price=document.getElementById('price-'+id).value,status=document.getElementById('status-'+id).value;try{await sb.from('qa_courses').update({price_cents:Number(price),status:status}).eq('id',id);await loadAllData();loadAcademyData()}catch(e){showToast('Error: '+e.message,'error')}}
var stuData=[],stuPage=1,stuPS=15;
function loadAcadStudents(){var prof=new Map();profilesData.forEach(function(p){prof.set(p.id,p)});var userProg={};lessonProgress.forEach(function(lp){if(!userProg[lp.user_id])userProg[lp.user_id]={total:0,completed:0};userProg[lp.user_id].total++;if(lp.completed)userProg[lp.user_id].completed++});var sel=document.getElementById('stu-course');var prev=sel.value;sel.innerHTML='<option value="all">All Courses</option>';academyCourses.forEach(function(c){sel.innerHTML+='<option value="'+c.id+'">'+esc(c.title)+'</option>'});sel.value=prev||'all';var esel=document.getElementById('enroll-course');esel.innerHTML='';academyCourses.forEach(function(c){esel.innerHTML+='<option value="'+c.slug+'">'+esc(c.title)+'</option>'});var bsel=document.getElementById('bulk-course');if(bsel){bsel.innerHTML='';academyCourses.forEach(function(c){bsel.innerHTML+='<option value="'+c.slug+'">'+esc(c.title)+'</option>'})};stuData=[];academyEnrollments.forEach(function(e){var p=prof.get(e.user_id);var email=p?p.email:e.user_id;var name=p?p.full_name||'':'';var courseName=e.qa_courses&&e.qa_courses.title||'Unknown';var courseId=e.qa_courses&&e.qa_courses.id||e.course_id;var prog=userProg[e.user_id]||{total:0,completed:0};var pct=prog.total?Math.round(prog.completed/prog.total*100):0;var purchase=purchasesData.find(function(px){return px.email&&px.email.toLowerCase()===email.toLowerCase()&&isAcademy(px.product_id)});var isGranted=purchase&&purchase.stripe_event_id&&purchase.stripe_event_id.indexOf('admin-grant')===0;stuData.push({id:e.id,email:email,name:name,userId:e.user_id,course:courseName,courseId:courseId,enrolled:e.enrolled_at,status:e.status,lessonsCompleted:prog.completed,lessonsTotal:prog.total,pct:pct,paid:purchase?Number(purchase.amount_paid)||0:0,granted:isGranted||false})});renderStudentTable()}
function renderStudentTable(){var courseF=document.getElementById('stu-course').value;var statusF=document.getElementById('stu-status').value;var sortF=document.getElementById('stu-sort').value;var searchF=(document.getElementById('stu-search').value||'').toLowerCase().trim();var filtered=stuData.filter(function(s){if(courseF!=='all'&&s.courseId!==courseF)return false;if(statusF==='active'&&s.status!=='active')return false;if(statusF==='granted'&&!s.granted)return false;if(statusF==='revoked'&&s.status!=='revoked')return false;if(searchF&&s.email.toLowerCase().indexOf(searchF)<0&&s.name.toLowerCase().indexOf(searchF)<0)return false;return true});filtered.sort(function(a,b){switch(sortF){case'enrolled-desc':return(b.enrolled||'').localeCompare(a.enrolled||'');case'enrolled-asc':return(a.enrolled||'').localeCompare(b.enrolled||'');case'progress-desc':return b.pct-a.pct;case'progress-asc':return a.pct-b.pct;case'email-asc':return a.email.localeCompare(b.email);case'name-asc':return(a.name||'').localeCompare(b.name||'');case'paid-desc':return b.paid-a.paid;default:return 0}});var tp=Math.ceil(filtered.length/stuPS)||1;stuPage=Math.min(stuPage,tp);var start=(stuPage-1)*stuPS;var page=filtered.slice(start,start+stuPS);var c=document.getElementById('acad-students-table');if(!page.length){c.innerHTML='<div class="empty"><p>No students match filters</p></div>';document.getElementById('stu-pagination').innerHTML='';return}
var html='<table class="tbl"><thead><tr><th>Student</th><th>Name</th><th>Course</th><th>Enrolled</th><th>Lessons</th><th>Progress</th><th>Paid</th><th>Status</th><th></th></tr></thead><tbody>';page.forEach(function(s){var statusBadge=s.status==='active'?(s.granted?'<span class="badge yellow">Granted</span>':'<span class="badge green">Active</span>'):'<span class="badge muted">Revoked</span>';var pBar='<div style="display:flex;align-items:center;gap:6px;min-width:90px"><div style="flex:1;height:5px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+s.pct+'%;background:linear-gradient(90deg,var(--teal),var(--teal-light));border-radius:3px"></div></div><span style="font-size:10px;font-weight:600;color:var(--teal);min-width:28px">'+s.pct+'%</span></div>';var e2=esc(s.email.replace(/'/g,"\\'"));html+='<tr><td class="email" style="cursor:pointer" onclick="go(\'customers\');setTimeout(function(){showCustomerDetail(\''+e2+'\')},100)">'+esc(s.email)+'</td><td class="name">'+(s.name?esc(s.name):'<span style="color:var(--text-dim)">\u2014</span>')+'</td><td style="font-size:12px">'+esc(s.course)+'</td><td>'+timeAgo(s.enrolled)+'</td><td>'+s.lessonsCompleted+'/'+s.lessonsTotal+'</td><td>'+pBar+'</td><td>'+(s.paid>0?'<span style="color:var(--success)">'+fmtMoney(s.paid)+'</span>':'\u2014')+'</td><td>'+statusBadge+'</td><td>'+(s.status==='active'?'<button class="btn btn-danger btn-sm" onclick="unenrollDirect(\''+s.id+'\')">Unenroll</button>':'')+'</td></tr>'});html+='</tbody></table>';c.innerHTML=html;document.getElementById('stu-pagination').innerHTML='<span>'+filtered.length+' enrollments \u00b7 Page '+stuPage+'/'+tp+'</span><div class="page-btns"><button class="btn btn-ghost btn-sm" onclick="stuPage=Math.max(1,stuPage-1);renderStudentTable()" '+(stuPage<=1?'disabled':'')+'>Prev</button><button class="btn btn-ghost btn-sm" onclick="stuPage=Math.min('+tp+',stuPage+1);renderStudentTable()" '+(stuPage>=tp?'disabled':'')+'>Next</button></div>'}
function acadStatClick(type){var btn=document.querySelector('#page-academy .tab-btn:last-child');switchAcadTab('students',btn);setTimeout(function(){document.getElementById('stu-course').value='all';document.getElementById('stu-status').value='all';document.getElementById('stu-search').value='';if(type==='active'){document.getElementById('stu-status').value='active';document.getElementById('stu-sort').value='enrolled-desc'}else if(type==='students'){document.getElementById('stu-sort').value='email-asc'}else if(type==='revenue'){document.getElementById('stu-sort').value='paid-desc'}else if(type==='bundles'){document.getElementById('stu-search').value=''}stuPage=1;renderStudentTable()},50)}
async function enrollStudent(){var email=document.getElementById('enroll-email').value.trim();var slug=document.getElementById('enroll-course').value;var msg=document.getElementById('enroll-msg');if(!email){showMsg(msg,'error','Enter a student email');return}try{var prof=await sb.from('qa_profiles').select('id').eq('email',email.toLowerCase());if(!prof.data||!prof.data.length){showMsg(msg,'error','No Academy account found for '+email+'. They need to sign up first.');return}var uid=prof.data[0].id;var course=await sb.from('qa_courses').select('id').eq('slug',slug).single();if(!course.data){showMsg(msg,'error','Course not found');return}await sb.from('qa_enrollments').upsert({user_id:uid,course_id:course.data.id,status:'active',enrolled_at:new Date().toISOString()},{onConflict:'user_id,course_id'});showMsg(msg,'success','Enrolled '+email+' in '+productName(slug));document.getElementById('enroll-email').value='';await logAudit('enroll_student',email,'Enrolled in '+productName(slug),{course_slug:slug});await loadAllData();loadAcadStudents();loadAcademyData()}catch(e){showMsg(msg,'error','Error: '+e.message)}}
async function unenrollDirect(id){if(!await qpConfirm('Confirm','Remove this enrollment?'))return;try{var stu=stuData.find(function(s){return s.id===id});await sb.from('qa_enrollments').update({status:'revoked'}).eq('id',id);if(stu)await logAudit('unenroll_student',stu.email,'Unenrolled from '+stu.course,{enrollment_id:id});await loadAllData();loadAcadStudents()}catch(e){showToast('Error: '+e.message,'error')}}
function loadFusionData(){if(!dataLoaded)return;var fp=purchasesData.filter(function(p){return isFusion(p.product_id)});var fr=fp.reduce(function(s,p){return s+(Number(p.amount_paid)||0)},0);var bc=fp.filter(function(p){return p.product_id==='bundle-all'}).length;var ub=new Set(fp.map(function(p){return p.email&&p.email.toLowerCase()})).size;var sc={};fp.forEach(function(p){if(p.product_id!=='bundle-all')sc[p.product_id]=(sc[p.product_id]||0)+1});
document.getElementById('fusion-stats').innerHTML='<div class="stat-card"><div class="stat-ico green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div><div class="stat-val">'+fmtMoney(fr)+'</div><div class="stat-lbl">Fusion Revenue</div></div></div><div class="stat-card"><div class="stat-ico purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/></svg></div><div><div class="stat-val">'+bc+'</div><div class="stat-lbl">Bundle Sales</div></div></div><div class="stat-card"><div class="stat-ico warm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div><div class="stat-val">'+ub+'</div><div class="stat-lbl">Total Buyers</div></div></div><div class="stat-card"><div class="stat-ico teal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div><div class="stat-val">'+fp.filter(function(p){return p.product_id!=='bundle-all'}).length+'</div><div class="stat-lbl">Individual Sales</div></div></div>';
var sl=Object.entries(FUSION_NAMES).filter(function(x){return x[0]!=='bundle-all'}).map(function(x){return{pid:x[0],name:x[1],count:sc[x[0]]||0}}).sort(function(a,b){return b.count-a.count});
document.getElementById('fusion-content').innerHTML='<table class="tbl"><thead><tr><th>Session</th><th>Sales</th></tr></thead><tbody>'+sl.map(function(s){return'<tr><td class="name">'+s.name+'</td><td><strong style="color:var(--purple)">'+s.count+'</strong></td></tr>'}).join('')+'</tbody></table><div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)"><div class="card-title" style="margin-bottom:12px">Recent Purchases</div>'+fp.slice(0,8).map(function(p){return'<div class="feed-item"><div class="feed-dot" style="background:var(--purple)"></div><div class="feed-content"><div class="feed-text"><strong>'+esc(p.email)+'</strong> \u2192 '+productName(p.product_id)+'</div><div class="feed-time">'+fmtMoney(p.amount_paid)+' \u00b7 '+timeAgo(p.purchased_at)+'</div></div></div>'}).join('')+'</div>'}

function switchCommTab(tab,btn){document.querySelectorAll('#page-community .tab-content').forEach(function(t){t.classList.remove('active')});document.getElementById('comm-tab-'+tab).classList.add('active');btn.closest('.tab-nav').querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');if(tab==='academy')loadAcadDiscussions();if(tab==='fusion')loadFusionPosts()}
async function loadCommunityData(){try{var r=await Promise.all([sb.from('qa_discussions').select('*',{count:'exact',head:true}),sb.from('discussion_posts').select('*',{count:'exact',head:true})]);var ac=r[0].count||0,fc=r[1].count||0;document.getElementById('comm-stats').innerHTML='<div class="stat-card"><div class="stat-ico teal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div><div><div class="stat-val">'+ac+'</div><div class="stat-lbl">Academy Posts</div></div></div><div class="stat-card"><div class="stat-ico purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div><div><div class="stat-val">'+fc+'</div><div class="stat-lbl">Fusion Posts</div></div></div><div class="stat-card"><div class="stat-ico green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div><div class="stat-val">'+(ac+fc)+'</div><div class="stat-lbl">Total Posts</div></div></div>';loadAcadDiscussions()}catch(e){console.error(e)}}
async function loadAcadDiscussions(){var c=document.getElementById('comm-acad-posts');c.innerHTML='<div class="loading-center"><div class="spinner"></div>Loading...</div>';try{var q=sb.from('qa_discussions').select('*').order('created_at',{ascending:false}).limit(50);var f=document.getElementById('comm-acad-filter').value,s=document.getElementById('comm-acad-search').value.trim();if(f==='visible')q=q.or('is_hidden.is.null,is_hidden.eq.false');else if(f==='hidden')q=q.eq('is_hidden',true);else if(f==='pinned')q=q.eq('is_pinned',true);if(s)q=q.or('content.ilike.%'+s+'%,user_name.ilike.%'+s+'%');var res=await q;if(res.error)throw res.error;var posts=res.data;if(!posts||!posts.length){c.innerHTML='<div class="empty"><p>No discussions found</p></div>';return}c.innerHTML=posts.map(function(p){return renderPostCard(p,'qa_discussions')}).join('')}catch(e){c.innerHTML='<p style="color:var(--danger)">Error: '+e.message+'</p>'}}
async function loadFusionPosts(){var c=document.getElementById('comm-fus-posts');c.innerHTML='<div class="loading-center"><div class="spinner"></div>Loading...</div>';try{var q=sb.from('discussion_posts').select('*').order('created_at',{ascending:false}).limit(50);var f=document.getElementById('comm-fus-filter').value,s=document.getElementById('comm-fus-search').value.trim();if(f==='visible')q=q.or('is_hidden.is.null,is_hidden.eq.false');else if(f==='hidden')q=q.eq('is_hidden',true);else if(f==='pinned')q=q.eq('is_pinned',true);if(s)q=q.or('content.ilike.%'+s+'%,user_email.ilike.%'+s+'%');var res=await q;if(res.error)throw res.error;var posts=res.data;if(!posts||!posts.length){c.innerHTML='<div class="empty"><p>No posts found</p></div>';return}c.innerHTML=posts.map(function(p){return renderPostCard(p,'discussion_posts')}).join('')}catch(e){c.innerHTML='<p style="color:var(--danger)">Error: '+e.message+'</p>'}}
function renderPostCard(p,table){var name=p.user_name||(p.user_email?p.user_email.split('@')[0]:'Anonymous');var email=p.user_email||'';var init=(name[0]||'?').toUpperCase();var badges=[];if(p.is_pinned)badges.push('<span class="badge teal">Pinned</span>');if(p.is_hidden)badges.push('<span class="badge danger">Hidden</span>');return'<div class="post-card '+(p.is_hidden?'hidden-post ':'')+' '+(p.is_pinned?'pinned-post':'')+'"><div class="post-header"><div class="post-author"><div class="post-avatar">'+init+'</div><div><div style="font-size:13px;font-weight:500">'+esc(name)+'</div><div style="font-size:11px;color:var(--text-dim)">'+esc(email)+'</div></div></div><div>'+badges.join(' ')+'</div></div><div class="post-body">'+esc((p.content||'').substring(0,300))+((p.content||'').length>300?'...':'')+'</div><div class="post-meta"><span>'+timeAgo(p.created_at)+'</span>'+(p.reply_count?'<span>'+p.reply_count+' replies</span>':'')+'</div><div class="post-actions"><button class="btn btn-ghost btn-sm" onclick="togglePostPin(\''+p.id+'\','+(!p.is_pinned)+',\''+table+'\')">'+(p.is_pinned?'Unpin':'Pin')+'</button><button class="btn btn-ghost btn-sm" onclick="togglePostHide(\''+p.id+'\','+(!p.is_hidden)+',\''+table+'\')">'+(p.is_hidden?'Show':'Hide')+'</button><button class="btn btn-danger btn-sm" onclick="deletePost(\''+p.id+'\',\''+table+'\')">Delete</button></div></div>'}
async function togglePostPin(id,val,table){try{await sb.from(table).update({is_pinned:val}).eq('id',id);if(table==='qa_discussions')loadAcadDiscussions();else loadFusionPosts()}catch(e){showToast('Error: '+e.message,'error')}}
async function togglePostHide(id,val,table){try{await sb.from(table).update({is_hidden:val}).eq('id',id);if(table==='qa_discussions')loadAcadDiscussions();else loadFusionPosts()}catch(e){showToast('Error: '+e.message,'error')}}
async function deletePost(id,table){if(!await qpConfirm('Delete Post','Delete this post permanently?',{danger:true,okText:'Delete'}))return;try{var replyTable=table==='qa_discussions'?'qa_discussion_replies':'discussion_replies';var fk=table==='qa_discussions'?'discussion_id':'post_id';await sb.from(replyTable).delete().eq(fk,id);await sb.from(table).delete().eq('id',id);if(table==='qa_discussions')loadAcadDiscussions();else loadFusionPosts();loadCommunityData()}catch(e){showToast('Error: '+e.message,'error')}}
function loadReferralData(){if(!dataLoaded)return;var tco=referralData.reduce(function(s,r){return s+(Number(r.credit_balance)||0)},0);var te=referralData.reduce(function(s,r){return s+(Number(r.total_earned)||0)},0);var tr=referralData.reduce(function(s,r){return s+(r.successful_referrals||0)},0);var ar=referralData.filter(function(r){return r.successful_referrals>0}).length;

document.getElementById('ref-stats').innerHTML='<div class="stat-card"><div class="stat-ico green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div><div class="stat-val">'+fmtMoney(tco)+'</div><div class="stat-lbl">Credits Outstanding</div></div></div><div class="stat-card"><div class="stat-ico warm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div><div><div class="stat-val">'+fmtMoney(te)+'</div><div class="stat-lbl">Total Earned</div></div></div><div class="stat-card"><div class="stat-ico teal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></div><div><div class="stat-val">'+tr+'</div><div class="stat-lbl">Total Referrals</div></div></div><div class="stat-card"><div class="stat-ico purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div><div class="stat-val">'+ar+'</div><div class="stat-lbl">Active Referrers</div></div></div>';
var top=referralData.filter(function(r){return r.successful_referrals>0}).sort(function(a,b){return b.successful_referrals-a.successful_referrals}).slice(0,10);
document.getElementById('ref-leaderboard').innerHTML=top.length?'<table class="tbl"><thead><tr><th>Email</th><th>Code</th><th>Referrals</th><th>Balance</th><th>Earned</th></tr></thead><tbody>'+top.map(function(r){return'<tr><td class="email">'+esc(r.email)+'</td><td class="mono">'+r.code+'</td><td><strong style="color:var(--teal)">'+r.successful_referrals+'</strong></td><td>'+(Number(r.credit_balance)>0?'<span style="color:var(--success)">'+fmtMoney(r.credit_balance)+'</span>':'\u2014')+'</td><td style="color:var(--taupe)">'+fmtMoney(r.total_earned)+'</td></tr>'}).join('')+'</tbody></table>':'<div class="empty"><p>No referrals</p></div>';
var rc=creditHistory.slice(0,15);document.getElementById('ref-activity').innerHTML=rc.length?rc.map(function(c){return'<div class="feed-item"><div class="feed-dot" style="background:'+(c.amount>0?'var(--success)':'var(--warning)')+'"></div><div class="feed-content"><div class="feed-text"><strong>'+esc(c.email)+'</strong> '+(c.amount>0?'+':'')+fmtMoney(c.amount)+'</div><div class="feed-time">'+esc(c.description||c.type)+' \u00b7 '+timeAgo(c.created_at)+'</div></div></div>'}).join(''):'<div class="empty"><p>No activity</p></div>'}

/* --- CREATE REFERRAL CODE --- */
async function createReferralCode(email){if(!await qpConfirm('Create Referral Code','Create a new referral code for '+email+'?',{okText:'Create'}))return;try{var existing=await sbAdmin.from('referral_codes').select('code').eq('email',email.toLowerCase());if(existing.data&&existing.data.length){showToast('Already has code: '+existing.data[0].code,'info');await loadAllData();showCustomerDetail(email);return}var code='';var chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';for(var i=0;i<8;i++)code+=chars.charAt(Math.floor(Math.random()*chars.length));var codeCheck=await sbAdmin.from('referral_codes').select('code').eq('code',code);if(codeCheck.data&&codeCheck.data.length)code+=Math.floor(Math.random()*10);await sbAdmin.from('referral_codes').insert({email:email.toLowerCase(),code:code,credit_balance:0,total_earned:0,successful_referrals:0}).then(function(res){if(res.error){console.error('Insert error:',res.error);throw new Error(res.error.message)}});await logAudit('create_referral',email,'Created referral code: '+code,{code:code});await loadAllData();showCustomerDetail(email);showToast('Referral code created: '+code,'success')}catch(e){showToast('Error: '+e.message,'error')}}

/* --- DANGER ZONE: REVOKE ALL ACCESS (soft â€” marks revoked, no deletes) --- */
async function revokeAllAccess(email){if(!await qpConfirm('Revoke All Access','Revoke ALL access for '+email+'? This will mark all purchases as revoked and disable all enrollments. Data is preserved.',{danger:true,okText:'Revoke All'}))return;try{var freshPurchases=await sbAdmin.from('purchases').select('*').eq('email',email.toLowerCase());var cp=freshPurchases.data||[];for(var i=0;i<cp.length;i++){if(!cp[i].product_id.startsWith('revoked__')){await sbAdmin.from('purchases').update({product_id:'revoked__'+cp[i].product_id}).eq('id',cp[i].id)}}var prof=await sbAdmin.from('qa_profiles').select('id').eq('email',email.toLowerCase());if(prof.data&&prof.data.length){var uid=prof.data[0].id;await sbAdmin.from('qa_enrollments').update({status:'revoked'}).eq('user_id',uid)}await logAudit('revoke_all',email,'Revoked ALL access ('+cp.length+' purchases marked revoked, enrollments disabled)');await loadAllData();showCustomerDetail(email);showToast('All access revoked for '+email,'success')}catch(e){showToast('Error: '+e.message,'error')}}

/* --- DANGER ZONE: ARCHIVE ACCOUNT (soft â€” blocks auth, keeps all data) --- */
async function archiveAccount(email,userId){if(!await qpConfirm('Archive Account','Archive account for '+email+'? This will block login, revoke enrollments, and mark as blocked. All data is preserved and can be restored.',{danger:true,okText:'Archive'}))return;try{await fetch(SUPABASE_URL+'/auth/v1/admin/users/'+userId,{method:'PUT',headers:{'Content-Type':'application/json','apikey':SUPABASE_SERVICE_KEY,'Authorization':'Bearer '+SUPABASE_SERVICE_KEY},body:JSON.stringify({ban_duration:'876600h'})});await sbAdmin.from('profiles').update({is_blocked:true}).eq('id',userId);var qaProf=await sbAdmin.from('qa_profiles').select('id').eq('email',email.toLowerCase());if(qaProf.data&&qaProf.data.length){await sbAdmin.from('qa_enrollments').update({status:'revoked'}).eq('user_id',qaProf.data[0].id)}await logAudit('archive_account',email,'Archived account (auth banned, enrollments revoked, data preserved)',{user_id:userId});await loadAllData();showCustomerDetail(email);showToast('Account archived for '+email+'. Data preserved.','success')}catch(e){showToast('Error: '+e.message,'error')}}

/* --- RESET STUDENT PROGRESS --- */
async function resetStudentProgress(userId,courseId,courseName,email){if(!await qpConfirm('Reset Progress','Reset all lesson progress for '+email+' in '+courseName+'? This will mark all lessons as incomplete.',{danger:true,okText:'Reset'}))return;try{await sb.from('qa_lesson_progress').delete().eq('user_id',userId).eq('course_id',courseId);await logAudit('reset_progress',email,'Reset progress for '+courseName,{course_id:courseId});await loadAllData();showCustomerDetail(email);showToast('Progress reset for '+courseName,'success')}catch(e){showToast('Error: '+e.message,'error')}}

/* --- BULK ENROLL (CSV) --- */
async function bulkEnrollCSV(){var fileInput=document.getElementById('bulk-csv');if(!fileInput||!fileInput.files.length)return showToast('Select a CSV file first','error');var file=fileInput.files[0];var reader=new FileReader();reader.onload=async function(ev){var text=ev.target.result;var lines=text.split(/\r?\n/).filter(function(l){return l.trim()});if(lines.length<2)return showToast('CSV needs a header row and at least one data row','error');var header=lines[0].toLowerCase();var hasSlug=header.indexOf('course')>=0||header.indexOf('slug')>=0;var results=[];var errors=[];var slug=document.getElementById('bulk-course').value;for(var i=1;i<lines.length;i++){var parts=lines[i].split(',').map(function(s){return s.trim().replace(/^["']|["']$/g,'')});var email=parts[0];if(!email||email.indexOf('@')<0)continue;var courseSlug=hasSlug&&parts[1]?parts[1]:slug;try{var prof=await sb.from('qa_profiles').select('id').eq('email',email.toLowerCase());if(!prof.data||!prof.data.length){errors.push(email+': No Academy account');continue}var uid=prof.data[0].id;var course=await sb.from('qa_courses').select('id').eq('slug',courseSlug).single();if(!course.data){errors.push(email+': Course "'+courseSlug+'" not found');continue}await sb.from('qa_enrollments').upsert({user_id:uid,course_id:course.data.id,status:'active',enrolled_at:new Date().toISOString()},{onConflict:'user_id,course_id'});results.push(email)}catch(e){errors.push(email+': '+e.message)}}await logAudit('bulk_enroll',null,'Bulk enrolled '+results.length+' students'+(errors.length?' ('+errors.length+' errors)':''),{enrolled:results,errors:errors});await loadAllData();loadAcadStudents();loadAcademyData();var msg=document.getElementById('bulk-msg');var txt='Enrolled '+results.length+' students.';if(errors.length)txt+='\n\nErrors:\n'+errors.join('\n');showMsg(msg,errors.length?'error':'success',txt)};reader.readAsText(file)}

/* --- EMAIL CENTER --- */
const APPS_SCRIPT_URL='https://script.google.com/macros/s/AKfycbxHvXyIybqImwiCkWSj9_VcnmGGmeknJVLbWRa16LjVa6L5Md1IaMfw0kgO6RsrFNVz/exec';
let currentAudience=[],emailStatsUsersCache=[],emailStudentListData=[],currentEmailStudentFilter='total',_campaignHistoryData=[];
const EMAIL_TEMPLATES={welcome:{name:'Welcome',icon:'ðŸ‘‹',subject:'Welcome to the Quantum Physician Family! âœ¨',body:'Hi {{name}},\n\nWelcome to Quantum Physician! We\'re so excited to have you join our healing community.\n\nYour journey toward balance, vitality, and inner alignment starts now.\n\nIf you have any questions, just reply to this email â€“ we\'re here for you every step of the way.'},newSession:{name:'New Session',icon:'âœ¨',subject:'ðŸŽ‰ New Fusion Session Now Available!',body:'Hi {{name}},\n\nExciting news! A new Fusion Session is now available.\n\nLog in to your dashboard to learn more and secure your spot.'},reminder:{name:'Session Reminder',icon:'â°',subject:'â° Your Fusion Session is Coming Up!',body:'Hi {{name}},\n\nJust a friendly reminder that your next Fusion Session is coming up soon!\n\nCheck your dashboard for the exact date and time.'},referral:{name:'Referral Promo',icon:'ðŸŽ',subject:'ðŸŽ Share the Healing & Earn Rewards!',body:'Hi {{name}},\n\nDid you know you can earn credits just by sharing Quantum Physician with friends?\n\nYour personal referral code: {{referral_code}}\n\nVisit your Referral Hub to grab your shareable link!'},thankYou:{name:'Thank You',icon:'ðŸ’œ',subject:'ðŸ’œ Thank You for Being Part of Our Community',body:'Hi {{name}},\n\nWe just wanted to take a moment to say THANK YOU.\n\nThank you for trusting us with your healing journey.\n\nWith gratitude and healing energy.'},academyWelcome:{name:'Academy Welcome',icon:'ðŸŽ“',subject:'Welcome to the Self-H.O.P.E. Academy! ðŸŽ“',body:'Hi {{name}},\n\nWelcome to the Self-H.O.P.E. Academy! Your courses are ready and waiting for you.\n\nLog in to your student dashboard to start learning today.'}};

function loadEmailPage(){loadEmailStats();updateAudiencePreview();renderTemplateGrid();loadCampaignHistory();loadWeeklyEmailLimit();var si=document.getElementById('email-subject');if(si)si.oninput=function(){document.getElementById('subject-count').textContent=this.value.length}}

function loadEmailStats(){var optedIn=0,optedOut=0,total=0;authUsersMap.forEach(function(u){total++;var oi=true;if(u.raw_user_meta_data&&u.raw_user_meta_data.marketing_opt_in===false)oi=false;if(oi)optedIn++;else optedOut++});document.getElementById('email-stats').innerHTML='<div class="stat-card" style="cursor:pointer" onclick="toggleEmailStudentList(\'opted-in\')"><div class="stat-ico green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div><div><div class="stat-val">'+optedIn+'</div><div class="stat-lbl">Opted In</div></div></div><div class="stat-card" style="cursor:pointer" onclick="toggleEmailStudentList(\'opted-out\')"><div class="stat-ico warm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></div><div><div class="stat-val">'+optedOut+'</div><div class="stat-lbl">Opted Out</div></div></div><div class="stat-card" style="cursor:pointer" onclick="toggleEmailStudentList(\'total\')"><div class="stat-ico teal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><div><div class="stat-val">'+total+'</div><div class="stat-lbl">Total Users</div></div></div><div class="stat-card"><div class="stat-ico purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div><div><div class="stat-val">'+emailCampaignsData.length+'</div><div class="stat-lbl">Campaigns Sent</div></div></div>'}

function toggleEmailStudentList(filterType){var panel=document.getElementById('email-student-panel');if(panel.style.display!=='none'&&currentEmailStudentFilter===filterType){closeEmailStudentList();return}currentEmailStudentFilter=filterType;var titles={'opted-in':'âœ… Opted-In Users','opted-out':'ðŸš« Opted-Out Users','total':'ðŸ‘¥ All Users'};document.getElementById('email-student-title').textContent=titles[filterType]||'Users';document.getElementById('email-student-search').value='';panel.style.display='block';var wrap=document.getElementById('email-student-table-wrap');var users=[];authUsersMap.forEach(function(u){var oi=true;if(u.raw_user_meta_data&&u.raw_user_meta_data.marketing_opt_in===false)oi=false;if(filterType==='opted-in'&&!oi)return;if(filterType==='opted-out'&&oi)return;var prof=profilesData.find(function(p){return p.email&&p.email.toLowerCase()===(u.email||'').toLowerCase()});users.push({email:u.email,name:prof?prof.full_name||'':'',optedIn:oi,lastLogin:u.last_sign_in_at})});emailStudentListData=users;renderEmailStudentList(users);panel.scrollIntoView({behavior:'smooth'})}
function closeEmailStudentList(){document.getElementById('email-student-panel').style.display='none'}
function filterEmailStudentList(){var q=(document.getElementById('email-student-search').value||'').toLowerCase().trim();var filtered=emailStudentListData.filter(function(u){return!q||u.email.toLowerCase().indexOf(q)>=0||(u.name||'').toLowerCase().indexOf(q)>=0});renderEmailStudentList(filtered)}
function renderEmailStudentList(users){var wrap=document.getElementById('email-student-table-wrap');if(!users.length){wrap.innerHTML='<p style="color:var(--text-dim);font-size:12px">No users match filter</p>';return}wrap.innerHTML='<table class="tbl"><thead><tr><th>Email</th><th>Name</th><th>Status</th><th>Last Login</th></tr></thead><tbody>'+users.map(function(u){return'<tr><td class="email">'+esc(u.email)+'</td><td>'+esc(u.name||'â€”')+'</td><td>'+(u.optedIn?'<span class="badge green">Opted In</span>':'<span class="badge muted">Opted Out</span>')+'</td><td style="font-size:11px;color:var(--text-dim)">'+timeAgo(u.lastLogin)+'</td></tr>'}).join('')+'</tbody></table>'}

function getWeeklyEmailLimit(){return parseInt(localStorage.getItem('weeklyPromoEmailLimit')||'3',10)}
function saveWeeklyEmailLimit(){var val=parseInt(document.getElementById('weekly-email-limit').value,10)||3;localStorage.setItem('weeklyPromoEmailLimit',val)}
function loadWeeklyEmailLimit(){var el=document.getElementById('weekly-email-limit');if(el)el.value=getWeeklyEmailLimit()}

async function updateAudiencePreview(){var audience=document.getElementById('email-audience').value;var customGroup=document.getElementById('custom-emails-group');var previewEl=document.getElementById('audience-preview');customGroup.style.display=audience==='custom'?'block':'none';if(audience==='custom'){previewEl.innerHTML='Enter emails above, then click Preview';currentAudience=[];updateSendCount();return}previewEl.innerHTML='<div class="spinner" style="display:inline-block;width:14px;height:14px;margin-right:8px"></div> Loading...';try{var recipients=[];if(audience==='all-opted-in'){authUsersMap.forEach(function(u){var oi=true;if(u.raw_user_meta_data&&u.raw_user_meta_data.marketing_opt_in===false)oi=false;if(oi){var prof=profilesData.find(function(p){return p.email&&p.email.toLowerCase()===u.email.toLowerCase()});var ref=referralData.find(function(r){return r.email&&r.email.toLowerCase()===u.email.toLowerCase()});recipients.push({email:u.email,name:prof?prof.full_name||'':'',referral_code:ref?ref.code||'':''})}})}else if(audience==='bundle-owners'){var bundleEmails={};purchasesData.forEach(function(p){if(p.product_id==='bundle-all')bundleEmails[p.email.toLowerCase()]=true});authUsersMap.forEach(function(u){var oi=true;if(u.raw_user_meta_data&&u.raw_user_meta_data.marketing_opt_in===false)oi=false;if(oi&&bundleEmails[u.email.toLowerCase()]){var prof=profilesData.find(function(p){return p.email&&p.email.toLowerCase()===u.email.toLowerCase()});var ref=referralData.find(function(r){return r.email&&r.email.toLowerCase()===u.email.toLowerCase()});recipients.push({email:u.email,name:prof?prof.full_name||'':'',referral_code:ref?ref.code||'':''})}})}else if(audience==='single-session'){var purchMap={};purchasesData.forEach(function(p){if(!purchMap[p.email.toLowerCase()])purchMap[p.email.toLowerCase()]={hasBundle:false};if(p.product_id==='bundle-all')purchMap[p.email.toLowerCase()].hasBundle=true});var singleEmails={};Object.keys(purchMap).forEach(function(e){if(!purchMap[e].hasBundle)singleEmails[e]=true});authUsersMap.forEach(function(u){var oi=true;if(u.raw_user_meta_data&&u.raw_user_meta_data.marketing_opt_in===false)oi=false;if(oi&&singleEmails[u.email.toLowerCase()]){var prof=profilesData.find(function(p){return p.email&&p.email.toLowerCase()===u.email.toLowerCase()});var ref=referralData.find(function(r){return r.email&&r.email.toLowerCase()===u.email.toLowerCase()});recipients.push({email:u.email,name:prof?prof.full_name||'':'',referral_code:ref?ref.code||'':''})}})}else if(audience==='no-purchase'){var purchaserEmails={};purchasesData.forEach(function(p){purchaserEmails[p.email.toLowerCase()]=true});authUsersMap.forEach(function(u){var oi=true;if(u.raw_user_meta_data&&u.raw_user_meta_data.marketing_opt_in===false)oi=false;if(oi&&!purchaserEmails[u.email.toLowerCase()]){var prof=profilesData.find(function(p){return p.email&&p.email.toLowerCase()===u.email.toLowerCase()});recipients.push({email:u.email,name:prof?prof.full_name||'':'',referral_code:''})}})}else if(audience.startsWith('session-')){var sessionEmails={};purchasesData.forEach(function(p){if(p.product_id===audience||p.product_id==='bundle-all')sessionEmails[p.email.toLowerCase()]=true});authUsersMap.forEach(function(u){var oi=true;if(u.raw_user_meta_data&&u.raw_user_meta_data.marketing_opt_in===false)oi=false;if(oi&&sessionEmails[u.email.toLowerCase()]){var prof=profilesData.find(function(p){return p.email&&p.email.toLowerCase()===u.email.toLowerCase()});var ref=referralData.find(function(r){return r.email&&r.email.toLowerCase()===u.email.toLowerCase()});recipients.push({email:u.email,name:prof?prof.full_name||'':'',referral_code:ref?ref.code||'':''})}})}else if(audience==='academy-all'){var acadEmails={};academyEnrollments.forEach(function(e){if(e.status==='active'){var prof=profilesData.find(function(p){return p.id===e.user_id});if(prof)acadEmails[prof.email?prof.email.toLowerCase():'']=true}});var qaProfs={};purchasesData.forEach(function(p){if(isAcademy(p.product_id))acadEmails[p.email.toLowerCase()]=true});authUsersMap.forEach(function(u){var oi=true;if(u.raw_user_meta_data&&u.raw_user_meta_data.marketing_opt_in===false)oi=false;if(oi&&acadEmails[u.email.toLowerCase()]){var prof=profilesData.find(function(p){return p.email&&p.email.toLowerCase()===u.email.toLowerCase()});var ref=referralData.find(function(r){return r.email&&r.email.toLowerCase()===u.email.toLowerCase()});recipients.push({email:u.email,name:prof?prof.full_name||'':'',referral_code:ref?ref.code||'':''})}})}currentAudience=recipients;var emails=recipients.map(function(r){return r.email});var vis=emails.slice(0,8);var hidden=emails.slice(8);var html='<div style="display:flex;justify-content:space-between;align-items:center"><span style="color:var(--teal);font-weight:600">ðŸ“¬ '+recipients.length+' recipient'+(recipients.length!==1?'s':'')+' selected</span>'+(recipients.length>0?'<button class="btn btn-ghost btn-sm" onclick="copyAllEmails()">ðŸ“‹ Copy All</button>':'')+'</div>';if(recipients.length>0){html+='<div style="margin-top:8px;font-size:12px;color:var(--text-dim)">';vis.forEach(function(e){html+=esc(e)+'<br>'});if(hidden.length)html+='<span style="color:var(--teal);cursor:pointer" onclick="toggleAudienceExpand(this,'+hidden.length+')">...and '+hidden.length+' more â–¼</span><span class="ec-hidden" style="display:none">'+hidden.map(function(e){return esc(e)}).join('<br>')+'</span>';html+='</div>'}previewEl.innerHTML=html;updateSendCount()}catch(e){console.error('Audience error:',e);previewEl.innerHTML='<span style="color:var(--danger)">Error loading audience</span>'}}

function updateSendCount(){var el=document.getElementById('send-count');if(el)el.textContent=currentAudience.length}
function copyAllEmails(){var emails=currentAudience.map(function(r){return r.email}).join('\n');navigator.clipboard.writeText(emails).then(function(){showToast('Copied '+currentAudience.length+' emails','success')}).catch(function(){showToast('Copy failed','error')})}
function toggleAudienceExpand(el,count){var hidden=el.parentElement.querySelector('.ec-hidden');if(!hidden)return;var showing=hidden.style.display!=='none';hidden.style.display=showing?'none':'block';el.textContent=showing?'...and '+count+' more â–¼':'show less â–²'}
function insertEmailVar(v){var ta=document.getElementById('email-body');var s=ta.selectionStart,e=ta.selectionEnd,t=ta.value;ta.value=t.substring(0,s)+v+t.substring(e);ta.focus();ta.selectionStart=ta.selectionEnd=s+v.length}

function updateEmailTypeHint(){var type=document.getElementById('email-type-select').value;var hint=document.getElementById('email-type-hint');if(type==='promotional'){hint.style.color='var(--warning)';hint.textContent='âš ï¸ Promotional emails count toward the weekly limit and respect opt-out preferences.'}else if(type==='automated'){hint.style.color='var(--teal)';hint.textContent='âœ… Automated/Course emails are NOT limited and sent regardless of opt-out.'}else{hint.style.color='var(--success)';hint.textContent='âœ… Transactional emails are NOT limited and sent regardless of opt-out.'}}

function previewEmail(){var fromEmail=document.getElementById('email-from').value;var subject=document.getElementById('email-subject').value;var body=document.getElementById('email-body').value;if(!subject||!body){showToast('Fill in subject and body','error');return}if(document.getElementById('email-audience').value==='custom'){var cust=document.getElementById('custom-emails').value.split('\n').map(function(e){return e.trim().toLowerCase()}).filter(function(e){return e&&e.indexOf('@')>=0});currentAudience=cust.map(function(email){return{email:email,name:'',referral_code:''}});updateSendCount()}if(!currentAudience.length){showToast('No recipients selected','error');return}var s=currentAudience[0];var pb=body.replace(/\{\{name\}\}/g,s.name||'Friend').replace(/\{\{email\}\}/g,s.email).replace(/\{\{referral_code\}\}/g,s.referral_code||'XXXXXX');document.getElementById('preview-from').textContent=fromEmail;document.getElementById('preview-to').textContent=s.email+(currentAudience.length>1?' (+'+( currentAudience.length-1)+' more)':'');document.getElementById('preview-subject').textContent=subject;document.getElementById('preview-body').textContent=pb;document.getElementById('email-preview-box').style.display='block'}

function prepareToSend(){var subject=document.getElementById('email-subject').value;var body=document.getElementById('email-body').value;if(!subject||!body){showToast('Fill in subject and body','error');return}if(document.getElementById('email-audience').value==='custom'){var cust=document.getElementById('custom-emails').value.split('\n').map(function(e){return e.trim().toLowerCase()}).filter(function(e){return e&&e.indexOf('@')>=0});currentAudience=cust.map(function(email){return{email:email,name:'',referral_code:''}});updateSendCount()}if(!currentAudience.length){showToast('No recipients selected','error');return}qpConfirm('Confirm Send','Send this email to '+currentAudience.length+' recipients?\n\nSubject: '+subject+'\nFrom: '+document.getElementById('email-from').value,{okText:'Yes, Send'}).then(function(ok){if(ok)sendEmails()})}

async function sendEmails(){var fromEmail=document.getElementById('email-from').value;var subject=document.getElementById('email-subject').value;var body=document.getElementById('email-body').value;var emailType=document.getElementById('email-type-select').value;var isPromo=emailType==='promotional';document.getElementById('email-log').style.display='block';document.getElementById('send-btn').disabled=true;var logEntries=document.getElementById('email-log-entries');var progressFill=document.getElementById('progress-fill');var progressText=document.getElementById('progress-text');logEntries.innerHTML='';progressFill.style.width='0%';addLogEntry('Starting email send... (type: '+emailType+')','info');var sent=0,failed=0,skippedLimit=0;var total=currentAudience.length;
/* Create campaign record */
var campaignId=null;try{var res=await sbAdmin.from('email_campaigns').insert([{campaign_type:isPromo?'custom':'automated',campaign_name:subject,subject:subject,from_email:fromEmail,recipient_count:total,status:'sending',sent_at:new Date().toISOString()}]).select().single();if(res.data)campaignId=res.data.id}catch(e){console.error('Campaign insert error:',e)}
/* Pre-check weekly limits for promos */
var recipientEmailCounts={};if(isPromo){var weeklyLimit=getWeeklyEmailLimit();addLogEntry('Weekly promo limit: '+weeklyLimit+' per user','info');var sevenDaysAgo=new Date(Date.now()-7*24*60*60*1000).toISOString();try{var rt=await sb.from('email_tracking').select('recipient_email').in('recipient_email',currentAudience.map(function(r){return r.email})).eq('email_type','promotional').gte('sent_at',sevenDaysAgo);(rt.data||[]).forEach(function(t){recipientEmailCounts[t.recipient_email]=(recipientEmailCounts[t.recipient_email]||0)+1})}catch(e){addLogEntry('âš ï¸ Could not pre-check limits','info')}}else{addLogEntry('â„¹ï¸ '+emailType+' â€” weekly limit NOT enforced','info')}
for(var i=0;i<total;i++){var recipient=currentAudience[i];
/* Check weekly limit for promos */
if(isPromo){var wl=getWeeklyEmailLimit();var cc=(recipientEmailCounts[recipient.email]||0);if(cc>=wl){skippedLimit++;addLogEntry('â­ Skipped '+recipient.email+' â€” promo limit ('+cc+'/'+wl+')','skip');progressFill.style.width=((i+1)/total*100).toFixed(0)+'%';progressText.textContent='Sent '+sent+'/'+total+(failed?' ('+failed+' failed':'')+(skippedLimit?', '+skippedLimit+' skipped':'')+')';continue}}
var trackingId=campaignId?(campaignId.slice(0,8)+'-'+Date.now()+'-'+Math.random().toString(36).substr(2,6)):('manual-'+Date.now()+'-'+Math.random().toString(36).substr(2,6));
/* Insert tracking record */
try{await sbAdmin.from('email_tracking').insert([{campaign_id:campaignId,recipient_email:recipient.email,tracking_id:trackingId,status:'sent',email_type:emailType,sent_at:new Date().toISOString()}])}catch(e){}
var ps=subject.replace(/\{\{name\}\}/g,recipient.name||'Friend').replace(/\{\{email\}\}/g,recipient.email);var pb=body.replace(/\{\{name\}\}/g,recipient.name||'Friend').replace(/\{\{email\}\}/g,recipient.email).replace(/\{\{referral_code\}\}/g,recipient.referral_code||'');
try{await fetch(APPS_SCRIPT_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:JSON.stringify({to:recipient.email,from:fromEmail,subject:ps,body:pb})});sent++;addLogEntry('âœ“ Sent to '+recipient.email,'success');if(isPromo)recipientEmailCounts[recipient.email]=(recipientEmailCounts[recipient.email]||0)+1}catch(e){failed++;addLogEntry('âœ— Error: '+recipient.email+' â€” '+e.message,'error')}
progressFill.style.width=((i+1)/total*100).toFixed(0)+'%';progressText.textContent='Sent '+sent+'/'+total+(failed?' ('+failed+' failed':'')+(skippedLimit?', '+skippedLimit+' skipped':'')+')';await new Promise(function(r){setTimeout(r,100)})}
/* Update campaign record */
if(campaignId){try{await sbAdmin.from('email_campaigns').update({status:failed===total?'failed':'sent',sent_count:sent,failed_count:failed}).eq('id',campaignId)}catch(e){}}
var summary='âœ… Complete! Sent: '+sent;if(failed)summary+=' | Failed: '+failed;if(skippedLimit)summary+=' | Skipped: '+skippedLimit;addLogEntry(summary,'success');document.getElementById('send-btn').disabled=false;await logAudit('send_email',null,'Sent campaign "'+subject+'" to '+sent+' recipients'+(failed?' ('+failed+' failed)':''),{campaign_id:campaignId,sent:sent,failed:failed,skipped:skippedLimit});await loadAllData();loadCampaignHistory()}

function addLogEntry(text,type){var e=document.createElement('div');e.className='log-entry '+(type||'info');e.textContent=text;document.getElementById('email-log-entries').appendChild(e);e.scrollIntoView({behavior:'smooth'})}

/* Templates */
function getAllTemplates(){var custom=JSON.parse(localStorage.getItem('customEmailTemplates')||'{}');return Object.assign({},EMAIL_TEMPLATES,custom)}
function loadTemplate(key){var tmpl=getAllTemplates()[key];if(!tmpl)return;document.getElementById('email-subject').value=tmpl.subject;document.getElementById('email-body').value=tmpl.body;document.getElementById('subject-count').textContent=tmpl.subject.length;showToast('Loaded "'+tmpl.name+'" template','success');document.getElementById('email-subject').scrollIntoView({behavior:'smooth',block:'center'});document.getElementById('email-subject').focus()}
function renderTemplateGrid(){var grid=document.getElementById('template-grid');if(!grid)return;var all=getAllTemplates();var custom=JSON.parse(localStorage.getItem('customEmailTemplates')||'{}');var html='';for(var key in all){var t=all[key];var isC=custom.hasOwnProperty(key);html+='<button class="template-btn'+(isC?' custom':'')+'" onclick="loadTemplate(\''+key+'\')" oncontextmenu="event.preventDefault();openTemplateEditor(\''+key+'\')"><span class="edit-icon">âœï¸</span><span class="template-icon">'+(t.icon||'ðŸ“§')+'</span><span class="template-name">'+(t.name||key)+'</span></button>'}html+='<button class="template-btn" onclick="openTemplateEditor(null)"><span class="template-icon">âž•</span><span class="template-name">Create New</span></button>';grid.innerHTML=html}
var editingTemplateKey=null;
function openTemplateEditor(key){editingTemplateKey=key;var custom=JSON.parse(localStorage.getItem('customEmailTemplates')||'{}');var all=getAllTemplates();var t=key?all[key]:null;var title=key?'Edit Template':'Create New Template';var html='<div style="display:flex;flex-direction:column;gap:12px"><div class="form-group"><label>Name</label><input type="text" class="input" id="tmpl-name" value="'+(t?esc(t.name):'')+'"></div><div class="form-group"><label>Icon (emoji)</label><input type="text" class="input" id="tmpl-icon" value="'+(t?t.icon||'ðŸ“§':'ðŸ“§')+'" style="width:60px"></div><div class="form-group"><label>Subject</label><input type="text" class="input" id="tmpl-subject" value="'+(t?esc(t.subject):'')+'"></div><div class="form-group"><label>Body</label><textarea class="input" id="tmpl-body" rows="6">'+(t?esc(t.body):'')+'</textarea></div></div>';showModal({title:title,message:'',type:'confirm',okText:'Save'}).then(function(){});
/* Use a simpler modal approach */
var overlay=document.createElement('div');overlay.className='modal-overlay';overlay.innerHTML='<div class="modal-box" style="max-width:500px"><div class="modal-title">'+title+'</div>'+html+'<div class="modal-actions" style="margin-top:16px">'+(key&&custom.hasOwnProperty(key)?'<button class="btn btn-danger btn-sm" id="tmpl-del">Delete</button>':'')+'<button class="btn btn-ghost btn-sm" id="tmpl-cancel">Cancel</button><button class="btn btn-primary btn-sm" id="tmpl-save">Save</button></div></div>';document.body.appendChild(overlay);overlay.querySelector('#tmpl-save').onclick=function(){var n=document.getElementById('tmpl-name').value.trim(),ic=document.getElementById('tmpl-icon').value.trim()||'ðŸ“§',su=document.getElementById('tmpl-subject').value.trim(),bo=document.getElementById('tmpl-body').value.trim();if(!n||!su||!bo){showToast('Fill in all fields','error');return}var ct=JSON.parse(localStorage.getItem('customEmailTemplates')||'{}');var k2=editingTemplateKey||n.toLowerCase().replace(/[^a-z0-9]/g,'_');ct[k2]={name:n,icon:ic,subject:su,body:bo};localStorage.setItem('customEmailTemplates',JSON.stringify(ct));overlay.remove();renderTemplateGrid();showToast('Template saved','success')};overlay.querySelector('#tmpl-cancel').onclick=function(){overlay.remove()};var delBtn=overlay.querySelector('#tmpl-del');if(delBtn)delBtn.onclick=function(){var ct=JSON.parse(localStorage.getItem('customEmailTemplates')||'{}');delete ct[editingTemplateKey];localStorage.setItem('customEmailTemplates',JSON.stringify(ct));overlay.remove();renderTemplateGrid();showToast('Template deleted','success')};overlay.onclick=function(e){if(e.target===overlay)overlay.remove()}}

/* Campaign History */
async function loadCampaignHistory(){var container=document.getElementById('campaign-history-list');if(!container)return;_campaignHistoryData=emailCampaignsData;renderCampaignHistory('all')}
function filterCampaignHistory(type,btn){if(btn){btn.parentElement.querySelectorAll('.ec-filter').forEach(function(b){b.classList.remove('active')});btn.classList.add('active')}renderCampaignHistory(type)}
function renderCampaignHistory(filterType){var container=document.getElementById('campaign-history-list');var campaigns=filterType==='all'?_campaignHistoryData:_campaignHistoryData.filter(function(c){return c.campaign_type===filterType});if(!campaigns.length){container.innerHTML='<div class="empty"><p>No campaigns found'+(filterType!=='all'?' for this filter':'')+'.</p></div>';return}container.innerHTML=campaigns.map(function(c){var date=c.sent_at?new Date(c.sent_at):null;var dateStr=date?date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' '+date.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}):'Draft';var openRate=c.sent_count>0?((c.open_count||0)/c.sent_count*100).toFixed(1):'0';var clickRate=c.open_count>0?((c.click_count||0)/c.open_count*100).toFixed(1):'0';var typeLabel=(c.campaign_type||'custom').replace(/_/g,' ');return'<div class="campaign-item" id="hc-'+c.id+'"><div class="campaign-item-header" onclick="toggleCampaignDetail(\''+c.id+'\')"><span class="campaign-type-badge '+(c.campaign_type||'custom')+'">'+typeLabel+'</span><span style="flex:1;font-weight:500;font-size:13px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(c.campaign_name||c.subject||'Untitled')+'</span><span style="display:flex;gap:14px;align-items:center;font-size:12px;color:var(--text-dim);flex-shrink:0"><span style="color:var(--text-dim)">'+dateStr+'</span><span><strong style="color:var(--teal)">'+(c.sent_count||0)+'</strong> sent</span><span><strong style="color:var(--purple)">'+openRate+'%</strong> opened</span><span><strong style="color:var(--warning)">'+clickRate+'%</strong> clicked</span><span style="font-size:14px">â–¼</span></span></div><div class="campaign-item-body"><div id="hc-recipients-'+c.id+'"><div class="loading-center"><div class="spinner"></div>Loading...</div></div></div></div>'}).join('')}

async function toggleCampaignDetail(id){var el=document.getElementById('hc-'+id);var wasExpanded=el.classList.contains('expanded');document.querySelectorAll('.campaign-item.expanded').forEach(function(c){c.classList.remove('expanded')});if(wasExpanded)return;el.classList.add('expanded');var rc=document.getElementById('hc-recipients-'+id);try{var res=await sb.from('email_tracking').select('*').eq('campaign_id',id).order('sent_at',{ascending:false});var tracking=res.data||[];if(!tracking.length){rc.innerHTML='<p style="color:var(--text-dim);font-size:12px">No tracking data for this campaign.</p>';return}var totalSent=tracking.length,totalOpened=tracking.filter(function(t){return t.opened_at}).length,totalClicked=tracking.filter(function(t){return t.clicked_at}).length;var html='<div style="display:flex;gap:14px;margin-bottom:12px;font-size:12px;color:var(--text-dim)"><span><strong style="color:var(--teal)">'+totalSent+'</strong> delivered</span><span><strong style="color:var(--purple)">'+totalOpened+'</strong> opened ('+(totalSent>0?(totalOpened/totalSent*100).toFixed(0):0)+'%)</span><span><strong style="color:var(--warning)">'+totalClicked+'</strong> clicked ('+(totalOpened>0?(totalClicked/totalOpened*100).toFixed(0):0)+'%)</span></div>';html+='<table class="tbl"><thead><tr><th>Recipient</th><th>Status</th><th>Opened</th><th>Clicked</th><th>Sent</th></tr></thead><tbody>';tracking.forEach(function(t){var statusColor=t.clicked_at?'var(--success)':(t.opened_at?'var(--purple)':'var(--text-dim)');var statusLabel=t.clicked_at?'Engaged':(t.opened_at?'Opened':'Delivered');var sentDate=t.sent_at?new Date(t.sent_at).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'-';var opened=t.opened_at?'âœ… '+new Date(t.opened_at).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'â€”';var clicked=t.clicked_at?'âœ… '+new Date(t.clicked_at).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'â€”';html+='<tr><td class="email" style="cursor:pointer" onclick="go(\'customers\');setTimeout(function(){showCustomerDetail(\''+esc(t.recipient_email)+'\')},100)">'+esc(t.recipient_email||'-')+'</td><td><span style="color:'+statusColor+';font-weight:600;font-size:10px;text-transform:uppercase">'+statusLabel+'</span></td><td style="font-size:11px">'+opened+'</td><td style="font-size:11px">'+clicked+'</td><td style="font-size:11px;color:var(--text-dim)">'+sentDate+'</td></tr>'});html+='</tbody></table>';rc.innerHTML=html}catch(e){rc.innerHTML='<p style="color:var(--danger);font-size:12px">Error loading recipients.</p>'}}

/* Email Customer (from detail panel) */
function emailCustomer(email){go('email',document.querySelector('.sb-link[onclick*="email"]'));setTimeout(function(){document.getElementById('email-audience').value='custom';document.getElementById('custom-emails-group').style.display='block';document.getElementById('custom-emails').value=email;currentAudience=[{email:email,name:'',referral_code:''}];document.getElementById('audience-preview').innerHTML='<span style="color:var(--teal);font-weight:600">ðŸ“¬ 1 recipient selected</span><div style="margin-top:4px;font-size:12px;color:var(--text-dim)">'+esc(email)+'</div>';updateSendCount();document.getElementById('email-subject').scrollIntoView({behavior:'smooth',block:'center'});document.getElementById('email-subject').focus();showToast('Ready to email '+email,'success')},200)}

/* Customer Email History (for detail panel) */
async function loadCustomerEmailHistory(email){var tracking=emailTrackingData.filter(function(t){return t.recipient_email&&t.recipient_email.toLowerCase()===email.toLowerCase()});if(!tracking.length)return'<div style="color:var(--text-dim);font-size:12px">No tracked emails</div>';var campaignMap={};emailCampaignsData.forEach(function(c){campaignMap[c.id]=c});return'<div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);margin-bottom:8px">ðŸ“§ Email History ('+tracking.length+')</div>'+tracking.slice(0,20).map(function(t){var c=campaignMap[t.campaign_id]||{};var subj=c.subject||c.campaign_name||'Email';var statusDot=t.clicked_at?'clicked':(t.opened_at?'opened':'sent');var date=t.sent_at?new Date(t.sent_at).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'-';return'<div class="email-detail-row"><span class="email-status-dot '+statusDot+'"></span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(subj)+'</span><span style="color:var(--text-dim);flex-shrink:0">'+date+'</span></div>'}).join('')}

/* --- AUDIT LOG PAGE --- */
var auditPage=1,auditPS=25;
async function loadAuditLog(){var c=document.getElementById('audit-log-content');if(!c)return;c.innerHTML='<div class="loading-center"><div class="spinner"></div>Loading...</div>';try{var filter=document.getElementById('audit-filter').value;var search=(document.getElementById('audit-search').value||'').trim().toLowerCase();var q=sbAdmin.from('admin_audit_log').select('*',{count:'exact'}).order('created_at',{ascending:false});if(filter!=='all')q=q.eq('action',filter);if(search)q=q.ilike('target_email','%'+search+'%');q=q.range((auditPage-1)*auditPS,auditPage*auditPS-1);var res=await q;if(res.error){console.error('Audit log query error:',res.error);throw new Error(res.error.message||JSON.stringify(res.error))}var logs=res.data||[];var total=res.count||0;var tp=Math.ceil(total/auditPS)||1;var actionColors={'grant_access':'var(--success)','revoke_access':'var(--danger)','block_user':'var(--danger)','adjust_credit':'var(--warning)','set_credit':'var(--warning)','create_referral':'var(--teal)','enroll_student':'var(--success)','unenroll_student':'var(--danger)','reset_password':'var(--purple)','reset_progress':'var(--warning)','delete_account':'var(--danger)','revoke_all':'var(--danger)','add_note':'var(--taupe)','delete_note':'var(--text-dim)','bulk_enroll':'var(--teal)','login_as':'var(--purple)'};var actionLabels={'grant_access':'Grant Access','revoke_access':'Revoke Access','block_user':'Block/Unblock','adjust_credit':'Credit Adjust','set_credit':'Credit Set','create_referral':'Create Referral','enroll_student':'Enroll','unenroll_student':'Unenroll','reset_password':'Reset PW','reset_progress':'Reset Progress','delete_account':'Archive Account','archive_account':'Archive Account','revoke_all':'Revoke All','add_note':'Add Note','delete_note':'Delete Note','bulk_enroll':'Bulk Enroll','login_as':'Login As'};document.getElementById('audit-stats').innerHTML='<div class="stat-card"><div class="stat-ico teal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div><div class="stat-val">'+total+'</div><div class="stat-lbl">Total Actions</div></div></div>';if(!logs.length){c.innerHTML='<div class="empty"><p>No audit log entries'+(filter!=='all'?' for this filter':'')+'</p></div>';document.getElementById('audit-pagination').innerHTML='';return}c.innerHTML=logs.map(function(l){var col=actionColors[l.action]||'var(--text-dim)';var label=actionLabels[l.action]||l.action;return'<div class="feed-item"><div class="feed-dot" style="background:'+col+'"></div><div class="feed-content"><div class="feed-text"><span class="badge" style="background:rgba(255,255,255,.06);color:'+col+'">'+label+'</span> '+(l.target_email?'<strong style="cursor:pointer" onclick="go(\'customers\');setTimeout(function(){showCustomerDetail(\''+esc(l.target_email)+'\')},100)">'+esc(l.target_email)+'</strong>':'<span style="color:var(--text-dim)">System</span>')+'</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px">'+esc(l.details||'')+'</div><div class="feed-time" style="display:flex;justify-content:space-between;align-items:center"><span>'+timeAgo(l.created_at)+' \u00b7 '+new Date(l.created_at).toLocaleString()+'</span><span style="color:var(--taupe);font-size:10px">by '+(l.admin_user||'QPadmin')+'</span></div></div></div>'}).join('');document.getElementById('audit-pagination').innerHTML='<span>'+total+' entries \u00b7 Page '+auditPage+'/'+tp+'</span><div class="page-btns"><button class="btn btn-ghost btn-sm" onclick="auditPage=Math.max(1,auditPage-1);loadAuditLog()" '+(auditPage<=1?'disabled':'')+'>Prev</button><button class="btn btn-ghost btn-sm" onclick="auditPage=Math.min('+tp+',auditPage+1);loadAuditLog()" '+(auditPage>=tp?'disabled':'')+'>Next</button></div>'}catch(e){c.innerHTML='<p style="color:var(--danger)">Error loading audit log: '+e.message+'</p>'}}
</script>
</body>
</html>