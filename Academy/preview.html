<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Course Preview</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,sans-serif;background:#0b1d30;color:rgba(255,255,255,.9);line-height:1.6}
h1,h2{font-family:'Playfair Display',serif}
a{color:#5bb8c2;text-decoration:none}

/* Admin bar */
.bar{background:#1a1035;border-bottom:1px solid rgba(167,139,250,.2);padding:8px 24px;display:flex;align-items:center;gap:10px;font-size:12px;color:#a78bfa;position:sticky;top:0;z-index:50}
.bar b{text-transform:uppercase;letter-spacing:.05em}
.bar a{margin-left:auto;color:#5bb8c2;font-weight:600}

/* Shared */
.container{max-width:900px;margin:0 auto;padding:0 24px}
.sec{margin-bottom:36px}
.sec h2{font-size:22px;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid rgba(91,184,194,.15);display:inline-block}
.card{background:#112a42;border:1px solid rgba(91,168,178,.12);border-radius:12px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:8px;border:none;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer}
.btn-teal{background:linear-gradient(135deg,#5bb8c2,#4fd4e0);color:#fff}
.btn-ghost{background:none;border:1px solid rgba(91,168,178,.2);color:rgba(255,255,255,.7)}
.btn-ghost:hover{border-color:#5bb8c2;color:#5bb8c2}

/* LANDING PAGE MODE */
.hero{padding:48px 0 32px}
.hero-grid{display:grid;grid-template-columns:1fr 380px;gap:32px;align-items:start}
.badge{display:inline-block;padding:4px 12px;border-radius:16px;font-size:11px;font-weight:700;text-transform:uppercase;margin-bottom:14px;background:rgba(240,180,41,.1);color:#f0b429;border:1px solid rgba(240,180,41,.25)}
.badge.published{background:rgba(61,214,140,.1);color:#3dd68c;border-color:rgba(61,214,140,.25)}
.hero h1{font-size:36px;margin-bottom:10px}
.hero .sub{font-size:17px;color:rgba(255,255,255,.5);margin-bottom:16px}
.hero .meta{font-size:13px;color:rgba(255,255,255,.3);margin-bottom:20px}
.hero-img{width:100%;border-radius:12px;border:1px solid rgba(91,168,178,.12);background:#112a42;overflow:hidden;aspect-ratio:16/10}
.hero-img img{width:100%;height:100%;object-fit:cover;display:block}
.hero-img .ph{display:flex;align-items:center;justify-content:center;height:100%;color:rgba(255,255,255,.2);font-size:14px}
.price-bar{padding:20px 24px;margin-bottom:32px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.price-big{font-size:32px;font-weight:800;color:#5bb8c2}

.learn-item{padding:12px 16px;border-radius:8px;margin-bottom:6px;font-size:14px;color:rgba(255,255,255,.7);border-left:3px solid transparent}
.learn-item:nth-child(odd){background:rgba(91,188,198,.04);border-left-color:rgba(91,184,194,.3)}
.learn-item:nth-child(even){background:rgba(167,139,250,.03);border-left-color:rgba(167,139,250,.2)}
.learn-item::before{content:'✓ ';color:#5bb8c2;font-weight:700}

/* Modules */
.mod{border:1px solid rgba(91,168,178,.12);border-radius:10px;margin-bottom:8px;overflow:hidden}
.mod-h{padding:14px 18px;display:flex;align-items:center;gap:12px;cursor:pointer}
.mod-h:hover{background:rgba(91,168,178,.02)}
.mod-n{width:28px;height:28px;border-radius:6px;background:rgba(91,184,194,.1);color:#5bb8c2;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;flex-shrink:0}
.mod-t{flex:1;font-weight:600;font-size:14px}
.mod-c{font-size:12px;color:rgba(255,255,255,.3)}
.mod-a{color:rgba(255,255,255,.3);transition:transform .2s}
.mod.open .mod-a{transform:rotate(180deg)}
.mod-body{display:none;border-top:1px solid rgba(91,168,178,.06)}
.mod.open .mod-body{display:block}

.les{padding:10px 18px 10px 56px;display:flex;align-items:center;gap:10px;cursor:pointer;border-bottom:1px solid rgba(91,168,178,.03);font-size:14px}
.les:last-child{border-bottom:none}
.les:hover{background:rgba(91,168,178,.03)}
.les-i{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.les-i svg{width:13px;height:13px;stroke:currentColor}
.les-i.video{background:rgba(91,184,194,.1);color:#5bb8c2}
.les-i.text{background:rgba(196,173,148,.1);color:#c4ad94}
.les-i.quiz{background:rgba(167,139,250,.1);color:#a78bfa}
.les-i.pdf,.les-i.download{background:rgba(240,180,41,.1);color:#f0b429}
.les-i.assignment{background:rgba(255,94,148,.08);color:#ff5e94}
.les-i.live_session{background:rgba(239,83,80,.08);color:#ef5350}
.les-i.embed{background:rgba(91,184,194,.06);color:#4fd4e0}
.les-i.audio{background:rgba(61,214,140,.08);color:#3dd68c}
.les-n{flex:1}
.les-d{font-size:12px;color:rgba(255,255,255,.3)}
.les-b{font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(91,184,194,.08);color:#5bb8c2;font-weight:700;text-transform:uppercase}

.test{padding:20px 22px;margin-bottom:10px;background:linear-gradient(135deg,rgba(17,42,66,.9),rgba(30,50,75,.6));border:1px solid rgba(196,173,148,.1)}
.test .stars{color:#d4a853;margin-bottom:8px;font-size:14px;letter-spacing:2px}
.test .txt{font-size:14px;color:rgba(255,255,255,.55);font-style:italic;margin-bottom:10px;line-height:1.6}
.test .who{font-size:13px;font-weight:600;color:#c4ad94}

.faq{border:1px solid rgba(91,168,178,.12);border-radius:8px;margin-bottom:6px;overflow:hidden}
.faq-q{padding:14px 18px;font-weight:600;font-size:14px;cursor:pointer;display:flex;justify-content:space-between}
.faq-q:hover{background:rgba(91,168,178,.02)}
.faq-a{padding:0 18px 14px;font-size:14px;color:rgba(255,255,255,.5);display:none}
.faq.open .faq-a{display:block}

/* LESSON VIEW MODE */
#lessonView{display:none}
.lv-top{padding:12px 0;margin-bottom:24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(91,168,178,.08)}
.lv-back{font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px}
.lv-back:hover{color:#4fd4e0}
.lv-crumb{font-size:12px;color:rgba(255,255,255,.3);flex:1}

.lv-title{font-size:28px;margin-bottom:8px}
.lv-meta{font-size:13px;color:rgba(255,255,255,.3);margin-bottom:24px;display:flex;gap:12px;flex-wrap:wrap}
.lv-meta .pill{padding:3px 10px;border-radius:10px;font-weight:600}
.lv-meta .pill.video{background:rgba(91,184,194,.08);color:#5bb8c2}
.lv-meta .pill.text{background:rgba(196,173,148,.08);color:#c4ad94}
.lv-meta .pill.quiz{background:rgba(167,139,250,.08);color:#a78bfa}
.lv-meta .pill.assignment{background:rgba(255,94,148,.06);color:#ff5e94}
.lv-meta .pill.pdf{background:rgba(240,180,41,.08);color:#f0b429}
.lv-meta .pill.live_session{background:rgba(239,83,80,.06);color:#ef5350}

.lv-video{width:100%;aspect-ratio:16/9;border-radius:12px;overflow:hidden;margin-bottom:28px;background:#000;border:1px solid rgba(91,168,178,.08)}
.lv-video iframe{width:100%;height:100%;border:none}
.lv-video img{width:100%;height:100%;object-fit:cover}

.lv-body{font-size:15px;line-height:1.75;color:rgba(255,255,255,.65);max-width:740px}
.lv-body h2{font-size:20px;color:rgba(255,255,255,.92);margin:32px 0 10px;padding-top:24px;border-top:1px solid rgba(91,168,178,.08);font-family:'Playfair Display',serif}
.lv-body h2:first-child{margin-top:0;padding-top:0;border-top:none}
.lv-body h3{font-size:14px;color:#5bb8c2;margin:18px 0 6px;font-family:Inter,sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:.03em}
.lv-body strong{color:rgba(255,255,255,.85)}
.lv-body code{background:rgba(91,184,194,.08);padding:1px 5px;border-radius:3px;font-size:13px;color:#5bb8c2}
.lv-body ul,.lv-body ol{padding-left:20px;margin:6px 0}
.lv-body li{margin-bottom:2px}

/* Content card wrapper */
.lv-content-card{background:linear-gradient(135deg,rgba(17,42,66,.8),rgba(17,42,66,.5));border:1px solid rgba(91,168,178,.08);border-left:3px solid #5bb8c2;border-radius:0 12px 12px 0;padding:28px 32px;margin:20px 0}
.lv-content-card.quiz-card{border-left-color:#a78bfa}
.lv-content-card.assignment-card{border-left-color:#ff5e94}
.lv-content-card.pdf-card{border-left-color:#f0b429}

/* Lesson type header banner */
.lv-type-banner{padding:10px 16px;border-radius:8px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;display:inline-flex;align-items:center;gap:8px;margin-bottom:20px}
.lv-type-banner.video{background:rgba(91,184,194,.08);color:#5bb8c2}
.lv-type-banner.text{background:rgba(196,173,148,.08);color:#c4ad94}
.lv-type-banner.quiz{background:rgba(167,139,250,.08);color:#a78bfa}
.lv-type-banner.assignment{background:rgba(255,94,148,.06);color:#ff5e94}
.lv-type-banner.pdf{background:rgba(240,180,41,.06);color:#f0b429}
.lv-type-banner.live_session{background:rgba(239,83,80,.06);color:#ef5350}
.lv-type-banner svg{width:14px;height:14px;stroke:currentColor}

/* Custom checkboxes */
.cb-row{display:flex;gap:10px;padding:5px 0;align-items:flex-start}
.cb-box{width:20px;height:20px;min-width:20px;border-radius:5px;border:2px solid rgba(91,184,194,.2);margin-top:1px;transition:all .15s}
.cb-box.checked{background:linear-gradient(135deg,#5bb8c2,#4fd4e0);border-color:transparent}
.cb-box.checked svg{width:12px;height:12px;display:block;margin:2px auto}
.cb-row:has(.checked) span{color:rgba(255,255,255,.85)}

.lv-quiz{margin:24px 0;max-width:640px}
.qq{background:#112a42;border:1px solid rgba(91,168,178,.1);border-radius:10px;padding:18px 22px;margin-bottom:10px}
.qq .ql{font-size:10px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
.qq .qt{font-size:15px;font-weight:600;margin-bottom:12px}
.qq .qo{padding:8px 14px;margin:4px 0;border-radius:7px;font-size:14px;border:1px solid rgba(91,168,178,.06);background:rgba(255,255,255,.015)}
.qq .qo.right{background:rgba(61,214,140,.06);border-color:rgba(61,214,140,.2);color:#3dd68c}
.qq .qo.right::before{content:'✓ ';font-weight:700}
.qq .qr{padding:14px;background:rgba(167,139,250,.04);border:1px dashed rgba(167,139,250,.15);border-radius:8px;font-size:14px;color:rgba(255,255,255,.35);font-style:italic}
.qq .qs{display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,.3);margin-top:8px}
.qq .qs-bar{height:8px;border-radius:4px;background:linear-gradient(90deg,rgba(91,168,178,.1),#5bb8c2);margin-top:6px}

.lv-file{display:flex;align-items:center;gap:14px;padding:16px 20px;background:rgba(240,180,41,.03);border:1px solid rgba(240,180,41,.12);border-radius:10px}
.lv-file .fi{width:42px;height:42px;border-radius:8px;background:rgba(240,180,41,.1);color:#f0b429;display:flex;align-items:center;justify-content:center}
.lv-file .fi svg{width:18px;height:18px;stroke:currentColor}

.lv-nav{display:flex;gap:10px;margin-top:40px;padding-top:24px;border-top:1px solid rgba(91,168,178,.08)}
.lv-nav .btn{flex:1;justify-content:center}

.loading{text-align:center;padding:100px 24px;color:rgba(255,255,255,.4)}
.spin{width:30px;height:30px;border:3px solid rgba(91,168,178,.15);border-top-color:#5bb8c2;border-radius:50%;animation:sp .7s linear infinite;margin:0 auto 16px}
@keyframes sp{to{transform:rotate(360deg)}}
.err-page{text-align:center;padding:100px 24px}
.err-page p{color:rgba(255,255,255,.5)}

@media(max-width:768px){
  .hero-grid{grid-template-columns:1fr}
  .hero-img{order:-1}
  .hero h1{font-size:26px}
  .lv-title{font-size:22px}
}
</style>
</head>
<body>
<div class="bar"><b>Admin Preview</b><span style="color:rgba(167,139,250,.5)">— Student view</span><a href="javascript:history.back()">← Builder</a></div>

<div id="landing"><div class="loading"><div class="spin"></div>Loading…</div></div>
<div id="lessonView"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
function getToken(){return sessionStorage.getItem('qp_admin_token')||localStorage.getItem('qp_admin_token')||''}
async function api(p){const r=await fetch('/.netlify/functions/admin-proxy',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()},body:JSON.stringify(p)});const j=await r.json();if(!r.ok)throw new Error(j.error||'fail');return j}
function pf(t){return{_t:t,_s:'*',_f:[],_o:null,_si:false,select(s){this._s=s;return this},eq(c,v){this._f.push({column:c,op:'eq',value:v});return this},order(c){this._o={column:c,ascending:true};return this},single(){this._si=true;return this},then(res){return api({type:'query',table:this._t,select:this._s,filters:this._f,order:this._o,single:this._si}).then(r=>({data:r.data,error:null})).then(res,e=>res({data:null,error:{message:e.message}}))}}}
function e(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}

const IC={video:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>',text:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',quiz:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',pdf:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',assignment:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>',embed:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',live_session:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>',audio:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>'};
function icon(t){return IC[t]||IC.text}

let ALL_LESSONS=[], ALL_MODS=[], COURSE=null;

function toggleMod(el){
  const block=el.closest('.mod'), mid=block.dataset.mid, body=block.querySelector('.mod-body');
  if(!body.dataset.loaded){
    const mod=ALL_MODS.find(m=>m.id===mid);
    if(mod&&mod.lessons.length){
      body.innerHTML=mod.lessons.map(l=>`<div class="les" onclick="viewLesson('${l.id}')" data-lid="${l.id}"><div class="les-i ${l.content_type||'text'}">${icon(l.content_type)}</div><span class="les-n">${e(l.title)}</span>${l.estimated_minutes?`<span class="les-d">${l.estimated_minutes}m</span>`:''}${l.is_free_preview?'<span class="les-b">Preview</span>':''}</div>`).join('');
    } else { body.innerHTML='<div style="padding:14px 56px;font-size:13px;color:rgba(255,255,255,.25)">No lessons yet</div>'; }
    body.dataset.loaded='1';
  }
  block.classList.toggle('open');
}
function toggleFaq(el){el.closest('.faq').classList.toggle('open')}

function md(s){
  if(!s||s.trim().startsWith('{'))return '';
  // Normalize line endings and remove excessive blank lines
  s=s.replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n');
  return s
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code>$1</code>')
    .replace(/^- \[ \] (.+)$/gm,'<div class="cb-row"><div class="cb-box"></div><span>$1</span></div>')
    .replace(/^- \[x\] (.+)$/gm,'<div class="cb-row"><div class="cb-box checked"><svg viewBox="0 0 24 24" fill="none" stroke="#0b1d30" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div><span>$1</span></div>')
    .replace(/^(\d+)\. (.+)$/gm,'<li style="margin-bottom:2px">$2</li>')
    .replace(/^- (.+)$/gm,'<li style="margin-bottom:2px">$1</li>')
    .replace(/((?:<li[^>]*>.*?<\/li>\s*)+)/g,'<ul style="margin:4px 0 12px;padding-left:20px">$1</ul>')
    .replace(/\n\n/g,'</p><p style="margin:8px 0">')
    .replace(/\n/g,' ')
    .replace(/^/,'<p style="margin:8px 0">').replace(/$/,'</p>')
    .replace(/<p style="margin:8px 0">(<h[23]>)/g,'$1')
    .replace(/(<\/h[23]>)<\/p>/g,'$1');
}

function quizHtml(raw){
  try{
    const q=typeof raw==='string'?JSON.parse(raw):raw;
    if(!q||!q.questions)return '';
    return '<div class="lv-quiz">'+q.questions.map((qq,i)=>{
      let body='';
      if(q.quiz_type==='multiple_choice') body=(qq.options||[]).map((o,oi)=>`<div class="qo${oi===qq.correct?' right':''}">${e(o)}</div>`).join('');
      else if(q.quiz_type==='true_false') body=`<div class="qo${qq.correct===true||qq.correct==='true'?' right':''}">True</div><div class="qo${qq.correct===false||qq.correct==='false'?' right':''}">False</div>`;
      else if(q.quiz_type==='reflection') body='<div class="qr">Students write their open-ended response here…</div>';
      else if(q.quiz_type==='rating') body=`<div class="qs-bar"></div><div class="qs"><span>${e(qq.scale_low||'Low')}</span><span>${e(qq.scale_high||'High')}</span></div>`;
      else if(q.quiz_type==='checklist') body=(qq.items||[]).map(it=>`<div style="padding:4px 0;font-size:14px">☐ ${e(it)}</div>`).join('');
      return `<div class="qq"><div class="ql">Question ${i+1} · ${(q.quiz_type||'').replace('_',' ')}</div><div class="qt">${e(qq.question)}</div>${body}</div>`;
    }).join('')+'</div>';
  }catch(ex){return ''}
}

// ===== FULL PAGE LESSON VIEW =====
function viewLesson(lid){
  const l=ALL_LESSONS.find(x=>x.id===lid);
  if(!l) return;
  const ct=l.content_type||'text';
  const content=l.content_markdown||l.content_html||l.description||'';
  const hasVid=ct==='video'&&l.video_url;

  // Find module name
  const mod=ALL_MODS.find(m=>m.lessons.some(x=>x.id===lid));
  const modTitle=mod?mod.title:'';

  // prev/next: flatten all lessons in module order, then lesson order
  const sorted=[];
  ALL_MODS.forEach(m=>{m.lessons.forEach(l=>sorted.push(l))});
  const idx=sorted.findIndex(x=>x.id===lid);
  const prev=idx>0?sorted[idx-1]:null;
  const next=idx<sorted.length-1?sorted[idx+1]:null;

  let vidHtml='';
  if(hasVid){
    if(l.video_url.includes('youtube.com')||l.video_url.includes('youtu.be')){
      // Extract YouTube ID
      let ytid='';
      if(l.video_url.includes('youtu.be/')) ytid=l.video_url.split('youtu.be/')[1].split('?')[0];
      else if(l.video_url.includes('v=')) ytid=l.video_url.split('v=')[1].split('&')[0];
      else if(l.video_url.includes('/embed/')) ytid=l.video_url.split('/embed/')[1].split('?')[0];
      if(ytid) vidHtml=`<div class="lv-video"><iframe src="https://www.youtube-nocookie.com/embed/${ytid}" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen loading="lazy"></iframe></div>`;
    } else if(l.video_url.includes('vimeo')){
      vidHtml=`<div class="lv-video"><iframe src="${e(l.video_url)}?title=0&byline=0&portrait=0" allow="autoplay;fullscreen" allowfullscreen loading="lazy"></iframe></div>`;
    } else if(l.video_thumbnail_url){
      vidHtml=`<div class="lv-video"><img src="${e(l.video_thumbnail_url)}" alt="" loading="lazy"></div>`;
    }
  } else if(l.video_thumbnail_url){
    vidHtml=`<img src="${e(l.video_thumbnail_url)}" alt="" style="width:100%;border-radius:12px;margin-bottom:24px;border:1px solid rgba(91,168,178,.08)" loading="lazy">`;
  }

  document.getElementById('landing').style.display='none';
  const lv=document.getElementById('lessonView');
  lv.style.display='block';

  const cardClass=ct==='quiz'?'quiz-card':ct==='assignment'?'assignment-card':(ct==='pdf'||ct==='download')?'pdf-card':'';
  const mdContent=md(content);
  const qzContent=ct==='quiz'?quizHtml(l.content_html||l.content_markdown):'';

  lv.innerHTML=`<div class="container" style="padding-top:20px;padding-bottom:60px">
    <div class="lv-top">
      <a class="lv-back" onclick="backToLanding()">← Back to Course</a>
      <span class="lv-crumb">${e(modTitle)}</span>
    </div>

    <div class="lv-type-banner ${ct}">${icon(ct)} ${ct.replace('_',' ')}${l.estimated_minutes?' · '+l.estimated_minutes+' min':''}${l.is_free_preview?' · Free Preview':''}</div>

    <h1 class="lv-title">${e(l.title)}</h1>

    ${l.description&&l.description!==content?`<p style="font-size:15px;color:rgba(255,255,255,.45);margin:8px 0 24px;max-width:640px">${e(l.description)}</p>`:''}

    ${vidHtml}

    ${(mdContent||qzContent||l.file_name)?`<div class="lv-content-card ${cardClass}">
      ${qzContent}
      ${mdContent?`<div class="lv-body">${mdContent}</div>`:''}
      ${l.file_name?`<div class="lv-file" style="margin-top:${mdContent?'20':'0'}px"><div class="fi">${IC.pdf}</div><div><div style="font-weight:600;font-size:14px">${e(l.file_name)}</div><div style="font-size:12px;color:rgba(255,255,255,.3)">Download resource</div></div></div>`:''}
    </div>`:''}

    <div class="lv-nav">
      ${prev?`<button class="btn btn-ghost" onclick="viewLesson('${prev.id}')">← ${e(prev.title)}</button>`:'<button class="btn btn-ghost" disabled>← Start of course</button>'}
      ${next?`<button class="btn btn-ghost" onclick="viewLesson('${next.id}')">${e(next.title)} →</button>`:'<button class="btn btn-teal" onclick="backToLanding()">✓ Course Complete</button>'}
    </div>
  </div>`;
  window.scrollTo(0,0);
}

function backToLanding(){
  document.getElementById('lessonView').style.display='none';
  document.getElementById('landing').style.display='block';
}

// ===== LOAD =====
async function load(){
  const p=new URLSearchParams(location.search),slug=p.get('slug'),id=p.get('id');
  if(!getToken()){document.getElementById('landing').innerHTML='<div class="err-page"><h2>Admin Access Required</h2><p><a href="/academy/builder.html">Sign in via Builder</a> first.</p></div>';return}
  try{
    let c;
    if(id) c=(await pf('qa_courses').select('*').eq('id',id).single()).data;
    else if(slug) c=(await pf('qa_courses').select('*').eq('slug',slug).single()).data;
    if(!c){document.getElementById('landing').innerHTML='<div class="err-page"><h2>Not Found</h2><p><a href="/academy/builder.html">Back to Builder</a></p></div>';return}
    COURSE=c;

    const[mr,lr]=await Promise.all([pf('qa_modules').select('*').eq('course_id',c.id).order('sort_order'),pf('qa_lessons').select('*').eq('course_id',c.id).order('sort_order')]);
    ALL_LESSONS=lr.data||[];
    ALL_MODS=(mr.data||[]).map(m=>({...m,lessons:ALL_LESSONS.filter(l=>l.module_id===m.id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0))}));

    let lp={learn:[],faq:[],testimonials:[]};
    try{if(c.short_description&&c.short_description.startsWith('{'))lp=JSON.parse(c.short_description)}catch(ex){}

    const tl=ALL_MODS.reduce((s,m)=>s+m.lessons.length,0);
    const free=c.enrollment_type==='free';
    document.title=c.title+' — Preview';

    let html='<div class="container"><div class="hero"><div class="hero-grid"><div>';
    html+=`<span class="badge ${c.status||'draft'}">${(c.status||'draft').replace('_',' ')}</span>`;
    html+=`<h1>${e(c.title)}</h1>`;
    if(c.subtitle) html+=`<p class="sub">${e(c.subtitle)}</p>`;
    html+=`<p class="meta">${c.instructor_name?e(c.instructor_name)+' · ':''}${ALL_MODS.length} modules · ${tl} lessons${c.difficulty?' · '+e(c.difficulty):''}</p>`;
    html+=`<button class="btn btn-teal" style="margin-top:8px">${free?'Enroll for Free':'Enroll Now'}</button>`;
    html+='</div><div class="hero-img">';
    html+=c.thumbnail_url?`<img src="${e(c.thumbnail_url)}" alt="" loading="lazy">`:'<div class="ph">No thumbnail set</div>';
    html+='</div></div></div>';

    if(c.price_cents&&!free) html+=`<div class="card price-bar"><span class="price-big">$${(c.price_cents/100).toFixed(2)}</span></div>`;

    if(c.description) html+=`<div class="sec"><h2>About This Course</h2><p style="color:rgba(255,255,255,.5);font-size:15px;line-height:1.7;white-space:pre-wrap">${e(c.description)}</p></div>`;

    if(lp.learn&&lp.learn.length){
      html+='<div class="sec"><h2>What You\'ll Learn</h2>';
      lp.learn.forEach(i=>html+=`<div class="learn-item">${e(i)}</div>`);
      html+='</div>';
    }

    html+='<div class="sec"><h2>Curriculum</h2>';
    ALL_MODS.forEach((m,mi)=>{
      const lm=m.lessons.reduce((s,l)=>s+(l.estimated_minutes||0),0);
      html+=`<div class="mod" data-mid="${m.id}"><div class="mod-h" onclick="toggleMod(this)"><span class="mod-n">${mi+1}</span><span class="mod-t">${e(m.title)}</span><span class="mod-c">${m.lessons.length} lesson${m.lessons.length!==1?'s':''}${lm?' · '+lm+'m':''}</span><span class="mod-a">▾</span></div><div class="mod-body"></div></div>`;
    });
    html+='</div>';

    if(lp.testimonials&&lp.testimonials.length){
      html+='<div class="sec"><h2>What Students Say</h2>';
      lp.testimonials.forEach(t=>html+=`<div class="card test"><div class="stars">${'★'.repeat(t.rating||5)}${'☆'.repeat(5-(t.rating||5))}</div><div class="txt">"${e(t.text)}"</div><div class="who">— ${e(t.name)}</div></div>`);
      html+='</div>';
    }

    if(lp.faq&&lp.faq.length){
      html+='<div class="sec"><h2>FAQ</h2>';
      lp.faq.forEach(f=>html+=`<div class="faq"><div class="faq-q" onclick="toggleFaq(this)"><span>${e(f.q)}</span><span>▾</span></div><div class="faq-a">${e(f.a)}</div></div>`);
      html+='</div>';
    }

    html+='</div>';
    document.getElementById('landing').innerHTML=html;

    // Auto-open first module
    const first=document.querySelector('.mod .mod-h');
    if(first) first.click();

  }catch(ex){
    document.getElementById('landing').innerHTML=`<div class="err-page"><h2>Error</h2><p>${e(ex.message)}</p><p><a href="/academy/builder.html">Back to Builder</a></p></div>`;
  }
}
load();
</script>
</body>
</html>
