<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Course Preview</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b1d30;--bg-card:#112a42;--text:rgba(255,255,255,.9);--text-muted:rgba(255,255,255,.65);
  --text-dim:rgba(255,255,255,.3);--border:rgba(91,168,178,.12);--teal:#5bb8c2;--purple:#a78bfa;
  --taupe:#c4ad94;--gold:#d4a853;--warn:#f0b429;--danger:#ef5350;--success:#3dd68c;--pink:#ff5e94;
}
[data-theme="light"]{
  --bg:#f4f1ec;--bg-card:#ffffff;--text:#1a2332;--text-muted:#3d4f63;
  --text-dim:#7a8a9e;--border:rgba(26,35,50,.1);--teal:#2a8f9a;--purple:#6b46b0;
  --taupe:#6b5a48;--gold:#a07d2e;
}
[data-theme="light"] .hero-img{box-shadow:0 4px 20px rgba(0,0,0,.08)}
[data-theme="light"] .card,[data-theme="light"] .mod,[data-theme="light"] .faq,[data-theme="light"] .qq{box-shadow:0 1px 4px rgba(0,0,0,.04)}
[data-theme="light"] .learn-item:nth-child(odd){background:rgba(42,143,154,.06);border-left-color:rgba(42,143,154,.4)}
[data-theme="light"] .learn-item:nth-child(even){background:rgba(107,70,176,.05);border-left-color:rgba(107,70,176,.3)}
[data-theme="light"] .lv-content-card{background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.05)}
[data-theme="light"] .lv-tip.tip-info{background:rgba(42,143,154,.06);border-color:rgba(42,143,154,.2)}
[data-theme="light"] .lv-tip.tip-warn{background:rgba(240,180,41,.06);border-color:rgba(240,180,41,.25)}
[data-theme="light"] .lv-tip.tip-success{background:rgba(34,160,100,.06);border-color:rgba(34,160,100,.2)}
[data-theme="light"] .lv-takeaway{background:rgba(34,160,100,.05);border-color:rgba(34,160,100,.15)}
[data-theme="light"] .badge{color:#a07d2e;background:rgba(160,125,46,.08);border-color:rgba(160,125,46,.2)}
[data-theme="light"] .badge.published{color:#1a8a5a;background:rgba(26,138,90,.08);border-color:rgba(26,138,90,.2)}
[data-theme="light"] .price-big{color:var(--teal)}
[data-theme="light"] .progress-fill{background:linear-gradient(90deg,var(--teal),#35b8c5)}
[data-theme="light"] .btn-teal{background:linear-gradient(135deg,#2a8f9a,#35b8c5)}
[data-theme="light"] .btn-ghost{border-color:rgba(26,35,50,.12);color:var(--text-muted)}
[data-theme="light"] .btn-ghost:hover{border-color:var(--teal);color:var(--teal)}
[data-theme="light"] .bar{background:#fff;border-bottom-color:rgba(26,35,50,.08)}
[data-theme="light"] .les:hover{background:rgba(42,143,154,.04)}
[data-theme="light"] .mod-h:hover{background:rgba(42,143,154,.02)}
[data-theme="light"] .faq-q:hover{background:rgba(42,143,154,.02)}
[data-theme="light"] .cb-box{border-color:rgba(42,143,154,.3)}
[data-theme="light"] .qo{border-color:rgba(26,35,50,.08);background:rgba(26,35,50,.015)}
[data-theme="light"] .qo.right{background:rgba(34,160,100,.06);border-color:rgba(34,160,100,.2);color:#1a6b40}
[data-theme="light"] hr{border-top-color:rgba(26,35,50,.08)!important}
body{font-family:Inter,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;transition:background .3s,color .3s}
h1,h2{font-family:'Playfair Display',serif}
a{color:var(--teal);text-decoration:none}

/* Admin bar */
.bar{background:var(--bg-card);border-bottom:1px solid var(--border);padding:8px 24px;display:flex;align-items:center;gap:10px;font-size:12px;color:var(--purple);position:sticky;top:0;z-index:50;transition:background .3s}
.bar b{text-transform:uppercase;letter-spacing:.05em}
.bar a{margin-left:auto;color:var(--teal);font-weight:600}
.bar .mode-toggle{margin-left:12px;display:flex;align-items:center;gap:8px;background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:12px;font-family:inherit;padding:6px 0;transition:color .15s}
.bar .mode-toggle:hover{color:var(--text)}
.bar .mode-toggle svg{width:15px;height:15px;stroke:currentColor;opacity:.7}
.mode-switch{margin-left:4px;width:32px;height:18px;background:var(--border);border-radius:9px;position:relative;transition:background .3s}
.mode-switch::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:var(--teal);transition:transform .3s}
[data-theme="light"] .mode-switch{background:var(--taupe)}
[data-theme="light"] .mode-switch::after{transform:translateX(14px);background:#fff}

/* Shared */
.container{max-width:900px;margin:0 auto;padding:0 24px}
.sec{margin-bottom:36px}
.sec h2{font-size:22px;margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid var(--border);display:inline-block}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;transition:background .3s}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:8px;border:none;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer}
.btn-teal{background:linear-gradient(135deg,#5bb8c2,#4fd4e0);color:#fff}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--text-muted)}
.btn-ghost:hover{border-color:#5bb8c2;color:#5bb8c2}

/* LANDING PAGE MODE */
.hero{padding:48px 0 32px}
.hero-grid{display:grid;grid-template-columns:1fr 380px;gap:32px;align-items:start}
.badge{display:inline-block;padding:4px 12px;border-radius:16px;font-size:11px;font-weight:700;text-transform:uppercase;margin-bottom:14px;background:rgba(240,180,41,.1);color:#f0b429;border:1px solid rgba(240,180,41,.25)}
.badge.published{background:rgba(61,214,140,.1);color:#3dd68c;border-color:rgba(61,214,140,.25)}
.hero h1{font-size:36px;margin-bottom:10px}
.hero .sub{font-size:17px;color:var(--text-muted);margin-bottom:16px}
.hero .meta{font-size:13px;color:var(--text-dim);margin-bottom:20px}
.hero-img{width:100%;border-radius:12px;border:1px solid var(--border);background:var(--bg-card);overflow:hidden;aspect-ratio:16/10;transition:all .3s}
.hero-img img{width:100%;height:100%;object-fit:cover;display:block}
.hero-img .ph{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-dim);font-size:14px}
.price-bar{padding:20px 24px;margin-bottom:32px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.price-big{font-size:32px;font-weight:800;color:#5bb8c2}

.learn-item{padding:12px 16px;border-radius:8px;margin-bottom:6px;font-size:14px;color:var(--text-muted);border-left:3px solid transparent}
.learn-item:nth-child(odd){background:rgba(91,188,198,.04);border-left-color:rgba(91,184,194,.3)}
.learn-item:nth-child(even){background:rgba(167,139,250,.03);border-left-color:rgba(167,139,250,.2)}
.learn-item::before{content:'‚úì ';color:#5bb8c2;font-weight:700}

/* Modules */
.mod{border:1px solid var(--border);border-radius:10px;margin-bottom:8px;overflow:hidden;transition:border-color .3s}
.mod-h{padding:14px 18px;display:flex;align-items:center;gap:12px;cursor:pointer}
.mod-h:hover{background:rgba(91,168,178,.02)}
.mod-n{width:28px;height:28px;border-radius:6px;background:rgba(91,184,194,.1);color:#5bb8c2;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;flex-shrink:0}
.mod-t{flex:1;font-weight:600;font-size:14px}
.mod-c{font-size:12px;color:var(--text-dim)}
.mod-a{color:var(--text-dim);transition:transform .2s}
.mod.open .mod-a{transform:rotate(180deg)}
.mod-body{display:none;border-top:1px solid rgba(91,168,178,.06)}
.mod.open .mod-body{display:block}

.les{padding:10px 18px 10px 56px;display:flex;align-items:center;gap:10px;cursor:pointer;border-bottom:1px solid rgba(91,168,178,.03);font-size:14px}
.les:last-child{border-bottom:none}
.les:hover{background:rgba(91,168,178,.03)}
.les-i{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.les-i svg{width:13px;height:13px;stroke:currentColor}
.les-i.video{background:rgba(91,184,194,.1);color:#5bb8c2}
.les-i.text{background:rgba(196,173,148,.1);color:#c4ad94}
.les-i.quiz{background:rgba(167,139,250,.1);color:#a78bfa}
.les-i.pdf,.les-i.download{background:rgba(240,180,41,.1);color:#f0b429}
.les-i.assignment{background:rgba(255,94,148,.08);color:#ff5e94}
.les-i.live_session{background:rgba(239,83,80,.08);color:#ef5350}
.les-i.embed{background:rgba(91,184,194,.06);color:#4fd4e0}
.les-i.audio{background:rgba(61,214,140,.08);color:#3dd68c}
.les-n{flex:1}
.les-num{font-size:11px;color:var(--text-dim);font-weight:700;min-width:16px;text-align:center}
.les-d{font-size:12px;color:var(--text-dim)}
.les-b{font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(91,184,194,.08);color:#5bb8c2;font-weight:700;text-transform:uppercase}

.test{padding:20px 22px;margin-bottom:10px;background:var(--bg-card);border:1px solid var(--border);transition:background .3s}
.test .stars{color:#d4a853;margin-bottom:8px;font-size:14px;letter-spacing:2px}
.test .txt{font-size:14px;color:var(--text-muted);font-style:italic;margin-bottom:10px;line-height:1.6}
.test .who{font-size:13px;font-weight:600;color:var(--taupe)}

.faq{border:1px solid var(--border);border-radius:8px;margin-bottom:6px;overflow:hidden;transition:border-color .3s}
.faq-q{padding:14px 18px;font-weight:600;font-size:14px;cursor:pointer;display:flex;justify-content:space-between}
.faq-q:hover{background:rgba(91,168,178,.02)}
.faq-a{padding:0 18px 14px;font-size:14px;color:var(--text-muted);display:none}
.faq.open .faq-a{display:block}

/* LESSON VIEW MODE */
#lessonView{display:none}
.lv-top{padding:12px 0;margin-bottom:24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(91,168,178,.08)}
.lv-back{font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px}
.lv-back:hover{color:#4fd4e0}
.lv-crumb{font-size:12px;color:var(--text-dim);flex:1}

.lv-title{font-size:28px;margin-bottom:8px}
.lv-meta{font-size:13px;color:var(--text-dim);margin-bottom:24px;display:flex;gap:12px;flex-wrap:wrap}
.lv-meta .pill{padding:3px 10px;border-radius:10px;font-weight:600}
.lv-meta .pill.video{background:rgba(91,184,194,.08);color:#5bb8c2}
.lv-meta .pill.text{background:rgba(196,173,148,.08);color:#c4ad94}
.lv-meta .pill.quiz{background:rgba(167,139,250,.08);color:#a78bfa}
.lv-meta .pill.assignment{background:rgba(255,94,148,.06);color:#ff5e94}
.lv-meta .pill.pdf{background:rgba(240,180,41,.08);color:#f0b429}
.lv-meta .pill.live_session{background:rgba(239,83,80,.06);color:#ef5350}

.lv-video{width:100%;aspect-ratio:16/9;border-radius:12px;overflow:hidden;margin-bottom:28px;background:#000;border:1px solid rgba(91,168,178,.08)}
.lv-video iframe{width:100%;height:100%;border:none}
.lv-video img{width:100%;height:100%;object-fit:cover}

.lv-body{font-size:15px;line-height:1.75;color:var(--text-muted);max-width:100%;overflow-wrap:break-word;word-wrap:break-word}
.lv-body h2{font-size:20px;color:var(--text);margin:32px 0 10px;padding-top:24px;border-top:1px solid var(--border);font-family:'Playfair Display',serif}
.lv-body h2:first-child{margin-top:0;padding-top:0;border-top:none}
.lv-body h3{font-size:14px;color:var(--teal);margin:18px 0 6px;font-family:Inter,sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:.03em}
.lv-body strong{color:var(--text)}
.lv-body code{background:rgba(91,184,194,.08);padding:1px 5px;border-radius:3px;font-size:13px;color:var(--teal)}
.lv-body ul,.lv-body ol{padding-left:20px;margin:6px 0}
.lv-body li{margin-bottom:2px}

/* Content card wrapper */
.lv-content-card{background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--teal);border-radius:0 12px 12px 0;padding:24px 24px;margin:20px 0;overflow:hidden;word-break:break-word;overflow-wrap:anywhere;transition:background .3s}
.lv-content-card *{max-width:100%}
.lv-content-card.quiz-card{border-left-color:#a78bfa}
.lv-content-card.assignment-card{border-left-color:#ff5e94}
.lv-content-card.pdf-card{border-left-color:#f0b429}

/* Lesson type header banner */
.lv-type-banner{padding:10px 16px;border-radius:8px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;display:inline-flex;align-items:center;gap:8px;margin-bottom:20px}
.lv-type-banner.video{background:rgba(91,184,194,.08);color:#5bb8c2}
.lv-type-banner.text{background:rgba(196,173,148,.08);color:#c4ad94}
.lv-type-banner.quiz{background:rgba(167,139,250,.08);color:#a78bfa}
.lv-type-banner.assignment{background:rgba(255,94,148,.06);color:#ff5e94}
.lv-type-banner.pdf{background:rgba(240,180,41,.06);color:#f0b429}
.lv-type-banner.live_session{background:rgba(239,83,80,.06);color:#ef5350}
.lv-type-banner svg{width:14px;height:14px;stroke:currentColor}

/* Custom checkboxes */
.cb-row{display:flex;gap:10px;padding:5px 0;align-items:flex-start;min-width:0}
.cb-box{width:20px;height:20px;min-width:20px;border-radius:5px;border:2px solid rgba(91,184,194,.2);margin-top:1px;transition:all .15s;flex-shrink:0}
.cb-box.checked{background:linear-gradient(135deg,#5bb8c2,#4fd4e0);border-color:transparent}
.cb-box.checked svg{width:12px;height:12px;display:block;margin:2px auto}
.cb-row span{flex:1;min-width:0;word-break:break-word}

/* Callout boxes */
.lv-tip{padding:14px 18px;border-radius:8px;margin:16px 0;font-size:14px;display:flex;gap:10px;align-items:flex-start;line-height:1.6}
.lv-tip .tip-icon{font-size:18px;flex-shrink:0;margin-top:-1px}
.lv-tip.tip-info{background:rgba(91,184,194,.06);border:1px solid rgba(91,184,194,.12)}
.lv-tip.tip-warn{background:rgba(240,180,41,.04);border:1px solid rgba(240,180,41,.12)}
.lv-tip.tip-success{background:rgba(61,214,140,.04);border:1px solid rgba(61,214,140,.12)}

/* Inline images in lessons */
.lv-img{width:100%;border-radius:10px;margin:16px 0;border:1px solid rgba(91,168,178,.08)}
.lv-img-caption{font-size:12px;color:var(--text-dim);text-align:center;margin-top:-10px;margin-bottom:12px}

/* Key takeaway */
.lv-takeaway{padding:16px 20px;border-radius:10px;margin:20px 0;background:linear-gradient(135deg,rgba(61,214,140,.04),rgba(91,184,194,.04));border:1px solid rgba(61,214,140,.12)}
.lv-takeaway-title{font-size:12px;font-weight:700;color:#3dd68c;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px;display:flex;align-items:center;gap:6px}

/* Lesson number badge */
.lv-lesson-num{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:rgba(91,184,194,.1);color:#5bb8c2;font-size:13px;font-weight:800;margin-right:8px;flex-shrink:0}

/* Progress bar for course */
.progress-bar{height:4px;background:rgba(91,184,194,.1);border-radius:2px;margin:8px 0 20px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#5bb8c2,#4fd4e0);border-radius:2px}

.lv-quiz{margin:24px 0;max-width:640px}
.qq{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:18px 22px;margin-bottom:10px;transition:background .3s}
.qq .ql{font-size:10px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
.qq .qt{font-size:15px;font-weight:600;margin-bottom:12px}
.qq .qo{padding:8px 14px;margin:4px 0;border-radius:7px;font-size:14px;border:1px solid rgba(91,168,178,.06);background:rgba(255,255,255,.015)}
.qq .qo.right{background:rgba(61,214,140,.06);border-color:rgba(61,214,140,.2);color:#3dd68c}
.qq .qo.right::before{content:'‚úì ';font-weight:700}
.qq .qr{padding:14px;background:rgba(167,139,250,.04);border:1px dashed rgba(167,139,250,.15);border-radius:8px;font-size:14px;color:var(--text-dim);font-style:italic}
.qq .qs{display:flex;justify-content:space-between;font-size:11px;color:var(--text-dim);margin-top:8px}
.qq .qs-bar{height:8px;border-radius:4px;background:linear-gradient(90deg,rgba(91,168,178,.1),#5bb8c2);margin-top:6px}

.lv-file{display:flex;align-items:center;gap:14px;padding:16px 20px;background:rgba(240,180,41,.03);border:1px solid rgba(240,180,41,.12);border-radius:10px}
.lv-file .fi{width:42px;height:42px;border-radius:8px;background:rgba(240,180,41,.1);color:#f0b429;display:flex;align-items:center;justify-content:center}
.lv-file .fi svg{width:18px;height:18px;stroke:currentColor}

.lv-nav{display:flex;gap:10px;margin-top:40px;padding-top:24px;border-top:1px solid rgba(91,168,178,.08)}
.lv-nav .btn{flex:1;justify-content:center}

.loading{text-align:center;padding:100px 24px;color:var(--text-dim)}
.spin{width:30px;height:30px;border:3px solid rgba(91,168,178,.15);border-top-color:#5bb8c2;border-radius:50%;animation:sp .7s linear infinite;margin:0 auto 16px}
@keyframes sp{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideIn{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
@keyframes progressFill{from{width:0}to{width:var(--pw)}}
@keyframes glowPulse{0%,100%{box-shadow:0 0 0 0 rgba(91,184,194,0)}50%{box-shadow:0 0 12px 2px rgba(91,184,194,.15)}}

/* Animated elements */
.hero{animation:fadeUp .5s ease both}
.sec{animation:fadeUp .5s ease both}
.sec:nth-child(2){animation-delay:.05s}
.sec:nth-child(3){animation-delay:.1s}
.sec:nth-child(4){animation-delay:.15s}
.mod{animation:fadeUp .3s ease both}
.learn-item{animation:slideIn .3s ease both}
.learn-item:nth-child(2){animation-delay:.03s}
.learn-item:nth-child(3){animation-delay:.06s}
.learn-item:nth-child(4){animation-delay:.09s}
.learn-item:nth-child(5){animation-delay:.12s}
.learn-item:nth-child(6){animation-delay:.15s}
.learn-item:nth-child(7){animation-delay:.18s}
.learn-item:nth-child(8){animation-delay:.21s}
.lv-content-card{animation:scaleIn .35s ease both}
.lv-type-banner{animation:fadeIn .3s ease both}
.lv-title{animation:fadeUp .35s ease both;animation-delay:.05s}
.lv-video{animation:scaleIn .4s ease both;animation-delay:.1s}
.progress-fill{animation:progressFill .6s ease both}
.lv-tip{animation:slideIn .3s ease both}
.lv-takeaway{animation:scaleIn .3s ease both}
.lv-img{animation:fadeIn .4s ease both}
.qq{animation:fadeUp .3s ease both}
.qq:nth-child(2){animation-delay:.05s}
.qq:nth-child(3){animation-delay:.1s}
.qq:nth-child(4){animation-delay:.15s}

/* Interactive hovers */
.les{transition:all .15s}
.les:hover{background:rgba(91,168,178,.04);padding-left:60px}
.mod-h{transition:all .15s}
.mod-h:hover .mod-n{transform:scale(1.08);box-shadow:0 0 8px rgba(91,184,194,.2)}
.mod-n{transition:all .2s}
.btn{transition:all .15s}
.btn-teal:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(91,184,194,.25)}
.btn-ghost:hover{transform:translateY(-1px)}
.lv-back{transition:all .15s}
.lv-back:hover{transform:translateX(-3px)}
.card.test{transition:all .2s}
.card.test:hover{transform:translateY(-2px);border-color:rgba(196,173,148,.2);box-shadow:0 4px 20px rgba(0,0,0,.15)}
.faq{transition:all .15s}
.faq:hover{border-color:rgba(91,168,178,.2)}
.learn-item{transition:all .15s}
.learn-item:hover{transform:translateX(4px);border-left-width:4px}
.hero-img{transition:all .3s}
.hero-img:hover{transform:scale(1.01);box-shadow:0 8px 30px rgba(0,0,0,.2)}

/* Smooth page transitions */
#lessonView{animation:fadeUp .3s ease both}
.err-page{text-align:center;padding:100px 24px}
.err-page p{color:var(--text-muted)}

/* ===== STUDENT TOOLS ===== */
.st-toolbar{position:fixed;right:20px;bottom:20px;display:flex;flex-direction:column;gap:8px;z-index:40}
.st-btn{width:44px;height:44px;border-radius:50%;border:1px solid var(--border);background:var(--bg-card);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 2px 12px rgba(0,0,0,.15);position:relative;padding:0;font-family:inherit}
.st-btn:hover{border-color:var(--teal);color:var(--teal);transform:scale(1.1)}
.st-btn.active{background:var(--teal);color:#fff;border-color:var(--teal)}
.st-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
.st-count{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;border-radius:9px;background:#ff5e94;color:#fff;font-size:10px;font-weight:800;display:none;align-items:center;justify-content:center;padding:0 4px;line-height:1;border:2px solid var(--bg)}
.st-count.show{display:flex}

/* Notes panel */
.st-panel{position:fixed;right:20px;bottom:80px;width:360px;max-height:75vh;background:var(--bg-card);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 40px rgba(0,0,0,.25);display:none;flex-direction:column;z-index:41;overflow:hidden;animation:scaleIn .2s ease}
.st-panel.open{display:flex}
.st-panel-head{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-weight:700;font-size:14px}
.st-panel-head svg{width:16px;height:16px;stroke:var(--teal);fill:none;stroke-width:2;flex-shrink:0}
.st-panel-head .close{margin-left:auto;cursor:pointer;color:var(--text-dim);font-size:18px;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .15s}
.st-panel-head .close:hover{color:var(--text);background:rgba(91,184,194,.06)}

/* Panel tabs */
.st-tabs{display:flex;border-bottom:1px solid var(--border)}
.st-tab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.st-tab:hover{color:var(--text-muted)}
.st-tab.active{color:var(--teal);border-bottom-color:var(--teal)}

.st-panel-body{flex:1;overflow-y:auto;padding:12px}
.st-empty{padding:24px;text-align:center;color:var(--text-dim);font-size:13px;line-height:1.6}

/* Notes */
.st-note{padding:10px 12px;margin-bottom:8px;border-radius:8px;background:rgba(91,184,194,.04);border-left:3px solid var(--teal);font-size:13px;line-height:1.5;position:relative;transition:all .15s}
.st-note:hover{background:rgba(91,184,194,.06)}
.st-note-meta{font-size:10px;color:var(--text-dim);margin-top:4px;font-weight:600}
.st-note-del{position:absolute;top:6px;right:8px;cursor:pointer;color:var(--text-dim);font-size:14px;opacity:0;transition:opacity .15s;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:4px}
.st-note:hover .st-note-del{opacity:1}
.st-note-del:hover{background:rgba(239,83,80,.1);color:var(--danger)}
.st-note-input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
.st-note-input textarea{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:13px;padding:8px 10px;resize:none;min-height:36px;max-height:80px;transition:border-color .15s}
.st-note-input textarea:focus{outline:none;border-color:var(--teal)}
.st-note-input button{padding:0 14px;border-radius:8px;border:none;background:var(--teal);color:#fff;font-family:inherit;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap;transition:all .15s}
.st-note-input button:hover{filter:brightness(1.1)}
.st-panel-footer{padding:8px 12px;border-top:1px solid var(--border);display:flex;gap:6px}
.st-panel-footer button{flex:1;padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text-muted);font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
.st-panel-footer button:hover{border-color:var(--teal);color:var(--teal)}

/* Highlights */
.st-highlight{padding:10px 12px;margin-bottom:8px;border-radius:8px;font-size:13px;line-height:1.5;position:relative;transition:all .15s}
.st-highlight.yellow{background:rgba(240,180,41,.08);border-left:3px solid var(--warn)}
.st-highlight.green{background:rgba(61,214,140,.06);border-left:3px solid var(--success)}
.st-highlight.purple{background:rgba(167,139,250,.06);border-left:3px solid var(--purple)}
.st-highlight:hover .st-note-del{opacity:1}

/* Timer */
.st-timer{text-align:center;padding:16px}
.st-timer-display{font-size:36px;font-weight:800;font-variant-numeric:tabular-nums;color:var(--teal);margin-bottom:12px}
.st-timer-btns{display:flex;gap:8px;justify-content:center}
.st-timer-btns button{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:none;color:var(--text-muted);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
.st-timer-btns button:hover{border-color:var(--teal);color:var(--teal)}
.st-timer-btns button.primary{background:var(--teal);color:#fff;border-color:var(--teal)}
.st-timer-presets{display:flex;gap:6px;justify-content:center;margin-top:12px}
.st-timer-presets button{padding:4px 12px;border-radius:12px;border:1px solid var(--border);background:none;color:var(--text-dim);font-family:inherit;font-size:11px;cursor:pointer}
.st-timer-presets button:hover{border-color:var(--teal);color:var(--teal)}

/* Interactive checkboxes */
.cb-box{cursor:pointer}
.cb-box:hover{border-color:var(--teal)}

/* Print styles for notes */
@media print{
  .bar,.st-toolbar,.st-notes,.progress-bar,.lv-nav,.lv-back{display:none!important}
  body,[data-theme="light"],[data-theme="dark"]{background:#fff!important;color:#000!important}
  .lv-content-card{border:1px solid #ddd!important;background:#f9f9f9!important}
  .lv-tip{border:1px solid #ccc!important;background:#f5f5f5!important}
  .st-note-print{page-break-inside:avoid;padding:8px;margin:4px 0;border-left:3px solid #5bb8c2}
  .st-note-print .meta{font-size:10px;color:#888}
}

@media(max-width:768px){
  .hero-grid{grid-template-columns:1fr}
  .hero-img{order:-1}
  .hero h1{font-size:26px}
  .lv-title{font-size:22px}
  .lv-content-card{padding:20px 16px}
  .lv-nav{flex-direction:column}
  .qq{padding:14px 16px}
  .container{padding:0 16px}
}
</style>
</head>
<body>
<div class="bar"><b>Admin Preview</b><span style="color:var(--text-dim)">‚Äî Student view</span><a href="javascript:history.back()">‚Üê Builder</a><button class="mode-toggle" onclick="toggleMode()" title="Toggle theme"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span id="themeLabel">Light</span><div class="mode-switch"></div></button></div>

<div id="landing"><div class="loading"><div class="spin"></div>Loading‚Ä¶</div></div>
<div id="lessonView"></div>

<!-- Student Tools -->
<div class="st-toolbar" id="stToolbar" style="display:none">
  <button class="st-btn" onclick="openTool('notes')" title="My Notes" id="stNotesBtn">
    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    <span class="st-count" id="noteCount">0</span>
  </button>
  <button class="st-btn" onclick="openTool('timer')" title="Focus Timer">
    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
  </button>
  <button class="st-btn" onclick="printNotes()" title="Print Notes">
    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
  </button>
</div>

<!-- Tools Panel -->
<div class="st-panel" id="stPanel">
  <div class="st-panel-head" id="stPanelHead">
    <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    <span id="stPanelTitle">My Notes</span>
    <span class="close" onclick="closePanel()">‚úï</span>
  </div>
  <div id="stPanelContent"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
function getToken(){return sessionStorage.getItem('qp_admin_token')||localStorage.getItem('qp_admin_token')||''}
async function api(p){const r=await fetch('/.netlify/functions/admin-proxy',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+getToken()},body:JSON.stringify(p)});const j=await r.json();if(!r.ok)throw new Error(j.error||'fail');return j}
function pf(t){return{_t:t,_s:'*',_f:[],_o:null,_si:false,select(s){this._s=s;return this},eq(c,v){this._f.push({column:c,op:'eq',value:v});return this},order(c){this._o={column:c,ascending:true};return this},single(){this._si=true;return this},then(res){return api({type:'query',table:this._t,select:this._s,filters:this._f,order:this._o,single:this._si}).then(r=>({data:r.data,error:null})).then(res,e=>res({data:null,error:{message:e.message}}))}}}
function e(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}

const IC={video:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>',text:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',quiz:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',pdf:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',assignment:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>',embed:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',live_session:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>',audio:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>'};
function icon(t){return IC[t]||IC.text}

function toggleMode(){
  const html=document.documentElement;
  const next=html.getAttribute('data-theme')==='dark'?'light':'dark';
  html.setAttribute('data-theme',next);
  const l=document.getElementById('themeLabel');if(l)l.textContent=next==='dark'?'Light':'Dark';
  localStorage.setItem('qa-theme',next);
}
const _st=localStorage.getItem('qa-theme');
if(_st){document.documentElement.setAttribute('data-theme',_st);const l=document.getElementById('themeLabel');if(l)l.textContent=_st==='dark'?'Light':'Dark'}

let ALL_LESSONS=[], ALL_MODS=[], COURSE=null;

function toggleMod(el){
  const block=el.closest('.mod'), mid=block.dataset.mid, body=block.querySelector('.mod-body');
  if(!body.dataset.loaded){
    const mod=ALL_MODS.find(m=>m.id===mid);
    if(mod&&mod.lessons.length){
      body.innerHTML=mod.lessons.map((l,li)=>`<div class="les" onclick="viewLesson('${l.id}')" data-lid="${l.id}"><span class="les-num">${li+1}</span><div class="les-i ${l.content_type||'text'}">${icon(l.content_type)}</div><span class="les-n">${e(l.title)}</span>${l.estimated_minutes?`<span class="les-d">${l.estimated_minutes}m</span>`:''}${l.is_free_preview?'<span class="les-b">Preview</span>':''}</div>`).join('');
    } else { body.innerHTML='<div style="padding:14px 56px;font-size:13px;color:var(--text-dim)">No lessons yet</div>'; }
    body.dataset.loaded='1';
  }
  block.classList.toggle('open');
}
function toggleFaq(el){el.closest('.faq').classList.toggle('open')}

function md(s){
  if(!s||s.trim().startsWith('{'))return '';
  s=s.replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n');
  return s
    // Images: ![alt](url)
    .replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img class="lv-img" src="$2" alt="$1" loading="lazy">')
    // Blockquotes as tip boxes: > üí° ... or > ‚ö†Ô∏è ... or > ‚úÖ ...
    .replace(/^> üí° ?(.+)$/gm,'<div class="lv-tip tip-info"><span class="tip-icon">üí°</span><span>$1</span></div>')
    .replace(/^> ‚ö†Ô∏è ?(.+)$/gm,'<div class="lv-tip tip-warn"><span class="tip-icon">‚ö†Ô∏è</span><span>$1</span></div>')
    .replace(/^> ‚úÖ ?(.+)$/gm,'<div class="lv-tip tip-success"><span class="tip-icon">‚úÖ</span><span>$1</span></div>')
    // Generic blockquote
    .replace(/^> (.+)$/gm,'<div class="lv-tip tip-info"><span>$1</span></div>')
    // Horizontal rule as section divider
    .replace(/^---$/gm,'<hr style="border:none;border-top:1px solid rgba(91,168,178,.1);margin:20px 0">')
    // Key takeaway: === text ===
    .replace(/^=== (.+) ===$/gm,'<div class="lv-takeaway"><div class="lv-takeaway-title">üîë Key Takeaway</div>$1</div>')
    // Headers
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    // Inline
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code>$1</code>')
    // Checkboxes
    .replace(/^- \[ \] (.+)$/gm,'<div class="cb-row"><div class="cb-box"></div><span>$1</span></div>')
    .replace(/^- \[x\] (.+)$/gm,'<div class="cb-row"><div class="cb-box checked"><svg viewBox="0 0 24 24" fill="none" stroke="#0b1d30" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div><span>$1</span></div>')
    // Lists
    .replace(/^(\d+)\. (.+)$/gm,'<li style="margin-bottom:2px">$2</li>')
    .replace(/^- (.+)$/gm,'<li style="margin-bottom:2px">$1</li>')
    .replace(/((?:<li[^>]*>.*?<\/li>\s*)+)/g,'<ul style="margin:4px 0 12px;padding-left:20px">$1</ul>')
    // Paragraphs
    .replace(/\n\n/g,'</p><p style="margin:8px 0">')
    .replace(/\n/g,' ')
    .replace(/^/,'<p style="margin:8px 0">').replace(/$/,'</p>')
    .replace(/<p style="margin:8px 0">(<h[23]>)/g,'$1')
    .replace(/(<\/h[23]>)<\/p>/g,'$1')
    .replace(/<p style="margin:8px 0">(<div )/g,'$1')
    .replace(/<p style="margin:8px 0">(<hr )/g,'$1')
    .replace(/<p style="margin:8px 0">(<img )/g,'$1');
}

function quizHtml(raw){
  try{
    const q=typeof raw==='string'?JSON.parse(raw):raw;
    if(!q||!q.questions)return '';
    return '<div class="lv-quiz">'+q.questions.map((qq,i)=>{
      let body='';
      if(q.quiz_type==='multiple_choice') body=(qq.options||[]).map((o,oi)=>`<div class="qo${oi===qq.correct?' right':''}">${e(o)}</div>`).join('');
      else if(q.quiz_type==='true_false') body=`<div class="qo${qq.correct===true||qq.correct==='true'?' right':''}">True</div><div class="qo${qq.correct===false||qq.correct==='false'?' right':''}">False</div>`;
      else if(q.quiz_type==='reflection') body='<div class="qr">Students write their open-ended response here‚Ä¶</div>';
      else if(q.quiz_type==='rating') body=`<div class="qs-bar"></div><div class="qs"><span>${e(qq.scale_low||'Low')}</span><span>${e(qq.scale_high||'High')}</span></div>`;
      else if(q.quiz_type==='checklist') body=(qq.items||[]).map(it=>`<div style="padding:4px 0;font-size:14px">‚òê ${e(it)}</div>`).join('');
      return `<div class="qq"><div class="ql">Question ${i+1} ¬∑ ${(q.quiz_type||'').replace('_',' ')}</div><div class="qt">${e(qq.question)}</div>${body}</div>`;
    }).join('')+'</div>';
  }catch(ex){return ''}
}

// ===== FULL PAGE LESSON VIEW =====
function viewLesson(lid){
  const l=ALL_LESSONS.find(x=>x.id===lid);
  if(!l) return;
  currentLessonId=lid;
  showToolbar(true);
  updateNotesBadge();
  notesView='lesson';
  const ct=l.content_type||'text';
  const content=l.content_markdown||l.content_html||l.description||'';
  const hasVid=ct==='video'&&l.video_url;

  // Find module name and lesson index
  const mod=ALL_MODS.find(m=>m.lessons.some(x=>x.id===lid));
  const modTitle=mod?mod.title:'';
  const lesIdx=mod?mod.lessons.findIndex(x=>x.id===lid)+1:0;
  const modIdx=ALL_MODS.indexOf(mod)+1;

  // prev/next: flatten all lessons in module order, then lesson order
  const sorted=[];
  ALL_MODS.forEach(m=>{m.lessons.forEach(l=>sorted.push(l))});
  const idx=sorted.findIndex(x=>x.id===lid);
  const prev=idx>0?sorted[idx-1]:null;
  const next=idx<sorted.length-1?sorted[idx+1]:null;
  const progressPct=Math.round(((idx+1)/sorted.length)*100);

  let vidHtml='';
  if(hasVid){
    if(l.video_url.includes('youtube.com')||l.video_url.includes('youtu.be')){
      // Extract YouTube ID
      let ytid='';
      if(l.video_url.includes('youtu.be/')) ytid=l.video_url.split('youtu.be/')[1].split('?')[0];
      else if(l.video_url.includes('v=')) ytid=l.video_url.split('v=')[1].split('&')[0];
      else if(l.video_url.includes('/embed/')) ytid=l.video_url.split('/embed/')[1].split('?')[0];
      if(ytid) vidHtml=`<div class="lv-video"><iframe src="https://www.youtube-nocookie.com/embed/${ytid}" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen loading="lazy"></iframe></div>`;
    } else if(l.video_url.includes('vimeo')){
      vidHtml=`<div class="lv-video"><iframe src="${e(l.video_url)}?title=0&byline=0&portrait=0" allow="autoplay;fullscreen" allowfullscreen loading="lazy"></iframe></div>`;
    } else if(l.video_thumbnail_url){
      vidHtml=`<div class="lv-video"><img src="${e(l.video_thumbnail_url)}" alt="" loading="lazy"></div>`;
    }
  } else if(l.video_thumbnail_url){
    vidHtml=`<img src="${e(l.video_thumbnail_url)}" alt="" style="width:100%;border-radius:12px;margin-bottom:24px;border:1px solid rgba(91,168,178,.08)" loading="lazy">`;
  }

  document.getElementById('landing').style.display='none';
  const lv=document.getElementById('lessonView');
  lv.style.display='block';

  const cardClass=ct==='quiz'?'quiz-card':ct==='assignment'?'assignment-card':(ct==='pdf'||ct==='download')?'pdf-card':'';
  const mdContent=md(content);
  const qzContent=ct==='quiz'?quizHtml(l.content_html||l.content_markdown):'';

  lv.innerHTML=`<div class="container" style="padding-top:20px;padding-bottom:60px">
    <div class="lv-top">
      <a class="lv-back" onclick="backToLanding()">‚Üê Back to Course</a>
      <span class="lv-crumb">Module ${modIdx}: ${e(modTitle)} ¬∑ Lesson ${lesIdx}</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" style="--pw:${progressPct}%;width:${progressPct}%"></div></div>

    <div class="lv-type-banner ${ct}">${icon(ct)} ${ct.replace('_',' ')}${l.estimated_minutes?' ¬∑ '+l.estimated_minutes+' min':''}${l.is_free_preview?' ¬∑ Free Preview':''}</div>

    <h1 class="lv-title">${e(l.title)}</h1>

    ${l.description&&l.description!==content?`<p style="font-size:15px;color:var(--text-dim);margin:8px 0 24px;max-width:640px">${e(l.description)}</p>`:''}

    ${vidHtml}

    ${(mdContent||qzContent||l.file_name)?`<div class="lv-content-card ${cardClass}">
      ${qzContent}
      ${mdContent?`<div class="lv-body">${mdContent}</div>`:''}
      ${l.file_name?`<div class="lv-file" style="margin-top:${mdContent?'20':'0'}px"><div class="fi">${IC.pdf}</div><div><div style="font-weight:600;font-size:14px">${e(l.file_name)}</div><div style="font-size:12px;color:var(--text-dim)">Download resource</div></div></div>`:''}
    </div>`:''}

    <div class="lv-nav">
      ${prev?`<button class="btn btn-ghost" onclick="viewLesson('${prev.id}')">‚Üê ${e(prev.title)}</button>`:'<button class="btn btn-ghost" disabled>‚Üê Start of course</button>'}
      ${next?`<button class="btn btn-ghost" onclick="viewLesson('${next.id}')">${e(next.title)} ‚Üí</button>`:'<button class="btn btn-teal" onclick="backToLanding()">‚úì Course Complete</button>'}
    </div>
  </div>`;
  window.scrollTo(0,0);
}

function backToLanding(){
  document.getElementById('lessonView').style.display='none';
  document.getElementById('landing').style.display='block';
  currentLessonId=null;
  showToolbar(false);
}

// ===== STUDENT TOOLS =====
let currentLessonId = null;
let activePanel = null;
let timerInterval = null;
let timerSeconds = 0;
let timerRunning = false;

function getNotesKey(){ return 'qp_notes_'+(COURSE?COURSE.id:''); }
function getAllNotes(){ try{return JSON.parse(localStorage.getItem(getNotesKey())||'[]')}catch(e){return []} }
function saveAllNotes(notes){ localStorage.setItem(getNotesKey(),JSON.stringify(notes)); updateNotesBadge(); }
function updateNotesBadge(){
  const notes=getAllNotes();
  const el=document.getElementById('noteCount');
  if(el){el.textContent=notes.length;el.classList.toggle('show',notes.length>0)}
}

function openTool(tool){
  const panel=document.getElementById('stPanel');
  if(activePanel===tool&&panel.classList.contains('open')){closePanel();return}
  activePanel=tool;
  panel.classList.add('open');
  if(tool==='notes') renderNotesPanel();
  else if(tool==='timer') renderTimerPanel();
}
function closePanel(){document.getElementById('stPanel').classList.remove('open');activePanel=null}

let notesView='lesson';
function renderNotesPanel(){
  document.getElementById('stPanelTitle').textContent='My Notes';
  const notes=getAllNotes();
  const filtered=(notesView==='all')?notes:notes.filter(n=>n.lessonId===currentLessonId);
  let tabs='<div class="st-tabs"><div class="st-tab'+(notesView==='lesson'?' active':'')+'" onclick="notesView=\'lesson\';renderNotesPanel()">This Lesson</div><div class="st-tab'+(notesView==='all'?' active':'')+'" onclick="notesView=\'all\';renderNotesPanel()">All Notes ('+notes.length+')</div></div>';
  let body='';
  if(!filtered.length){body='<div class="st-empty">No notes yet. Add one below!</div>'}
  else{body=filtered.map(function(n,i){
    var gi=notes.indexOf(n);
    var mod=ALL_MODS.find(function(m){return m.lessons.some(function(l){return l.id===n.lessonId})});
    var les=ALL_LESSONS.find(function(l){return l.id===n.lessonId});
    var canNav=notesView==='all'&&n.lessonId!==currentLessonId;
    var click=canNav?' onclick="viewLesson(\''+n.lessonId+'\');openTool(\'notes\')" style="cursor:pointer"':'';
    return '<div class="st-note"'+click+'><span class="st-note-del" onclick="event.stopPropagation();deleteNote('+gi+')">‚úï</span>'+e(n.text)+'<div class="st-note-meta">'+(mod?e(mod.title)+' ‚Üí ':'')+( les?e(les.title):'')+' ¬∑ '+timeAgo(n.ts)+'</div></div>';
  }).join('')}
  document.getElementById('stPanelContent').innerHTML=tabs+'<div class="st-panel-body">'+body+'</div><div class="st-note-input"><textarea id="stNoteText" placeholder="Add a note..." rows="1" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();addNote()}"></textarea><button onclick="addNote()">Save</button></div><div class="st-panel-footer"><button onclick="exportNotes()">Copy All</button><button onclick="printNotes()">Print</button><button onclick="clearNotes()">Clear</button></div>';
}

function addNote(){
  var ta=document.getElementById('stNoteText');if(!ta)return;
  var text=ta.value.trim();if(!text||!currentLessonId)return;
  var notes=getAllNotes();notes.push({lessonId:currentLessonId,text:text,ts:Date.now()});
  saveAllNotes(notes);ta.value='';renderNotesPanel();
}
function deleteNote(gi){var notes=getAllNotes();if(gi>=0&&gi<notes.length){notes.splice(gi,1);saveAllNotes(notes);renderNotesPanel()}}
function clearNotes(){if(!confirm('Delete all notes?'))return;saveAllNotes([]);renderNotesPanel()}
function timeAgo(ts){var d=Date.now()-ts,m=Math.floor(d/60000);if(m<1)return 'just now';if(m<60)return m+'m ago';var h=Math.floor(m/60);if(h<24)return h+'h ago';return new Date(ts).toLocaleDateString()}

function exportNotes(){
  var notes=getAllNotes();if(!notes.length){showToastPreview('No notes');return}
  var text=(COURSE?COURSE.title:'')+'\n';var lastMod='';
  notes.forEach(function(n){var mod=ALL_MODS.find(function(m){return m.lessons.some(function(l){return l.id===n.lessonId})});var les=ALL_LESSONS.find(function(l){return l.id===n.lessonId});var mt=mod?mod.title:'';if(mt!==lastMod){text+='\n'+mt+'\n';lastMod=mt}text+='  '+(les?les.title:'')+': '+n.text+'\n'});
  navigator.clipboard.writeText(text).then(function(){showToastPreview('Copied!')}).catch(function(){});
}
function printNotes(){
  var notes=getAllNotes();if(!notes.length){showToastPreview('No notes');return}
  var html='<html><head><title>Notes</title><style>body{font-family:Inter,Arial,sans-serif;max-width:700px;margin:40px auto;color:#1a1a2e;line-height:1.6}h1{font-size:22px;border-bottom:2px solid #5bb8c2;padding-bottom:8px}h2{font-size:16px;color:#5bb8c2;margin:24px 0 8px}.note{border-left:3px solid #5bb8c2;padding:6px 12px;margin:6px 0;background:#f5f5f5;border-radius:0 6px 6px 0;font-size:14px}.meta{font-size:11px;color:#888;margin-bottom:8px}</style></head><body>';
  html+='<h1>'+e(COURSE?COURSE.title:'Notes')+'</h1>';var lastMod='';
  notes.forEach(function(n){var mod=ALL_MODS.find(function(m){return m.lessons.some(function(l){return l.id===n.lessonId})});var les=ALL_LESSONS.find(function(l){return l.id===n.lessonId});var mt=mod?mod.title:'';if(mt!==lastMod){html+='<h2>'+e(mt)+'</h2>';lastMod=mt}html+='<div class="note">'+e(n.text)+'</div><div class="meta">'+(les?e(les.title):'')+' ¬∑ '+new Date(n.ts).toLocaleDateString()+'</div>'});
  html+='</body></html>';var w=window.open('','_blank');if(w){w.document.write(html);w.document.close();setTimeout(function(){w.print()},300)}
}

// --- Focus Timer ---
function renderTimerPanel(){
  document.getElementById('stPanelTitle').textContent='Focus Timer';
  var mm=String(Math.floor(timerSeconds/60)).padStart(2,'0');
  var ss=String(timerSeconds%60).padStart(2,'0');
  document.getElementById('stPanelContent').innerHTML='<div class="st-timer"><div class="st-timer-display">'+mm+':'+ss+'</div><div class="st-timer-btns"><button class="'+(timerRunning?'':'primary')+'" onclick="timerToggle()">'+(timerRunning?'Pause':'Start')+'</button><button onclick="timerReset()">Reset</button></div><div class="st-timer-presets"><button onclick="timerSet(5)">5m</button><button onclick="timerSet(10)">10m</button><button onclick="timerSet(15)">15m</button><button onclick="timerSet(25)">25m</button></div><p style="margin-top:16px;font-size:12px;color:var(--text-dim);line-height:1.5">Focus timer for study sessions.<br>Plays a chime when complete.</p></div>';
}
function timerToggle(){
  if(timerRunning){clearInterval(timerInterval);timerRunning=false}
  else{if(timerSeconds<=0)timerSeconds=25*60;timerRunning=true;timerInterval=setInterval(function(){timerSeconds--;if(timerSeconds<=0){clearInterval(timerInterval);timerRunning=false;timerSeconds=0;timerChime();showToastPreview('Timer complete!')}if(activePanel==='timer')renderTimerPanel()},1000)}
  if(activePanel==='timer')renderTimerPanel();
}
function timerReset(){clearInterval(timerInterval);timerRunning=false;timerSeconds=0;if(activePanel==='timer')renderTimerPanel()}
function timerSet(min){clearInterval(timerInterval);timerRunning=false;timerSeconds=min*60;if(activePanel==='timer')renderTimerPanel()}
function timerChime(){try{var ctx=new(window.AudioContext||window.webkitAudioContext)();[523.25,659.25,783.99].forEach(function(freq,i){var osc=ctx.createOscillator(),gain=ctx.createGain();osc.connect(gain);gain.connect(ctx.destination);osc.type='sine';osc.frequency.value=freq;gain.gain.setValueAtTime(0.15,ctx.currentTime+i*0.2);gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.2+0.5);osc.start(ctx.currentTime+i*0.2);osc.stop(ctx.currentTime+i*0.2+0.5)})}catch(ex){}}

function showToastPreview(msg){
  var t=document.getElementById('previewToast');
  if(!t){t=document.createElement('div');t.id='previewToast';t.style.cssText='position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--teal);color:var(--teal);padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:99;transition:opacity .3s;box-shadow:0 4px 16px rgba(0,0,0,.15)';document.body.appendChild(t)}
  t.textContent=msg;t.style.opacity='1';setTimeout(function(){t.style.opacity='0'},2500);
}

document.addEventListener('click',function(ev){
  var box=ev.target.closest('.cb-box');if(!box)return;
  if(box.classList.contains('checked')){box.classList.remove('checked');box.innerHTML=''}
  else{box.classList.add('checked');box.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="#0b1d30" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>'}
});

function showToolbar(show){var tb=document.getElementById('stToolbar');if(tb)tb.style.display=show?'flex':'none';if(!show)closePanel()}

// ===== LOAD =====
async function load(){
  const p=new URLSearchParams(location.search),slug=p.get('slug'),id=p.get('id');
  if(!getToken()){document.getElementById('landing').innerHTML='<div class="err-page"><h2>Admin Access Required</h2><p><a href="/academy/builder.html">Sign in via Builder</a> first.</p></div>';return}
  try{
    let c;
    if(id) c=(await pf('qa_courses').select('*').eq('id',id).single()).data;
    else if(slug) c=(await pf('qa_courses').select('*').eq('slug',slug).single()).data;
    if(!c){document.getElementById('landing').innerHTML='<div class="err-page"><h2>Not Found</h2><p><a href="/academy/builder.html">Back to Builder</a></p></div>';return}
    COURSE=c;

    const[mr,lr]=await Promise.all([pf('qa_modules').select('*').eq('course_id',c.id).order('sort_order'),pf('qa_lessons').select('*').eq('course_id',c.id).order('sort_order')]);
    ALL_LESSONS=lr.data||[];
    ALL_MODS=(mr.data||[]).map(m=>({...m,lessons:ALL_LESSONS.filter(l=>l.module_id===m.id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0))}));

    let lp={learn:[],faq:[],testimonials:[]};
    try{if(c.short_description&&c.short_description.startsWith('{'))lp=JSON.parse(c.short_description)}catch(ex){}

    const tl=ALL_MODS.reduce((s,m)=>s+m.lessons.length,0);
    const free=c.enrollment_type==='free';
    document.title=c.title+' ‚Äî Preview';

    let html='<div class="container"><div class="hero"><div class="hero-grid"><div>';
    html+=`<span class="badge ${c.status||'draft'}">${(c.status||'draft').replace('_',' ')}</span>`;
    html+=`<h1>${e(c.title)}</h1>`;
    if(c.subtitle) html+=`<p class="sub">${e(c.subtitle)}</p>`;
    html+=`<p class="meta">${c.instructor_name?e(c.instructor_name)+' ¬∑ ':''}${ALL_MODS.length} modules ¬∑ ${tl} lessons${c.difficulty?' ¬∑ '+e(c.difficulty):''}</p>`;
    html+=`<button class="btn btn-teal" style="margin-top:8px">${free?'Enroll for Free':'Enroll Now'}</button>`;
    html+='</div><div class="hero-img">';
    html+=c.thumbnail_url?`<img src="${e(c.thumbnail_url)}" alt="" loading="lazy">`:'<div class="ph">No thumbnail set</div>';
    html+='</div></div></div>';

    if(c.price_cents&&!free) html+=`<div class="card price-bar"><span class="price-big">$${(c.price_cents/100).toFixed(2)}</span></div>`;

    if(c.description) html+=`<div class="sec"><h2>About This Course</h2><p style="color:var(--text-muted);font-size:15px;line-height:1.7;white-space:pre-wrap">${e(c.description)}</p></div>`;

    if(lp.learn&&lp.learn.length){
      html+='<div class="sec"><h2>What You\'ll Learn</h2>';
      lp.learn.forEach(i=>html+=`<div class="learn-item">${e(i)}</div>`);
      html+='</div>';
    }

    html+='<div class="sec"><h2>Curriculum</h2>';
    ALL_MODS.forEach((m,mi)=>{
      const lm=m.lessons.reduce((s,l)=>s+(l.estimated_minutes||0),0);
      html+=`<div class="mod" data-mid="${m.id}"><div class="mod-h" onclick="toggleMod(this)"><span class="mod-n">${mi+1}</span><span class="mod-t">${e(m.title)}</span><span class="mod-c">${m.lessons.length} lesson${m.lessons.length!==1?'s':''}${lm?' ¬∑ '+lm+'m':''}</span><span class="mod-a">‚ñæ</span></div><div class="mod-body"></div></div>`;
    });
    html+='</div>';

    if(lp.testimonials&&lp.testimonials.length){
      html+='<div class="sec"><h2>What Students Say</h2>';
      lp.testimonials.forEach(t=>html+=`<div class="card test"><div class="stars">${'‚òÖ'.repeat(t.rating||5)}${'‚òÜ'.repeat(5-(t.rating||5))}</div><div class="txt">"${e(t.text)}"</div><div class="who">‚Äî ${e(t.name)}</div></div>`);
      html+='</div>';
    }

    if(lp.faq&&lp.faq.length){
      html+='<div class="sec"><h2>FAQ</h2>';
      lp.faq.forEach(f=>html+=`<div class="faq"><div class="faq-q" onclick="toggleFaq(this)"><span>${e(f.q)}</span><span>‚ñæ</span></div><div class="faq-a">${e(f.a)}</div></div>`);
      html+='</div>';
    }

    html+='</div>';
    document.getElementById('landing').innerHTML=html;

    // Auto-open first module
    const first=document.querySelector('.mod .mod-h');
    if(first) first.click();

  }catch(ex){
    document.getElementById('landing').innerHTML=`<div class="err-page"><h2>Error</h2><p>${e(ex.message)}</p><p><a href="/academy/builder.html">Back to Builder</a></p></div>`;
  }
}
load();
</script>
</body>
</html>
