<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Course Preview ‚Äî Quantum Academy</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <style>
:root {
  --bg: #0b1d30; --bg-deep: #071825; --bg-card: #112a42; --bg-card2: #15344e;
  --border: rgba(91,168,178,.12); --border-hover: rgba(91,168,178,.3);
  --text: rgba(255,255,255,.92); --text-muted: rgba(255,255,255,.55); --text-dim: rgba(255,255,255,.3);
  --teal: #5bb8c2; --teal-light: #4fd4e0; --teal-glow: rgba(91,188,198,.08);
  --taupe: #c4ad94; --purple: #a78bfa; --pink: #ff5e94;
  --success: #3dd68c; --danger: #ef5350; --warning: #f0b429; --gold: #d4a853;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; -webkit-font-smoothing: antialiased; }
h1, h2, h3 { font-family: 'Playfair Display', Georgia, serif; }

.admin-bar {
  background: rgba(167,139,250,.08); border-bottom: 1px solid rgba(167,139,250,.2);
  padding: 8px 24px; display: flex; align-items: center; gap: 10px;
  font-size: 12px; color: var(--purple); position: sticky; top: 0; z-index: 100;
}
.admin-bar .pulse { width: 7px; height: 7px; border-radius: 50%; background: var(--purple); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:.3} }
.admin-bar .label { font-weight: 700; letter-spacing: .06em; text-transform: uppercase; }
.admin-bar .info { color: rgba(167,139,250,.6); }
.admin-bar .back { margin-left: auto; color: var(--teal); text-decoration: none; font-weight: 600; }
.admin-bar .back:hover { text-decoration: underline; }

.hero-wrap { position: relative; overflow: hidden; background: linear-gradient(180deg, rgba(91,184,194,.04) 0%, transparent 60%); }
.hero-wrap::before { content:''; position:absolute; top:-200px; right:-200px; width:600px; height:600px; border-radius:50%; background:radial-gradient(circle,rgba(91,184,194,.06),transparent 70%); pointer-events:none; }
.hero { max-width:1000px; margin:0 auto; padding:50px 32px 40px; display:flex; gap:40px; align-items:flex-start; position:relative; }
.hero-content { flex:1; min-width:0; }
.hero-badges { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
.badge-pill { padding:5px 14px; border-radius:20px; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.06em; border:1px solid; }
.badge-pill.draft { background:rgba(240,180,41,.08); color:var(--warning); border-color:rgba(240,180,41,.25); }
.badge-pill.published { background:rgba(61,214,140,.08); color:var(--success); border-color:rgba(61,214,140,.25); }
.badge-pill.coming_soon { background:rgba(167,139,250,.08); color:var(--purple); border-color:rgba(167,139,250,.25); }
.badge-pill.free { background:rgba(91,184,194,.08); color:var(--teal); border-color:rgba(91,184,194,.25); }
.badge-pill.cat { background:rgba(196,173,148,.06); color:var(--taupe); border-color:rgba(196,173,148,.2); }
.hero h1 { font-size:40px; font-weight:700; line-height:1.15; margin-bottom:12px; }
.hero .subtitle { font-size:18px; color:var(--text-muted); line-height:1.5; margin-bottom:20px; }
.hero .meta-row { display:flex; gap:20px; flex-wrap:wrap; font-size:13px; color:var(--text-dim); }
.hero .meta-row span { display:flex; align-items:center; gap:6px; }
.hero .meta-row svg { width:14px; height:14px; stroke:currentColor; opacity:.6; }
.hero-thumb { width:380px; min-width:380px; aspect-ratio:16/10; border-radius:14px; overflow:hidden; border:1px solid var(--border); background:var(--bg-card); }
.hero-thumb img { width:100%; height:100%; object-fit:cover; }
.hero-thumb .placeholder { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text-dim); font-size:13px; gap:8px; }
.hero-thumb .placeholder svg { width:40px; height:40px; stroke:currentColor; opacity:.3; }

.price-strip { max-width:1000px; margin:0 auto; padding:0 32px 32px; }
.price-card { background:linear-gradient(135deg,var(--bg-card),var(--bg-card2)); border:1px solid var(--border); border-radius:14px; padding:24px 28px; display:flex; align-items:center; gap:20px; flex-wrap:wrap; }
.price-main { font-size:36px; font-weight:800; color:var(--teal); }
.price-original { font-size:18px; color:var(--text-dim); text-decoration:line-through; }
.price-sale-tag { background:linear-gradient(135deg,rgba(239,83,80,.12),rgba(255,94,148,.12)); color:var(--pink); padding:5px 12px; border-radius:8px; font-size:12px; font-weight:800; }
.price-sale-timer { font-size:12px; color:var(--text-dim); }
.enroll-btn { margin-left:auto; padding:14px 40px; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:default; background:linear-gradient(135deg,var(--teal),var(--teal-light)); color:#fff; box-shadow:0 4px 20px rgba(91,184,194,.25); }

.container { max-width:1000px; margin:0 auto; padding:0 32px; }
.section { margin-bottom:40px; }
.section-title { font-size:26px; font-weight:700; margin-bottom:20px; position:relative; display:inline-block; }
.section-title::after { content:''; position:absolute; bottom:-6px; left:0; width:40px; height:3px; border-radius:2px; background:linear-gradient(90deg,var(--teal),transparent); }

.desc-text { color:var(--text-muted); font-size:15px; line-height:1.8; white-space:pre-wrap; max-width:720px; }

.learn-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.learn-card { display:flex; gap:12px; align-items:flex-start; padding:14px 18px; background:var(--teal-glow); border:1px solid rgba(91,184,194,.08); border-radius:10px; transition:all .2s; }
.learn-card:hover { border-color:rgba(91,184,194,.2); }
.learn-check { color:var(--teal); font-size:16px; font-weight:700; flex-shrink:0; }
.learn-text { font-size:14px; line-height:1.5; }

.module-block { border:1px solid var(--border); border-radius:12px; margin-bottom:10px; overflow:hidden; transition:border-color .2s; }
.module-block:hover { border-color:var(--border-hover); }
.mod-head { padding:16px 20px; display:flex; align-items:center; gap:14px; cursor:pointer; user-select:none; transition:background .15s; }
.mod-head:hover { background:rgba(91,184,194,.03); }
.mod-num { width:32px; height:32px; border-radius:8px; flex-shrink:0; background:linear-gradient(135deg,rgba(91,184,194,.12),rgba(91,184,194,.05)); color:var(--teal); display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; }
.mod-title { flex:1; font-weight:600; font-size:15px; }
.mod-count { font-size:12px; color:var(--text-dim); white-space:nowrap; }
.mod-arrow { color:var(--text-dim); transition:transform .25s; font-size:12px; }
.module-block.open .mod-arrow { transform:rotate(180deg); }
.mod-lessons { display:none; border-top:1px solid var(--border); }
.module-block.open .mod-lessons { display:block; }
.mod-tags { display:flex; gap:6px; }
.mod-tag { font-size:10px; padding:2px 8px; border-radius:10px; font-weight:600; text-transform:uppercase; letter-spacing:.03em; }
.mod-tag.drip { background:rgba(240,180,41,.08); color:var(--warning); }
.mod-tag.locked { background:rgba(167,139,250,.08); color:var(--purple); }

.les-row { padding:12px 20px 12px 64px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(91,168,178,.04); transition:background .1s; }
.les-row:last-child { border-bottom:none; }
.les-row:hover { background:rgba(91,168,178,.04); }
.les-row.active { background:rgba(91,184,194,.08); border-left:3px solid var(--teal); }

/* Lesson Detail Panel */
.lesson-panel-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:200; opacity:0; transition:opacity .25s; }
.lesson-panel-overlay.open { opacity:1; }
.lesson-panel {
  position:fixed; top:0; right:-560px; width:560px; max-width:90vw; height:100vh;
  background:var(--bg); border-left:1px solid var(--border); z-index:201;
  transition:right .3s cubic-bezier(.4,0,.2,1); overflow-y:auto;
  box-shadow:-8px 0 40px rgba(0,0,0,.4);
}
.lesson-panel.open { right:0; }
.lp-header {
  position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:1px solid var(--border);
  padding:16px 24px; display:flex; align-items:center; gap:12px;
}
.lp-header .lp-type { width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; }
.lp-header .lp-type svg { width:16px; height:16px; stroke:currentColor; }
.lp-header .lp-title { flex:1; font-weight:700; font-size:16px; }
.lp-header .lp-close { background:none; border:none; color:var(--text-muted); cursor:pointer; padding:6px; border-radius:6px; }
.lp-header .lp-close:hover { background:rgba(255,255,255,.05); color:var(--text); }
.lp-header .lp-close svg { width:18px; height:18px; stroke:currentColor; }
.lp-body { padding:24px; }
.lp-meta { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; font-size:12px; color:var(--text-dim); }
.lp-meta .pill { padding:3px 10px; border-radius:10px; background:rgba(91,184,194,.06); font-weight:600; }
.lp-video { width:100%; aspect-ratio:16/9; border-radius:10px; border:1px solid var(--border); margin-bottom:20px; background:#000; }
.lp-video iframe { width:100%; height:100%; border:none; border-radius:10px; }
.lp-video img { width:100%; height:100%; object-fit:cover; border-radius:10px; }
.lp-content { font-size:14px; line-height:1.8; color:var(--text-muted); }
.lp-content h2 { font-family:'Playfair Display',serif; font-size:20px; color:var(--text); margin:24px 0 12px; }
.lp-content h3 { font-size:15px; color:var(--teal); margin:20px 0 8px; font-family:Inter,sans-serif; font-weight:700; }
.lp-content strong { color:var(--text); }
.lp-content code { background:rgba(91,184,194,.08); padding:2px 6px; border-radius:4px; font-size:13px; color:var(--teal); }
.lp-content ul,.lp-content ol { padding-left:20px; margin:8px 0; }
.lp-content li { margin-bottom:4px; }
.lp-content blockquote { border-left:3px solid var(--teal); padding-left:16px; margin:12px 0; color:var(--text-muted); font-style:italic; }
.lp-quiz { margin-top:16px; }
.lp-quiz-q { background:var(--bg-card); border:1px solid var(--border); border-radius:10px; padding:16px 20px; margin-bottom:10px; }
.lp-quiz-q .q-label { font-size:11px; font-weight:700; color:var(--purple); text-transform:uppercase; letter-spacing:.05em; margin-bottom:6px; }
.lp-quiz-q .q-text { font-size:14px; font-weight:600; margin-bottom:10px; }
.lp-quiz-q .q-opt { display:flex; align-items:center; gap:8px; padding:8px 12px; margin:4px 0; border-radius:6px; font-size:13px; transition:background .15s; }
.lp-quiz-q .q-opt.correct { background:rgba(61,214,140,.08); border:1px solid rgba(61,214,140,.2); }
.lp-quiz-q .q-opt:not(.correct) { background:rgba(255,255,255,.02); border:1px solid var(--border); }
.lp-quiz-q .q-opt .dot { width:16px; height:16px; border-radius:50%; border:2px solid var(--border); flex-shrink:0; }
.lp-quiz-q .q-opt.correct .dot { border-color:var(--success); background:var(--success); }
.lp-quiz-q .q-scale { display:flex; justify-content:space-between; font-size:12px; color:var(--text-dim); margin-top:8px; }
.lp-quiz-q .q-scale-bar { height:8px; border-radius:4px; background:linear-gradient(90deg,var(--border),var(--teal)); margin-top:6px; }
.lp-quiz-q .q-reflection { padding:12px; background:rgba(167,139,250,.05); border:1px dashed rgba(167,139,250,.2); border-radius:8px; font-size:13px; color:var(--text-dim); font-style:italic; }
.lp-quiz-q .q-check { display:flex; align-items:center; gap:8px; padding:6px 0; font-size:13px; }
.lp-quiz-q .q-check span { color:var(--teal); }
.lp-file { display:flex; align-items:center; gap:12px; padding:16px; background:var(--bg-card); border:1px solid var(--border); border-radius:10px; margin-top:16px; }
.lp-file .file-icon { width:40px; height:40px; border-radius:8px; background:rgba(240,180,41,.1); color:var(--warning); display:flex; align-items:center; justify-content:center; }
.lp-file .file-icon svg { width:18px; height:18px; stroke:currentColor; }
.lp-file .file-info { flex:1; }
.lp-file .file-name { font-weight:600; font-size:14px; }
.lp-file .file-size { font-size:12px; color:var(--text-dim); }
.lp-nav { display:flex; gap:8px; padding:16px 24px; border-top:1px solid var(--border); position:sticky; bottom:0; background:var(--bg); }
.lp-nav button { flex:1; padding:10px 16px; border:1px solid var(--border); border-radius:8px; background:none; color:var(--text); font-size:13px; font-weight:600; cursor:pointer; transition:all .15s; font-family:inherit; }
.lp-nav button:hover { border-color:var(--teal); background:rgba(91,184,194,.05); }
.les-icon { width:30px; height:30px; border-radius:7px; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
.les-icon svg { width:14px; height:14px; stroke:currentColor; }
.les-icon.video { background:rgba(91,184,194,.1); color:var(--teal); }
.les-icon.text { background:rgba(196,173,148,.1); color:var(--taupe); }
.les-icon.quiz { background:rgba(167,139,250,.1); color:var(--purple); }
.les-icon.pdf,.les-icon.download { background:rgba(240,180,41,.1); color:var(--warning); }
.les-icon.assignment { background:rgba(255,94,148,.08); color:var(--pink); }
.les-icon.live_session { background:rgba(239,83,80,.08); color:var(--danger); }
.les-icon.embed { background:rgba(91,184,194,.06); color:var(--teal-light); }
.les-icon.audio { background:rgba(61,214,140,.08); color:var(--success); }
.les-name { flex:1; font-size:14px; }
.les-dur { font-size:12px; color:var(--text-dim); }
.les-badge { font-size:10px; padding:3px 10px; border-radius:12px; background:rgba(91,184,194,.08); color:var(--teal); font-weight:700; text-transform:uppercase; letter-spacing:.03em; }
.les-lock { color:var(--text-dim); font-size:11px; }

.test-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.test-card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:22px 24px; transition:border-color .2s; }
.test-card:hover { border-color:var(--border-hover); }
.test-stars { color:var(--gold); margin-bottom:10px; font-size:14px; letter-spacing:2px; }
.test-quote { font-size:14px; color:var(--text-muted); font-style:italic; line-height:1.6; margin-bottom:12px; }
.test-quote::before { content:'\201C'; color:var(--teal); font-size:24px; font-weight:700; line-height:0; vertical-align:-.3em; margin-right:3px; }
.test-quote::after { content:'\201D'; color:var(--teal); font-size:24px; font-weight:700; line-height:0; vertical-align:-.3em; margin-left:3px; }
.test-author { font-size:13px; font-weight:600; color:var(--taupe); }

.faq-item { border:1px solid var(--border); border-radius:10px; margin-bottom:8px; overflow:hidden; transition:border-color .2s; }
.faq-item:hover { border-color:var(--border-hover); }
.faq-q { padding:16px 20px; font-weight:600; font-size:14px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; user-select:none; transition:background .15s; }
.faq-q:hover { background:rgba(91,184,194,.03); }
.faq-q .arrow { color:var(--text-dim); transition:transform .25s; font-size:12px; }
.faq-item.open .faq-q .arrow { transform:rotate(180deg); }
.faq-a { padding:0 20px 16px; font-size:14px; color:var(--text-muted); line-height:1.7; display:none; }
.faq-item.open .faq-a { display:block; }

.preview-footer { text-align:center; padding:48px 24px; border-top:1px solid var(--border); margin-top:20px; font-size:12px; color:var(--text-dim); }

.loading { text-align:center; padding:120px 24px; color:var(--text-muted); }
.spinner { width:36px; height:36px; border:3px solid var(--border); border-top-color:var(--teal); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 20px; }
@keyframes spin { to{transform:rotate(360deg)} }
.not-found { text-align:center; padding:120px 24px; }
.not-found h2 { margin-bottom:8px; }
.not-found p { color:var(--text-muted); }
.not-found a { color:var(--teal); }

@media(max-width:768px){
  .hero{flex-direction:column-reverse;padding:30px 20px;gap:24px}
  .hero-thumb{width:100%;min-width:100%}
  .hero h1{font-size:28px}
  .learn-grid,.test-grid{grid-template-columns:1fr}
  .price-card{flex-direction:column;align-items:stretch}
  .enroll-btn{margin-left:0;text-align:center}
  .container{padding:0 20px}
  .les-row{padding-left:48px}
}
  </style>
</head>
<body>
<div class="admin-bar">
  <div class="pulse"></div>
  <span class="label">Admin Preview</span>
  <span class="info">‚Äî How students will see this course</span>
  <a class="back" href="javascript:history.back()">‚Üê Back to Builder</a>
</div>
<div id="content"><div class="loading"><div class="spinner"></div>Loading preview‚Ä¶</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://bqbcehfozsaaqrbjvkml.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYmNlaGZvenNhYXFyYmp2a21sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjczMTcxNDEsImV4cCI6MjA0Mjg5MzE0MX0.2Iv2kPMLpECGqHPiyDGkPrdsMhFKQMFnpJm2x9a3vMA';
function getAdminToken(){return sessionStorage.getItem('qp_admin_token')||localStorage.getItem('qp_admin_token')||''}
async function adminProxy(p){const r=await fetch('/.netlify/functions/admin-proxy',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+getAdminToken()},body:JSON.stringify(p)});const j=await r.json();if(!r.ok)throw new Error(j.error||'Proxy failed');return j}
function proxyFrom(t){return{_t:t,_s:'*',_f:[],_o:null,_si:false,select(s){this._s=s;return this},eq(c,v){this._f.push({column:c,op:'eq',value:v});return this},order(c,o){this._o={column:c,ascending:o?o.ascending!==false:true};return this},single(){this._si=true;return this},then(res,rej){return adminProxy({type:'query',table:this._t,select:this._s,filters:this._f,order:this._o,single:this._si}).then(r=>({data:r.data,error:null})).then(res,e=>res?res({data:null,error:{message:e.message}}):rej?rej(e):null)}}}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
const I={
  video:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
  text:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  quiz:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  pdf:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  assignment:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>',
  embed:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
  live_session:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>',
  audio:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',
  download:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  discussion:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
  image:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
  user:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
  clock:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  book:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
  bar:'<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>',
};
function ti(t){return I[t]||I.text}
function toggleMod(el){
  const block=el.closest('.module-block');
  const mid=block.dataset.mid;
  const lessonsDiv=block.querySelector('.mod-lessons');
  // Lazy render lessons on first open
  if(!lessonsDiv.dataset.loaded && mid){
    const mod=(window._mods||[]).find(m=>m.id===mid);
    if(mod && mod.lessons.length){
      lessonsDiv.innerHTML=mod.lessons.map(l=>`
        <div class="les-row" onclick="showLesson(this)" data-lid="${l.id}" style="cursor:pointer">
          <div class="les-icon ${l.content_type||'text'}">${ti(l.content_type)}</div>
          <span class="les-name">${esc(l.title)}</span>
          ${l.estimated_minutes?`<span class="les-dur">${l.estimated_minutes} min</span>`:''}
          ${l.is_free_preview?'<span class="les-badge">Preview</span>':''}
          ${l.require_previous?'<span class="les-lock">üîí</span>':''}
        </div>`).join('');
    } else {
      lessonsDiv.innerHTML='<div style="padding:16px 20px 16px 64px;font-size:13px;color:var(--text-dim)">No lessons yet</div>';
    }
    lessonsDiv.dataset.loaded='1';
  }
  block.classList.toggle('open');
}
function toggleFaq(el){el.closest('.faq-item').classList.toggle('open')}

async function loadPreview(){
  const p=new URLSearchParams(location.search), slug=p.get('slug'), id=p.get('id');
  if(!getAdminToken()){document.getElementById('content').innerHTML='<div class="not-found"><h2>Admin Access Required</h2><p>Please <a href="/academy/builder.html">sign in via the Course Builder</a> first.</p></div>';return}
  try{
    let c;
    if(id){const r=await proxyFrom('qa_courses').select('*').eq('id',id).single();c=r.data}
    else if(slug){const r=await proxyFrom('qa_courses').select('*').eq('slug',slug).single();c=r.data}
    if(!c){document.getElementById('content').innerHTML='<div class="not-found"><h2>Course Not Found</h2><p><a href="/academy/builder.html">Back to Builder</a></p></div>';return}

    const[mr,lr]=await Promise.all([proxyFrom('qa_modules').select('*').eq('course_id',c.id).order('sort_order'),proxyFrom('qa_lessons').select('*').eq('course_id',c.id).order('sort_order')]);
    const al=lr.data||[];
    window._allLessons=al; // store for panel
    const mods=(mr.data||[]).map(m=>({...m,lessons:al.filter(l=>l.module_id===m.id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0))}));
    window._mods=mods; // store for lazy render
    let lp={learn:[],faq:[],testimonials:[]};
    try{if(c.short_description&&c.short_description.startsWith('{'))lp=JSON.parse(c.short_description)}catch(e){}

    const price=c.price_cents||0, sp=c.sale_price_cents;
    const saleOn=sp&&c.sale_ends_at&&new Date(c.sale_ends_at)>new Date();
    const dp=saleOn?sp:price;
    const tl=mods.reduce((s,m)=>s+m.lessons.length,0);
    const tm=mods.reduce((s,m)=>s+m.lessons.reduce((s2,l)=>s2+(l.estimated_minutes||0),0),0);
    const free=c.enrollment_type==='free';
    document.title=c.title+' ‚Äî Quantum Academy';

    let saleTimer='';
    if(saleOn){const d=new Date(c.sale_ends_at)-new Date(),dd=Math.floor(d/864e5),hh=Math.floor(d%864e5/36e5);saleTimer=`<span class="price-sale-timer">Sale ends in ${dd>0?dd+'d ':''}${hh}h</span>`}

    document.getElementById('content').innerHTML=`
    <div class="hero-wrap"><div class="hero">
      <div class="hero-content">
        <div class="hero-badges">
          <span class="badge-pill ${c.status||'draft'}">${(c.status||'draft').replace('_',' ')}</span>
          ${free?'<span class="badge-pill free">Free Course</span>':''}
          ${c.category?`<span class="badge-pill cat">${esc(c.category)}</span>`:''}
          ${c.difficulty?`<span class="badge-pill cat">${esc(c.difficulty)}</span>`:''}
        </div>
        <h1>${esc(c.title)}</h1>
        ${c.subtitle?`<p class="subtitle">${esc(c.subtitle)}</p>`:''}
        <div class="meta-row">
          ${c.instructor_name?`<span>${I.user} ${esc(c.instructor_name)}</span>`:''}
          <span>${I.book} ${mods.length} module${mods.length!==1?'s':''} ¬∑ ${tl} lesson${tl!==1?'s':''}</span>
          ${tm>0?`<span>${I.clock} ${tm} min</span>`:''}
        </div>
      </div>
      <div class="hero-thumb">
        ${c.thumbnail_url?`<img src="${esc(c.thumbnail_url)}" alt="">`:`<div class="placeholder">${I.image}<span>No thumbnail</span></div>`}
      </div>
    </div></div>

    ${price>0||free?`<div class="price-strip"><div class="price-card">
      ${free?'<span class="price-main">Free</span>':`<span class="price-main">$${(dp/100).toFixed(2)}</span>${saleOn?`<span class="price-original">$${(price/100).toFixed(2)}</span><span class="price-sale-tag">SAVE $${((price-sp)/100).toFixed(2)}</span>${saleTimer}`:''}`}
      <button class="enroll-btn">${free?'Enroll for Free':'Enroll Now'}</button>
    </div></div>`:''}

    <div class="container">
      ${c.description?`<div class="section"><h2 class="section-title">About This Course</h2><div class="desc-text">${esc(c.description)}</div></div>`:''}

      ${lp.learn&&lp.learn.length?`<div class="section"><h2 class="section-title">What You'll Learn</h2><div class="learn-grid">${lp.learn.map(i=>`<div class="learn-card"><span class="learn-check">‚úì</span><span class="learn-text">${esc(i)}</span></div>`).join('')}</div></div>`:''}

      <div class="section">
        <h2 class="section-title">Curriculum</h2>
        ${mods.length?mods.map((m,mi)=>{const lm=m.lessons.reduce((s,l)=>s+(l.estimated_minutes||0),0);return`
        <div class="module-block" data-mid="${m.id}">
          <div class="mod-head" onclick="toggleMod(this)">
            <span class="mod-num">${mi+1}</span>
            <span class="mod-title">${esc(m.title)}</span>
            <div class="mod-tags">
              ${m.drip_delay_days?`<span class="mod-tag drip">Drip ${m.drip_delay_days}d</span>`:''}
              ${m.require_previous?'<span class="mod-tag locked">Sequential</span>':''}
            </div>
            <span class="mod-count">${m.lessons.length} lesson${m.lessons.length!==1?'s':''}${lm?' ¬∑ '+lm+' min':''}</span>
            <span class="mod-arrow">‚ñæ</span>
          </div>
          <div class="mod-lessons"></div>
        </div>`}).join(''):'<p style="color:var(--text-muted);font-style:italic">No curriculum added yet.</p>'}
      </div>

      ${lp.testimonials&&lp.testimonials.length?`<div class="section"><h2 class="section-title">What Students Say</h2><div class="test-grid">${lp.testimonials.map(t=>`<div class="test-card"><div class="test-stars">${'‚òÖ'.repeat(t.rating||5)}${'‚òÜ'.repeat(5-(t.rating||5))}</div><div class="test-quote">${esc(t.text)}</div><div class="test-author">‚Äî ${esc(t.name)}</div></div>`).join('')}</div></div>`:''}

      ${lp.faq&&lp.faq.length?`<div class="section"><h2 class="section-title">Frequently Asked Questions</h2>${lp.faq.map(f=>`<div class="faq-item"><div class="faq-q" onclick="toggleFaq(this)"><span>${esc(f.q)}</span><span class="arrow">‚ñæ</span></div><div class="faq-a">${esc(f.a)}</div></div>`).join('')}</div>`:''}
    </div>
    <div class="preview-footer">Quantum Academy ¬∑ Admin Preview</div>`;
  }catch(e){document.getElementById('content').innerHTML=`<div class="not-found"><h2>Preview Error</h2><p>${esc(e.message)}</p><p style="margin-top:12px"><a href="/academy/builder.html">Back to Builder</a></p></div>`}
}
function mdToHtml(md) {
  if(!md) return '';
  // Check if it's JSON (quiz data) ‚Äî don't render as markdown
  if(md.trim().startsWith('{')) return '';
  return md
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code>$1</code>')
    .replace(/^- \[ \] (.+)$/gm,'<div style="display:flex;gap:8px;margin:4px 0"><span style="color:var(--text-dim)">‚òê</span> $1</div>')
    .replace(/^- \[x\] (.+)$/gm,'<div style="display:flex;gap:8px;margin:4px 0"><span style="color:var(--teal)">‚òë</span> $1</div>')
    .replace(/^- (.+)$/gm,'<li>$1</li>')
    .replace(/^(\d+)\. (.+)$/gm,'<li>$2</li>')
    .replace(/(<li>.*<\/li>\n?)+/g,'<ul>$&</ul>')
    .replace(/\n\n/g,'<br><br>')
    .replace(/\n/g,'<br>');
}

function renderQuizPreview(jsonStr) {
  try {
    const q = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
    if(!q.questions) return '';
    return `<div class="lp-quiz">${q.questions.map((qq,i) => {
      let body = '';
      if(q.quiz_type === 'multiple_choice') {
        body = (qq.options||[]).map((o,oi) =>
          `<div class="q-opt ${oi===qq.correct?'correct':''}"><div class="dot"></div>${esc(o)}</div>`
        ).join('');
      } else if(q.quiz_type === 'true_false') {
        body = `<div class="q-opt ${qq.correct===true||qq.correct==='true'?'correct':''}"><div class="dot"></div>True</div>
                <div class="q-opt ${qq.correct===false||qq.correct==='false'?'correct':''}"><div class="dot"></div>False</div>`;
      } else if(q.quiz_type === 'reflection') {
        body = `<div class="q-reflection">Students write their response here...</div>`;
      } else if(q.quiz_type === 'rating') {
        body = `<div class="q-scale-bar"></div><div class="q-scale"><span>${esc(qq.scale_low||'Low')}</span><span>${esc(qq.scale_high||'High')}</span></div>`;
      } else if(q.quiz_type === 'checklist') {
        body = (qq.items||[]).map(item => `<div class="q-check"><span>‚òê</span> ${esc(item)}</div>`).join('');
      }
      return `<div class="lp-quiz-q"><div class="q-label">Question ${i+1} ¬∑ ${(q.quiz_type||'').replace('_',' ')}</div><div class="q-text">${esc(qq.question)}</div>${body}</div>`;
    }).join('')}</div>`;
  } catch(e) { return ''; }
}

function showLesson(el) {
  const lid = el.dataset.lid;
  const lesson = (window._allLessons||[]).find(l => l.id === lid);
  if(!lesson) return;

  // Remove old panel if exists
  document.querySelectorAll('.lesson-panel-overlay,.lesson-panel').forEach(e=>e.remove());

  // Mark active
  document.querySelectorAll('.les-row.active').forEach(e=>e.classList.remove('active'));
  el.classList.add('active');

  // Find prev/next
  const sorted = (window._allLessons||[]).slice().sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
  const idx = sorted.findIndex(l=>l.id===lid);
  const prev = idx > 0 ? sorted[idx-1] : null;
  const next = idx < sorted.length-1 ? sorted[idx+1] : null;

  // Content
  const ct = lesson.content_type || 'text';
  const content = lesson.content_markdown || lesson.content_html || lesson.description || '';
  let quizHtml = '';
  if(ct === 'quiz') {
    quizHtml = renderQuizPreview(lesson.content_html || lesson.content_markdown);
  }
  const hasVideo = lesson.video_url && (ct === 'video');
  const isVimeo = hasVideo && lesson.video_url.includes('vimeo');

  // Build panel
  const overlay = document.createElement('div');
  overlay.className = 'lesson-panel-overlay';
  overlay.onclick = () => closeLesson();

  const panel = document.createElement('div');
  panel.className = 'lesson-panel';
  panel.onclick = (e) => e.stopPropagation();
  panel.innerHTML = `
    <div class="lp-header">
      <div class="lp-type les-icon ${ct}">${ti(ct)}</div>
      <div class="lp-title">${esc(lesson.title)}</div>
      <button class="lp-close" onclick="closeLesson()"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="lp-body">
      <div class="lp-meta">
        <span class="pill">${ct.replace('_',' ')}</span>
        ${lesson.estimated_minutes ? `<span>${lesson.estimated_minutes} min</span>` : ''}
        ${lesson.is_free_preview ? '<span style="color:var(--teal)">Free Preview</span>' : ''}
        ${lesson.is_required ? '<span>Required</span>' : '<span>Optional</span>'}
      </div>
      ${hasVideo ? `<div class="lp-video">
        ${isVimeo
          ? `<iframe src="${esc(lesson.video_url)}?title=0&byline=0&portrait=0" allow="autoplay; fullscreen" allowfullscreen></iframe>`
          : lesson.video_thumbnail_url
            ? `<img src="${esc(lesson.video_thumbnail_url)}" alt="Video thumbnail">`
            : `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-dim)">Video: ${esc(lesson.video_url)}</div>`
        }
      </div>` : ''}
      ${lesson.video_thumbnail_url && !hasVideo ? `<img src="${esc(lesson.video_thumbnail_url)}" style="width:100%;border-radius:10px;margin-bottom:16px;border:1px solid var(--border)" alt="">` : ''}
      ${quizHtml}
      <div class="lp-content">${mdToHtml(content)}</div>
      ${lesson.file_name ? `<div class="lp-file">
        <div class="file-icon">${I.pdf}</div>
        <div class="file-info">
          <div class="file-name">${esc(lesson.file_name)}</div>
          <div class="file-size">${lesson.file_url && lesson.file_url !== '#' ? 'Download available' : 'File placeholder'}</div>
        </div>
      </div>` : ''}
    </div>
    <div class="lp-nav">
      ${prev ? `<button onclick="closeLesson();document.querySelector('[data-lid=\\'${prev.id}\\']').click()">‚Üê ${esc(prev.title)}</button>` : '<button disabled style="opacity:.3">‚Üê Previous</button>'}
      ${next ? `<button onclick="closeLesson();document.querySelector('[data-lid=\\'${next.id}\\']').click()">${esc(next.title)} ‚Üí</button>` : '<button disabled style="opacity:.3">Next ‚Üí</button>'}
    </div>
  `;

  document.body.appendChild(overlay);
  document.body.appendChild(panel);
  requestAnimationFrame(() => { overlay.classList.add('open'); panel.classList.add('open'); });
}

function closeLesson() {
  document.querySelectorAll('.les-row.active').forEach(e=>e.classList.remove('active'));
  const o = document.querySelector('.lesson-panel-overlay');
  const p = document.querySelector('.lesson-panel');
  if(o) { o.classList.remove('open'); setTimeout(()=>o.remove(),300); }
  if(p) { p.classList.remove('open'); setTimeout(()=>p.remove(),300); }
}
document.addEventListener('keydown', e => { if(e.key==='Escape') closeLesson(); });

loadPreview();
</script>
</body>
</html>
