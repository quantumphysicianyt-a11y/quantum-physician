<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="pageTitle">Course ‚Äî Quantum Academy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/shared.css">
  <link rel="stylesheet" href="/academy/css/academy.css">
</head>
<body class="qa-page">
  <div id="shared-header"></div>

  <main>
    <div id="loading" class="qa-loading" style="padding:120px 0"><div class="qa-spinner"></div></div>

    <div id="courseContent" style="display:none">
      <!-- Hero -->
      <section class="qa-hero" style="text-align:left;padding:50px 0 60px">
        <div class="qa-hero-orb a"></div>
        <div class="qa-hero-orb b"></div>
        <div class="qa-wrap">
          <div class="qa-sales-hero">
            <div>
              <div class="qa-label" id="courseCategory"></div>
              <h1 class="qa-h1" id="courseTitle" style="margin-top:12px"></h1>
              <p id="courseSubtitle" style="font-family:'Playfair Display',serif;font-style:italic;font-size:20px;color:var(--taupe);margin-bottom:20px"></p>
              <p class="qa-subtitle" id="courseDesc" style="max-width:none"></p>
              <div style="display:flex;align-items:center;gap:20px;margin-top:24px;flex-wrap:wrap">
                <div id="instructorInfo" style="display:flex;align-items:center;gap:10px;font-size:14px;color:var(--qa-text-muted)"></div>
                <div id="courseMeta" style="display:flex;gap:16px;font-size:14px;color:var(--qa-text-muted)"></div>
              </div>
            </div>
            <div>
              <div class="qa-sales-sidebar" id="sidebar">
                <div id="videoPreview" class="video-preview" style="margin-bottom:24px;border-radius:8px;overflow:hidden;display:none"></div>
                <div id="priceDisplay"></div>
                <div id="enrollBtn" style="margin-top:20px"></div>
                <ul class="includes" id="includes" style="list-style:none;padding:0"></ul>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Curriculum -->
      <section class="qa-wrap qa-curriculum">
        <h2 class="qa-h2" style="text-align:center;margin-bottom:8px">Course Curriculum</h2>
        <p style="text-align:center;color:var(--qa-text-muted);margin-bottom:30px" id="curriculumMeta"></p>
        <div id="curriculum"></div>
      </section>

      <!-- Reviews -->
      <section class="qa-wrap" style="padding:40px 24px 80px" id="reviewsSection" style="display:none">
        <h2 class="qa-h2" style="text-align:center">What Students Say</h2>
        <div id="reviews" style="max-width:700px;margin:24px auto 0"></div>
      </section>
    </div>
  </main>

  <div id="shared-footer"></div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/shared.js"></script>
  <script src="/academy/js/academy.js"></script>
  <script>
    const slug = new URLSearchParams(window.location.search).get('slug');
    const bundleSlug = new URLSearchParams(window.location.search).get('bundle');
    if (!slug && !bundleSlug) window.location.href = '/academy/';

    (async () => {
      try {
        // --- BUNDLE MODE ---
        if (bundleSlug) {
          const { data: bundle, error: bErr } = await sb.from('qa_bundles')
            .select('*')
            .eq('slug', bundleSlug)
            .single();
          if (bErr || !bundle) { window.location.href = '/academy/'; return; }

          // Get bundle courses
          const { data: bundleCourses } = await sb.from('qa_bundle_courses')
            .select('course_id, sort_order, qa_courses(*)')
            .eq('bundle_id', bundle.id)
            .order('sort_order');

          const courses = (bundleCourses || []).map(bc => bc.qa_courses).filter(Boolean);

          document.getElementById('pageTitle').textContent = bundle.title + ' ‚Äî Quantum Academy';
          document.getElementById('courseTitle').textContent = bundle.title;
          document.getElementById('courseSubtitle').textContent = bundle.subtitle || 'All 5 Self-H.O.P.E. Academy Courses';
          document.getElementById('courseDesc').textContent = bundle.description || '';
          document.getElementById('courseCategory').textContent = 'Bundle';

          // Meta
          const totalLessons = courses.reduce((sum, c) => sum + (c.total_lessons || 1), 0);
          const totalDuration = courses.reduce((sum, c) => sum + (c.total_duration_minutes || 0), 0);
          const metaItems = [`üìö ${courses.length} courses`, `üì∫ ${totalLessons} lessons`];
          if (totalDuration) metaItems.push(`‚è± ${formatDuration(totalDuration)}`);
          document.getElementById('courseMeta').innerHTML = metaItems.map(m => `<span>${m}</span>`).join('');

          // Instructor
          document.getElementById('instructorInfo').innerHTML = `<span>By <strong style="color:var(--qa-text)">Dr. Tracey Clark</strong></span>`;

          // Bundle image
          const vp = document.getElementById('videoPreview');
          vp.style.display = 'block';
          vp.innerHTML = `<img src="/assets/images/Bundle-Full.png" alt="${bundle.title}" style="width:100%;object-fit:contain">`;

          // Price
          const perCourse = courses.length > 0 ? Math.round(bundle.price_cents / courses.length) : 0;
          const fullPrice = courses.reduce((sum, c) => sum + (c.price_cents || 0), 0);
          document.getElementById('priceDisplay').innerHTML = `
            <div class="price-main">${formatPrice(bundle.price_cents)}</div>
            ${fullPrice > bundle.price_cents ? `<div class="price-original">${formatPrice(fullPrice)}</div><div style="color:var(--teal);font-size:14px;margin-top:4px">Save ${formatPrice(fullPrice - bundle.price_cents)}!</div>` : ''}
          `;

          // Includes
          const includes = [
            { icon: 'üìö', text: `${courses.length} complete courses` },
            { icon: 'üì∫', text: `${totalLessons} on-demand lessons` },
            { icon: '‚ôæÔ∏è', text: 'Lifetime access' },
            { icon: 'üì±', text: 'Access on mobile & desktop' },
            { icon: 'üí∞', text: `${formatPrice(perCourse)}/course (save ${formatPrice(fullPrice - bundle.price_cents)})` }
          ];
          document.getElementById('includes').innerHTML = includes.map(i =>
            `<li><span class="icon">${i.icon}</span> ${i.text}</li>`
          ).join('');

          // Enroll button
          const user = await getUser();
          const btnDiv = document.getElementById('enrollBtn');
          if (user) {
            // Check if already owns all courses
            const { data: existingEnrollments } = await sb.from('qa_enrollments')
              .select('course_id')
              .eq('user_id', user.id)
              .eq('status', 'active');
            const enrolledIds = (existingEnrollments || []).map(e => e.course_id);
            const allEnrolled = courses.every(c => enrolledIds.includes(c.id));

            if (allEnrolled) {
              btnDiv.innerHTML = `<a href="/academy/dashboard.html" class="qa-btn qa-btn-primary" style="width:100%;justify-content:center">Go to Dashboard ‚Üí</a>`;
            } else {
              btnDiv.innerHTML = `<button class="qa-btn qa-btn-primary" style="width:100%;justify-content:center" onclick="handlePurchase('transformational-mastery')">Get the Bundle ‚Äî ${formatPrice(bundle.price_cents)}</button>`;
            }
          } else {
            btnDiv.innerHTML = `<a href="/academy/login.html?redirect=/academy/course.html?bundle=${bundleSlug}" class="qa-btn qa-btn-primary" style="width:100%;justify-content:center">Sign In to Enroll ‚Äî ${formatPrice(bundle.price_cents)}</a>`;
          }

          // Curriculum ‚Äî show each course as a "module"
          document.getElementById('curriculumMeta').textContent = `${courses.length} courses included in this bundle`;
          document.getElementById('curriculum').innerHTML = courses.map((c, i) => `
            <a href="/academy/course.html?slug=${c.slug}" class="qa-module-accordion" style="text-decoration:none;color:inherit;display:block">
              <div class="qa-module-header">
                <h4>${c.title}</h4>
                <span class="info">${formatPrice(c.price_cents)} individually</span>
              </div>
              <div class="qa-module-lessons open" style="padding:14px 24px 14px 40px;font-size:14px;color:var(--qa-text-muted);line-height:1.6">
                ${c.short_description || c.description || ''}
              </div>
            </a>
          `).join('');

          document.getElementById('loading').style.display = 'none';
          document.getElementById('courseContent').style.display = '';
          return;
        }

        // --- SINGLE COURSE MODE ---
        const course = await getCourse(slug);
        if (!course) { window.location.href = '/academy/'; return; }

        document.getElementById('pageTitle').textContent = course.title + ' ‚Äî Quantum Academy';
        document.getElementById('courseTitle').textContent = course.title;
        document.getElementById('courseSubtitle').textContent = course.subtitle || '';
        document.getElementById('courseDesc').textContent = course.description || course.short_description || '';
        document.getElementById('courseCategory').textContent = course.category || 'Course';

        // Meta
        const meta = [];
        if (course.total_lessons) meta.push(`üì∫ ${course.total_lessons} lessons`);
        if (course.total_duration_minutes) meta.push(`‚è± ${formatDuration(course.total_duration_minutes)}`);
        if (course.difficulty) meta.push(`üìä ${course.difficulty.charAt(0).toUpperCase() + course.difficulty.slice(1)}`);
        if (course.enrolled_count) meta.push(`üë• ${course.enrolled_count} students`);
        document.getElementById('courseMeta').innerHTML = meta.map(m => `<span>${m}</span>`).join('');

        // Instructor
        if (course.instructor_name) {
          document.getElementById('instructorInfo').innerHTML = `<span>By <strong style="color:var(--qa-text)">${course.instructor_name}</strong></span>`;
        }

        // Video preview
        if (course.promo_video_url) {
          const vp = document.getElementById('videoPreview');
          vp.style.display = 'block';
          vp.innerHTML = `<video controls poster="${course.thumbnail_url || ''}" style="width:100%;aspect-ratio:16/9;background:#000"><source src="${course.promo_video_url}" type="video/mp4"></video>`;
        } else if (course.thumbnail_url) {
          const vp = document.getElementById('videoPreview');
          vp.style.display = 'block';
          vp.innerHTML = `<img src="${course.thumbnail_url}" alt="${course.title}" style="width:100%;aspect-ratio:16/9;object-fit:cover">`;
        }

        // Price
        const isOnSale = course.sale_price_cents && course.sale_ends_at && new Date(course.sale_ends_at) > new Date();
        const displayPrice = isOnSale ? course.sale_price_cents : course.price_cents;
        document.getElementById('priceDisplay').innerHTML = `
          <div class="price-main">${formatPrice(displayPrice)}</div>
          ${isOnSale ? `<div class="price-original">${formatPrice(course.price_cents)}</div>` : ''}
        `;

        // Includes
        const includes = [];
        if (course.total_lessons) includes.push({ icon: 'üì∫', text: `${course.total_lessons} on-demand lessons` });
        if (course.total_duration_minutes) includes.push({ icon: '‚è±', text: `${formatDuration(course.total_duration_minutes)} of content` });
        includes.push({ icon: '‚ôæÔ∏è', text: 'Lifetime access' });
        includes.push({ icon: 'üì±', text: 'Access on mobile & desktop' });
        if (course.certificate_enabled) includes.push({ icon: 'üìú', text: 'Certificate of completion' });
        if (course.discussion_enabled) includes.push({ icon: 'üí¨', text: 'Course community discussions' });
        document.getElementById('includes').innerHTML = includes.map(i => 
          `<li><span class="icon">${i.icon}</span> ${i.text}</li>`
        ).join('');

        // Enrollment button
        const user = await getUser();
        const enrollment = user ? await getEnrollment(course.id) : null;
        const btnDiv = document.getElementById('enrollBtn');

        if (enrollment) {
          btnDiv.innerHTML = `<a href="/academy/learn.html?slug=${course.slug}" class="qa-btn qa-btn-primary" style="width:100%;justify-content:center">Continue Learning ‚Üí</a>`;
        } else if (course.status === 'coming_soon') {
          btnDiv.innerHTML = `<button class="qa-btn qa-btn-taupe" disabled style="width:100%;justify-content:center">Coming Soon</button>`;
        } else if (course.enrollment_type === 'free' || course.price_cents === 0) {
          if (user) {
            btnDiv.innerHTML = `<button class="qa-btn qa-btn-primary" style="width:100%;justify-content:center" onclick="handleFreeEnroll('${course.id}','${course.slug}')">Enroll Free ‚Üí</button>`;
          } else {
            btnDiv.innerHTML = `<a href="/academy/login.html?redirect=/academy/course.html?slug=${course.slug}" class="qa-btn qa-btn-primary" style="width:100%;justify-content:center">Sign In to Enroll (Free)</a>`;
          }
        } else {
          // Paid ‚Äî Stripe checkout
          if (user) {
            btnDiv.innerHTML = `<button class="qa-btn qa-btn-primary" style="width:100%;justify-content:center" onclick="handlePurchase('${course.slug}')">Enroll Now ‚Äî ${formatPrice(course.price_cents)}</button>`;
          } else {
            btnDiv.innerHTML = `<a href="/academy/login.html?redirect=/academy/course.html?slug=${course.slug}" class="qa-btn qa-btn-primary" style="width:100%;justify-content:center">Sign In to Enroll ‚Äî ${formatPrice(course.price_cents)}</a>`;
          }
        }

        // Curriculum
        const modules = await getCourseModules(course.id);
        const currMeta = document.getElementById('curriculumMeta');
        currMeta.textContent = `${modules.length} modules ¬∑ ${course.total_lessons || 0} lessons ¬∑ ${formatDuration(course.total_duration_minutes || 0)} total`;

        document.getElementById('curriculum').innerHTML = modules.map((m, i) => `
          <div class="qa-module-accordion">
            <div class="qa-module-header" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
              <h4>Module ${i + 1}: ${m.title}</h4>
              <span class="info">${m.qa_lessons?.length || 0} lessons</span>
            </div>
            <div class="qa-module-lessons${i === 0 ? ' open' : ''}">
              ${(m.qa_lessons || []).map(l => `
                <div class="qa-module-lesson-row">
                  <span class="type-icon">${l.content_type === 'video' ? '‚ñ∂Ô∏è' : l.content_type === 'quiz' ? '‚ùì' : l.content_type === 'pdf' ? 'üìÑ' : l.content_type === 'assignment' ? 'üìù' : 'üìñ'}</span>
                  <span class="title">${l.title}</span>
                  ${l.is_free_preview ? '<span class="preview-tag">Preview</span>' : ''}
                  ${l.estimated_minutes ? `<span class="dur">${l.estimated_minutes}m</span>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `).join('');

        // First module open by default
        const firstHeader = document.querySelector('.qa-module-header');
        if (firstHeader) firstHeader.classList.add('open');

        // Show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('courseContent').style.display = '';

        trackEvent('page_view', course.id, null, { page: 'course_sales', slug });

      } catch (err) {
        console.error(err);
        window.location.href = '/academy/';
      }
    })();

    async function handleFreeEnroll(courseId, slug) {
      try {
        await enrollFree(courseId);
        window.location.href = '/academy/learn.html?slug=' + slug;
      } catch (err) {
        alert('Failed to enroll: ' + err.message);
      }
    }

    async function handlePurchase(productId) {
      const btn = document.querySelector('#enrollBtn button');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        const user = await getUser();
        if (!user) {
          window.location.href = '/academy/login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
          return;
        }

        const res = await fetch('/.netlify/functions/academy-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId: productId,
            email: user.email,
            applyCredits: false
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Checkout failed');
        }

        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL returned');
        }
      } catch (err) {
        console.error('Purchase error:', err);
        alert('Something went wrong: ' + err.message);
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }
  </script>
</body>
</html>
