<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Dashboard ‚Äî Quantum Academy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/shared.css">
  <link rel="stylesheet" href="/academy/css/academy.css">
  <style>
    /* === SIDEBAR DASHBOARD LAYOUT === */
    .qa-dash-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: calc(100vh - 80px);
    }

    /* --- Sidebar --- */
    .qa-dash-sidebar {
      background: #071825;
      border-right: 1px solid var(--qa-border);
      padding: 0;
      position: sticky;
      top: 80px;
      height: calc(100vh - 80px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .qa-dash-sidebar .profile-area {
      padding: 28px 24px 20px;
      border-bottom: 1px solid var(--qa-border);
      text-align: center;
    }
    .qa-dash-sidebar .avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--teal), #4a97a1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      margin: 0 auto 12px;
      font-family: "Playfair Display", serif;
    }
    .qa-dash-sidebar .profile-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--qa-text);
      margin-bottom: 2px;
    }
    .qa-dash-sidebar .profile-email {
      font-size: 12px;
      color: var(--qa-text-muted);
      word-break: break-all;
    }

    .qa-dash-sidebar nav {
      padding: 16px 0;
      flex: 1;
    }
    .qa-dash-sidebar nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      font-size: 14px;
      color: var(--qa-text-muted);
      text-decoration: none;
      transition: all .15s;
      border-left: 3px solid transparent;
    }
    .qa-dash-sidebar nav a:hover {
      color: var(--qa-text);
      background: rgba(255,255,255,0.02);
    }
    .qa-dash-sidebar nav a.active {
      color: var(--teal);
      background: rgba(91,168,178,0.06);
      border-left-color: var(--teal);
    }
    .qa-dash-sidebar nav a .nav-icon {
      width: 20px;
      text-align: center;
      font-size: 15px;
      opacity: .7;
    }
    .qa-dash-sidebar nav a.active .nav-icon { opacity: 1; }

    .qa-dash-sidebar nav .divider {
      height: 1px;
      background: var(--qa-border);
      margin: 12px 24px;
    }

    .qa-dash-sidebar .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--qa-border);
    }
    .qa-dash-sidebar .sidebar-footer a {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--qa-text-muted);
      text-decoration: none;
      padding: 6px 0;
      transition: color .15s;
    }
    .qa-dash-sidebar .sidebar-footer a:hover { color: var(--qa-text); }

    /* --- Main content --- */
    .qa-dash-main {
      padding: 36px 40px 80px;
      overflow-y: auto;
    }

    /* Success banner */
    .qa-success-banner {
      background: linear-gradient(135deg, rgba(91,168,178,0.1), rgba(173,155,132,0.06));
      border: 1px solid rgba(91,168,178,0.25);
      border-radius: 10px;
      padding: 20px 24px;
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      gap: 14px;
      animation: fadeIn .4s ease;
    }
    .qa-success-banner .check {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(91,168,178,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--teal);
      font-size: 18px;
      flex-shrink: 0;
    }
    .qa-success-banner .text h4 { font-size: 15px; color: var(--teal); margin-bottom: 2px; }
    .qa-success-banner .text p { font-size: 13px; color: var(--qa-text-muted); margin: 0; }
    .qa-success-banner .dismiss {
      margin-left: auto;
      background: none; border: none;
      color: var(--qa-text-muted);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }

    /* Page header */
    .qa-page-header {
      margin-bottom: 28px;
    }
    .qa-page-header h1 {
      font-family: "Playfair Display", serif;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .qa-page-header p {
      font-size: 14px;
      color: var(--qa-text-muted);
    }

    /* Mini stats row */
    .qa-mini-stats {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
    }
    .qa-mini-stat {
      background: var(--qa-bg-card);
      border: 1px solid var(--qa-border);
      border-radius: 10px;
      padding: 18px 22px;
      flex: 1;
    }
    .qa-mini-stat .num {
      font-family: "Playfair Display", serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--teal);
      line-height: 1;
    }
    .qa-mini-stat .lbl {
      font-size: 11px;
      color: var(--qa-text-muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      margin-top: 4px;
    }

    /* Section label */
    .qa-section-label {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--qa-text-muted);
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--qa-border);
    }

    /* Course list items ‚Äî clean rows */
    .qa-course-row {
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 18px 20px;
      background: var(--qa-bg-card);
      border: 1px solid var(--qa-border);
      border-radius: 10px;
      margin-bottom: 10px;
      text-decoration: none;
      color: inherit;
      transition: all .2s;
    }
    .qa-course-row:hover {
      border-color: var(--qa-border-hover);
      background: var(--qa-bg-card-hover);
      transform: translateX(2px);
    }
    .qa-course-row .row-thumb {
      width: 80px;
      height: 52px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      background: var(--qa-bg-light);
    }
    .qa-course-row .row-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .qa-course-row .row-info {
      flex: 1;
      min-width: 0;
    }
    .qa-course-row .row-info h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .qa-course-row .row-info .row-meta {
      font-size: 12px;
      color: var(--qa-text-muted);
    }
    .qa-course-row .row-progress {
      width: 140px;
      flex-shrink: 0;
    }
    .qa-course-row .row-progress .qa-progress { margin-bottom: 4px; }
    .qa-course-row .row-progress .pct-text {
      font-size: 11px;
      color: var(--qa-text-muted);
      text-align: right;
    }
    .qa-course-row .row-status {
      width: 90px;
      text-align: right;
      flex-shrink: 0;
    }
    .qa-course-row .row-status .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .02em;
    }
    .qa-course-row .row-status .badge.new {
      background: rgba(173,155,132,0.15);
      color: var(--taupe);
    }
    .qa-course-row .row-status .badge.progress {
      background: rgba(91,168,178,0.12);
      color: var(--teal);
    }
    .qa-course-row .row-status .badge.done {
      background: rgba(91,168,178,0.2);
      color: var(--teal);
    }
    .qa-course-row .row-action {
      font-size: 18px;
      color: var(--qa-text-muted);
      flex-shrink: 0;
      transition: color .15s;
    }
    .qa-course-row:hover .row-action { color: var(--teal); }

    /* Referral card ‚Äî compact */
    .qa-ref-compact {
      background: var(--qa-bg-card);
      border: 1px solid var(--qa-border);
      border-radius: 10px;
      padding: 22px 24px;
      margin-top: 32px;
    }
    .qa-ref-compact h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .qa-ref-compact .desc {
      font-size: 12px;
      color: var(--qa-text-muted);
      margin-bottom: 14px;
    }
    .qa-ref-compact .code-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .qa-ref-compact .code-display {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border: 1px dashed var(--qa-border-hover);
      border-radius: 6px;
      padding: 10px 16px;
      font-family: monospace;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .12em;
      color: var(--teal);
    }
    .qa-ref-compact .copy-btn {
      background: var(--teal);
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: .04em;
      transition: opacity .15s;
      white-space: nowrap;
    }
    .qa-ref-compact .copy-btn:hover { opacity: .85; }
    .qa-ref-compact .ref-stats {
      display: flex;
      gap: 20px;
      margin-top: 14px;
      font-size: 12px;
      color: var(--qa-text-muted);
    }
    .qa-ref-compact .ref-stats strong { color: var(--teal); }

    /* Empty state */
    .qa-empty-clean {
      text-align: center;
      padding: 60px 20px;
    }
    .qa-empty-clean .icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: rgba(91,168,178,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin: 0 auto 20px;
    }
    .qa-empty-clean h3 {
      font-family: "Playfair Display", serif;
      font-size: 22px;
      margin-bottom: 8px;
    }
    .qa-empty-clean p {
      font-size: 14px;
      color: var(--qa-text-muted);
      margin-bottom: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Mobile hamburger for sidebar */
    .qa-dash-mobile-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 200;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--teal);
      color: #fff;
      border: none;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .qa-dash-layout { grid-template-columns: 1fr; }
      .qa-dash-sidebar {
        display: none;
        position: fixed;
        top: 0; left: 0; bottom: 0;
        width: 280px;
        z-index: 300;
      }
      .qa-dash-sidebar.open { display: flex; }
      .qa-dash-mobile-toggle { display: flex; align-items: center; justify-content: center; }
      .qa-dash-main { padding: 24px 20px 100px; }
      .qa-mini-stats { flex-wrap: wrap; }
      .qa-mini-stat { min-width: calc(50% - 6px); }
      .qa-course-row .row-progress { display: none; }
      .qa-course-row .row-status { width: auto; }
    }
    @media (max-width: 480px) {
      .qa-mini-stat { min-width: 100%; }
      .qa-course-row .row-thumb { width: 60px; height: 40px; }
    }

    /* Sidebar overlay on mobile */
    .qa-dash-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 299;
    }
    .qa-dash-overlay.open { display: block; }
  </style>
</head>
<body class="qa-page">
  <div id="shared-header"></div>

  <div class="qa-dash-layout">
    <!-- Sidebar -->
    <aside class="qa-dash-sidebar" id="sidebar">
      <div class="profile-area">
        <div class="avatar" id="avatar">?</div>
        <div class="profile-name" id="profileName">‚Äî</div>
        <div class="profile-email" id="profileEmail">‚Äî</div>
      </div>
      <nav>
        <a href="/academy/dashboard.html" class="active">
          <span class="nav-icon">üìä</span> Dashboard
        </a>
        <a href="/academy/">
          <span class="nav-icon">üìö</span> Browse Courses
        </a>
        <a href="#" onclick="scrollToRef(); return false;" id="navReferrals" style="display:none">
          <span class="nav-icon">üéÅ</span> Referrals
        </a>
        <div class="divider"></div>
        <a href="#" onclick="handleSignOut(); return false;">
          <span class="nav-icon">‚Üí</span> Sign Out
        </a>
      </nav>
    </aside>

    <!-- Overlay for mobile -->
    <div class="qa-dash-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Main -->
    <div class="qa-dash-main">

      <!-- Success banner -->
      <div id="successBanner" class="qa-success-banner" style="display:none">
        <div class="check">‚úì</div>
        <div class="text">
          <h4>Enrollment Confirmed</h4>
          <p>Your course access is ready. Start learning below.</p>
        </div>
        <button class="dismiss" onclick="this.parentElement.style.display='none'">&times;</button>
      </div>

      <!-- Page header -->
      <div class="qa-page-header">
        <h1 id="greeting">Dashboard</h1>
        <p id="subGreeting">Here's your learning overview</p>
      </div>

      <!-- Stats -->
      <div class="qa-mini-stats" id="statsRow">
        <div class="qa-mini-stat">
          <div class="num" id="statCourses">‚Äì</div>
          <div class="lbl">Courses</div>
        </div>
        <div class="qa-mini-stat">
          <div class="num" id="statLessons">‚Äì</div>
          <div class="lbl">Lessons Done</div>
        </div>
        <div class="qa-mini-stat">
          <div class="num" id="statHours">‚Äì</div>
          <div class="lbl">Hours</div>
        </div>
        <div class="qa-mini-stat">
          <div class="num" id="statCompleted">‚Äì</div>
          <div class="lbl">Completed</div>
        </div>
      </div>

      <!-- Courses list -->
      <div id="coursesSection">
        <div class="qa-section-label" id="coursesLabel">My Courses</div>
        <div id="coursesList">
          <div class="qa-loading"><div class="qa-spinner"></div></div>
        </div>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="qa-empty-clean" style="display:none">
        <div class="icon">üéì</div>
        <h3>Your Academy Awaits</h3>
        <p>Browse the catalog to find courses that resonate with your journey.</p>
        <a href="/academy/" class="qa-btn qa-btn-primary">Explore Courses</a>
      </div>

      <!-- Referral section -->
      <div id="referralSection" class="qa-ref-compact" style="display:none">
        <h4>Share & Earn</h4>
        <div class="desc">Friends get 10% off. You earn credits toward future courses.</div>
        <div class="code-row">
          <div class="code-display" id="refCode">‚Äî</div>
          <button class="copy-btn" onclick="copyRefCode()">Copy Code</button>
        </div>
        <div class="ref-stats">
          <span>Balance: <strong id="refBalance">$0</strong></span>
          <span>Earned: <strong id="refEarned">$0</strong></span>
          <span>Referrals: <strong id="refCount">0</strong></span>
        </div>
      </div>

    </div>
  </div>

  <!-- Mobile toggle -->
  <button class="qa-dash-mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/shared.js"></script>
  <script src="/academy/js/academy.js"></script>
  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('overlay').classList.toggle('open');
    }

    function scrollToRef() {
      document.getElementById('referralSection').scrollIntoView({ behavior: 'smooth' });
      // Close mobile sidebar if open
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('overlay').classList.remove('open');
    }

    function handleSignOut() { signOut(); }

    function copyRefCode() {
      const code = document.getElementById('refCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector('.qa-ref-compact .copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy Code'; }, 2000);
      });
    }

    (async () => {
      const user = await getUser();
      if (!user) {
        window.location.href = '/academy/login.html?redirect=/academy/dashboard.html';
        return;
      }

      // Purchase success
      const params = new URLSearchParams(window.location.search);
      if (params.get('purchase') === 'success') {
        document.getElementById('successBanner').style.display = 'flex';
        window.history.replaceState({}, '', '/academy/dashboard.html');
      }

      // Profile
      const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'there';
      const firstName = name.split(' ')[0];
      const initial = firstName.charAt(0).toUpperCase();

      document.getElementById('avatar').textContent = initial;
      document.getElementById('profileName').textContent = name;
      document.getElementById('profileEmail').textContent = user.email;
      document.getElementById('greeting').textContent = `Welcome back, ${firstName}`;

      // Time-based subgreeting
      const hour = new Date().getHours();
      const timeGreet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
      document.getElementById('subGreeting').textContent = `${timeGreet} ‚Äî here's your learning overview`;

      // Enrollments
      const enrollments = await getMyEnrollments();
      const list = document.getElementById('coursesList');
      const empty = document.getElementById('emptyState');
      const coursesSection = document.getElementById('coursesSection');

      if (!enrollments || enrollments.length === 0) {
        list.innerHTML = '';
        coursesSection.style.display = 'none';
        document.getElementById('statsRow').style.display = 'none';
        empty.style.display = 'block';
      } else {
        let totalLessonsDone = 0;
        let totalMinutes = 0;
        let completedCourses = 0;
        const enriched = [];

        for (const e of enrollments) {
          const course = e.qa_courses;
          if (!course) continue;

          let lessonsDone = 0;
          try {
            const { data: progress } = await sb.from('qa_lesson_progress')
              .select('id, status')
              .eq('enrollment_id', e.id)
              .eq('user_id', user.id);
            if (progress) {
              lessonsDone = progress.filter(p => p.status === 'completed').length;
            }
          } catch (err) { }

          const totalLessons = course.total_lessons || 1;
          const progressPct = Math.round((lessonsDone / totalLessons) * 100);
          const isComplete = progressPct >= 100;

          totalLessonsDone += lessonsDone;
          totalMinutes += (course.total_duration_minutes || 0) * (progressPct / 100);
          if (isComplete) completedCourses++;

          enriched.push({ ...e, course, lessonsDone, totalLessons, progressPct, isComplete });
        }

        // Stats
        document.getElementById('statCourses').textContent = enrollments.length;
        document.getElementById('statLessons').textContent = totalLessonsDone;
        document.getElementById('statHours').textContent = totalMinutes >= 60 ? Math.round(totalMinutes / 60) + 'h' : Math.round(totalMinutes) + 'm';
        document.getElementById('statCompleted').textContent = completedCourses;

        // Sort: in-progress first, then new, then completed
        enriched.sort((a, b) => {
          if (a.isComplete !== b.isComplete) return a.isComplete ? 1 : -1;
          if (a.lessonsDone !== b.lessonsDone) return b.lessonsDone - a.lessonsDone;
          return 0;
        });

        document.getElementById('coursesLabel').textContent = `My Courses (${enriched.length})`;

        list.innerHTML = enriched.map(item => {
          const c = item.course;
          let badgeClass = 'new';
          let badgeText = 'New';
          if (item.isComplete) { badgeClass = 'done'; badgeText = 'Done'; }
          else if (item.lessonsDone > 0) { badgeClass = 'progress'; badgeText = `${item.progressPct}%`; }

          return `
            <a class="qa-course-row" href="/academy/learn.html?slug=${c.slug}">
              <div class="row-thumb">
                ${c.thumbnail_url
                  ? `<img src="${c.thumbnail_url}" alt="${c.title}" loading="lazy">`
                  : ''}
              </div>
              <div class="row-info">
                <h4>${c.title}</h4>
                <div class="row-meta">${item.lessonsDone} of ${item.totalLessons} lessons${c.total_duration_minutes ? ' ¬∑ ' + formatDuration(c.total_duration_minutes) : ''}</div>
              </div>
              <div class="row-progress">
                <div class="qa-progress"><div class="qa-progress-fill" style="width:${item.progressPct}%"></div></div>
                <div class="pct-text">${item.progressPct}% complete</div>
              </div>
              <div class="row-status">
                <span class="badge ${badgeClass}">${badgeText}</span>
              </div>
              <div class="row-action">‚Ä∫</div>
            </a>
          `;
        }).join('');
      }

      // Referral
      try {
        const { data: refData } = await sb.from('referral_codes')
          .select('code, credit_balance, total_earned, successful_referrals')
          .eq('email', user.email.toLowerCase())
          .single();

        if (refData && refData.code) {
          document.getElementById('referralSection').style.display = '';
          document.getElementById('navReferrals').style.display = '';
          document.getElementById('refCode').textContent = refData.code;
          document.getElementById('refBalance').textContent = '$' + (refData.credit_balance || 0).toFixed(0);
          document.getElementById('refEarned').textContent = '$' + (refData.total_earned || 0).toFixed(0);
          document.getElementById('refCount').textContent = refData.successful_referrals || 0;
        }
      } catch (e) { }

      trackEvent('page_view', null, null, { page: 'dashboard' });
    })();
  </script>
</body>
</html>
