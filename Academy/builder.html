<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Course Builder â€” Quantum Academy</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <style>
/* ==============================================
   COURSE BUILDER â€” STANDALONE EDITOR
   Brand: navy #0a1e33, teal #5ba8b2, taupe #ad9b84
   ============================================== */

:root {
  --bg: #0a1e33;
  --bg-deep: #071825;
  --bg-card: #112a42;
  --bg-card-hover: #153450;
  --bg-input: #0d2236;
  --border: rgba(91,168,178,.15);
  --border-hover: rgba(91,168,178,.35);
  --border-focus: rgba(91,168,178,.6);
  --text: rgba(255,255,255,.88);
  --text-muted: rgba(255,255,255,.5);
  --text-dim: rgba(255,255,255,.3);
  --teal: #5ba8b2;
  --teal-light: #4acfd9;
  --teal-glow: rgba(91,168,178,.15);
  --taupe: #ad9b84;
  --purple: #a78bfa;
  --pink: #ff006e;
  --success: #3dd68c;
  --danger: #ef5350;
  --warning: #f0b429;
  --radius: 10px;
  --radius-sm: 6px;
  --ease: .3s cubic-bezier(.22,1,.36,1);
  --sidebar-w: 280px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
}

/* === AUTH SCREEN === */
.auth-screen {
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-deep);
}
.auth-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 48px 40px;
  width: 100%; max-width: 400px;
  text-align: center;
}
.auth-box .logo {
  font-family: 'Playfair Display', serif;
  font-size: 24px; font-weight: 600;
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  margin-bottom: 8px;
}
.auth-box .subtitle { font-size: 13px; color: var(--text-muted); margin-bottom: 32px; }
.auth-box input {
  width: 100%; padding: 12px 16px;
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius-sm); color: var(--text);
  font-size: 14px; outline: none; margin-bottom: 12px;
  transition: border-color var(--ease);
}
.auth-box input:focus { border-color: var(--border-focus); }
.auth-box .btn-login {
  width: 100%; padding: 12px;
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  border: none; border-radius: var(--radius-sm);
  color: #fff; font-weight: 600; font-size: 14px;
  cursor: pointer; transition: opacity var(--ease);
  margin-top: 4px;
}
.auth-box .btn-login:hover { opacity: .9; }
.auth-box .btn-login:disabled { opacity: .5; cursor: not-allowed; }
.auth-error {
  display: none; background: rgba(239,83,80,.1);
  border: 1px solid rgba(239,83,80,.3);
  border-radius: var(--radius-sm); padding: 10px 14px;
  font-size: 12px; color: var(--danger); margin-bottom: 12px;
}

/* === LAYOUT === */
.cb-layout { display: flex; min-height: 100vh; }

/* === SIDEBAR === */
.cb-sidebar {
  width: var(--sidebar-w); flex-shrink: 0;
  background: var(--bg-deep);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0;
  z-index: 50; overflow-y: auto;
}
.cb-sidebar-header {
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--border);
}
.cb-sidebar-header .brand {
  font-family: 'Playfair Display', serif;
  font-size: 18px; font-weight: 600;
  background: linear-gradient(135deg, var(--text), var(--teal));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.cb-sidebar-header .sub {
  font-size: 11px; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: .08em; margin-top: 2px;
}
.cb-sidebar-header .admin-info {
  margin-top: 12px; padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,.04);
  display: flex; align-items: center; gap: 10px;
}
.cb-sidebar-header .admin-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff;
  font-family: 'Playfair Display', serif;
}
.cb-sidebar-header .admin-name { font-size: 13px; font-weight: 500; }
.cb-sidebar-header .admin-role { font-size: 10px; color: var(--text-muted); }

/* Course list in sidebar */
.cb-course-list { flex: 1; padding: 12px 0; overflow-y: auto; }
.cb-course-list .section-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: .1em;
  color: var(--text-dim); padding: 8px 20px 6px; font-weight: 600;
}
.cb-course-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 20px; cursor: pointer;
  border-left: 3px solid transparent;
  transition: all .15s; font-size: 13px; color: var(--text-muted);
}
.cb-course-item:hover {
  background: rgba(255,255,255,.02); color: var(--text);
}
.cb-course-item.active {
  background: rgba(91,168,178,.06); color: var(--teal);
  border-left-color: var(--teal);
}
.cb-course-item .dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.cb-course-item .dot.published { background: var(--success); }
.cb-course-item .dot.draft { background: var(--warning); }
.cb-course-item .dot.coming_soon { background: var(--purple); }
.cb-course-item .title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cb-course-item .count { font-size: 10px; color: var(--text-dim); }

.cb-add-course {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 20px; cursor: pointer;
  font-size: 13px; color: var(--teal); font-weight: 500;
  border: none; background: none; width: 100%; text-align: left;
  transition: all .15s;
}
.cb-add-course:hover { background: rgba(91,168,178,.06); }
.cb-add-course svg { width: 16px; height: 16px; stroke: var(--teal); }

/* Sidebar footer */
.cb-sidebar-footer {
  padding: 12px 20px; border-top: 1px solid var(--border);
}
.cb-sidebar-footer a {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; color: var(--text-muted);
  text-decoration: none; padding: 6px 0; transition: color .15s;
}
.cb-sidebar-footer a:hover { color: var(--text); }
.cb-sidebar-footer a svg { width: 14px; height: 14px; stroke: currentColor; }

/* === MAIN === */
.cb-main {
  margin-left: var(--sidebar-w); flex: 1;
  padding: 0; min-height: 100vh;
}

/* Top bar */
.cb-topbar {
  display: flex; align-items: center; gap: 16px;
  padding: 16px 32px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-deep);
  position: sticky; top: 0; z-index: 40;
}
.cb-topbar .breadcrumb {
  font-size: 13px; color: var(--text-muted); flex: 1;
}
.cb-topbar .breadcrumb span { color: var(--text); font-weight: 500; }
.cb-topbar .actions { display: flex; gap: 8px; }

/* Buttons */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: var(--radius-sm);
  font-size: 13px; font-weight: 500; cursor: pointer;
  border: 1px solid var(--border); background: var(--bg-card);
  color: var(--text); transition: all .15s; white-space: nowrap;
}
.btn:hover { border-color: var(--border-hover); background: var(--bg-card-hover); }
.btn svg { width: 14px; height: 14px; stroke: currentColor; }
.btn-primary {
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  border-color: transparent; color: #fff;
}
.btn-primary:hover { opacity: .9; background: linear-gradient(135deg, var(--teal), var(--teal-light)); border-color: transparent; }
.btn-danger { border-color: rgba(239,83,80,.3); color: var(--danger); }
.btn-danger:hover { background: rgba(239,83,80,.08); border-color: rgba(239,83,80,.5); }
.btn-ghost { border: none; background: none; padding: 6px 10px; }
.btn-ghost:hover { background: rgba(255,255,255,.04); }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-sm svg { width: 12px; height: 12px; }

/* === EMPTY STATE === */
.cb-empty {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 60vh; text-align: center; padding: 40px;
}
.cb-empty .icon {
  width: 80px; height: 80px; border-radius: 50%;
  background: var(--teal-glow);
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 20px;
}
.cb-empty .icon svg { width: 36px; height: 36px; stroke: var(--teal); }
.cb-empty h2 {
  font-family: 'Playfair Display', serif;
  font-size: 22px; font-weight: 600; margin-bottom: 8px;
}
.cb-empty p { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; max-width: 400px; }

/* === COURSE EDITOR === */
.cb-editor { padding: 32px; max-width: 900px; }

.cb-editor-header {
  display: flex; align-items: flex-start; gap: 20px; margin-bottom: 32px;
}
.cb-editor-header .thumb {
  width: 140px; height: 90px; border-radius: var(--radius);
  background: var(--bg-card); border: 1px solid var(--border);
  overflow: hidden; flex-shrink: 0; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: border-color var(--ease); position: relative;
}
.cb-editor-header .thumb:hover { border-color: var(--border-hover); }
.cb-editor-header .thumb img { width: 100%; height: 100%; object-fit: cover; }
.cb-editor-header .thumb .placeholder {
  font-size: 10px; color: var(--text-dim); text-align: center;
  display: flex; flex-direction: column; align-items: center; gap: 4px;
}
.cb-editor-header .thumb .placeholder svg { width: 24px; height: 24px; stroke: var(--text-dim); }
.cb-editor-header .info { flex: 1; }

/* Field groups */
.field-group { margin-bottom: 20px; }
.field-group label {
  display: block; font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: .06em;
  color: var(--text-muted); margin-bottom: 6px;
}
.field-group input, .field-group textarea, .field-group select {
  width: 100%; padding: 10px 14px;
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius-sm); color: var(--text);
  font-size: 14px; font-family: inherit; outline: none;
  transition: border-color var(--ease);
}
.field-group input:focus, .field-group textarea:focus, .field-group select:focus {
  border-color: var(--border-focus);
}
.field-group textarea { resize: vertical; min-height: 80px; line-height: 1.5; }
.field-group select { cursor: pointer; }
.field-group .hint { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

.field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.field-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

/* Toggle */
.toggle-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,.03);
}
.toggle-row:last-child { border-bottom: none; }
.toggle-row .toggle-info { flex: 1; }
.toggle-row .toggle-label { font-size: 13px; font-weight: 500; }
.toggle-row .toggle-desc { font-size: 11px; color: var(--text-muted); }
.toggle {
  width: 40px; height: 22px; border-radius: 11px;
  background: rgba(255,255,255,.1); cursor: pointer;
  position: relative; transition: background .2s;
  border: none; flex-shrink: 0;
}
.toggle.on { background: var(--teal); }
.toggle::after {
  content: ''; position: absolute;
  top: 3px; left: 3px;
  width: 16px; height: 16px; border-radius: 50%;
  background: #fff; transition: transform .2s;
}
.toggle.on::after { transform: translateX(18px); }

/* Section dividers */
.cb-section {
  margin-top: 32px; padding-top: 24px;
  border-top: 1px solid var(--border);
}
.cb-section-head {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 16px;
}
.cb-section-head h3 {
  font-family: 'Playfair Display', serif;
  font-size: 18px; font-weight: 600; flex: 1;
}
.cb-section-head .badge {
  font-size: 10px; padding: 3px 8px; border-radius: 10px;
  background: var(--teal-glow); color: var(--teal); font-weight: 600;
}

/* === MODULES === */
.module-list { }
.module-item {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 12px;
  transition: border-color var(--ease);
  overflow: hidden;
}
.module-item:hover { border-color: var(--border-hover); }
.module-item.dragging { opacity: .5; border-color: var(--teal); }
.module-header {
  display: flex; align-items: center; gap: 10px;
  padding: 14px 16px; cursor: pointer;
}
.module-header .drag-handle {
  cursor: grab; color: var(--text-dim); display: flex;
  padding: 2px; transition: color .15s;
}
.module-header .drag-handle:hover { color: var(--text-muted); }
.module-header .drag-handle svg { width: 16px; height: 16px; stroke: currentColor; }
.module-header .module-title {
  flex: 1; font-size: 14px; font-weight: 600;
}
.module-header .module-meta {
  font-size: 11px; color: var(--text-dim);
}
.module-header .module-actions { display: flex; gap: 4px; }
.module-header .expand-icon {
  transition: transform .2s; color: var(--text-dim);
}
.module-item.open .module-header .expand-icon { transform: rotate(180deg); }

/* Lessons inside module */
.module-lessons {
  display: none; padding: 0 16px 12px;
  border-top: 1px solid rgba(255,255,255,.03);
}
.module-item.open .module-lessons { display: block; }

.lesson-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; margin-top: 4px;
  border-radius: var(--radius-sm);
  background: rgba(0,0,0,.15);
  transition: background .15s;
  cursor: pointer;
}
.lesson-item:hover { background: rgba(0,0,0,.25); }
.lesson-item.dragging { opacity: .5; }
.lesson-item .lesson-drag {
  cursor: grab; color: var(--text-dim); display: flex;
}
.lesson-item .lesson-drag svg { width: 14px; height: 14px; stroke: currentColor; }
.lesson-item .lesson-type {
  width: 28px; height: 28px; border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; flex-shrink: 0;
}
.lesson-type.video { background: rgba(91,168,178,.1); color: var(--teal); }
.lesson-type.text { background: rgba(173,155,132,.1); color: var(--taupe); }
.lesson-type.quiz { background: rgba(167,139,250,.1); color: var(--purple); }
.lesson-type.pdf { background: rgba(240,180,41,.1); color: var(--warning); }
.lesson-type.assignment { background: rgba(255,0,110,.08); color: var(--pink); }
.lesson-type.embed { background: rgba(91,168,178,.08); color: var(--teal-light); }
.lesson-type.live_session { background: rgba(239,83,80,.08); color: var(--danger); }
.lesson-type.audio { background: rgba(61,214,140,.08); color: var(--success); }
.lesson-item .lesson-type svg { width: 16px; height: 16px; stroke: currentColor; }

.lesson-item .lesson-info { flex: 1; min-width: 0; }
.lesson-item .lesson-title { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.lesson-item .lesson-meta { font-size: 11px; color: var(--text-dim); display: flex; gap: 8px; }
.lesson-item .lesson-actions { display: flex; gap: 2px; }

.add-lesson-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 12px; margin-top: 8px;
  border: 1px dashed rgba(91,168,178,.3);
  border-radius: var(--radius-sm);
  background: transparent; color: var(--teal);
  font-size: 12px; cursor: pointer; width: 100%;
  transition: all .15s;
}
.add-lesson-btn:hover { background: rgba(91,168,178,.04); border-color: rgba(91,168,178,.5); }
.add-lesson-btn svg { width: 14px; height: 14px; stroke: currentColor; }

.add-module-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 14px; margin-top: 12px;
  border: 1px dashed var(--border);
  border-radius: var(--radius);
  background: transparent; color: var(--text-muted);
  font-size: 13px; cursor: pointer; width: 100%;
  transition: all .15s;
}
.add-module-btn:hover { border-color: var(--border-hover); color: var(--teal); background: rgba(91,168,178,.02); }
.add-module-btn svg { width: 16px; height: 16px; stroke: currentColor; }

/* === MODAL === */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,.6); z-index: 100;
  display: flex; align-items: center; justify-content: center;
  padding: 20px; opacity: 0; transition: opacity .2s;
}
.modal-overlay.open { opacity: 1; }
.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  width: 100%; max-width: 560px;
  max-height: 90vh; overflow-y: auto;
  transform: translateY(10px); transition: transform .2s;
}
.modal-overlay.open .modal { transform: translateY(0); }
.modal-head {
  display: flex; align-items: center; gap: 12px;
  padding: 20px 24px; border-bottom: 1px solid var(--border);
}
.modal-head h3 {
  font-family: 'Playfair Display', serif;
  font-size: 18px; font-weight: 600; flex: 1;
}
.modal-close {
  width: 32px; height: 32px; border-radius: 8px;
  background: rgba(255,255,255,.04); border: none;
  color: var(--text-muted); cursor: pointer; display: flex;
  align-items: center; justify-content: center; transition: all .15s;
}
.modal-close:hover { background: rgba(255,255,255,.08); color: var(--text); }
.modal-close svg { width: 18px; height: 18px; stroke: currentColor; }
.modal-body { padding: 24px; }
.modal-footer {
  padding: 16px 24px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; justify-content: flex-end;
}

/* Toast */
/* === RICH TEXT TOOLBAR === */
.rich-toolbar {
  display: flex; align-items: center; gap: 2px; padding: 6px 8px;
  background: var(--bg-deep); border: 1px solid var(--border); border-bottom: none;
  border-radius: var(--radius-sm) var(--radius-sm) 0 0;
}
.rich-toolbar button {
  background: none; border: none; color: var(--text-muted); cursor: pointer;
  padding: 4px 8px; border-radius: 4px; font-size: 12px; font-family: inherit;
  transition: all .15s;
}
.rich-toolbar button:hover { background: rgba(91,168,178,.15); color: var(--teal); }
.rich-toolbar .divider { width: 1px; height: 16px; background: var(--border); margin: 0 4px; }
.rich-toolbar + textarea { border-top-left-radius: 0 !important; border-top-right-radius: 0 !important; }

.toast {
  position: fixed; bottom: 24px; right: 24px; z-index: 200;
  padding: 12px 20px; border-radius: var(--radius);
  font-size: 13px; font-weight: 500;
  background: var(--bg-card); border: 1px solid var(--border);
  color: var(--text); box-shadow: 0 8px 32px rgba(0,0,0,.3);
  transform: translateY(20px); opacity: 0;
  transition: all .3s ease;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-color: rgba(61,214,140,.4); color: var(--success); }
.toast.error { border-color: rgba(239,83,80,.4); color: var(--danger); }

/* Status badge */
.status-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 8px; border-radius: 10px;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: .04em;
}
.status-badge.published { background: rgba(61,214,140,.1); color: var(--success); }
.status-badge.draft { background: rgba(240,180,41,.1); color: var(--warning); }
.status-badge.coming_soon { background: rgba(167,139,250,.1); color: var(--purple); }

/* Preview badge */
.preview-badge {
  display: inline-block; padding: 1px 6px; border-radius: 4px;
  font-size: 9px; font-weight: 600; text-transform: uppercase;
  background: rgba(91,168,178,.15); color: var(--teal);
}

/* Unsaved indicator */
.unsaved-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--warning); display: inline-block;
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; } 50% { opacity: .4; }
}

/* Loading spinner */
.spinner {
  width: 24px; height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--teal);
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Responsive */
@media (max-width: 768px) {
  .cb-sidebar { display: none; }
  .cb-main { margin-left: 0; }
  .cb-editor { padding: 20px; }
  .field-row, .field-row-3 { grid-template-columns: 1fr; }
  .cb-editor-header { flex-direction: column; }
  .cb-editor-header .thumb { width: 100%; height: 120px; }
}
  </style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen" class="auth-screen">
  <div class="auth-box">
    <div class="logo">Quantum Academy</div>
    <div class="subtitle">Course Builder â€” Admin Access Required</div>
    <div id="auth-error" class="auth-error"></div>
    <input type="email" id="auth-email" placeholder="Admin email" autocomplete="email">
    <input type="password" id="auth-pass" placeholder="Password" autocomplete="current-password">
    <button class="btn-login" id="auth-btn" onclick="doAuth()">Sign In</button>
  </div>
</div>

<!-- Main Layout (hidden until auth) -->
<div id="app-layout" class="cb-layout" style="display:none">

  <!-- Sidebar -->
  <aside class="cb-sidebar">
    <div class="cb-sidebar-header">
      <div class="brand">Course Builder</div>
      <div class="sub">Quantum Academy</div>
      <div class="admin-info">
        <div class="admin-avatar" id="adminAvatar">?</div>
        <div>
          <div class="admin-name" id="adminName">â€”</div>
          <div class="admin-role" id="adminRole">â€”</div>
        </div>
      </div>
    </div>

    <div class="cb-course-list" id="courseList">
      <div class="section-label">Courses</div>
      <div id="courseListItems" style="padding:20px;text-align:center">
        <div class="spinner" style="margin:0 auto"></div>
      </div>
    </div>

    <button class="cb-add-course" onclick="createNewCourse()">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Course
    </button>

    <!-- Bundles Section -->
    <div class="cb-course-list" style="border-top:1px solid var(--border)">
      <div class="section-label" style="display:flex;align-items:center;justify-content:space-between">
        <span>Bundles</span>
        <button style="background:none;border:none;color:var(--teal);cursor:pointer;font-size:16px;padding:2px 6px" onclick="createNewBundle()" title="New Bundle">+</button>
      </div>
      <div id="bundleListItems"></div>
    </div>

    <div class="cb-sidebar-footer">
      <a href="/admin/" target="_blank">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Admin Panel
      </a>
      <a href="/academy/" target="_blank">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        View Academy
      </a>
      <a href="#" onclick="signOutBuilder();return false">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="cb-main">
    <div class="cb-topbar">
      <div class="breadcrumb" id="breadcrumb">
        Courses
      </div>
      <div class="actions" id="topActions"></div>
    </div>

    <div id="mainContent">
      <!-- Dynamic content renders here -->
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast" class="toast"></div>

<!-- ============ JAVASCRIPT ============ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =============================================
   COURSE BUILDER â€” Quantum Academy
   Uses same Supabase + admin-proxy pattern as QP Admin
   ============================================= */

// --- Config ---
const SUPABASE_URL = 'https://bqbcehfozsaaqrbjvkml.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYmNlaGZvenNhYXFyYmp2a21sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjczMTcxNDEsImV4cCI6MjA0Mjg5MzE0MX0.2Iv2kPMLpECGqHPiyDGkPrdsMhFKQMFnpJm2x9a3vMA';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- State ---
let currentAdmin = null;
let allCourses = [];
let selectedCourseId = null;
let courseModules = [];
let hasUnsavedChanges = false;
let allBundles = [];
let allBundleCourses = [];

// --- Proxy (same pattern as admin panel) ---
function getAdminToken() { return sessionStorage.getItem('qp_admin_token') || localStorage.getItem('qp_admin_token') || ''; }

async function adminProxy(payload) {
  const res = await fetch('/.netlify/functions/admin-proxy', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + getAdminToken()
    },
    body: JSON.stringify(payload)
  });
  const json = await res.json();
  if (!res.ok) throw new Error(json.error || 'Proxy request failed');
  return json;
}

function proxyFrom(table) {
  return {
    _table: table, _select: '*', _filters: [], _order: null, _limit: null, _single: false,
    select(s, opts) { this._select = s; if (opts && opts.count) this._count = opts.count; return this; },
    eq(c, v) { this._filters.push({column:c, op:'eq', value:v}); return this; },
    neq(c, v) { this._filters.push({column:c, op:'neq', value:v}); return this; },
    gt(c, v) { this._filters.push({column:c, op:'gt', value:v}); return this; },
    gte(c, v) { this._filters.push({column:c, op:'gte', value:v}); return this; },
    in(c, v) { this._filters.push({column:c, op:'in', value:v}); return this; },
    order(c, opts) { this._order = {column:c, ascending: opts ? opts.ascending !== false : true}; return this; },
    limit(n) { this._limit = n; return this; },
    single() { this._single = true; return this; },
    maybeSingle() { this._filters.push({op:'maybeSingle'}); return this; },
    then(resolve, reject) {
      return adminProxy({type:'query', table:this._table, select:this._select, filters:this._filters, order:this._order, limit:this._limit, single:this._single})
        .then(r => ({data: r.data, count: r.count !== undefined ? r.count : null, error: null}))
        .then(resolve, e => resolve ? resolve({data:null, error:{message:e.message}}) : reject ? reject(e) : null);
    },
    insert(rows) {
      const t = this._table; let sel = this._select;
      return {
        select(s) { sel = s; return this; },
        then(resolve, reject) {
          return adminProxy({type:'insert', table:t, data:rows, select: sel !== '*' ? sel : undefined})
            .then(r => ({data:r.data, error:null}))
            .then(resolve, e => resolve ? resolve({data:null, error:{message:e.message}}) : reject ? reject(e) : null);
        }
      };
    },
    update(d) {
      const t = this._table; const f = this._filters;
      return {
        eq(c, v) { f.push({column:c, op:'eq', value:v}); return this; },
        then(resolve, reject) {
          return adminProxy({type:'update', table:t, data:d, filters:f})
            .then(r => ({data:r.data, error:null}))
            .then(resolve, e => resolve ? resolve({data:null, error:{message:e.message}}) : reject ? reject(e) : null);
        }
      };
    },
    delete() {
      const t = this._table; const f = this._filters;
      return {
        eq(c, v) { f.push({column:c, op:'eq', value:v}); return this; },
        then(resolve, reject) {
          return adminProxy({type:'delete', table:t, filters:f})
            .then(r => ({data:r.data, error:null}))
            .then(resolve, e => resolve ? resolve({data:null, error:{message:e.message}}) : reject ? reject(e) : null);
        }
      };
    }
  };
}

// --- Auth ---
async function doAuth() {
  const emailEl = document.getElementById('auth-email');
  const passEl = document.getElementById('auth-pass');
  const errEl = document.getElementById('auth-error');
  const btn = document.getElementById('auth-btn');
  const email = emailEl.value.trim();
  const pass = passEl.value;
  if (!email || !pass) { errEl.textContent = 'Enter email and password'; errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';
  btn.disabled = true; btn.textContent = 'Signing in...';
  try {
    // Try admin-auth function first
    const res = await fetch('/.netlify/functions/admin-auth', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({action:'login', email:email.toLowerCase(), password:pass})
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Login failed');
    currentAdmin = data.admin;
    sessionStorage.setItem('qp_admin_auth', JSON.stringify(currentAdmin));
    if (data.token) sessionStorage.setItem('qp_admin_token', data.token); localStorage.setItem('qp_admin_token', data.token);
    showApp();
  } catch(e) {
    // Fallback: direct Supabase auth
    if (e.message && e.message.indexOf('Failed to fetch') !== -1) {
      try {
        const authRes = await sb.auth.signInWithPassword({email: email.toLowerCase(), password: pass});
        if (authRes.error) throw new Error(authRes.error.message);
        const admRes = await proxyFrom('admin_users').select('*').eq('email', email.toLowerCase()).eq('is_active', true).single();
        if (admRes.error || !admRes.data) throw new Error('No admin access.');
        currentAdmin = {
          id: admRes.data.id, email: admRes.data.email, name: admRes.data.name, role: admRes.data.role,
          permissions: { customers: admRes.data.can_customers, email: admRes.data.can_email }
        };
        sessionStorage.setItem('qp_admin_auth', JSON.stringify(currentAdmin));
        if (authRes.data && authRes.data.session) sessionStorage.setItem('qp_admin_token', authRes.data.session.access_token); localStorage.setItem('qp_admin_token', authRes.data.session.access_token);
        showApp();
      } catch(e2) {
        errEl.textContent = e2.message; errEl.style.display = 'block';
      }
    } else {
      errEl.textContent = e.message; errEl.style.display = 'block';
    }
  }
  btn.disabled = false; btn.textContent = 'Sign In';
}

// Enter key on password field
document.getElementById('auth-pass').addEventListener('keydown', e => { if (e.key === 'Enter') doAuth(); });

// Check for existing session
(async function checkSession() {
  const saved = sessionStorage.getItem('qp_admin_auth');
  const token = sessionStorage.getItem('qp_admin_token');
  if (saved && token) {
    try {
      currentAdmin = JSON.parse(saved);
      showApp();
    } catch(e) {
      sessionStorage.clear();
    }
  }
})();

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app-layout').style.display = 'flex';
  document.getElementById('adminAvatar').textContent = (currentAdmin.name || currentAdmin.email)[0].toUpperCase();
  document.getElementById('adminName').textContent = currentAdmin.name || currentAdmin.email.split('@')[0];
  document.getElementById('adminRole').textContent = currentAdmin.role.replace('_', ' ');
  loadCourses();
}

function signOutBuilder() {
  sessionStorage.clear();
  localStorage.removeItem('qp_admin_token');
  window.location.reload();
}

// --- SVG Icons ---
const ICONS = {
  grip: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><circle cx="9" cy="6" r="1" fill="currentColor" stroke="none"/><circle cx="15" cy="6" r="1" fill="currentColor" stroke="none"/><circle cx="9" cy="12" r="1" fill="currentColor" stroke="none"/><circle cx="15" cy="12" r="1" fill="currentColor" stroke="none"/><circle cx="9" cy="18" r="1" fill="currentColor" stroke="none"/><circle cx="15" cy="18" r="1" fill="currentColor" stroke="none"/></svg>',
  chevDown: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>',
  plus: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  edit: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  trash: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
  save: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
  eye: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
  image: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
  book: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
  x: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  layers: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>',
  video: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
  text: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
  quiz: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  pdf: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  assignment: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg>',
  embed: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
  live: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>',
  audio: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',
  template: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>',
};

function typeIcon(t) {
  const icons = {
    video: ICONS.video, text: ICONS.text, quiz: ICONS.quiz, pdf: ICONS.pdf,
    assignment: ICONS.assignment, embed: ICONS.embed, live_session: ICONS.live,
    live: ICONS.live, audio: ICONS.audio, download: ICONS.pdf, discussion: ICONS.book
  };
  return icons[t] || ICONS.text;
}

// --- Toast ---
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type || '') + ' show';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.className = 'toast', 3000);
}

// --- Escape HTML ---
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// --- Slug generator ---
function slugify(text) {
  return text.toLowerCase().trim()
    .replace(/[^\w\s-]/g, '').replace(/[\s_]+/g, '-').replace(/^-+|-+$/g, '');
}

// --- Load Courses ---
async function loadCourses() {
  try {
    const [courseRes, bundleRes, bcRes] = await Promise.all([
      proxyFrom('qa_courses').select('*').order('sort_order'),
      proxyFrom('qa_bundles').select('*').order('created_at'),
      proxyFrom('qa_bundle_courses').select('*').order('sort_order'),
    ]);
    allCourses = courseRes.data || [];
    allBundles = bundleRes.data || [];
    allBundleCourses = bcRes.data || [];
    renderCourseList();
    renderBundleList();
    if (!selectedCourseId && allCourses.length) {
      selectCourse(allCourses[0].id);
    } else if (selectedCourseId) {
      selectCourse(selectedCourseId);
    } else {
      showEmptyState();
    }
  } catch(e) {
    showToast('Failed to load courses: ' + e.message, 'error');
  }
}

function renderCourseList() {
  const el = document.getElementById('courseListItems');
  if (!allCourses.length) {
    el.innerHTML = '<div style="padding:20px;text-align:center;font-size:12px;color:var(--text-dim)">No courses yet</div>';
    return;
  }
  el.innerHTML = allCourses.map(c => `
    <div class="cb-course-item ${c.id === selectedCourseId ? 'active' : ''}" onclick="selectCourse('${c.id}')">
      <span class="dot ${c.status || 'draft'}"></span>
      <span class="title">${esc(c.title)}</span>
      <span class="count">${c.total_lessons || 0}</span>
    </div>
  `).join('');
}

function showEmptyState() {
  document.getElementById('breadcrumb').innerHTML = 'Courses';
  document.getElementById('topActions').innerHTML = '';
  document.getElementById('mainContent').innerHTML = `
    <div class="cb-empty">
      <div class="icon">${ICONS.book}</div>
      <h2>Build Your First Course</h2>
      <p>Create courses with modules and lessons. Your students will see them on the Academy site.</p>
      <button class="btn btn-primary" onclick="createNewCourse()">${ICONS.plus} Create Course</button>
    </div>
  `;
}

// --- Select Course ---
async function selectCourse(id, force) {
  if (!force && hasUnsavedChanges) {
    if (!await qpConfirm('Unsaved Changes', 'You have unsaved changes. Discard them?', {okText: 'Discard', danger: true})) return;
  }
  selectedCourseId = id;
  selectedBundleId = null;
  hasUnsavedChanges = false;
  renderCourseList();

  const course = allCourses.find(c => c.id === id);
  if (!course) { showEmptyState(); return; }

  // Load modules + lessons
  try {
    const [modRes, lessonRes] = await Promise.all([
      proxyFrom('qa_modules').select('*').eq('course_id', id).order('sort_order'),
      proxyFrom('qa_lessons').select('*').eq('course_id', id).order('sort_order'),
    ]);
    console.log('Modules loaded:', modRes.data?.length || 0, 'Lessons loaded:', lessonRes.data?.length || 0);
    const lessons = lessonRes.data || [];
    courseModules = (modRes.data || []).map(m => ({
      ...m,
      qa_lessons: lessons.filter(l => l.module_id === m.id).sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0))
    }));
  } catch(e) {
    courseModules = [];
    console.error('Module load error:', e);
  }

  renderCourseEditor(course);
}

// --- Render Course Editor ---
function renderCourseEditor(course) {
  document.getElementById('breadcrumb').innerHTML = `
    <span style="cursor:pointer;color:var(--text-muted)" onclick="showEmptyState()">Courses</span>
    <span style="margin:0 8px;color:var(--text-dim)">â€º</span>
    <span>${esc(course.title)}</span>
  `;

  document.getElementById('topActions').innerHTML = `
    <span id="unsavedIndicator" style="display:none;align-items:center;gap:6px;font-size:12px;color:var(--warning)"><span class="unsaved-dot"></span> Unsaved</span>
    <a href="/academy/preview.html?slug=${course.slug}" target="_blank" class="btn btn-ghost btn-sm">${ICONS.eye} Preview</a>
    <button class="btn btn-ghost btn-sm" onclick="cloneCourse('${course.id}')" title="Duplicate this course">${ICONS.layers} Clone</button>
    <button class="btn btn-danger btn-sm" onclick="deleteCourse('${course.id}')">${ICONS.trash} Delete</button>
    <button class="btn btn-primary btn-sm" id="saveBtn" onclick="saveCourse()">${ICONS.save} Save Changes</button>
  `;

  const totalLessons = courseModules.reduce((sum, m) => sum + (m.qa_lessons || []).length, 0);

  document.getElementById('mainContent').innerHTML = `
    <div class="cb-editor">
      <!-- Header with thumbnail -->
      <div class="cb-editor-header">
        <div class="thumb" onclick="editThumbnail()">
          ${course.thumbnail_url
            ? `<img src="${esc(course.thumbnail_url)}" alt="">`
            : `<div class="placeholder">${ICONS.image}<span>Add thumbnail</span></div>`
          }
        </div>
        <div class="info">
          <div class="field-group" style="margin-bottom:10px">
            <input type="text" id="ed-title" value="${esc(course.title || '')}" placeholder="Course title" style="font-size:20px;font-family:'Playfair Display',serif;font-weight:600;background:transparent;border:1px solid transparent;padding:8px 12px" onfocus="this.style.borderColor='var(--border-focus)'" onblur="this.style.borderColor='transparent'" oninput="markUnsaved()">
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="status-badge ${course.status || 'draft'}">${course.status || 'draft'}</span>
            <span style="font-size:12px;color:var(--text-dim)">${courseModules.length} modules Â· ${totalLessons} lessons</span>
          </div>
        </div>
      </div>

      <!-- Details -->
      <div class="field-group">
        <label>Subtitle</label>
        <input type="text" id="ed-subtitle" value="${esc(course.subtitle || '')}" placeholder="A brief tagline for your course" oninput="markUnsaved()">
      </div>

      <div class="field-group">
        <label>Description</label>
        <textarea id="ed-desc" rows="4" placeholder="What students will learnâ€¦" oninput="markUnsaved()">${esc(course.description || '')}</textarea>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label>Slug</label>
          <input type="text" id="ed-slug" value="${esc(course.slug || '')}" placeholder="course-url-slug" oninput="markUnsaved()">
          <div class="hint">/academy/course.html?slug=<span id="slugPreview">${esc(course.slug || '')}</span></div>
        </div>
        <div class="field-group">
          <label>Category</label>
          <input type="text" id="ed-category" value="${esc(course.category || '')}" placeholder="e.g. Self-H.O.P.E. Workshop Series" oninput="markUnsaved()">
        </div>
      </div>

      <div class="field-row-3">
        <div class="field-group">
          <label>Price (cents)</label>
          <input type="number" id="ed-price" value="${course.price_cents || 0}" min="0" oninput="markUnsaved()">
          <div class="hint">$${((course.price_cents || 0) / 100).toFixed(2)}</div>
        </div>
        <div class="field-group">
          <label>Sale Price (cents)</label>
          <input type="number" id="ed-sale-price" value="${course.sale_price_cents || ''}" placeholder="Optional" oninput="markUnsaved()">
        </div>
        <div class="field-group">
          <label>Status</label>
          <select id="ed-status" onchange="markUnsaved()">
            <option value="draft" ${course.status === 'draft' ? 'selected' : ''}>Draft</option>
            <option value="published" ${course.status === 'published' ? 'selected' : ''}>Published</option>
            <option value="coming_soon" ${course.status === 'coming_soon' ? 'selected' : ''}>Coming Soon</option>
          </select>
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label>Thumbnail URL</label>
          <input type="text" id="ed-thumb" value="${esc(course.thumbnail_url || '')}" placeholder="https://..." oninput="markUnsaved()">
        </div>
        <div class="field-group">
          <label>Promo Video URL</label>
          <input type="text" id="ed-video" value="${esc(course.promo_video_url || '')}" placeholder="https://..." oninput="markUnsaved()">
        </div>
      </div>

      <div class="field-row">
        <div class="field-group">
          <label>Instructor Name</label>
          <input type="text" id="ed-instructor" value="${esc(course.instructor_name || '')}" placeholder="Dr. Tracey Clark" oninput="markUnsaved()">
        </div>
        <div class="field-group">
          <label>Sort Order</label>
          <input type="number" id="ed-sort" value="${course.sort_order || 0}" min="0" oninput="markUnsaved()">
        </div>
      </div>

      <!-- Sale & Enrollment -->
      <div class="cb-section">
        <div class="cb-section-head"><h3>Pricing & Access</h3></div>
        <div class="field-row-3">
          <div class="field-group">
            <label>Sale End Date</label>
            <input type="datetime-local" id="ed-sale-ends" value="${course.sale_ends_at ? new Date(course.sale_ends_at).toISOString().slice(0,16) : ''}" oninput="markUnsaved()">
            <div class="hint">${course.sale_ends_at ? (new Date(course.sale_ends_at) > new Date() ? 'ðŸŸ¢ Sale active' : 'ðŸ”´ Sale ended') : 'No sale set'}</div>
          </div>
          <div class="field-group">
            <label>Enrollment Type</label>
            <select id="ed-enrollment" onchange="markUnsaved()">
              <option value="paid" ${course.enrollment_type === 'paid' ? 'selected' : ''}>Paid</option>
              <option value="free" ${course.enrollment_type === 'free' ? 'selected' : ''}>Free</option>
              <option value="invite" ${course.enrollment_type === 'invite' ? 'selected' : ''}>Invite Only</option>
            </select>
          </div>
          <div class="field-group">
            <label>Visibility</label>
            <select id="ed-visibility" onchange="markUnsaved()">
              <option value="public" ${course.visibility === 'public' || !course.visibility ? 'selected' : ''}>Public</option>
              <option value="hidden" ${course.visibility === 'hidden' ? 'selected' : ''}>Hidden (URL only)</option>
              <option value="private" ${course.visibility === 'private' ? 'selected' : ''}>Private</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Drip & Prerequisites -->
      <div class="cb-section">
        <div class="cb-section-head"><h3>Drip Schedule</h3></div>
        <div class="toggle-row">
          <div class="toggle-info">
            <div class="toggle-label">Enable Drip Content</div>
            <div class="toggle-desc">Release modules on a schedule after enrollment</div>
          </div>
          <button class="toggle ${course.drip_enabled ? 'on' : ''}" id="tog-drip" onclick="this.classList.toggle('on');markUnsaved();document.getElementById('drip-settings').style.display=this.classList.contains('on')?'':'none'"></button>
        </div>
        <div id="drip-settings" style="display:${course.drip_enabled ? '' : 'none'};margin-top:12px">
          <div class="field-group">
            <label>Default Drip Interval (days between modules)</label>
            <input type="number" id="ed-drip-days" value="${course.drip_interval_days || 7}" min="1" oninput="markUnsaved()">
            <div class="hint">Each module unlocks this many days after the previous one</div>
          </div>
        </div>
      </div>

      <!-- Settings & Toggles -->
      <div class="cb-section">
        <div class="cb-section-head"><h3>Settings</h3></div>
        <div class="field-row-3">
          <div class="field-group">
            <label>Difficulty</label>
            <select id="ed-difficulty" onchange="markUnsaved()">
              <option value="" ${!course.difficulty ? 'selected' : ''}>Not set</option>
              <option value="beginner" ${course.difficulty === 'beginner' ? 'selected' : ''}>Beginner</option>
              <option value="intermediate" ${course.difficulty === 'intermediate' ? 'selected' : ''}>Intermediate</option>
              <option value="advanced" ${course.difficulty === 'advanced' ? 'selected' : ''}>Advanced</option>
            </select>
          </div>
          <div class="field-group">
            <label>Tags (comma-separated)</label>
            <input type="text" id="ed-tags" value="${esc((course.tags || []).join(', '))}" placeholder="healing, meditation, wellness" oninput="markUnsaved()">
          </div>
          <div class="field-group" style="display:flex;flex-direction:column;justify-content:flex-end">
            <button class="btn btn-ghost btn-sm" onclick="toggleSEO()" style="width:100%">SEO Settings â–¾</button>
          </div>
        </div>
        <div id="seo-fields" style="display:none;margin-top:12px">
          <div class="field-group">
            <label>Meta Title</label>
            <input type="text" id="ed-meta-title" value="${esc(course.meta_title || '')}" placeholder="Custom page title for search engines" oninput="markUnsaved()">
          </div>
          <div class="field-group">
            <label>Meta Description</label>
            <textarea id="ed-meta-desc" rows="2" placeholder="Custom description for search engines" oninput="markUnsaved()">${esc(course.meta_description || '')}</textarea>
          </div>
          <div class="field-group">
            <label>OG Image URL</label>
            <input type="text" id="ed-og-image" value="${esc(course.og_image_url || '')}" placeholder="Social share image URL" oninput="markUnsaved()">
          </div>
        </div>
        <div class="toggle-row" style="margin-top:12px">
          <div class="toggle-info">
            <div class="toggle-label">Discussion</div>
            <div class="toggle-desc">Enable community discussions for this course</div>
          </div>
          <button class="toggle ${course.discussion_enabled ? 'on' : ''}" id="tog-discussion" onclick="this.classList.toggle('on');markUnsaved()"></button>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <div class="toggle-label">Certificate</div>
            <div class="toggle-desc">Award certificate on course completion</div>
          </div>
          <button class="toggle ${course.certificate_enabled ? 'on' : ''}" id="tog-certificate" onclick="this.classList.toggle('on');markUnsaved()"></button>
        </div>
      </div>

      ${getLandingPageEditor(course)}

      <!-- CURRICULUM -->
      <div class="cb-section">
        <div class="cb-section-head">
          <h3>Curriculum</h3>
          <span class="badge">${courseModules.length} modules Â· ${totalLessons} lessons</span>
        </div>

        <div class="module-list" id="moduleList">
          ${courseModules.map((m, mi) => renderModule(m, mi)).join('')}
        </div>

        <button class="add-module-btn" onclick="addModule()">
          ${ICONS.plus} Add Module
        </button>
      </div>
    </div>
  `;

  // Update slug preview on title change
  const titleEl = document.getElementById('ed-title');
  const slugEl = document.getElementById('ed-slug');
  titleEl.addEventListener('input', () => {
    if (!slugEl._userEdited) {
      const newSlug = slugify(titleEl.value);
      slugEl.value = newSlug;
      document.getElementById('slugPreview').textContent = newSlug;
    }
  });
  slugEl.addEventListener('input', () => {
    slugEl._userEdited = true;
    document.getElementById('slugPreview').textContent = slugEl.value;
  });

  // Update price display
  document.getElementById('ed-price').addEventListener('input', function() {
    const hint = this.parentElement.querySelector('.hint');
    if (hint) hint.textContent = '$' + (Number(this.value || 0) / 100).toFixed(2);
  });
}

function renderModule(mod, idx) {
  const lessons = mod.qa_lessons || [];
  return `
    <div class="module-item" data-id="${mod.id}" data-idx="${idx}">
      <div class="module-header" onclick="toggleModule(this)">
        <div class="drag-handle" draggable="true" ondragstart="dragModuleStart(event, '${mod.id}')" ondragover="event.preventDefault()" ondrop="dropModule(event, '${mod.id}')">${ICONS.grip}</div>
        <span class="module-title">Module ${idx + 1}: ${esc(mod.title)}</span>
        <span class="module-meta">${lessons.length} lesson${lessons.length !== 1 ? 's' : ''}${mod.require_previous ? ' Â· ðŸ”’' : ''}${mod.drip_delay_days ? ' Â· â±' + mod.drip_delay_days + 'd' : ''}</span>
        <div class="module-actions">
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();editModule('${mod.id}')" title="Edit">${ICONS.edit}</button>
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();deleteModule('${mod.id}')" title="Delete" style="color:var(--danger)">${ICONS.trash}</button>
        </div>
        <span class="expand-icon">${ICONS.chevDown}</span>
      </div>
      <div class="module-lessons">
        ${lessons.map((l, li) => renderLesson(l, li, mod.id)).join('')}
        <button class="add-lesson-btn" onclick="addLesson('${mod.id}')">
          ${ICONS.plus} Add Lesson
        </button>
      </div>
    </div>
  `;
}

function renderLesson(lesson, idx, moduleId) {
  return `
    <div class="lesson-item" data-id="${lesson.id}" draggable="true" ondragstart="dragLessonStart(event, '${lesson.id}', '${moduleId}')" ondragover="event.preventDefault()" ondrop="dropLesson(event, '${lesson.id}', '${moduleId}')">
      <div class="lesson-drag">${ICONS.grip}</div>
      <div class="lesson-type ${lesson.content_type || 'text'}">${typeIcon(lesson.content_type)}</div>
      <div class="lesson-info">
        <div class="lesson-title">${esc(lesson.title)}</div>
        <div class="lesson-meta">
          <span>${lesson.content_type || 'text'}</span>
          ${lesson.estimated_minutes ? `<span>${lesson.estimated_minutes}m</span>` : ''}
          ${lesson.is_free_preview ? '<span class="preview-badge">Preview</span>' : ''}
        </div>
      </div>
      <div class="lesson-actions">
        <button class="btn btn-ghost btn-sm" onclick="editLesson('${lesson.id}', '${moduleId}')">${ICONS.edit}</button>
        <button class="btn btn-ghost btn-sm" onclick="deleteLesson('${lesson.id}', '${moduleId}')" style="color:var(--danger)">${ICONS.trash}</button>
      </div>
    </div>
  `;
}

function toggleModule(header) {
  header.closest('.module-item').classList.toggle('open');
}

function markUnsaved() {
  hasUnsavedChanges = true;
  const ind = document.getElementById('unsavedIndicator');
  if (ind) ind.style.display = 'flex';
}

// --- Save Course ---
async function saveCourse() {
  const btn = document.getElementById('saveBtn');
  btn.disabled = true; btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px"></div> Saving...';

  try {
    const data = {
      title: document.getElementById('ed-title').value.trim(),
      subtitle: document.getElementById('ed-subtitle').value.trim() || null,
      description: document.getElementById('ed-desc').value.trim() || null,
      slug: document.getElementById('ed-slug').value.trim(),
      category: document.getElementById('ed-category').value.trim() || null,
      price_cents: Number(document.getElementById('ed-price').value) || 0,
      sale_price_cents: document.getElementById('ed-sale-price').value ? Number(document.getElementById('ed-sale-price').value) : null,
      sale_ends_at: document.getElementById('ed-sale-ends').value ? new Date(document.getElementById('ed-sale-ends').value).toISOString() : null,
      enrollment_type: document.getElementById('ed-enrollment').value,
      visibility: document.getElementById('ed-visibility').value,
      status: document.getElementById('ed-status').value,
      thumbnail_url: document.getElementById('ed-thumb').value.trim() || null,
      promo_video_url: document.getElementById('ed-video').value.trim() || null,
      instructor_name: document.getElementById('ed-instructor').value.trim() || null,
      sort_order: Number(document.getElementById('ed-sort').value) || 0,
      drip_enabled: document.getElementById('tog-drip').classList.contains('on'),
      drip_interval_days: Number(document.getElementById('ed-drip-days').value) || null,
      difficulty: document.getElementById('ed-difficulty').value || null,
      tags: document.getElementById('ed-tags').value.split(',').map(t => t.trim()).filter(Boolean),
      meta_title: document.getElementById('ed-meta-title').value.trim() || null,
      meta_description: document.getElementById('ed-meta-desc').value.trim() || null,
      og_image_url: document.getElementById('ed-og-image').value.trim() || null,
      discussion_enabled: document.getElementById('tog-discussion').classList.contains('on'),
      certificate_enabled: document.getElementById('tog-certificate').classList.contains('on'),
      short_description: JSON.stringify(collectLandingPageData()),
      total_lessons: courseModules.reduce((sum, m) => sum + (m.qa_lessons || []).length, 0),
      total_duration_minutes: courseModules.reduce((sum, m) => sum + (m.qa_lessons || []).reduce((s, l) => s + (l.estimated_minutes || 0), 0), 0),
      total_modules: courseModules.length,
    };

    if (!data.title) { showToast('Title is required', 'error'); return; }
    if (!data.slug) { showToast('Slug is required', 'error'); return; }

    const res = await proxyFrom('qa_courses').update(data).eq('id', selectedCourseId);
    if (res.error) throw new Error(res.error.message);

    hasUnsavedChanges = false;
    const ind = document.getElementById('unsavedIndicator');
    if (ind) ind.style.display = 'none';

    await loadCourses();
    showToast('Course saved', 'success');
  } catch(e) {
    showToast('Save failed: ' + e.message, 'error');
  }
  btn.disabled = false; btn.innerHTML = ICONS.save + ' Save Changes';
}

// --- Create Course ---
async function createNewCourse() {
  const title = await qpPrompt('New Course', 'Enter a course title');
  if (!title) return;

  try {
    const slug = slugify(title);
    const sortOrder = allCourses.length;
    const res = await proxyFrom('qa_courses').insert({
      title: title.trim(),
      slug: slug,
      status: 'draft',
      sort_order: sortOrder,
      price_cents: 0,
      instructor_name: 'Dr. Tracey Clark',
      discussion_enabled: false,
      certificate_enabled: false,
      total_lessons: 0,
      total_duration_minutes: 0,
    }).select('*');

    if (res.error) throw new Error(res.error.message);
    if (res.data && res.data.length) {
      selectedCourseId = res.data[0].id;
    }
    await loadCourses();
    showToast('Course created!', 'success');
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

// --- Delete Course ---
async function deleteCourse(id) {
  const course = allCourses.find(c => c.id === id);
  if (!await qpConfirm('Delete Course', `Delete "${course.title}"? This will also delete all modules and lessons. This cannot be undone.`, {okText: 'Delete Course', danger: true})) return;

  try {
    // Delete lessons first, then modules, then course
    for (const m of courseModules) {
      for (const l of (m.qa_lessons || [])) {
        await proxyFrom('qa_lessons').delete().eq('id', l.id);
      }
      await proxyFrom('qa_modules').delete().eq('id', m.id);
    }
    await proxyFrom('qa_courses').delete().eq('id', id);

    selectedCourseId = null;
    hasUnsavedChanges = false;
    await loadCourses();
    showToast('Course deleted', 'success');
  } catch(e) {
    showToast('Delete failed: ' + e.message, 'error');
  }
}

// --- Add Module ---
async function addModule() {
  const title = await qpPrompt('New Module', 'Enter a module title');
  if (!title) return;

  try {
    const sortOrder = courseModules.length;
    const res = await proxyFrom('qa_modules').insert({
      course_id: selectedCourseId,
      title: title.trim(),
      sort_order: sortOrder,
    }).select('*');

    if (res.error) throw new Error(res.error.message);
    await selectCourse(selectedCourseId, true);
    showToast('Module added', 'success');
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

// --- Edit Module ---
async function editModule(moduleId) {
  const mod = courseModules.find(m => m.id === moduleId);
  if (!mod) return;
  const course = allCourses.find(c => c.id === selectedCourseId);
  const isDrip = course && course.drip_enabled;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal" style="max-width:480px">
      <div class="modal-head">
        <h3>Edit Module</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">${ICONS.x}</button>
      </div>
      <div class="modal-body">
        <div class="field-group">
          <label>Module Title</label>
          <input type="text" id="mm-title" value="${esc(mod.title)}">
        </div>
        <div class="field-group">
          <label>Description (optional)</label>
          <textarea id="mm-desc" rows="2" placeholder="What this module covers">${esc(mod.description || '')}</textarea>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <div class="toggle-label">Require Previous Module</div>
            <div class="toggle-desc">Students must complete the prior module first</div>
          </div>
          <button class="toggle ${mod.require_previous ? 'on' : ''}" id="mm-prereq" onclick="this.classList.toggle('on')"></button>
        </div>
        ${isDrip ? `
        <div class="field-row" style="margin-top:12px">
          <div class="field-group">
            <label>Drip Delay (days)</label>
            <input type="number" id="mm-drip-days" value="${mod.drip_delay_days || ''}" placeholder="Default: ${course.drip_interval_days || 7}" min="0">
            <div class="hint">Days after enrollment to unlock. Leave blank for course default.</div>
          </div>
          <div class="field-group">
            <label>Or Fixed Date</label>
            <input type="datetime-local" id="mm-drip-date" value="${mod.drip_date ? new Date(mod.drip_date).toISOString().slice(0,16) : ''}">
            <div class="hint">Unlock on a specific date instead</div>
          </div>
        </div>` : ''}
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-primary" onclick="saveModuleEdit('${mod.id}')">Save Module</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  requestAnimationFrame(() => { overlay.classList.add('open'); document.getElementById('mm-title').focus(); });
}

async function saveModuleEdit(moduleId) {
  const title = document.getElementById('mm-title').value.trim();
  if (!title) { showToast('Module title is required', 'error'); return; }
  const data = {
    title,
    description: document.getElementById('mm-desc').value.trim() || null,
    require_previous: document.getElementById('mm-prereq').classList.contains('on'),
  };
  const dripDays = document.getElementById('mm-drip-days');
  const dripDate = document.getElementById('mm-drip-date');
  if (dripDays) data.drip_delay_days = dripDays.value ? Number(dripDays.value) : null;
  if (dripDate) data.drip_date = dripDate.value ? new Date(dripDate.value).toISOString() : null;

  try {
    await proxyFrom('qa_modules').update(data).eq('id', moduleId);
    document.querySelector('.modal-overlay').remove();
    await selectCourse(selectedCourseId, true);
    showToast('Module updated', 'success');
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

// --- Delete Module ---
async function deleteModule(moduleId) {
  const mod = courseModules.find(m => m.id === moduleId);
  if (!mod) return;
  const lessonCount = (mod.qa_lessons || []).length;
  if (!await qpConfirm('Delete Module', `Delete module "${mod.title}"${lessonCount ? ' and its ' + lessonCount + ' lesson(s)' : ''}?`, {okText: 'Delete', danger: true})) return;

  try {
    for (const l of (mod.qa_lessons || [])) {
      await proxyFrom('qa_lessons').delete().eq('id', l.id);
    }
    await proxyFrom('qa_modules').delete().eq('id', moduleId);
    await selectCourse(selectedCourseId, true);
    showToast('Module deleted', 'success');
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

// --- Lesson Templates ---
const LESSON_TEMPLATES = [
  { name: 'Blank Lesson', icon: 'text', desc: 'Start from scratch', defaults: {content_type: 'video', title: ''} },
  { name: 'Video Lecture', icon: 'video', desc: 'Video with notes & resource', defaults: {content_type: 'video', title: 'Video Lecture', description: '## Key Takeaways\n\n- \n- \n- \n\n## Notes\n\n', estimated_minutes: 15} },
  { name: 'Guided Exercise', icon: 'assignment', desc: 'Worksheet or journaling prompt', defaults: {content_type: 'assignment', title: 'Guided Exercise', description: '## Instructions\n\nTake 10-15 minutes to complete this exercise.\n\n### Step 1\n\n\n### Step 2\n\n\n### Reflection\n\nWhat did you notice?', estimated_minutes: 15} },
  { name: 'Quiz / Check-in', icon: 'quiz', desc: 'Multiple choice or reflection', defaults: {content_type: 'quiz', title: 'Knowledge Check', description: ''} },
  { name: 'Downloadable Resource', icon: 'pdf', desc: 'PDF, worksheet, or guide', defaults: {content_type: 'pdf', title: 'Resource Download', description: '## About This Resource\n\nDownload the file below to complete this section.'} },
  { name: 'Live Zoom Session', icon: 'live', desc: 'Scheduled live class', defaults: {content_type: 'live_session', title: 'Live Session', description: '## What to Prepare\n\n- Find a quiet space\n- Have your journal ready\n- Come with questions!'} },
];

// --- Add Lesson ---
function addLesson(moduleId) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal" style="max-width:520px">
      <div class="modal-head">
        <h3>Add Lesson</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">${ICONS.x}</button>
      </div>
      <div class="modal-body">
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Choose a template or start blank:</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          ${LESSON_TEMPLATES.map((t, i) => `
            <button class="template-btn" onclick="this.closest('.modal-overlay').remove();applyLessonTemplate('${moduleId}', ${i})" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;text-align:left;transition:all .15s;font-family:inherit">
              <div class="lesson-type ${t.icon}" style="width:36px;height:36px;min-width:36px;border-radius:8px;display:flex;align-items:center;justify-content:center">${typeIcon(t.icon)}</div>
              <div><div style="font-size:13px;font-weight:600">${t.name}</div><div style="font-size:11px;color:var(--text-muted)">${t.desc}</div></div>
            </button>
          `).join('')}
        </div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  requestAnimationFrame(() => overlay.classList.add('open'));
  // Hover effect
  overlay.querySelectorAll('.template-btn').forEach(b => {
    b.addEventListener('mouseenter', () => { b.style.borderColor = 'var(--teal)'; b.style.background = 'var(--bg-card)'; });
    b.addEventListener('mouseleave', () => { b.style.borderColor = 'var(--border)'; b.style.background = 'var(--bg-input)'; });
  });
}

function applyLessonTemplate(moduleId, templateIdx) {
  const t = LESSON_TEMPLATES[templateIdx];
  const lesson = {...t.defaults};
  showLessonModal(lesson, moduleId, true);
}

// --- Edit Lesson ---
function editLesson(lessonId, moduleId) {
  const mod = courseModules.find(m => m.id === moduleId);
  const lesson = mod ? (mod.qa_lessons || []).find(l => l.id === lessonId) : null;
  if (!lesson) return;
  showLessonModal(lesson, moduleId);
}

// --- Lesson Modal ---
function showLessonModal(lesson, moduleId, isTemplate) {
  const isEdit = !!lesson && !isTemplate && !!lesson.id;
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal" style="max-width:640px">
      <div class="modal-head">
        <h3>${isEdit ? 'Edit Lesson' : 'Add Lesson'}</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">${ICONS.x}</button>
      </div>
      <div class="modal-body" style="max-height:70vh;overflow-y:auto">
        <div class="field-group">
          <label>Lesson Title</label>
          <input type="text" id="ml-title" value="${esc(lesson ? lesson.title || '' : '')}" placeholder="Lesson title">
        </div>
        <div class="field-row">
          <div class="field-group">
            <label>Content Type</label>
            <select id="ml-type" onchange="updateLessonFields()">
              <option value="video" ${lesson && lesson.content_type === 'video' ? 'selected' : ''}>Video</option>
              <option value="text" ${lesson && lesson.content_type === 'text' ? 'selected' : ''}>Text / Reading</option>
              <option value="quiz" ${lesson && lesson.content_type === 'quiz' ? 'selected' : ''}>Quiz</option>
              <option value="pdf" ${lesson && lesson.content_type === 'pdf' ? 'selected' : ''}>PDF / File</option>
              <option value="assignment" ${lesson && lesson.content_type === 'assignment' ? 'selected' : ''}>Assignment</option>
              <option value="embed" ${lesson && lesson.content_type === 'embed' ? 'selected' : ''}>Embed</option>
              <option value="live_session" ${lesson && lesson.content_type === 'live_session' ? 'selected' : ''}>Live Session</option>
              <option value="audio" ${lesson && lesson.content_type === 'audio' ? 'selected' : ''}>Audio</option>
            </select>
          </div>
          <div class="field-group">
            <label>Duration (minutes)</label>
            <input type="number" id="ml-duration" value="${lesson ? lesson.estimated_minutes || '' : ''}" placeholder="Optional" min="0">
          </div>
        </div>

        <!-- Video fields -->
        <div id="ml-video-fields" class="ml-type-section">
          <div class="field-group">
            <label>Video URL</label>
            <input type="text" id="ml-video" value="${esc(lesson ? lesson.video_url || '' : '')}" placeholder="Vimeo or video URL">
          </div>
          <div class="field-group">
            <label>Video Thumbnail URL</label>
            <input type="text" id="ml-video-thumb" value="${esc(lesson ? lesson.video_thumbnail_url || '' : '')}" placeholder="Optional thumbnail override">
          </div>
        </div>

        <!-- File/PDF fields -->
        <div id="ml-file-fields" class="ml-type-section" style="display:none">
          <div class="field-group">
            <label>File URL</label>
            <input type="text" id="ml-file-url" value="${esc(lesson ? lesson.file_url || '' : '')}" placeholder="https://... (downloadable file)">
          </div>
          <div class="field-row">
            <div class="field-group">
              <label>File Name</label>
              <input type="text" id="ml-file-name" value="${esc(lesson ? lesson.file_name || '' : '')}" placeholder="worksheet.pdf">
            </div>
            <div class="field-group">
              <label>File Size (bytes)</label>
              <input type="number" id="ml-file-size" value="${lesson ? lesson.file_size_bytes || '' : ''}" placeholder="Optional">
            </div>
          </div>
        </div>

        <!-- Embed fields -->
        <div id="ml-embed-fields" class="ml-type-section" style="display:none">
          <div class="field-group">
            <label>Embed URL</label>
            <input type="text" id="ml-embed-url" value="${esc(lesson ? lesson.embed_url || '' : '')}" placeholder="External embed URL">
          </div>
          <div class="field-group">
            <label>Embed HTML (optional)</label>
            <textarea id="ml-embed-html" rows="3" placeholder="Custom embed code (iframe, etc.)">${esc(lesson ? lesson.embed_html || '' : '')}</textarea>
          </div>
        </div>

        <!-- Live session fields -->
        <div id="ml-live-fields" class="ml-type-section" style="display:none">
          <div class="field-group">
            <label>Live Date & Time</label>
            <input type="datetime-local" id="ml-live-date" value="${lesson && lesson.live_date ? new Date(lesson.live_date).toISOString().slice(0,16) : ''}">
          </div>
          <div class="field-group">
            <label>Meeting URL (Zoom, etc.)</label>
            <input type="text" id="ml-live-url" value="${esc(lesson ? lesson.live_meeting_url || '' : '')}" placeholder="https://zoom.us/j/...">
          </div>
          <div class="field-group">
            <label>Recording URL (after session)</label>
            <input type="text" id="ml-live-rec" value="${esc(lesson ? lesson.live_recording_url || '' : '')}" placeholder="Added after the live session">
          </div>
        </div>

        <!-- Quiz Builder -->
        <div id="ml-quiz-fields" class="ml-type-section" style="display:none">
          <div style="font-size:12px;font-weight:600;color:var(--purple);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em">Quiz Builder</div>
          <div class="field-group" style="margin-bottom:8px">
            <label>Quiz Type</label>
            <select id="ml-quiz-type" onchange="updateQuizType()" style="max-width:250px">
              <option value="multiple_choice">Multiple Choice</option>
              <option value="true_false">True / False</option>
              <option value="reflection">Open Reflection (no right answer)</option>
              <option value="rating">Self-Rating Scale</option>
              <option value="checklist">Checklist / Self-Assessment</option>
            </select>
          </div>
          <div id="ml-quiz-questions"></div>
          <button class="btn btn-ghost btn-sm" onclick="addQuizQuestion()" style="margin-top:8px">${ICONS.plus} Add Question</button>
          <div class="hint" style="margin-top:8px">Quiz data is saved as JSON in the lesson content field.</div>
        </div>

        <!-- Content (always shown) -->
        <div class="field-group" style="margin-top:12px">
          <label>Content / Description</label>
          ${getRichToolbar()}
          <textarea id="ml-content" rows="8" placeholder="Lesson content, instructions, or description (supports Markdown)" style="font-family:'Inter',monospace;font-size:13px;line-height:1.6">${esc(lesson ? lesson.content_markdown || lesson.content_html || lesson.description || '' : '')}</textarea>
        </div>

        <!-- Downloadable Resource (shown for all types) -->
        <div class="cb-section" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
          <div style="font-size:12px;font-weight:600;color:var(--taupe);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em">Downloadable Resource</div>
          <div class="field-row">
            <div class="field-group">
              <label>Resource File URL</label>
              <input type="text" id="ml-resource-url" value="${esc(lesson ? lesson.file_url || '' : '')}" placeholder="https://... (PDF, worksheet, etc.)">
            </div>
            <div class="field-group">
              <label>Resource Name</label>
              <input type="text" id="ml-resource-name" value="${esc(lesson ? lesson.file_name || '' : '')}" placeholder="Worksheet.pdf">
            </div>
          </div>
        </div>

        <!-- Toggles -->
        <div class="toggle-row" style="margin-top:12px">
          <div class="toggle-info">
            <div class="toggle-label">Free Preview</div>
            <div class="toggle-desc">Allow non-enrolled users to preview this lesson</div>
          </div>
          <button class="toggle ${lesson && lesson.is_free_preview ? 'on' : ''}" id="ml-preview" onclick="this.classList.toggle('on')"></button>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <div class="toggle-label">Required</div>
            <div class="toggle-desc">Students must complete this lesson for course completion</div>
          </div>
          <button class="toggle ${lesson && lesson.is_required !== false ? 'on' : ''}" id="ml-required" onclick="this.classList.toggle('on')"></button>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <div class="toggle-label">Require Previous</div>
            <div class="toggle-desc">Must complete the previous lesson first</div>
          </div>
          <button class="toggle ${lesson && lesson.require_previous ? 'on' : ''}" id="ml-req-prev" onclick="this.classList.toggle('on')"></button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-primary" onclick="saveLesson('${moduleId}', ${isEdit ? "'" + lesson.id + "'" : 'null'})">${isEdit ? 'Save Changes' : 'Add Lesson'}</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  requestAnimationFrame(() => { overlay.classList.add('open'); updateLessonFields(); });
  overlay.querySelector('#ml-title').focus();
}

function updateLessonFields() {
  const type = document.getElementById('ml-type').value;
  document.querySelectorAll('.ml-type-section').forEach(el => el.style.display = 'none');
  if (type === 'video') document.getElementById('ml-video-fields').style.display = '';
  if (type === 'pdf') document.getElementById('ml-file-fields').style.display = '';
  if (type === 'embed') document.getElementById('ml-embed-fields').style.display = '';
  if (type === 'live_session') document.getElementById('ml-live-fields').style.display = '';
  if (type === 'quiz') {
    document.getElementById('ml-quiz-fields').style.display = '';
    // Try to load existing quiz data from content
    try {
      const content = document.getElementById('ml-content').value;
      if (content && content.startsWith('{')) {
        const qd = JSON.parse(content);
        if (qd.quiz_type) {
          document.getElementById('ml-quiz-type').value = qd.quiz_type;
          const container = document.getElementById('ml-quiz-questions');
          container.innerHTML = '';
          (qd.questions || []).forEach(q => addQuizQuestion(q));
        }
      }
    } catch(e) {}
  }
}

// --- Quiz Builder Functions ---
function addQuizQuestion(existing) {
  const container = document.getElementById('ml-quiz-questions');
  const qType = document.getElementById('ml-quiz-type').value;
  const idx = container.children.length;
  const div = document.createElement('div');
  div.className = 'quiz-q-item';
  div.style.cssText = 'padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px';

  const q = existing || {};
  let answersHtml = '';

  if (qType === 'multiple_choice') {
    const opts = q.options || ['', '', '', ''];
    answersHtml = `<div class="quiz-options" style="margin-top:8px">
      ${opts.map((o, oi) => `<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">
        <input type="radio" name="q${idx}-correct" value="${oi}" ${q.correct === oi ? 'checked' : ''} style="accent-color:var(--teal)">
        <input type="text" class="quiz-opt" value="${esc(o)}" placeholder="Option ${oi+1}" style="flex:1;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px">
        ${oi > 1 ? `<button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px">Ã—</button>` : ''}
      </div>`).join('')}
      <button class="btn btn-ghost btn-sm" onclick="addQuizOption(this.parentElement, ${idx})" style="font-size:11px;margin-top:4px">${ICONS.plus} Option</button>
    </div>
    <div class="hint" style="margin-top:4px">Select the radio button next to the correct answer</div>`;
  } else if (qType === 'true_false') {
    answersHtml = `<div style="display:flex;gap:12px;margin-top:8px">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
        <input type="radio" name="q${idx}-correct" value="true" ${q.correct === true || q.correct === 'true' ? 'checked' : ''} style="accent-color:var(--teal)"> True
      </label>
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
        <input type="radio" name="q${idx}-correct" value="false" ${q.correct === false || q.correct === 'false' ? 'checked' : ''} style="accent-color:var(--teal)"> False
      </label>
    </div>`;
  } else if (qType === 'reflection') {
    answersHtml = `<div class="hint" style="margin-top:8px">Students will see a free-text response box. No right/wrong answer.</div>`;
  } else if (qType === 'rating') {
    answersHtml = `<div style="margin-top:8px">
      <div class="field-row">
        <div class="field-group"><label style="font-size:11px">Scale Label (low)</label><input type="text" class="quiz-scale-low" value="${esc(q.scale_low || 'Not at all')}" style="padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px"></div>
        <div class="field-group"><label style="font-size:11px">Scale Label (high)</label><input type="text" class="quiz-scale-high" value="${esc(q.scale_high || 'Completely')}" style="padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px"></div>
      </div>
    </div>`;
  } else if (qType === 'checklist') {
    const items = q.items || ['', ''];
    answersHtml = `<div class="quiz-checklist" style="margin-top:8px">
      ${items.map((item, ii) => `<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">
        <span style="color:var(--teal)">â˜</span>
        <input type="text" class="quiz-check-item" value="${esc(item)}" placeholder="Checklist item" style="flex:1;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px">
        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px">Ã—</button>
      </div>`).join('')}
      <button class="btn btn-ghost btn-sm" onclick="addChecklistItem(this.parentElement)" style="font-size:11px;margin-top:4px">${ICONS.plus} Item</button>
    </div>
    <div class="hint" style="margin-top:4px">Students check off items as they complete them</div>`;
  }

  div.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <span style="font-size:12px;font-weight:700;color:var(--purple)">Q${idx + 1}</span>
      <input type="text" class="quiz-question-text" value="${esc(q.question || '')}" placeholder="Enter your question" style="flex:1;padding:8px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;font-weight:600">
      <button onclick="this.closest('.quiz-q-item').remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;padding:4px">${ICONS.x}</button>
    </div>
    ${answersHtml}`;
  container.appendChild(div);
}

function addQuizOption(container, qIdx) {
  const opts = container.querySelectorAll('.quiz-opt');
  const idx = opts.length;
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:4px';
  div.innerHTML = `<input type="radio" name="q${qIdx}-correct" value="${idx}" style="accent-color:var(--teal)">
    <input type="text" class="quiz-opt" value="" placeholder="Option ${idx+1}" style="flex:1;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px">
    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px">Ã—</button>`;
  container.querySelector('.btn').before(div);
}

function addChecklistItem(container) {
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:4px';
  div.innerHTML = `<span style="color:var(--teal)">â˜</span>
    <input type="text" class="quiz-check-item" value="" placeholder="Checklist item" style="flex:1;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px">
    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:14px">Ã—</button>`;
  container.querySelector('.btn').before(div);
}

function updateQuizType() {
  document.getElementById('ml-quiz-questions').innerHTML = '';
  addQuizQuestion();
}

function collectQuizData() {
  const qType = document.getElementById('ml-quiz-type').value;
  const questions = [];
  document.querySelectorAll('.quiz-q-item').forEach((qEl, qi) => {
    const q = { question: qEl.querySelector('.quiz-question-text').value.trim() };
    if (!q.question) return;
    if (qType === 'multiple_choice') {
      q.options = [...qEl.querySelectorAll('.quiz-opt')].map(o => o.value.trim());
      const checked = qEl.querySelector(`input[name="q${qi}-correct"]:checked`);
      q.correct = checked ? Number(checked.value) : null;
    } else if (qType === 'true_false') {
      const checked = qEl.querySelector(`input[name="q${qi}-correct"]:checked`);
      q.correct = checked ? checked.value === 'true' : null;
    } else if (qType === 'rating') {
      q.scale_low = qEl.querySelector('.quiz-scale-low')?.value.trim() || 'Not at all';
      q.scale_high = qEl.querySelector('.quiz-scale-high')?.value.trim() || 'Completely';
    } else if (qType === 'checklist') {
      q.items = [...qEl.querySelectorAll('.quiz-check-item')].map(i => i.value.trim()).filter(Boolean);
    }
    questions.push(q);
  });
  return { quiz_type: qType, questions };
}

// --- Save Lesson ---
async function saveLesson(moduleId, lessonId) {
  const title = document.getElementById('ml-title').value.trim();
  if (!title) { showToast('Lesson title is required', 'error'); return; }

  const type = document.getElementById('ml-type').value;
  const contentVal = document.getElementById('ml-content').value.trim();
  
  // For quiz type, serialize quiz builder data as JSON into content fields
  let finalContent = contentVal;
  if (type === 'quiz') {
    const quizData = collectQuizData();
    if (quizData.questions.length > 0) {
      finalContent = JSON.stringify(quizData);
    }
  }
  
  const data = {
    title: title,
    content_type: type,
    estimated_minutes: Number(document.getElementById('ml-duration').value) || null,
    video_url: document.getElementById('ml-video').value.trim() || null,
    video_thumbnail_url: document.getElementById('ml-video-thumb')?.value.trim() || null,
    description: document.getElementById('ml-content').value.trim() || null,
    content_html: finalContent || null,
    content_markdown: finalContent || null,
    is_free_preview: document.getElementById('ml-preview').classList.contains('on'),
    is_required: document.getElementById('ml-required').classList.contains('on'),
    require_previous: document.getElementById('ml-req-prev').classList.contains('on'),
  };

  // Type-specific fields
  if (type === 'pdf' || document.getElementById('ml-file-url')?.value) {
    data.file_url = document.getElementById('ml-file-url')?.value.trim() || null;
    data.file_name = document.getElementById('ml-file-name')?.value.trim() || null;
    data.file_size_bytes = Number(document.getElementById('ml-file-size')?.value) || null;
  }
  if (type === 'embed') {
    data.embed_url = document.getElementById('ml-embed-url')?.value.trim() || null;
    data.embed_html = document.getElementById('ml-embed-html')?.value.trim() || null;
  }
  if (type === 'live_session') {
    data.live_date = document.getElementById('ml-live-date')?.value ? new Date(document.getElementById('ml-live-date').value).toISOString() : null;
    data.live_meeting_url = document.getElementById('ml-live-url')?.value.trim() || null;
    data.live_recording_url = document.getElementById('ml-live-rec')?.value.trim() || null;
  }

  // Resource fields (always available)
  const resUrl = document.getElementById('ml-resource-url')?.value.trim();
  const resName = document.getElementById('ml-resource-name')?.value.trim();
  if (resUrl && type !== 'pdf') {
    data.file_url = resUrl;
    data.file_name = resName || null;
  }

  try {
    if (lessonId) {
      const res = await proxyFrom('qa_lessons').update(data).eq('id', lessonId);
      if (res.error) throw new Error(res.error.message);
    } else {
      const mod = courseModules.find(m => m.id === moduleId);
      data.module_id = moduleId;
      data.course_id = selectedCourseId;
      data.sort_order = mod ? (mod.qa_lessons || []).length : 0;
      data.slug = slugify(title) + '-' + Date.now().toString(36).slice(-4);
      const res = await proxyFrom('qa_lessons').insert(data);
      console.log('Lesson insert result:', res);
      if (res.error) throw new Error(res.error.message);
    }
    document.querySelector('.modal-overlay').remove();
    await selectCourse(selectedCourseId, true);
    // Auto-save total_lessons count
    const totalLessons = courseModules.reduce((sum, m) => sum + (m.qa_lessons || []).length, 0);
    const totalDuration = courseModules.reduce((sum, m) => sum + (m.qa_lessons || []).reduce((s, l) => s + (l.estimated_minutes || 0), 0), 0);
    await proxyFrom('qa_courses').update({total_lessons: totalLessons, total_duration_minutes: totalDuration}).eq('id', selectedCourseId);
    showToast(lessonId ? 'Lesson updated' : 'Lesson added', 'success');
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

// --- Delete Lesson ---
async function deleteLesson(lessonId, moduleId) {
  if (!await qpConfirm('Delete Lesson', 'Delete this lesson?', {okText: 'Delete', danger: true})) return;
  try {
    await proxyFrom('qa_lessons').delete().eq('id', lessonId);
    await selectCourse(selectedCourseId, true);
    showToast('Lesson deleted', 'success');
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

// --- Thumbnail Edit ---
function editThumbnail() {
  const el = document.getElementById('ed-thumb');
  el.focus();
  el.scrollIntoView({behavior: 'smooth', block: 'center'});
}

// --- Drag & Drop: Modules ---
let dragModuleId = null;
function dragModuleStart(e, id) {
  dragModuleId = id;
  e.stopPropagation();
  e.dataTransfer.effectAllowed = 'move';
}

async function dropModule(e, targetId) {
  e.preventDefault();
  if (!dragModuleId || dragModuleId === targetId) return;

  const fromIdx = courseModules.findIndex(m => m.id === dragModuleId);
  const toIdx = courseModules.findIndex(m => m.id === targetId);
  if (fromIdx === -1 || toIdx === -1) return;

  // Reorder
  const [moved] = courseModules.splice(fromIdx, 1);
  courseModules.splice(toIdx, 0, moved);

  // Save new sort orders
  try {
    for (let i = 0; i < courseModules.length; i++) {
      await proxyFrom('qa_modules').update({sort_order: i}).eq('id', courseModules[i].id);
    }
    await selectCourse(selectedCourseId, true);
  } catch(e) {
    showToast('Reorder failed: ' + e.message, 'error');
  }
  dragModuleId = null;
}

// --- Drag & Drop: Lessons ---
let dragLessonId = null;
let dragLessonModuleId = null;
function dragLessonStart(e, lessonId, moduleId) {
  dragLessonId = lessonId;
  dragLessonModuleId = moduleId;
  e.stopPropagation();
  e.dataTransfer.effectAllowed = 'move';
}

async function dropLesson(e, targetLessonId, targetModuleId) {
  e.preventDefault();
  if (!dragLessonId || dragLessonId === targetLessonId) return;

  const sourceMod = courseModules.find(m => m.id === dragLessonModuleId);
  const targetMod = courseModules.find(m => m.id === targetModuleId);
  if (!sourceMod || !targetMod) return;

  const lessons = targetMod.qa_lessons || [];
  const fromIdx = (sourceMod.qa_lessons || []).findIndex(l => l.id === dragLessonId);
  const toIdx = lessons.findIndex(l => l.id === targetLessonId);

  if (dragLessonModuleId === targetModuleId) {
    // Same module reorder
    const [moved] = lessons.splice(fromIdx, 1);
    lessons.splice(toIdx, 0, moved);
    try {
      for (let i = 0; i < lessons.length; i++) {
        await proxyFrom('qa_lessons').update({sort_order: i}).eq('id', lessons[i].id);
      }
      await selectCourse(selectedCourseId, true);
    } catch(e) {
      showToast('Reorder failed', 'error');
    }
  } else {
    // Move to different module
    try {
      await proxyFrom('qa_lessons').update({module_id: targetModuleId, sort_order: toIdx}).eq('id', dragLessonId);
      await selectCourse(selectedCourseId, true);
    } catch(e) {
      showToast('Move failed', 'error');
    }
  }
  dragLessonId = null;
  dragLessonModuleId = null;
}

// --- Themed Confirm Modal ---
function qpConfirm(title, message, opts = {}) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal" style="max-width:420px">
        <div class="modal-head">
          <h3>${title}</h3>
          <button class="modal-close" data-action="cancel">${ICONS.x}</button>
        </div>
        <div class="modal-body">
          <p style="font-size:14px;color:var(--text-muted);line-height:1.6">${message}</p>
        </div>
        <div class="modal-footer">
          <button class="btn" data-action="cancel">Cancel</button>
          <button class="btn ${opts.danger ? 'btn-danger' : 'btn-primary'}" data-action="ok">${opts.okText || 'Confirm'}</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => overlay.classList.add('open'));

    overlay.addEventListener('click', e => {
      const action = e.target.dataset.action || e.target.closest('[data-action]')?.dataset.action;
      if (action === 'cancel' || e.target === overlay) {
        overlay.remove(); resolve(false);
      } else if (action === 'ok') {
        overlay.remove(); resolve(true);
      }
    });
  });
}

// --- Themed Prompt Modal ---
function qpPrompt(title, placeholder, defaultVal) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal" style="max-width:420px">
        <div class="modal-head">
          <h3>${title}</h3>
          <button class="modal-close" data-action="cancel">${ICONS.x}</button>
        </div>
        <div class="modal-body">
          <div class="field-group">
            <input type="text" id="qp-prompt-input" value="${esc(defaultVal || '')}" placeholder="${esc(placeholder || '')}">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" data-action="cancel">Cancel</button>
          <button class="btn btn-primary" data-action="ok">OK</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => { overlay.classList.add('open'); document.getElementById('qp-prompt-input').focus(); });

    const submit = () => {
      const val = document.getElementById('qp-prompt-input').value.trim();
      overlay.remove();
      resolve(val || null);
    };

    document.getElementById('qp-prompt-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') submit();
      if (e.key === 'Escape') { overlay.remove(); resolve(null); }
    });

    overlay.addEventListener('click', e => {
      const action = e.target.dataset.action || e.target.closest('[data-action]')?.dataset.action;
      if (action === 'cancel' || e.target === overlay) {
        overlay.remove(); resolve(null);
      } else if (action === 'ok') {
        submit();
      }
    });
  });
}

// --- Clone Course ---
async function cloneCourse(id) {
  const course = allCourses.find(c => c.id === id);
  if (!course) return;
  if (!await qpConfirm('Clone Course', `Create a copy of "${course.title}" with all modules and lessons? The clone will be set to Draft status.`, {okText: 'Clone'})) return;

  try {
    showToast('Cloning course...', '');
    // Clone course
    const newCourse = {...course};
    delete newCourse.id; delete newCourse.created_at; delete newCourse.updated_at; delete newCourse.published_at;
    newCourse.title = course.title + ' (Copy)';
    newCourse.slug = course.slug + '-copy-' + Date.now().toString(36).slice(-4);
    newCourse.status = 'draft';
    newCourse.enrolled_count = 0;
    newCourse.sort_order = allCourses.length;

    const cRes = await proxyFrom('qa_courses').insert(newCourse).select('*');
    if (cRes.error) throw new Error(cRes.error.message);
    const newCourseId = cRes.data[0].id;

    // Clone modules and lessons
    for (const mod of courseModules) {
      const newMod = {course_id: newCourseId, title: mod.title, description: mod.description, sort_order: mod.sort_order, drip_delay_days: mod.drip_delay_days, drip_date: mod.drip_date, require_previous: mod.require_previous};
      const mRes = await proxyFrom('qa_modules').insert(newMod).select('*');
      if (mRes.error) continue;
      const newModId = mRes.data[0].id;

      for (const lesson of (mod.qa_lessons || [])) {
        const newLesson = {...lesson};
        delete newLesson.id; delete newLesson.created_at; delete newLesson.updated_at;
        newLesson.module_id = newModId;
        newLesson.course_id = newCourseId;
        await proxyFrom('qa_lessons').insert(newLesson);
      }
    }

    selectedCourseId = newCourseId;
    await loadCourses();
    showToast('Course cloned!', 'success');
  } catch(e) {
    showToast('Clone failed: ' + e.message, 'error');
  }
}

// --- Toggle SEO Fields ---
function toggleSEO() {
  const el = document.getElementById('seo-fields');
  el.style.display = el.style.display === 'none' ? '' : 'none';
}

// ============================================================
// BUNDLE MANAGEMENT
// ============================================================

function renderBundleList() {
  const el = document.getElementById('bundleListItems');
  if (!allBundles.length) {
    el.innerHTML = '<div style="padding:12px 20px;font-size:11px;color:var(--text-dim)">No bundles yet</div>';
    return;
  }
  el.innerHTML = allBundles.map(b => {
    const courseCount = allBundleCourses.filter(bc => bc.bundle_id === b.id).length;
    return `
      <div class="cb-course-item ${b.id === selectedBundleId ? 'active' : ''}" onclick="selectBundle('${b.id}')" style="border-left-color:var(--purple)">
        <span class="dot ${b.status || 'draft'}" style="background:var(--purple)"></span>
        <span class="title">${esc(b.title)}</span>
        <span class="count">${courseCount}</span>
      </div>`;
  }).join('');
}

let selectedBundleId = null;

async function createNewBundle() {
  const title = await qpPrompt('New Bundle', 'Enter a bundle title');
  if (!title) return;
  try {
    const slug = slugify(title);
    const res = await proxyFrom('qa_bundles').insert({
      title: title.trim(), slug, status: 'draft', price_cents: 0,
    }).select('*');
    if (res.error) throw new Error(res.error.message);
    selectedBundleId = res.data[0].id;
    selectedCourseId = null;
    await loadCourses();
    selectBundle(selectedBundleId);
    showToast('Bundle created!', 'success');
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

function selectBundle(id) {
  selectedBundleId = id;
  selectedCourseId = null;
  hasUnsavedChanges = false;
  renderCourseList();
  renderBundleList();
  const bundle = allBundles.find(b => b.id === id);
  if (!bundle) return;
  const bundleCourseIds = allBundleCourses.filter(bc => bc.bundle_id === id).map(bc => bc.course_id);
  const assignedCourses = allCourses.filter(c => bundleCourseIds.includes(c.id));
  const availableCourses = allCourses.filter(c => !bundleCourseIds.includes(c.id));

  document.getElementById('breadcrumb').innerHTML = `
    <span style="cursor:pointer;color:var(--text-muted)" onclick="selectedBundleId=null;showEmptyState()">Bundles</span>
    <span style="margin:0 8px;color:var(--text-dim)">â€º</span>
    <span>${esc(bundle.title)}</span>`;

  document.getElementById('topActions').innerHTML = `
    <button class="btn btn-danger btn-sm" onclick="deleteBundle('${id}')">${ICONS.trash} Delete</button>
    <button class="btn btn-primary btn-sm" id="saveBundleBtn" onclick="saveBundle()">${ICONS.save} Save Bundle</button>`;

  const fullPrice = assignedCourses.reduce((s,c) => s + (c.price_cents||0), 0);

  document.getElementById('mainContent').innerHTML = `
    <div class="cb-editor">
      <div class="cb-section">
        <div class="cb-section-head"><h3>Bundle Details</h3></div>
        <div class="field-group">
          <label>Title</label>
          <input type="text" id="bd-title" value="${esc(bundle.title)}" placeholder="Bundle title" oninput="markUnsaved()">
        </div>
        <div class="field-group">
          <label>Description</label>
          <textarea id="bd-desc" rows="3" placeholder="What's included in this bundle" oninput="markUnsaved()">${esc(bundle.description || '')}</textarea>
        </div>
        <div class="field-row">
          <div class="field-group">
            <label>Slug</label>
            <input type="text" id="bd-slug" value="${esc(bundle.slug || '')}" placeholder="bundle-url-slug" oninput="markUnsaved()">
          </div>
          <div class="field-group">
            <label>Status</label>
            <select id="bd-status" onchange="markUnsaved()">
              <option value="draft" ${bundle.status === 'draft' ? 'selected' : ''}>Draft</option>
              <option value="published" ${bundle.status === 'published' ? 'selected' : ''}>Published</option>
            </select>
          </div>
        </div>
        <div class="field-row">
          <div class="field-group">
            <label>Bundle Price (cents)</label>
            <input type="number" id="bd-price" value="${bundle.price_cents || 0}" min="0" oninput="markUnsaved()">
            <div class="hint">$${((bundle.price_cents || 0) / 100).toFixed(2)} ${fullPrice > (bundle.price_cents||0) ? '(save $' + ((fullPrice - (bundle.price_cents||0))/100).toFixed(2) + ' vs individual)' : ''}</div>
          </div>
          <div class="field-group">
            <label>Original Price (cents)</label>
            <input type="number" id="bd-orig-price" value="${bundle.original_price_cents || ''}" placeholder="Show as strikethrough" min="0" oninput="markUnsaved()">
          </div>
        </div>
        <div class="field-group">
          <label>Thumbnail URL</label>
          <input type="text" id="bd-thumb" value="${esc(bundle.thumbnail_url || '')}" placeholder="https://..." oninput="markUnsaved()">
        </div>
        <div class="field-row">
          <div class="field-group">
            <label>Stripe Product ID</label>
            <input type="text" id="bd-stripe-product" value="${esc(bundle.stripe_product_id || '')}" placeholder="prod_..." oninput="markUnsaved()">
          </div>
          <div class="field-group">
            <label>Stripe Price ID</label>
            <input type="text" id="bd-stripe-price" value="${esc(bundle.stripe_price_id || '')}" placeholder="price_..." oninput="markUnsaved()">
          </div>
        </div>
      </div>

      <div class="cb-section">
        <div class="cb-section-head">
          <h3>Courses in Bundle</h3>
          <span class="badge">${assignedCourses.length} courses Â· $${(fullPrice / 100).toFixed(2)} individual value</span>
        </div>
        <div class="module-list">
          ${assignedCourses.map((c, i) => `
            <div class="lesson-item" style="padding:12px 16px">
              <span class="lesson-type video" style="font-size:14px">${i + 1}</span>
              <div class="lesson-info">
                <div class="lesson-title">${esc(c.title)}</div>
                <div class="lesson-meta"><span>$${((c.price_cents||0)/100).toFixed(2)}</span><span>${c.total_lessons||0} lessons</span></div>
              </div>
              <button class="btn btn-ghost btn-sm" style="color:var(--danger)" onclick="removeBundleCourse('${id}','${c.id}')">${ICONS.x}</button>
            </div>
          `).join('') || '<div style="padding:20px;text-align:center;font-size:13px;color:var(--text-dim)">No courses assigned yet</div>'}
        </div>
        ${availableCourses.length ? `
          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <select id="bd-add-course" class="field-group" style="flex:1;padding:8px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px">
              ${availableCourses.map(c => `<option value="${c.id}">${esc(c.title)}</option>`).join('')}
            </select>
            <button class="btn btn-primary btn-sm" onclick="addBundleCourse('${id}')">+ Add</button>
          </div>` : ''}
      </div>
    </div>`;
}

async function saveBundle() {
  const btn = document.getElementById('saveBundleBtn');
  btn.disabled = true; btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px"></div> Saving...';
  try {
    const data = {
      title: document.getElementById('bd-title').value.trim(),
      description: document.getElementById('bd-desc').value.trim() || null,
      slug: document.getElementById('bd-slug').value.trim(),
      status: document.getElementById('bd-status').value,
      price_cents: Number(document.getElementById('bd-price').value) || 0,
      original_price_cents: document.getElementById('bd-orig-price').value ? Number(document.getElementById('bd-orig-price').value) : null,
      thumbnail_url: document.getElementById('bd-thumb').value.trim() || null,
      stripe_product_id: document.getElementById('bd-stripe-product').value.trim() || null,
      stripe_price_id: document.getElementById('bd-stripe-price').value.trim() || null,
    };
    if (!data.title) { showToast('Title is required', 'error'); return; }
    await proxyFrom('qa_bundles').update(data).eq('id', selectedBundleId);
    hasUnsavedChanges = false;
    await loadCourses();
    showToast('Bundle saved', 'success');
  } catch(e) { showToast('Save failed: ' + e.message, 'error'); }
  btn.disabled = false; btn.innerHTML = ICONS.save + ' Save Bundle';
}

async function addBundleCourse(bundleId) {
  const courseId = document.getElementById('bd-add-course').value;
  if (!courseId) return;
  const sortOrder = allBundleCourses.filter(bc => bc.bundle_id === bundleId).length;
  try {
    await proxyFrom('qa_bundle_courses').insert({bundle_id: bundleId, course_id: courseId, sort_order: sortOrder});
    await loadCourses();
    selectBundle(bundleId);
    showToast('Course added to bundle', 'success');
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function removeBundleCourse(bundleId, courseId) {
  if (!await qpConfirm('Remove Course', 'Remove this course from the bundle?', {okText: 'Remove', danger: true})) return;
  try {
    await proxyFrom('qa_bundle_courses').delete().eq('bundle_id', bundleId).eq('course_id', courseId);
    await loadCourses();
    selectBundle(bundleId);
    showToast('Course removed from bundle', 'success');
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function deleteBundle(id) {
  const bundle = allBundles.find(b => b.id === id);
  if (!await qpConfirm('Delete Bundle', `Delete "${bundle.title}"? This won't delete the courses themselves.`, {okText: 'Delete', danger: true})) return;
  try {
    await proxyFrom('qa_bundle_courses').delete().eq('bundle_id', id);
    await proxyFrom('qa_bundles').delete().eq('id', id);
    selectedBundleId = null;
    await loadCourses();
    showEmptyState();
    showToast('Bundle deleted', 'success');
  } catch(e) { showToast('Delete failed: ' + e.message, 'error'); }
}

// ============================================================
// RICH TEXT TOOLBAR (for lesson content)
// ============================================================

function insertRichFormat(cmd, val) {
  const el = document.getElementById('ml-content');
  const start = el.selectionStart, end = el.selectionEnd;
  const selected = el.value.substring(start, end);
  let insert = '';
  switch(cmd) {
    case 'bold': insert = `**${selected || 'bold text'}**`; break;
    case 'italic': insert = `*${selected || 'italic text'}*`; break;
    case 'h2': insert = `\n## ${selected || 'Heading'}\n`; break;
    case 'h3': insert = `\n### ${selected || 'Subheading'}\n`; break;
    case 'ul': insert = `\n- ${selected || 'List item'}\n- \n- \n`; break;
    case 'ol': insert = `\n1. ${selected || 'First item'}\n2. \n3. \n`; break;
    case 'link': insert = `[${selected || 'link text'}](https://)`; break;
    case 'hr': insert = `\n---\n`; break;
    case 'quote': insert = `\n> ${selected || 'Quote text'}\n`; break;
    case 'code': insert = selected.includes('\n') ? `\n\`\`\`\n${selected}\n\`\`\`\n` : `\`${selected || 'code'}\``; break;
  }
  el.value = el.value.substring(0, start) + insert + el.value.substring(end);
  el.focus();
  el.selectionStart = el.selectionEnd = start + insert.length;
}

function getRichToolbar() {
  return `<div class="rich-toolbar">
    <button type="button" onclick="insertRichFormat('bold')" title="Bold"><b>B</b></button>
    <button type="button" onclick="insertRichFormat('italic')" title="Italic"><i>I</i></button>
    <span class="divider"></span>
    <button type="button" onclick="insertRichFormat('h2')" title="Heading 2">H2</button>
    <button type="button" onclick="insertRichFormat('h3')" title="Heading 3">H3</button>
    <span class="divider"></span>
    <button type="button" onclick="insertRichFormat('ul')" title="Bullet List">â€¢ List</button>
    <button type="button" onclick="insertRichFormat('ol')" title="Numbered List">1. List</button>
    <button type="button" onclick="insertRichFormat('quote')" title="Quote">â</button>
    <span class="divider"></span>
    <button type="button" onclick="insertRichFormat('link')" title="Link">ðŸ”—</button>
    <button type="button" onclick="insertRichFormat('code')" title="Code">&lt;/&gt;</button>
    <button type="button" onclick="insertRichFormat('hr')" title="Divider">â€”</button>
    <span style="flex:1"></span>
    <span style="font-size:10px;color:var(--text-dim)">Markdown</span>
  </div>`;
}

// ============================================================
// LANDING PAGE EDITOR (What You'll Learn, FAQ, Testimonials)
// ============================================================

function getLandingPageEditor(course) {
  // Parse existing data from short_description (JSON) or empty
  let landing = {learn: [], faq: [], testimonials: []};
  try {
    if (course.short_description && course.short_description.startsWith('{')) {
      landing = JSON.parse(course.short_description);
    }
  } catch(e) {}
  if (!landing.learn) landing.learn = [];
  if (!landing.faq) landing.faq = [];
  if (!landing.testimonials) landing.testimonials = [];

  return `
    <div class="cb-section">
      <div class="cb-section-head">
        <h3>Landing Page Content</h3>
        <span class="badge" style="font-size:10px">Shown on course sales page</span>
      </div>

      <!-- What You'll Learn -->
      <div style="margin-bottom:16px">
        <div style="font-size:12px;font-weight:600;color:var(--taupe);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em">What You'll Learn</div>
        <div id="lp-learn-list">
          ${landing.learn.map((item, i) => `
            <div class="lp-item" style="display:flex;gap:8px;margin-bottom:6px;align-items:center">
              <span style="color:var(--teal);font-size:14px">âœ“</span>
              <input type="text" class="lp-learn-input" value="${esc(item)}" placeholder="Learning outcome..." oninput="markUnsaved()" style="flex:1;padding:8px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px">
              <button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove();markUnsaved()" style="color:var(--danger);padding:4px">${ICONS.x}</button>
            </div>
          `).join('')}
        </div>
        <button class="btn btn-ghost btn-sm" onclick="addLearnItem()" style="margin-top:4px">${ICONS.plus} Add Item</button>
      </div>

      <!-- FAQ -->
      <div style="margin-bottom:16px">
        <div style="font-size:12px;font-weight:600;color:var(--taupe);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em">FAQ</div>
        <div id="lp-faq-list">
          ${landing.faq.map((item, i) => `
            <div class="lp-faq-item" style="margin-bottom:8px;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm)">
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
                <input type="text" class="lp-faq-q" value="${esc(item.q)}" placeholder="Question" oninput="markUnsaved()" style="flex:1;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;font-weight:600">
                <button class="btn btn-ghost btn-sm" onclick="this.closest('.lp-faq-item').remove();markUnsaved()" style="color:var(--danger);padding:4px">${ICONS.x}</button>
              </div>
              <textarea class="lp-faq-a" rows="2" placeholder="Answer" oninput="markUnsaved()" style="width:100%;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;resize:vertical">${esc(item.a)}</textarea>
            </div>
          `).join('')}
        </div>
        <button class="btn btn-ghost btn-sm" onclick="addFaqItem()" style="margin-top:4px">${ICONS.plus} Add FAQ</button>
      </div>

      <!-- Testimonials -->
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--taupe);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em">Testimonials</div>
        <div id="lp-testimonial-list">
          ${landing.testimonials.map((item, i) => `
            <div class="lp-test-item" style="margin-bottom:8px;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm)">
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
                <input type="text" class="lp-test-name" value="${esc(item.name)}" placeholder="Student name" oninput="markUnsaved()" style="flex:1;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;font-weight:600">
                <input type="number" class="lp-test-rating" value="${item.rating || 5}" min="1" max="5" oninput="markUnsaved()" style="width:60px;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--teal);font-size:13px;text-align:center">
                <button class="btn btn-ghost btn-sm" onclick="this.closest('.lp-test-item').remove();markUnsaved()" style="color:var(--danger);padding:4px">${ICONS.x}</button>
              </div>
              <textarea class="lp-test-text" rows="2" placeholder="What they said..." oninput="markUnsaved()" style="width:100%;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;resize:vertical">${esc(item.text)}</textarea>
            </div>
          `).join('')}
        </div>
        <button class="btn btn-ghost btn-sm" onclick="addTestimonialItem()" style="margin-top:4px">${ICONS.plus} Add Testimonial</button>
      </div>
    </div>`;
}

function addLearnItem() {
  const list = document.getElementById('lp-learn-list');
  const div = document.createElement('div');
  div.className = 'lp-item';
  div.style.cssText = 'display:flex;gap:8px;margin-bottom:6px;align-items:center';
  div.innerHTML = `<span style="color:var(--teal);font-size:14px">âœ“</span>
    <input type="text" class="lp-learn-input" placeholder="Learning outcome..." oninput="markUnsaved()" style="flex:1;padding:8px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px">
    <button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove();markUnsaved()" style="color:var(--danger);padding:4px">${ICONS.x}</button>`;
  list.appendChild(div);
  div.querySelector('input').focus();
  markUnsaved();
}

function addFaqItem() {
  const list = document.getElementById('lp-faq-list');
  const div = document.createElement('div');
  div.className = 'lp-faq-item';
  div.style.cssText = 'margin-bottom:8px;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm)';
  div.innerHTML = `<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
    <input type="text" class="lp-faq-q" placeholder="Question" oninput="markUnsaved()" style="flex:1;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;font-weight:600">
    <button class="btn btn-ghost btn-sm" onclick="this.closest('.lp-faq-item').remove();markUnsaved()" style="color:var(--danger);padding:4px">${ICONS.x}</button>
  </div>
  <textarea class="lp-faq-a" rows="2" placeholder="Answer" oninput="markUnsaved()" style="width:100%;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;resize:vertical"></textarea>`;
  list.appendChild(div);
  div.querySelector('input').focus();
  markUnsaved();
}

function addTestimonialItem() {
  const list = document.getElementById('lp-testimonial-list');
  const div = document.createElement('div');
  div.className = 'lp-test-item';
  div.style.cssText = 'margin-bottom:8px;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm)';
  div.innerHTML = `<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
    <input type="text" class="lp-test-name" placeholder="Student name" oninput="markUnsaved()" style="flex:1;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;font-weight:600">
    <input type="number" class="lp-test-rating" value="5" min="1" max="5" oninput="markUnsaved()" style="width:60px;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--teal);font-size:13px;text-align:center">
    <button class="btn btn-ghost btn-sm" onclick="this.closest('.lp-test-item').remove();markUnsaved()" style="color:var(--danger);padding:4px">${ICONS.x}</button>
  </div>
  <textarea class="lp-test-text" rows="2" placeholder="What they said..." oninput="markUnsaved()" style="width:100%;padding:6px 10px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px;resize:vertical"></textarea>`;
  list.appendChild(div);
  div.querySelector('input').focus();
  markUnsaved();
}

function collectLandingPageData() {
  const learn = [...document.querySelectorAll('.lp-learn-input')].map(el => el.value.trim()).filter(Boolean);
  const faq = [...document.querySelectorAll('.lp-faq-item')].map(el => ({
    q: el.querySelector('.lp-faq-q').value.trim(),
    a: el.querySelector('.lp-faq-a').value.trim(),
  })).filter(f => f.q);
  const testimonials = [...document.querySelectorAll('.lp-test-item')].map(el => ({
    name: el.querySelector('.lp-test-name').value.trim(),
    rating: Number(el.querySelector('.lp-test-rating').value) || 5,
    text: el.querySelector('.lp-test-text').value.trim(),
  })).filter(t => t.name && t.text);
  return {learn, faq, testimonials};
}

// Warn on page leave with unsaved changes
window.addEventListener('beforeunload', e => {
  if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; }
});
</script>
</body>
</html>
